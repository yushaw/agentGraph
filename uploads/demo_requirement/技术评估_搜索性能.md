# 搜索性能瓶颈分析报告

**作者**: 张伟（后端工程师）
**日期**: 2024年11月24日

---

## 一、现状分析

### 当前架构
```
用户请求 → API Gateway → 搜索服务 → MySQL LIKE查询 → 返回结果
```

### 性能数据（过去7天）

| 指标 | 平均值 | P95 | P99 |
|-----|-------|-----|-----|
| 响应时间 | 1.2s | 3.5s | 8.2s |
| QPS | 50 | 120 | 200 |
| 错误率 | 0.5% | 2% | 5% |

### 核心问题

1. **MySQL LIKE 查询效率低**
   - 当前使用 `LIKE '%keyword%'` 无法使用索引
   - 数据量达到500万条后性能急剧下降
   - 复杂查询时CPU占用超过80%

2. **无缓存机制**
   - 热门搜索词每次都查库
   - 相同查询重复计算

3. **单点架构**
   - 搜索服务只有单节点
   - 无法水平扩展

---

## 二、优化方案

### 方案A：引入 Elasticsearch（推荐）

**架构变更**:
```
用户请求 → API Gateway → 搜索服务 → Elasticsearch → 返回结果
                                  ↓
                            MySQL (数据同步)
```

**优势**:
- 全文搜索性能优异（预计 <100ms）
- 支持分词、拼音、模糊匹配
- 天然支持高亮、聚合、过滤
- 可水平扩展

**劣势**:
- 引入新组件，运维成本增加
- 数据同步需要额外开发
- 学习曲线

**工作量评估**: 2人/周

---

### 方案B：MySQL全文索引优化

**变更**:
- 添加 FULLTEXT 索引
- 使用 `MATCH AGAINST` 语法

**优势**:
- 无需引入新组件
- 改动小，风险低

**劣势**:
- 中文分词支持有限
- 性能提升有限（预计 500ms）
- 扩展性差

**工作量评估**: 3人/天

---

### 方案C：缓存 + MySQL优化

**变更**:
- 引入 Redis 缓存热门搜索结果
- MySQL 添加复合索引优化

**优势**:
- 热门查询性能提升明显
- 改动相对小

**劣势**:
- 长尾查询仍然慢
- 缓存一致性问题

**工作量评估**: 1人/周

---

## 三、方案对比

| 维度 | 方案A (ES) | 方案B (MySQL) | 方案C (缓存) |
|-----|-----------|---------------|-------------|
| 预期性能 | <100ms | ~500ms | 热门<50ms，长尾>1s |
| 开发成本 | 高 | 低 | 中 |
| 运维成本 | 高 | 低 | 中 |
| 扩展性 | 优 | 差 | 中 |
| 功能丰富度 | 优 | 差 | 差 |

---

## 四、建议

**短期（1-2周）**: 先实施方案C，快速缓解性能问题
**中期（1-2月）**: 实施方案A，彻底解决搜索体验问题

### ES选型建议
- 自建：阿里云 ES 或 腾讯云 ES
- 版本：7.x（兼容性好）
- 规格：3节点，4C8G起步

---

## 五、参考资料

1. Elasticsearch官方文档: https://elastic.co/guide
2. 《Elasticsearch权威指南》
3. 内部Wiki：搜索服务技术债清单
