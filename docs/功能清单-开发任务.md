# AgentGraph MVP 功能清单 - 开发任务版

> **生成日期**: 2025-10-31
> **数据源**: docs/桌面 AI 框架需求.md (v3.6)
> **提取方法**: 基于 PRD 显式功能需求章节
> **总卡片数**: 51 张
> **估算工时**: 191 人天

---

## 📊 总览统计

### 按优先级分布

| 优先级 | 卡片数 | 工时估算 | 占比 |
|--------|--------|----------|------|
| **P0-核心** | 37 | 143天 | 74.9% |
| **P1-重要** | 14 | 48天 | 25.1% |
| **合计** | **51** | **191天** | 100% |

### 按模块分布

| 模块 | 卡片数 | 工时 | 优先级 |
|------|--------|------|--------|
| **Agent 流程与状态管理** (Ch 2) | 9 | 35天 | P0 |
| **工具系统** (Ch 3) | 16 | 66天 | P0 |
| **HITL 人机协同** (Ch 5) | 7 | 23天 | P0 |
| **上下文管理** (Ch 6) | 5 | 19天 | P0 |
| **模型路由系统** (Ch 7) | 7 | 23天 | P1 |
| **多Agent协作** (Ch 8) | 7 | 25天 | P1 |

### 按技术栈分布

| 技术栈 | 引用次数 | 工时 | 说明 |
|--------|----------|------|------|
| **服务端** | 50 | 188天 | Python 后端实现 |
| **客户端** | 1 | 3天 | CLI 界面和交互 |

---

## 📋 详细功能清单

### Chapter 2: Agent 流程与状态管理 (9 张卡片, 35 天)

**优先级**: P0-核心

| 卡片ID | 功能名称 | 工时 | 说明 |
|--------|----------|------|------|
| 2.1 | Agent Loop 架构 | 3天 | 基于 LangGraph 的 ReAct 模式循环 |
| 2.2 | 状态定义（AppState） | 3天 | 29 字段的完整会话状态 |
| 2.3 | Planner 节点 | 5天 | LLM 推理、工具可见性控制、Token 监控 |
| 2.4 | Tools 节点（工具执行） | 5天 | 并发执行工具调用、HITL 审批集成 |
| 2.5 | Finalize 节点（最终输出） | 5天 | 最终输出格式化、消息历史清理 |
| 2.6 | Summarization 节点（自动压缩） | 5天 | Token >95% 时自动压缩消息历史 |
| 2.7 | 消息历史管理 | 3天 | OpenAI API 兼容的消息清理 |
| 2.8 | 路由逻辑 | 3天 | 三个路由函数控制 Loop 流程 |
| 2.9 | KV Cache 优化 | 3天 | SystemMessage 固定化、动态提醒分离 |

**核心文件**:
- `generalAgent/graph/builder.py` - Agent Loop 构建
- `generalAgent/graph/state.py` - 状态定义
- `generalAgent/graph/nodes/planner.py` - Planner 节点
- `generalAgent/graph/nodes/finalize.py` - Finalize 节点
- `generalAgent/graph/nodes/summarization.py` - 压缩节点
- `generalAgent/graph/routing.py` - 路由逻辑

---

### Chapter 3: 工具系统 (16 张卡片, 66 天)

**优先级**: P0-核心

#### 3.1 Core 工具 (6 张卡片, 18 天)

| 卡片ID | 功能名称 | 工时 | 说明 |
|--------|----------|------|------|
| 3.1.1 | now 工具 | 1天 | 获取当前 UTC 时间 |
| 3.1.2 | todo_read 工具 | 2天 | 读取任务列表 |
| 3.1.3 | todo_write 工具 | 3天 | 添加/更新/完成/删除任务 |
| 3.1.4 | delegate_task 工具 | 5天 | 创建同类型 Agent 副本处理子任务 |
| 3.1.5 | call_agent 工具 | 5天 | 调用异构 Agent（跨模板调用） |
| 3.1.6 | ask_human 工具 | 2天 | 主动请求用户输入（HITL） |

#### 3.2 Optional 工具 (10 张卡片, 48 天)

**文件操作** (6 张):
- `read_file` - 读取文件（2天）
- `write_file` - 写入文件（2天）
- `edit_file` - 编辑文件（3天）
- `find_files` - 文件名搜索（3天）
- `search_file` - 文件内容搜索（5天）
- `list_workspace_files` - 列出工作区文件（1天）

**网络工具** (2 张):
- `fetch_web` - 网页抓取（3天）
- `search_web` - 搜索引擎（3天）

**执行工具** (1 张):
- `run_bash_command` - 执行 Bash 命令（5天）

**上下文管理** (1 张):
- `compact_context` - 手动上下文压缩（5天）

**核心文件**:
- `generalAgent/tools/builtin/` - 内置工具实现
- `generalAgent/tools/custom/` - 用户自定义工具
- `generalAgent/tools/registry.py` - 工具注册表
- `generalAgent/config/tools.yaml` - 工具配置

---

### Chapter 5: HITL 人机协同 (7 张卡片, 23 天)

**优先级**: P0-核心

| 卡片ID | 功能名称 | 工时 | 说明 |
|--------|----------|------|------|
| 5.1 | ask_human 工具 | 2天 | Agent 主动请求用户输入 |
| 5.2 | 工具自定义检查器 | 3天 | 工具特定逻辑（如检测 `rm -rf`） |
| 5.3 | 全局风险模式 | 3天 | 跨工具检测（密码/API Key 泄露） |
| 5.4 | 工具配置规则 | 3天 | YAML 配置的审批规则 |
| 5.5 | 内置默认规则 | 2天 | 安全操作白名单 |
| 5.6 | ApprovalToolNode | 5天 | 工具执行拦截器，集成四层规则 |
| 5.7 | CLI 审批界面（极简版） | 5天 | 用户审批 UI（y/n prompt） |

**核心文件**:
- `generalAgent/hitl/approval_checker.py` - 四层审批规则
- `generalAgent/hitl/approval_node.py` - ApprovalToolNode 包装器
- `generalAgent/config/hitl_rules.yaml` - 审批规则配置
- `generalAgent/cli.py` - CLI 交互（interrupt 处理）

---

### Chapter 6: 上下文管理 (5 张卡片, 19 天)

**优先级**: P0-核心

| 卡片ID | 功能名称 | 工时 | 说明 |
|--------|----------|------|------|
| 6.1 | Token 监控 | 3天 | 三级阈值（75%/85%/95%） |
| 6.2 | 自动压缩（LLM 摘要） | 5天 | LLM 压缩旧消息 |
| 6.3 | 紧急截断（备用策略） | 3天 | LLM 失败时截断最旧消息 |
| 6.4 | 压缩后处理 | 3天 | Token 计数器重置 |
| 6.5 | 配置管理 | 5天 | 压缩阈值、保留比例等可配置 |

**核心文件**:
- `generalAgent/context/compressor.py` - 压缩核心逻辑
- `generalAgent/graph/nodes/summarization.py` - Summarization 节点
- `generalAgent/config/settings.py` - 上下文管理配置

---

### Chapter 7: 模型路由系统 (7 张卡片, 23 天)

**优先级**: P1-重要

| 卡片ID | 功能名称 | 工时 | 说明 |
|--------|----------|------|------|
| 7.1 | 五种模型槽位 | 3天 | base/reason/vision/code/chat |
| 7.2 | 多模态路由策略 | 3天 | 检测图片 → vision 模型 |
| 7.3 | 推理路由策略 | 3天 | 数学/逻辑问题 → reasoning 模型 |
| 7.4 | 代码路由策略 | 3天 | 代码生成/调试 → code 模型 |
| 7.5 | 长对话路由策略 | 3天 | 超长上下文 → chat 模型 |
| 7.6 | 默认路由策略 | 3天 | 通用对话 → base 模型 |
| 7.7 | ModelRegistry | 5天 | 模型注册表、动态配置 |

**核心文件**:
- `generalAgent/models/registry.py` - 模型注册表
- `generalAgent/models/routing.py` - 路由策略
- `generalAgent/config/settings.py` - 模型配置（.env）

---

### Chapter 8: 多Agent协作 (7 张卡片, 25 天)

**优先级**: P1-重要

| 卡片ID | 功能名称 | 工时 | 说明 |
|--------|----------|------|------|
| 8.1 | delegate_task 工具 | 5天 | 创建同类型 Agent 副本 |
| 8.2 | call_agent 工具 | 5天 | 调用异构 Agent |
| 8.3 | 状态继承 | 3天 | 工具/技能/工作区共享 |
| 8.4 | 循环检测 | 3天 | 防止 A→B→A 无限调用 |
| 8.5 | 深度限制 | 3天 | 最大嵌套 3 层（可配置） |
| 8.6 | Handoff Pattern | 3天 | Agent 切换机制（未来扩展） |
| 8.7 | Subagent 输出 | 3天 | 实时流式打印子 Agent 输出 |

**核心文件**:
- `generalAgent/tools/builtin/delegate_task.py` - delegate_task 实现
- `generalAgent/tools/builtin/call_agent.py` - call_agent 实现
- `generalAgent/graph/nodes/planner.py` - 状态继承逻辑

---

## 🗓️ 开发排期建议

### Phase 1: 核心基础 (P0, 约 12-14 周)

**Week 1-3: Agent Loop 基础**
- 实现 Agent Loop 架构 (2.1)
- 实现状态定义 (2.2)
- 实现 Planner 节点 (2.3)
- 实现 Tools 节点 (2.4)
- 实现路由逻辑 (2.8)

**Week 4-6: 工具系统核心**
- 实现 6 个 Core 工具 (3.1.1-3.1.6)
- 实现工具注册表和扫描器
- 实现按需加载机制
- 实现文件操作工具 (6 个)

**Week 7-9: HITL 系统**
- 实现 ask_human 工具 (5.1)
- 实现四层审批规则系统 (5.2-5.5)
- 实现 ApprovalToolNode (5.6)
- 实现 CLI 审批界面 (5.7)

**Week 10-12: 上下文管理**
- 实现 Token 监控 (6.1)
- 实现 Finalize 节点 (2.5)
- 实现 Summarization 节点 (2.6)
- 实现自动压缩和紧急截断 (6.2-6.3)
- 实现消息历史管理 (2.7)

**Week 13-14: 优化与测试**
- 实现 KV Cache 优化 (2.9)
- 实现网络工具和执行工具 (4 个)
- 集成测试和 Bug 修复

### Phase 2: 高级功能 (P1, 约 4-6 周)

**Week 15-17: 模型路由**
- 实现 ModelRegistry (7.7)
- 实现五种路由策略 (7.1-7.6)
- 集成多模型支持

**Week 18-20: Multi-Agent 协作**
- 实现 delegate_task (8.1)
- 实现 call_agent (8.2)
- 实现状态继承 (8.3)
- 实现循环检测和深度限制 (8.4-8.5)
- 实现 Subagent 输出 (8.7)

**Week 21-22: 系统测试**
- 端到端测试
- 性能优化
- 文档完善

---

## 📈 资源规划

### 按 3 人团队

| 角色 | 职责 | 负责模块 |
|------|------|----------|
| **后端开发 1** | Agent Loop + 工具系统 | Ch 2 (Agent 流程), Ch 3 (工具系统) |
| **后端开发 2** | HITL + 上下文管理 | Ch 5 (HITL), Ch 6 (上下文管理) |
| **后端开发 3** | 模型路由 + Multi-Agent | Ch 7 (模型路由), Ch 8 (Multi-Agent) |

**总工期**: 约 22 周 (~5.5 个月)

### 按 5 人团队

| 角色 | 职责 | 负责模块 |
|------|------|----------|
| **后端开发 1** | Agent Loop 核心 | Ch 2 (Agent 流程) |
| **后端开发 2** | 工具系统 | Ch 3 (工具系统) |
| **后端开发 3** | HITL 系统 | Ch 5 (HITL) |
| **后端开发 4** | 上下文管理 | Ch 6 (上下文管理) |
| **后端开发 5** | 模型路由 + Multi-Agent | Ch 7-8 (模型路由 + Multi-Agent) |

**总工期**: 约 14 周 (~3.5 个月)

---

## 🎯 验收标准

每个功能卡片都包含具体的验收标准，请参考 `docs/功能清单-Trello导入.csv` 中的 Description 字段。

### 示例: 2.1 Agent Loop 架构

- ✅ 支持最大 100 Loop（可配置 1-500）
- ✅ Token 使用率 >95% 时自动路由到 summarization
- ✅ LLM 决定无需工具时自动结束
- ✅ Loop 限制触发时强制 finalize

### 检查方式

1. **单元测试**: 每个功能有对应测试用例
2. **集成测试**: 端到端场景验证
3. **人工验收**: 产品经理/技术负责人确认
4. **文档更新**: 更新 CLAUDE.md 和相关文档

---

## 📁 相关文件

| 文件名 | 说明 |
|--------|------|
| `docs/功能清单-Trello导入.csv` | Trello 导入 CSV 文件（51 张卡片） |
| `docs/功能清单-提取报告.md` | 需求提取统计报告 |
| `docs/Trello导入指南.md` | Trello 导入操作指南 |
| `docs/桌面 AI 框架需求.md` | 完整 PRD 文档（v3.6） |

---

## 📞 说明

### 未覆盖章节

以下章节在 PRD 中**没有显式功能需求章节**，需要在实施时补充:

| 章节 | 标题 | 内容类型 | 说明 |
|------|------|----------|------|
| 4 | 技能系统 | 设计文档 | 定义 SKILL.md 结构、内置技能清单 |
| 9 | Agent 模板系统 | 架构设计 | SimpleAgent/GeneralAgent 模板 |
| 10 | 工作区管理 | 实现文档 | 会话隔离目录结构 |
| 11 | 文件处理 | API 文档 | 多格式支持、索引搜索 |
| 12 | 会话管理 | 存储设计 | SQLite 持久化 |
| 13 | 安全与合规 | 合规文档 | 数据隐私、HITL 审批 |
| 14 | Prompt 清单 | Prompt 库 | 系统提示词模板 |
| 15 | 快速开始 | 使用指南 | 5 分钟上手教程 |

**建议**: 在 Sprint Planning 时，从这些章节手动创建补充卡片。

### 工时估算说明

CSV 中的工时是**粗略估算**，实际工时需根据:
- 团队技术栈熟悉度
- LangGraph/LangChain 使用经验
- 是否需要学习时间
- 代码质量要求

**建议乘数**:
- 熟练团队: ×1.0
- 中等团队: ×1.5
- 新手团队: ×2.0

---

**生成时间**: 2025-10-31
**PRD 版本**: v3.6
**提取方法**: 自动化脚本基于 PRD 显式功能需求章节
