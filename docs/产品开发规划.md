## 桌面 AI 框架 - 最终产品需求文档 (v4.0)

## 🚀 里程碑 V1: 核心引擎与基础 UI (Core Engine & Basic UI)

**🎯 核心目标**：跑通“Hello World”。在客户端实现一个最精简的 `SimpleAgent` (TS LangGraph)，并为其搭建一个基础 UI 表单，实现从用户输入 -\> 客户端编排 -\> 云端 LLM -\> 客户端响应的最小闭环。

### 1.1 可快速落地场景/功能 (产品功能)

  * **标准对话窗口**：作为独立的产品形态，提供通用聊天（如“聊天助手”）。
  * **AI 悬浮窗/侧边栏**：满足用户即时的划词翻译、文本润色、代码解释等“轻交互”需求。

### 1.2 前台界面与数据契约 (UI & API)

#### 1.2.1 前台界面 (UI 交互)

**要实现的功能点：**

  * 实现一个基础的 Agent 模板渲染器。
  * 实现 `emptyStateGuidance`（空白状态引导）的渲染，包括 `hint`, `placeholder` 和 `examples` 卡片。
  * 实现 `examples` 卡片点击后 `presetInput` 自动填充。
  * 实现基础 `InputParam` 控件：`textarea`。
  * 实现 `inputTemplate` 的解析和展示（用于意图确认）。

**V1 交付的模板示例 (简单聊天助手)：**

```json
{
  "agentId": "com.company.agent.chat_assistant",
  "name": ["聊天助手", "Chat Assistant"],
  "description": "智能对话助手，可以回答问题、提供建议",
  "category": "通用助手",
  "emptyStateGuidance": {
    "hint": "我是你的智能助手，可以回答问题、提供建议、帮助创作",
    "placeholder": "输入你的问题或需求，开始对话...",
    "examples": [
      {
        "title": "日常咨询",
        "presetInput": { "message": "今天天气怎么样？" }
      },
      {
        "title": "学习辅导",
        "presetInput": { "message": "请解释一下什么是机器学习？" }
      }
    ]
  },
  "inputTemplate": { /* ... */ },
  "promptTemplate": "{{input.message}}",
  "displayTemplate": "{{input.message}}",
  "parameters": {
    "input": [
      {
        "name": "message",
        "type": "textarea",
        "label": "你的消息",
        "required": true,
        "rows": 3,
        "placeholder": "输入你的问题或需求...",
        "hint": "可以问我任何问题",
        "examples": [ "今天有什么重要新闻？" ]
      }
    ]
  }
}
```

#### 1.2.2 前端事件流数据契约 (API 输出)

*这是**客户端编排层 (TS LangGraph)** 输出给**客户端 UI 层 (React/Vue)** 的*内部事件\*。\*

| 事件类型 (type) | 负载内容 (payload) | UI 响应 (交互) |
| :--- | :--- | :--- |
| `AGENT_START` | `{ "agentId": "..." }` | 锁定输入框，显示“思考中...”动画。 |
| `AGENT_MESSAGE` | `{ "content": "..." }` | **(最终答案)** 在聊天窗口中渲染 Markdown 格式的回复。 |
| `AGENT_END` | `{ "status": "success" }` | 解锁输入框，停止“思考中”动画。 |
| `AGENT_ERROR` | `{ "error": "..." }` | 解锁输入框，显示红色的错误提示信息。 |

### 1.3 核心功能实现 (技术实现)

| 交付模块 | 章节 | 功能 (Function) | 实现 (Implementation) |
| :--- | :--- | :--- | :--- |
| **客户端 (UI)** | Ch 9. | 基础 UI 渲染器 (渲染 `textarea`, `emptyState...`) | `React/Vue` 组件 |
| **客户端 (TS LangGraph)** | Ch 2. | 基础 Agent Loop (Planner, Finalize) | `langgraph-ts` |
| | Ch 6. | KV Cache 优化 (固定 SystemMessage) | `langgraph-ts` 节点逻辑 |
| | Ch 9. | `SimpleAgent` 模板 (JS/TS 实现) | `simpleAgent.ts` |
| | Ch 14. | V1 提示词 (JS/TS 字符串) | `prompts.ts` |
| **服务端 (Cloud)** | Ch 17. | LLM 网关 + 鉴权服务 | `Node.js/Go/Python` (提供 API) |
| **文档** | Ch 1. | V1 架构图 (澄清三层架构) | `docs/architecture_v1.md` |

-----

## 🚀 里程碑 V2: 全能单体与高级引导 (Full-Fledged Agent & Guidance UI)

**🎯 核心目标**：构建“完全体”的 `GeneralAgent`。在**客户端**交付所有核心能力（本地工具、原生沙箱、技能、安全、记忆），并*同步交付*完整的**高级引导 UI**。

### 2.1 可快速落地场景/功能 (产品功能)

  * **本地文件助手**：Agent 能够读取、搜索、编辑和写入**本地文件沙箱**。
  * **Web 研究助手**：Agent 能（通过客户端）访问网络进行资料搜集。
  * **安全执行沙箱**：Agent 能在**用户审批** (HITL) 下执行本地 `bash` 命令。
  * **专业文档处理器**：通过**技能系统** (`@pdf`, `@docx`...)，实现对本地文档的专业操作。
  * **长时陪伴助手**：通过**本地会话持久化**和**上下文压缩**，实现长期记忆。

### 2.2 前台界面与数据契约 (UI & API)

#### 2.2.1 前台界面 (UI 交互)

**要实现的功能点：**

  * **【重点】** 实现“引导 PRD”中**所有高级 `InputParam` 控件**：
      * `text`, `number`, `select`, `checkbox`, `date`, `url`
      * **`file`, `image`, `video`, `audio`** (这些控件现在需要与**客户端原生层**的文件沙箱 API 对接)。
  * **【V2 核心交互】** 在 UI 层实现 `Ch 5 (HITL)` 的两个核心弹窗：
    1.  **主动提问弹窗** (监听 `INTERRUPT_ASK_HUMAN`)。
    2.  **安全审批弹窗** (监听 `INTERRUPT_APPROVAL`)。

**V2 交付的模板示例 (文档处理助手)：**

```json
{
  "agentId": "com.company.agent.document_processor",
  "name": ["文档处理助手", "Document Processor"],
  "category": "文档工具",
  "emptyStateGuidance": { /* ... */ },
  "parameters": {
    "input": [
      {
        "name": "document",
        "type": "file",
        "label": "上传文档",
        "required": true,
        "accept": ".pdf,.doc,.docx,.txt",
        "multiple": true,
        "maxSize": 20
      },
      {
        "name": "taskType",
        "type": "select",
        "label": "处理任务",
        "options": [
          { "value": "summarize", "label": "生成摘要", "default": true },
          { "value": "extract", "label": "信息提取" }
        ]
      },
      {
        "name": "extractFields",
        "type": "checkbox",
        "options": [
          { "value": "dates", "label": "日期时间", "checked": true },
          { "value": "amounts", "label": "金额数字", "checked": true }
        ]
      }
    ]
  }
}
```

#### 2.2.2 前端事件流数据契约 (API 输出)

*V1 事件...* **(并新增以下 V2 事件)**

| 事件类型 (type) | 负载内容 (payload) | UI 响应 (交互) |
| :--- | :--- | :--- |
| `TOOL_CALL` | `{ "tool_name": "read_file", "args": { "path": "..." } }` | 在聊天流中显示 `[Tool Call: 正在读取文件 "..." ]` 动画。 |
| `TOOL_RESULT` | `{ "tool_name": "read_file", "status": "success", "result": "..." }` | (可选) 在聊天流中显示 `[Tool Result: 已读取文件]`。 |
| **`INTERRUPT_APPROVAL`** | `{ "tool": "run_bash_command", "args": "...", "reason": "...", "risk_level": "high" }` | **(关键)** 暂停一切，弹出一个**安全审批模态框**，显示 `payload` 中的所有信息。 |
| **`INTERRUPT_ASK_HUMAN`** | `{ "question": "...", "default": "...", "context": "..." }` | **(关键)** 暂停一切，弹出一个**提问模态框**，显示 `question` 和 `default`。 |
| `SESSION_SAVE` | `{ "status": "saved" }` | (可选) 在 UI 角落显示一个“已保存”的 checkmark。 |
| `CONTEXT_COMPRESS` | `{ "status": "start" / "end" }` | (可选) 显示一个“正在压缩历史...”的 toast 提示。 |

### 2.3 核心功能实现 (技术实现)

| 交付模块 | 章节 | 功能 (Function) | 实现 (Implementation) |
| :--- | :--- | :--- | :--- |
| **客户端 (UI)** | Ch 9. | 实现**所有高级 UI 控件** (`file`, `image`, `url` 等)。 | `React/Vue` 组件 |
| | Ch 5. | 实现 **HITL 弹窗** (审批框, 提问框)。 | `React/Vue` 模态框 |
| **客户端 (TS LangGraph)** | Ch 2. | 交付 `Tools` 节点，使 Agent Loop 完整。 | `langgraph-ts` |
| | Ch 3. | 工具*定义* (JS/TS 侧的 `zod` schema)。 | `tools/definitions.ts` |
| | Ch 4. | 技能系统*逻辑* (加载、`SKILL.md` 解析)。 | `skills/registry.ts` |
| | Ch 5. | HITL *逻辑* (在 `Tools` 节点中调用 `interrupt()`)。 | `langgraph-ts` |
| | Ch 6. | **上下文压缩**和 **Token 监控** *逻辑*。 | `context/compressor.ts` |
| | Ch 12. | **会话持久化** *逻辑*。 | `session/manager.ts` (使用 `SQLite.js` 或 `IndexedDB`) |
| **客户端 (原生层)** | **Ch 10.** | **【V2 核心】** 实现**文件沙箱系统**。 | `Rust/Swift/C#` (Tauri/Electron Native) |
| | **Ch 3.** | **【V2 核心】** 实现**原生工具接口** ( `read_file`, `write_file`, `run_bash_command`...) | `Rust/Swift/C#` (暴露给 TS 层的接口) |
| | **Ch 11.** | **【V2 核心】** 实现**原生文件处理** (PDF/DOCX 解析, FTS5 索引)。 | `Rust/Swift/C#` (调用本地库) |
| | Ch 4. | 技能依赖安装 (如 `pip`/`npm` 的原生调用)。 | `Rust/Swift/C#` |
| **服务端 (Cloud)** | | (无重大变更) | |

-----

## 🚀 里程碑 V3: 智能协作 (Autonomous & Collaborative Agents)

**🎯 核心目标**：让 Agent “学会思考”和“学会协作”。在**客户端 (TS LangGraph)** 内部实现模型路由和多 Agent 协作。

### 3.1 可快速落地场景/功能 (产品功能)

  * **智能图像分析**：用户上传图片，**客户端**自动检测并请求 `vision` 模型进行分析。
  * **专家代码助手**：用户请求生成代码，**客户端**自动请求 `code` 模型。
  * **复杂任务自动拆解**：主 Agent（经理）自动委派给 Subagent（员工）执行，**全部在客户端 TS LangGraph 中完成**。

### 3.2 前台界面与数据契约 (UI & API)

#### 3.2.1 前台界面 (UI 交互)

**要实现的功能点：**

  * **【V3 核心交互】** 实现 **Subagent 流式日志渲染器**。
  * 前端必须能接收 `SUBAGENT_STREAM_...` 事件，并**在主聊天流中渲染一个“缩进”或“折叠”的日志块**，实时展示 Subagent 的执行过程。

**V3 交付的模板示例 (图片分析助手)：**

```json
{
  "agentId": "com.company.agent.image_analyzer",
  "name": ["图片分析助手", "Image Analyzer"],
  "category": "图像处理",
  "parameters": {
    "input": [
      {
        "name": "images",
        "type": "image",
        "label": "上传图片",
        "required": true
      },
      {
        "name": "question",
        "type": "textarea",
        "label": "具体需求"
      }
    ]
  }
}
```

#### 3.2.2 前端事件流数据契约 (API 输出)

*V1, V2 事件...* **(并新增以下 V3 事件)**

| 事件类型 (type) | 负载内容 (payload) | UI 响应 (交互) |
| :--- | :--- | :--- |
| `MODEL_ROUTE` | `{ "from": "chat", "to": "vision", "reason": "Image detected" }` | (可选) 显示一个 "已切换到 Vision 模型" 的 toast 提示。 |
| **`SUBAGENT_STREAM_START`** | `{ "context_id": "subagent-abc", "task": "..." }` | **(关键)** 在 UI 中创建一个新的、缩进的日志块。 |
| **`SUBAGENT_STREAM_MESSAGE`** | `{ "context_id": "subagent-abc", "message": "Loop 1: Searching..." }` | **(关键)** 在对应的日志块中追加 `message` 内容。 |
| `SUBAGENT_STREAM_END` | `{ "context_id": "subagent-abc", "status": "success" }` | 关闭对应的日志块，并显示“子任务完成”。 |

### 3.3 核心功能实现 (技术实现)

| 交付模块 | 章节 | 功能 (Function) | 实现 (Implementation) |
| :--- | :--- | :--- | :--- |
| **客户端 (UI)** | Ch 8. | **Subagent 流式日志渲染器**。 | `React/Vue` 组件 |
| **客户端 (TS LangGraph)** | **Ch 7.** | **模型路由逻辑** (在调用服务端前决定 `model_id`)。 | `models/registry.ts` |
| | **Ch 8.** | **多 Agent 协作** (`delegate_task`, `call_agent`)。 | `langgraph-ts` (图的嵌套) |
| | Ch 9. | `agents.yaml` 解析器和 `AgentRegistry`。 | `agents/registry.ts` |
| | Ch 14. | `SUBAGENT_SYSTEM_PROMPT`。 | `prompts.ts` |
| **服务端 (Cloud)** | Ch 7. | **LLM 网关升级**：支持接收 `model_id` 参数并路由到不同云端 LLM。 | `Node.js/Go/Python` (API 变更) |

-----

## 🚀 里程碑 V4: 自动化工作流与 1.0 发布 (Workflows & Platform 1.0)

**🎯 核心目标**：从“Agent”进化到“自动化工作流平台”。在**客户端**交付可复用的 `Workflow` 模板，并完成所有文档和安全加固，准备 1.0 正式发布。

### 4.1 可快速落地场景/功能 (产品功能)

  * **Pipeline (流水线) 工作流**：
      * *场景*：“文档翻译与校对”：用户上传文档，**客户端工作流**自动执行 [Step 1: 提取] -\> [Step 2: 翻译] -\> [Step 3: 校对]。
  * **Parallel (并行) 工作流**：
      * *场景*：“全网竞品分析”：用户输入竞品名称，**客户端工作流**自动**并行**执行 [Task 1: 搜索新闻] + [Task 2: 搜索博客]。
  * **1.0 稳定版平台**：交付所有文档，冻结核心 API。

### 4.2 前台界面与数据契约 (UI & API)

#### 4.2.1 前台界面 (UI 交互)

**要实现的功能点：**

  * 在模板选择器 UI 中，增加“工作流”分类。
  * **【V4 核心交互】** 实现一个**工作流进度 UI**，用于实时展示 `WORKFLOW_...` 事件。
  * 此 UI 应当能清晰展示 `Pipeline` 的步骤（如 "Step 2/3: 正在分析内容..."）或 `Parallel` 的并行任务状态。

**V4 交付的模板示例 (前端启动表单)：**

  * **目的**：为“文档处理流水线”提供一个简单的**启动表单**。
  * **结构**：`AgentTemplate` (来自 Ch 9)，并增加一个 `targetType: "workflow"` 字段。

<!-- end list -->

```json
{
  "agentId": "com.company.workflow.doc_process",
  "name": ["文档处理流水线", "Document Processing Workflow"],
  "description": "（工作流）自动执行[提取-分析-总结]流水线",
  "category": "工作流",
  "targetType": "workflow", 
  "parameters": {
    "input": [
      {
        "name": "document",
        "type": "file",
        "label": "上传文档",
        "required": true
      },
      {
        "name": "taskType",
        "type": "select",
        "label": "工作流类型",
        "options": [
          { "value": "report_summary", "label": "报告总结", "default": true },
          { "value": "translation_proofread", "label": "翻译与校对" }
        ]
      }
    ]
  }
}
```

#### 4.2.2 前端事件流数据契约 (API 输出)

*V1, V2, V3 事件...* **(并新增以下 V4 事件)**

| 事件类型 (type) | 负载内容 (payload) | UI 响应 (交互) |
| :--- | :--- | :--- |
| **`WORKFLOW_START`** | `{ "name": "文档处理流水线", "total_steps": 3 }` | **(关键)** 隐藏聊天输入框，显示“工作流进度” UI。 |
| **`WORKFLOW_STEP_START`** | `{ "step_name": "extract", "step_index": 1, "total_steps": 3 }` | **(关键)** 高亮显示“Step 1: extract”，并显示“进行中...”。 |
| `WORKFLOW_STEP_LOG` | `{ "step_name": "extract", "log": "..." }` | (可选) 在步骤下方显示 `SUBAGENT_STREAM_MESSAGE` 类似的日志。 |
| **`WORKFLOW_STEP_END`** | `{ "step_name": "extract", "status": "success" }` | **(关键)** 将“Step 1: extract”标记为“已完成”（绿色对勾）。 |
| **`WORKFLOW_END`** | `{ "status": "success", "outputs": { "report": "..." } }` | 显示“工作流全部完成”，并在聊天流中输出最终结果。 |

### 4.3 核心功能实现 (技术实现)

| 交付模块 | 章节 | 功能 (Function) | 实现 (Implementation) |
| :--- | :--- | :--- | :--- |
| **客户端 (UI)** | Ch 16. | **工作流进度 UI**。 | `React/Vue` 组件 |
| | Ch 9. | UI 模板列表增加“工作流”分类。 | `React/Vue` 组件 |
| **客户端 (TS LangGraph)** | **Ch 16.** | **`WorkflowEngine` (新)**: 解析 YAML 并按 `mode` (pipeline/parallel) 调度。 | `langgraph-ts` |
| | | **`Workflow Parser` (新)**: 负责加载和验证 `workflows/*.yaml` 文件。 | `workflow/parser.ts` |
| | | `WorkflowEngine` *调用* Ch 8 的能力来执行 `steps`。 | `langgraph-ts` |
| **客户端 (原生层)** | Ch 13. | **安全收尾** (Jinja2 沙箱, 最终安全审计)。 | `Rust/Swift/C#` (沙箱加固) |
| **文档** | Ch 15. | **文档冻结** (交付 1.0 上手指南)。 | `README.md` (Final) |
| **服务端 (Cloud)** | | (无重大变更) | |